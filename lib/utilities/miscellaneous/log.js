'use strict';

var path = require('path');

var pathUtilities = require('../../utilities/path'),
    arrayUtilities = require('../../utilities/array'),
    fileSystemUtilities = require('../../utilities/fileSystem');

var second = arrayUtilities.second,
    concatenatePaths = pathUtilities.concatenatePaths,
    checkFileExists = fileSystemUtilities.checkFileExists,
    readFile = fileSystemUtilities.readFile,
    appendToFile = fileSystemUtilities.appendToFile,
    renameFile = fileSystemUtilities.renameFile,
    getStats = fileSystemUtilities.getStats;
var TRACE = 'TRACE',
    DEBUG = 'DEBUG',
    INFO = 'INFO',
    WARNING = 'WARNING',
    ERROR = 'ERROR',
    FATAL = 'FATAL';
var logLevel = WARNING,
    logFileBaseName = 'default',
    logDirectoryPath = null;

function log(messageOrError) {
  var level = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';
  var pertinentStackMessageIndex = 2;
  var levels = [TRACE, DEBUG, INFO, WARNING, ERROR, FATAL];

  if (level) {
    ///
    var levelIndex = levels.indexOf(level),
        logLevelIndex = levels.indexOf(logLevel);

    if (levelIndex < logLevelIndex) {
      return;
    }

    pertinentStackMessageIndex += 1;
    level = "".concat(level, " "); ///
  }

  var error, message;

  if (messageOrError instanceof Error) {
    error = messageOrError; ///

    var _error = error;
    message = _error.message;
  } else {
    message = messageOrError; ///

    error = new Error(message);
  }

  var _error2 = error,
      stack = _error2.stack,
      stackMessages = stackMessagesFromStack(stack),
      pertinentStackMessage = stackMessages[pertinentStackMessageIndex],
      stackMessage = pertinentStackMessage,
      currentDateAndTimeString = getCurrentDateAndTimeString(),
      filePath = filePathFromStackMessage(stackMessage),
      lineNumber = lineNumberFromStackMessage(stackMessage),
      logMessage = "".concat(level).concat(currentDateAndTimeString, " ").concat(filePath, "(").concat(lineNumber, ") ").concat(message);
  console.log(logMessage);

  if (logDirectoryPath !== null) {
    rollOverLogFile();
    var logFilePath = getLogFilePath(),
        logFileContent = "".concat(logMessage, "\n");
    appendToFile(logFilePath, logFileContent);
  }

  return logMessage;
}

function trace(message) {
  return log(message, TRACE);
}

function debug(message) {
  return log(message, DEBUG);
}

function info(message) {
  return log(message, INFO);
}

function warning(message) {
  return log(message, WARNING);
}

function error(message) {
  return log(message, ERROR);
}

function fatal(message) {
  return log(message, FATAL);
}

function setLogLevel(level) {
  logLevel = level;
}

function setLogFileBaseName(fileBaseName) {
  logFileBaseName = fileBaseName;
}

function setLogDirectoryPath(directoryPath) {
  logDirectoryPath = directoryPath;
}

function setLogOptions(logOptions) {
  var level = logOptions.level,
      fileBaseName = logOptions.fileBaseName,
      directoryPath = logOptions.directoryPath;
  setLogLevel(level);
  setLogFileBaseName(fileBaseName);
  setLogDirectoryPath(directoryPath);
}

function getLogFileContent() {
  var logFilePath = getLogFilePath(),
      logFileContent = readFile(logFilePath);
  return logFileContent;
}

Object.assign(log, {
  TRACE: TRACE,
  DEBUG: DEBUG,
  INFO: INFO,
  WARNING: WARNING,
  ERROR: ERROR,
  FATAL: FATAL,
  trace: trace,
  debug: debug,
  info: info,
  warning: warning,
  error: error,
  fatal: fatal,
  setLogLevel: setLogLevel,
  setLogFileBaseName: setLogFileBaseName,
  setLogDirectoryPath: setLogDirectoryPath,
  setLogOptions: setLogOptions,
  getLogFileContent: getLogFileContent
});
module.exports = log;

function getLogFilePath() {
  var logFileName = "".concat(logFileBaseName, ".log"),
      logFilePath = concatenatePaths(logDirectoryPath, logFileName);
  return logFilePath;
}

function getRolledOverLogFilePath() {
  var currentDateString = getCurrentDateString(),
      rolledOverLogFileName = "".concat(logFileBaseName, ".").concat(currentDateString, ".log"),
      rolledOverLogFilePath = concatenatePaths(logDirectoryPath, rolledOverLogFileName);
  return rolledOverLogFilePath;
}

function getLogFileLastModifiedDate() {
  var logFilePath = getLogFilePath(),
      logFileStats = getStats(logFilePath),
      mtime = logFileStats.mtime,
      logFileLastModifiedDate = new Date(mtime); ///

  return logFileLastModifiedDate;
}

function rollOverLogFile() {
  var logFilePath = getLogFilePath(),
      logFileExists = checkFileExists(logFilePath);

  if (!logFileExists) {
    return;
  }

  var logFileLastModifiedDate = getLogFileLastModifiedDate(),
      logFileLastModifiedDateCurrentDate = isDateCurrentDate(logFileLastModifiedDate);

  if (!logFileLastModifiedDateCurrentDate) {
    var rolledOverLogFilePath = getRolledOverLogFilePath();
    renameFile(logFilePath, rolledOverLogFilePath);
  }
}

function isDateCurrentDate(date) {
  var currentDate = new Date(),
      dateString = date.toDateString(),
      currentDateString = currentDate.toDateString(),
      dateCurrentDate = dateString === currentDateString;
  return dateCurrentDate;
}

function getCurrentDateString() {
  var date = new Date(),
      day = padStartWithZeroes(date.getDate(), 2),
      ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
      ///
  year = date.getFullYear(),
      currentDateAndTimeString = "".concat(day, "-").concat(month, "-").concat(year);
  return currentDateAndTimeString;
}

function getCurrentDateAndTimeString() {
  var date = new Date(),
      day = padStartWithZeroes(date.getDate(), 2),
      ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
      ///
  year = date.getFullYear(),
      hours = padStartWithZeroes(date.getHours(), 2),
      minutes = padStartWithZeroes(date.getMinutes(), 2),
      seconds = padStartWithZeroes(date.getSeconds(), 2),
      milliseconds = padStartWithZeroes(date.getMilliseconds(), 3),
      currentDateAndTimeString = "".concat(day, "-").concat(month, "-").concat(year, " ").concat(hours, ":").concat(minutes, ":").concat(seconds, ".").concat(milliseconds);
  return currentDateAndTimeString;
}

function stackMessagesFromStack(stack) {
  var stackMessages = [],
      stackLines = stack.split(/\r\n|\n/);
  var stackMessage = "";
  stackLines.forEach(function (stackLine) {
    var matches = /^\s*at.*/.test(stackLine);
    stackMessage = stackMessage === "" ? stackLine : "".concat(stackMessage, "\n").concat(stackLine);

    if (matches) {
      stackMessages.push(stackMessage);
      stackMessage = "";
    }
  });
  return stackMessages;
}

function filePathFromStackMessage(stackMessage) {
  var matches = stackMessage.match(/(\/.+):\d+:\d+/m),
      secondMatch = second(matches),
      absoluteFilePath = secondMatch,
      ///
  currentWorkingDirectoryPath = path.resolve('.'),
      ///
  currentWorkingDirectoryPathLength = currentWorkingDirectoryPath.length,
      start = currentWorkingDirectoryPathLength + 1,
      ///
  filePath = absoluteFilePath.substr(start);
  return filePath;
}

function lineNumberFromStackMessage(stackMessage) {
  var matches = stackMessage.match(/:(\d+)/m),
      secondMatch = second(matches),
      lineNumber = secondMatch; ///

  return lineNumber;
}

function padStartWithZeroes(string, targetLength) {
  var padString = '0',
      paddedString = padStart(string, targetLength, padString);
  return paddedString;
}

function padStart(string, targetLength, padString) {
  var padding = '';

  for (var index = 0; index < targetLength; index++) {
    padding += padString;
  }

  var paddedString = "".concat(padding).concat(string).substr(-targetLength);
  return paddedString;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxvZy5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsInBhdGhVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsImZpbGVTeXN0ZW1VdGlsaXRpZXMiLCJzZWNvbmQiLCJjb25jYXRlbmF0ZVBhdGhzIiwiY2hlY2tGaWxlRXhpc3RzIiwicmVhZEZpbGUiLCJhcHBlbmRUb0ZpbGUiLCJyZW5hbWVGaWxlIiwiZ2V0U3RhdHMiLCJUUkFDRSIsIkRFQlVHIiwiSU5GTyIsIldBUk5JTkciLCJFUlJPUiIsIkZBVEFMIiwibG9nTGV2ZWwiLCJsb2dGaWxlQmFzZU5hbWUiLCJsb2dEaXJlY3RvcnlQYXRoIiwibG9nIiwibWVzc2FnZU9yRXJyb3IiLCJsZXZlbCIsInBlcnRpbmVudFN0YWNrTWVzc2FnZUluZGV4IiwibGV2ZWxzIiwibGV2ZWxJbmRleCIsImluZGV4T2YiLCJsb2dMZXZlbEluZGV4IiwiZXJyb3IiLCJtZXNzYWdlIiwiRXJyb3IiLCJzdGFjayIsInN0YWNrTWVzc2FnZXMiLCJzdGFja01lc3NhZ2VzRnJvbVN0YWNrIiwicGVydGluZW50U3RhY2tNZXNzYWdlIiwic3RhY2tNZXNzYWdlIiwiY3VycmVudERhdGVBbmRUaW1lU3RyaW5nIiwiZ2V0Q3VycmVudERhdGVBbmRUaW1lU3RyaW5nIiwiZmlsZVBhdGgiLCJmaWxlUGF0aEZyb21TdGFja01lc3NhZ2UiLCJsaW5lTnVtYmVyIiwibGluZU51bWJlckZyb21TdGFja01lc3NhZ2UiLCJsb2dNZXNzYWdlIiwiY29uc29sZSIsInJvbGxPdmVyTG9nRmlsZSIsImxvZ0ZpbGVQYXRoIiwiZ2V0TG9nRmlsZVBhdGgiLCJsb2dGaWxlQ29udGVudCIsInRyYWNlIiwiZGVidWciLCJpbmZvIiwid2FybmluZyIsImZhdGFsIiwic2V0TG9nTGV2ZWwiLCJzZXRMb2dGaWxlQmFzZU5hbWUiLCJmaWxlQmFzZU5hbWUiLCJzZXRMb2dEaXJlY3RvcnlQYXRoIiwiZGlyZWN0b3J5UGF0aCIsInNldExvZ09wdGlvbnMiLCJsb2dPcHRpb25zIiwiZ2V0TG9nRmlsZUNvbnRlbnQiLCJPYmplY3QiLCJhc3NpZ24iLCJtb2R1bGUiLCJleHBvcnRzIiwibG9nRmlsZU5hbWUiLCJnZXRSb2xsZWRPdmVyTG9nRmlsZVBhdGgiLCJjdXJyZW50RGF0ZVN0cmluZyIsImdldEN1cnJlbnREYXRlU3RyaW5nIiwicm9sbGVkT3ZlckxvZ0ZpbGVOYW1lIiwicm9sbGVkT3ZlckxvZ0ZpbGVQYXRoIiwiZ2V0TG9nRmlsZUxhc3RNb2RpZmllZERhdGUiLCJsb2dGaWxlU3RhdHMiLCJtdGltZSIsImxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlIiwiRGF0ZSIsImxvZ0ZpbGVFeGlzdHMiLCJsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZUN1cnJlbnREYXRlIiwiaXNEYXRlQ3VycmVudERhdGUiLCJkYXRlIiwiY3VycmVudERhdGUiLCJkYXRlU3RyaW5nIiwidG9EYXRlU3RyaW5nIiwiZGF0ZUN1cnJlbnREYXRlIiwiZGF5IiwicGFkU3RhcnRXaXRoWmVyb2VzIiwiZ2V0RGF0ZSIsIm1vbnRoIiwiZ2V0TW9udGgiLCJ5ZWFyIiwiZ2V0RnVsbFllYXIiLCJob3VycyIsImdldEhvdXJzIiwibWludXRlcyIsImdldE1pbnV0ZXMiLCJzZWNvbmRzIiwiZ2V0U2Vjb25kcyIsIm1pbGxpc2Vjb25kcyIsImdldE1pbGxpc2Vjb25kcyIsInN0YWNrTGluZXMiLCJzcGxpdCIsImZvckVhY2giLCJzdGFja0xpbmUiLCJtYXRjaGVzIiwidGVzdCIsInB1c2giLCJtYXRjaCIsInNlY29uZE1hdGNoIiwiYWJzb2x1dGVGaWxlUGF0aCIsImN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aCIsInJlc29sdmUiLCJjdXJyZW50V29ya2luZ0RpcmVjdG9yeVBhdGhMZW5ndGgiLCJsZW5ndGgiLCJzdGFydCIsInN1YnN0ciIsInN0cmluZyIsInRhcmdldExlbmd0aCIsInBhZFN0cmluZyIsInBhZGRlZFN0cmluZyIsInBhZFN0YXJ0IiwicGFkZGluZyIsImluZGV4Il0sIm1hcHBp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V0FGbkIsQ0FEZ0QsQ0FHaEI7O0FBRWhDLFNBQU9uRSxVQUFQO0FBQ0Q7O0FBRUQsU0FBUzZDLGtCQUFULENBQTRCOEIsTUFBNUIsRUFBb0NDLFlBQXBDLEVBQWtEO0FBQ2hELE1BQU1DLFNBQVMsR0FBRyxHQUFsQjtBQUFBLE1BQ01DLFlBQVksR0FBR0MsUUFBUSxDQUFDSixNQUFELEVBQVNDLFlBQVQsRUFBdUJDLFNBQXZCLENBRDdCO0FBR0EsU0FBT0MsWUFBUDtBQUNEOztBQUVELFNBQVNDLFFBQVQsQ0FBa0JKLE1BQWxCLEVBQTBCQyxZQUExQixFQUF3Q0MsU0FBeEMsRUFBbUQ7QUFDakQsTUFBSUcsT0FBTyxHQUFHLEVBQWQ7O0FBRUEsT0FBSyxJQUFJQyxLQUFLLEdBQUcsQ0FBakIsRUFBb0JBLEtBQUssR0FBR0wsWUFBNUIsRUFBMENLLEtBQUssRUFBL0MsRUFBbUQ7QUFDakRELElBQUFBLE9BQU8sSUFBSUgsU0FBWDtBQUNEOztBQUVELE1BQU1DLFlBQVksR0FBRyxVQUFHRSxPQUFILFNBQWFMLE1BQWIsRUFBc0JELE1BQXRCLENBQTZCLENBQUNFLFlBQTlCLENBQXJCO0FBRUEsU0FBT0UsWUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuXG5jb25zdCBwYXRoVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vLi4vdXRpbGl0aWVzL3BhdGgnKSxcbiAgICAgIGFycmF5VXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vLi4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICBmaWxlU3lzdGVtVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vLi4vdXRpbGl0aWVzL2ZpbGVTeXN0ZW0nKTtcblxuY29uc3QgeyBzZWNvbmQgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBjb25jYXRlbmF0ZVBhdGhzIH0gPSBwYXRoVXRpbGl0aWVzLFxuICAgICAgeyBjaGVja0ZpbGVFeGlzdHMsIHJlYWRGaWxlLCBhcHBlbmRUb0ZpbGUsIHJlbmFtZUZpbGUsIGdldFN0YXRzIH0gPSBmaWxlU3lzdGVtVXRpbGl0aWVzO1xuXG5jb25zdCBUUkFDRSA9ICdUUkFDRScsXG4gICAgICBERUJVRyA9ICdERUJVRycsXG4gICAgICBJTkZPID0gJ0lORk8nLFxuICAgICAgV0FSTklORyA9ICdXQVJOSU5HJyxcbiAgICAgIEVSUk9SID0gJ0VSUk9SJyxcbiAgICAgIEZBVEFMID0gJ0ZBVEFMJztcblxubGV0IGxvZ0xldmVsID0gV0FSTklORyxcbiAgICBsb2dGaWxlQmFzZU5hbWUgPSAnZGVmYXVsdCcsXG4gICAgbG9nRGlyZWN0b3J5UGF0aCA9IG51bGw7XG5cbmZ1bmN0aW9uIGxvZyhtZXNzYWdlT3JFcnJvciwgbGV2ZWwgPSAnJykge1xuICBsZXQgcGVydGluZW50U3RhY2tNZXNzYWdlSW5kZXggPSAyO1xuXG4gIGNvbnN0IGxldmVscyA9IFtcbiAgICBUUkFDRSxcbiAgICBERUJVRyxcbiAgICBJTkZPLFxuICAgIFdBUk5JTkcsXG4gICAgRVJST1IsXG4gICAgRkFUQUxcbiAgXTtcblxuICBpZiAobGV2ZWwpIHsgLy8vXG4gICAgY29uc3QgbGV2ZWxJbmRleCA9IGxldmVscy5pbmRleE9mKGxldmVsKSxcbiAgICAgICAgICBsb2dMZXZlbEluZGV4ID0gbGV2ZWxzLmluZGV4T2YobG9nTGV2ZWwpO1xuXG4gICAgaWYgKGxldmVsSW5kZXggPCBsb2dMZXZlbEluZGV4KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcGVydGluZW50U3RhY2tNZXNzYWdlSW5kZXggKz0gMTtcblxuICAgIGxldmVsID0gYCR7bGV2ZWx9IGA7ICAvLy9cbiAgfVxuXG4gIGxldCBlcnJvcixcbiAgICAgIG1lc3NhZ2U7XG5cbiAgaWYgKG1lc3NhZ2VPckVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICBlcnJvciA9IG1lc3NhZ2VPckVycm9yOyAvLy9cblxuICAgICh7IG1lc3NhZ2UgfSA9IGVycm9yKTtcbiAgfSBlbHNlIHtcbiAgICBtZXNzYWdlID0gbWVzc2FnZU9yRXJyb3I7IC8vL1xuXG4gICAgZXJyb3IgPSBuZXcgRXJyb3IobWVzc2FnZSk7XG4gIH1cblxuICBjb25zdCB7IHN0YWNrIH0gPSBlcnJvcixcbiAgICAgICAgc3RhY2tNZXNzYWdlcyA9IHN0YWNrTWVzc2FnZXNGcm9tU3RhY2soc3RhY2spLFxuICAgICAgICBwZXJ0aW5lbnRTdGFja01lc3NhZ2UgPSBzdGFja01lc3NhZ2VzW3BlcnRpbmVudFN0YWNrTWVzc2FnZUluZGV4XSxcbiAgICAgICAgc3RhY2tNZXNzYWdlID0gcGVydGluZW50U3RhY2tNZXNzYWdlLCAvLy9cbiAgICAgICAgY3VycmVudERhdGVBbmRUaW1lU3RyaW5nID0gZ2V0Q3VycmVudERhdGVBbmRUaW1lU3RyaW5nKCksXG4gICAgICAgIGZpbGVQYXRoID0gZmlsZVBhdGhGcm9tU3RhY2tNZXNzYWdlKHN0YWNrTWVzc2FnZSksXG4gICAgICAgIGxpbmVOdW1iZXIgPSBsaW5lTnVtYmVyRnJvbVN0YWNrTWVzc2FnZShzdGFja01lc3NhZ2UpLFxuICAgICAgICBsb2dNZXNzYWdlID0gYCR7bGV2ZWx9JHtjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmd9ICR7ZmlsZVBhdGh9KCR7bGluZU51bWJlcn0pICR7bWVzc2FnZX1gO1xuXG4gIGNvbnNvbGUubG9nKGxvZ01lc3NhZ2UpO1xuXG4gIGlmIChsb2dEaXJlY3RvcnlQYXRoICE9PSBudWxsKSB7XG4gICAgcm9sbE92ZXJMb2dGaWxlKCk7XG5cbiAgICBjb25zdCBsb2dGaWxlUGF0aCA9IGdldExvZ0ZpbGVQYXRoKCksXG4gICAgICAgICAgbG9nRmlsZUNvbnRlbnQgPSBgJHtsb2dNZXNzYWdlfVxcbmA7XG5cbiAgICBhcHBlbmRUb0ZpbGUobG9nRmlsZVBhdGgsIGxvZ0ZpbGVDb250ZW50KTtcbiAgfVxuXG4gIHJldHVybiBsb2dNZXNzYWdlO1xufVxuXG5mdW5jdGlvbiB0cmFjZShtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgVFJBQ0UpOyB9XG5cbmZ1bmN0aW9uIGRlYnVnKG1lc3NhZ2UpIHsgcmV0dXJuIGxvZyhtZXNzYWdlLCBERUJVRyk7IH1cblxuZnVuY3Rpb24gaW5mbyhtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgSU5GTyk7IH1cblxuZnVuY3Rpb24gd2FybmluZyhtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgV0FSTklORyk7IH1cblxuZnVuY3Rpb24gZXJyb3IobWVzc2FnZSkgeyByZXR1cm4gbG9nKG1lc3NhZ2UsIEVSUk9SKTsgfVxuXG5mdW5jdGlvbiBmYXRhbChtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgRkFUQUwpOyB9XG5cbmZ1bmN0aW9uIHNldExvZ0xldmVsKGxldmVsKSB7IGxvZ0xldmVsID0gbGV2ZWw7IH1cblxuZnVuY3Rpb24gc2V0TG9nRmlsZUJhc2VOYW1lKGZpbGVCYXNlTmFtZSkgeyBsb2dGaWxlQmFzZU5hbWUgPSBmaWxlQmFzZU5hbWU7IH1cblxuZnVuY3Rpb24gc2V0TG9nRGlyZWN0b3J5UGF0aChkaXJlY3RvcnlQYXRoKSB7IGxvZ0RpcmVjdG9yeVBhdGggPSBkaXJlY3RvcnlQYXRoOyB9XG5cbmZ1bmN0aW9uIHNldExvZ09wdGlvbnMobG9nT3B0aW9ucykge1xuICBjb25zdCB7IGxldmVsLCBmaWxlQmFzZU5hbWUsIGRpcmVjdG9yeVBhdGggfSA9IGxvZ09wdGlvbnM7XG5cbiAgc2V0TG9nTGV2ZWwobGV2ZWwpO1xuXG4gIHNldExvZ0ZpbGVCYXNlTmFtZShmaWxlQmFzZU5hbWUpO1xuXG4gIHNldExvZ0RpcmVjdG9yeVBhdGgoZGlyZWN0b3J5UGF0aCk7XG59XG5cbmZ1bmN0aW9uIGdldExvZ0ZpbGVDb250ZW50KCkge1xuICBjb25zdCBsb2dGaWxlUGF0aCA9IGdldExvZ0ZpbGVQYXRoKCksXG4gICAgICAgIGxvZ0ZpbGVDb250ZW50ID0gcmVhZEZpbGUobG9nRmlsZVBhdGgpO1xuXG4gIHJldHVybiBsb2dGaWxlQ29udGVudDtcbn1cblxuT2JqZWN0LmFzc2lnbihsb2csIHtcbiAgVFJBQ0UsXG4gIERFQlVHLFxuICBJTkZPLFxuICBXQVJOSU5HLFxuICBFUlJPUixcbiAgRkFUQUwsXG4gIHRyYWNlLFxuICBkZWJ1ZyxcbiAgaW5mbyxcbiAgd2FybmluZyxcbiAgZXJyb3IsXG4gIGZhdGFsLFxuICBzZXRMb2dMZXZlbCxcbiAgc2V0TG9nRmlsZUJhc2VOYW1lLFxuICBzZXRMb2dEaXJlY3RvcnlQYXRoLFxuICBzZXRMb2dPcHRpb25zLFxuICBnZXRMb2dGaWxlQ29udGVudFxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gbG9nO1xuXG5mdW5jdGlvbiBnZXRMb2dGaWxlUGF0aCgpIHtcbiAgY29uc3QgbG9nRmlsZU5hbWUgPSBgJHtsb2dGaWxlQmFzZU5hbWV9LmxvZ2AsXG4gICAgICAgIGxvZ0ZpbGVQYXRoID0gY29uY2F0ZW5hdGVQYXRocyhsb2dEaXJlY3RvcnlQYXRoLCBsb2dGaWxlTmFtZSk7XG5cbiAgcmV0dXJuIGxvZ0ZpbGVQYXRoO1xufVxuXG5mdW5jdGlvbiBnZXRSb2xsZWRPdmVyTG9nRmlsZVBhdGgoKSB7XG4gIGNvbnN0IGN1cnJlbnREYXRlU3RyaW5nID0gZ2V0Q3VycmVudERhdGVTdHJpbmcoKSxcbiAgICAgICAgcm9sbGVkT3ZlckxvZ0ZpbGVOYW1lID0gYCR7bG9nRmlsZUJhc2VOYW1lfS4ke2N1cnJlbnREYXRlU3RyaW5nfS5sb2dgLFxuICAgICAgICByb2xsZWRPdmVyTG9nRmlsZVBhdGggPSBjb25jYXRlbmF0ZVBhdGhzKGxvZ0RpcmVjdG9yeVBhdGgsIHJvbGxlZE92ZXJMb2dGaWxlTmFtZSk7XG5cbiAgcmV0dXJuIHJvbGxlZE92ZXJMb2dGaWxlUGF0aDtcbn1cblxuZnVuY3Rpb24gZ2V0TG9nRmlsZUxhc3RNb2RpZmllZERhdGUoKSB7XG4gIGNvbnN0IGxvZ0ZpbGVQYXRoID0gZ2V0TG9nRmlsZVBhdGgoKSxcbiAgICAgICAgbG9nRmlsZVN0YXRzID0gZ2V0U3RhdHMobG9nRmlsZVBhdGgpLFxuICAgICAgICB7IG10aW1lIH0gPSBsb2dGaWxlU3RhdHMsXG4gICAgICAgIGxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlID0gbmV3IERhdGUobXRpbWUpOyAgLy8vXG5cbiAgcmV0dXJuIGxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlO1xufVxuXG5mdW5jdGlvbiByb2xsT3ZlckxvZ0ZpbGUoKSB7XG4gIGNvbnN0IGxvZ0ZpbGVQYXRoID0gZ2V0TG9nRmlsZVBhdGgoKSxcbiAgICAgICAgbG9nRmlsZUV4aXN0cyA9IGNoZWNrRmlsZUV4aXN0cyhsb2dGaWxlUGF0aCk7XG5cbiAgaWYgKCFsb2dGaWxlRXhpc3RzKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgbG9nRmlsZUxhc3RNb2RpZmllZERhdGUgPSBnZXRMb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSgpLFxuICAgICAgICBsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZUN1cnJlbnREYXRlID0gaXNEYXRlQ3VycmVudERhdGUobG9nRmlsZUxhc3RNb2RpZmllZERhdGUpO1xuXG4gIGlmICghbG9nRmlsZUxhc3RNb2RpZmllZERhdGVDdXJyZW50RGF0ZSkge1xuICAgIGNvbnN0IHJvbGxlZE92ZXJMb2dGaWxlUGF0aCA9IGdldFJvbGxlZE92ZXJMb2dGaWxlUGF0aCgpO1xuXG4gICAgcmVuYW1lRmlsZShsb2dGaWxlUGF0aCwgcm9sbGVkT3ZlckxvZ0ZpbGVQYXRoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpc0RhdGVDdXJyZW50RGF0ZShkYXRlKSB7XG4gIGNvbnN0IGN1cnJlbnREYXRlID0gbmV3IERhdGUoKSxcbiAgICAgICAgZGF0ZVN0cmluZyA9IGRhdGUudG9EYXRlU3RyaW5nKCksXG4gICAgICAgIGN1cnJlbnREYXRlU3RyaW5nID0gY3VycmVudERhdGUudG9EYXRlU3RyaW5nKCksXG4gICAgICAgIGRhdGVDdXJyZW50RGF0ZSA9IChkYXRlU3RyaW5nID09PSBjdXJyZW50RGF0ZVN0cmluZyk7XG5cbiAgcmV0dXJuIGRhdGVDdXJyZW50RGF0ZTtcbn1cblxuZnVuY3Rpb24gZ2V0Q3VycmVudERhdGVTdHJpbmcoKSB7XG4gIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSgpLFxuICAgICAgICBkYXkgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXREYXRlKCksIDIpLCAgLy8vXG4gICAgICAgIG1vbnRoID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0TW9udGgoKSArIDEsIDIpLCAvLy9cbiAgICAgICAgeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgY3VycmVudERhdGVBbmRUaW1lU3RyaW5nID0gYCR7ZGF5fS0ke21vbnRofS0ke3llYXJ9YDtcblxuICByZXR1cm4gY3VycmVudERhdGVBbmRUaW1lU3RyaW5nO1xufVxuXG5mdW5jdGlvbiBnZXRDdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmcoKSB7XG4gIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSgpLFxuICAgICAgICBkYXkgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXREYXRlKCksIDIpLCAgLy8vXG4gICAgICAgIG1vbnRoID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0TW9udGgoKSArIDEsIDIpLCAvLy9cbiAgICAgICAgeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgaG91cnMgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRIb3VycygpLCAyKSxcbiAgICAgICAgbWludXRlcyA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldE1pbnV0ZXMoKSwgMiksXG4gICAgICAgIHNlY29uZHMgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRTZWNvbmRzKCksIDIpLFxuICAgICAgICBtaWxsaXNlY29uZHMgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRNaWxsaXNlY29uZHMoKSwgMyksXG4gICAgICAgIGN1cnJlbnREYXRlQW5kVGltZVN0cmluZyA9IGAke2RheX0tJHttb250aH0tJHt5ZWFyfSAke2hvdXJzfToke21pbnV0ZXN9OiR7c2Vjb25kc30uJHttaWxsaXNlY29uZHN9YDtcblxuICByZXR1cm4gY3VycmVudERhdGVBbmRUaW1lU3RyaW5nO1xufVxuXG5mdW5jdGlvbiBzdGFja01lc3NhZ2VzRnJvbVN0YWNrKHN0YWNrKSB7XG4gIGNvbnN0IHN0YWNrTWVzc2FnZXMgPSBbXSxcbiAgICAgICAgc3RhY2tMaW5lcyA9IHN0YWNrLnNwbGl0KC9cXHJcXG58XFxuLyk7XG5cbiAgbGV0IHN0YWNrTWVzc2FnZSA9IFwiXCI7XG5cbiAgc3RhY2tMaW5lcy5mb3JFYWNoKChzdGFja0xpbmUpID0+IHtcbiAgICBjb25zdCBtYXRjaGVzID0gL15cXHMqYXQuKi8udGVzdChzdGFja0xpbmUpO1xuXG4gICAgc3RhY2tNZXNzYWdlID0gKHN0YWNrTWVzc2FnZSA9PT0gXCJcIikgP1xuICAgICAgICAgICAgICAgICAgICAgIHN0YWNrTGluZSA6XG4gICAgICAgICAgICAgICAgICAgICAgICBgJHtzdGFja01lc3NhZ2V9XFxuJHtzdGFja0xpbmV9YDtcblxuICAgIGlmIChtYXRjaGVzKSB7XG4gICAgICBzdGFja01lc3NhZ2VzLnB1c2goc3RhY2tNZXNzYWdlKTtcblxuICAgICAgc3RhY2tNZXNzYWdlID0gXCJcIjtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBzdGFja01lc3NhZ2VzO1xufVxuXG5mdW5jdGlvbiBmaWxlUGF0aEZyb21TdGFja01lc3NhZ2Uoc3RhY2tNZXNzYWdlKSB7XG4gIGNvbnN0IG1hdGNoZXMgPSBzdGFja01lc3NhZ2UubWF0Y2goLyhcXC8uKyk6XFxkKzpcXGQrL20pLFxuICAgICAgICBzZWNvbmRNYXRjaCA9IHNlY29uZChtYXRjaGVzKSxcbiAgICAgICAgYWJzb2x1dGVGaWxlUGF0aCA9IHNlY29uZE1hdGNoLCAgLy8vXG4gICAgICAgIGN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aCA9IHBhdGgucmVzb2x2ZSgnLicpLCAgLy8vXG4gICAgICAgIGN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aExlbmd0aCA9IGN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aC5sZW5ndGgsXG4gICAgICAgIHN0YXJ0ID0gY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoTGVuZ3RoICsgMSwgIC8vL1xuICAgICAgICBmaWxlUGF0aCA9IGFic29sdXRlRmlsZVBhdGguc3Vic3RyKHN0YXJ0KTtcblxuICByZXR1cm4gZmlsZVBhdGg7XG59XG5cbmZ1bmN0aW9uIGxpbmVOdW1iZXJGcm9tU3RhY2tNZXNzYWdlKHN0YWNrTWVzc2FnZSkge1xuICBjb25zdCBtYXRjaGVzID0gc3RhY2tNZXNzYWdlLm1hdGNoKC86KFxcZCspL20pLFxuICAgICAgICBzZWNvbmRNYXRjaCA9IHNlY29uZChtYXRjaGVzKSxcbiAgICAgICAgbGluZU51bWJlciA9IHNlY29uZE1hdGNoOyAvLy9cblxuICByZXR1cm4gbGluZU51bWJlcjtcbn1cblxuZnVuY3Rpb24gcGFkU3RhcnRXaXRoWmVyb2VzKHN0cmluZywgdGFyZ2V0TGVuZ3RoKSB7XG4gIGNvbnN0IHBhZFN0cmluZyA9ICcwJyxcbiAgICAgICAgcGFkZGVkU3RyaW5nID0gcGFkU3RhcnQoc3RyaW5nLCB0YXJnZXRMZW5ndGgsIHBhZFN0cmluZyk7XG5cbiAgcmV0dXJuIHBhZGRlZFN0cmluZztcbn1cblxuZnVuY3Rpb24gcGFkU3RhcnQoc3RyaW5nLCB0YXJnZXRMZW5ndGgsIHBhZFN0cmluZykge1xuICBsZXQgcGFkZGluZyA9ICcnO1xuXG4gIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB0YXJnZXRMZW5ndGg7IGluZGV4KyspIHtcbiAgICBwYWRkaW5nICs9IHBhZFN0cmluZztcbiAgfVxuXG4gIGNvbnN0IHBhZGRlZFN0cmluZyA9IGAke3BhZGRpbmd9JHtzdHJpbmd9YC5zdWJzdHIoLXRhcmdldExlbmd0aCk7XG5cbiAgcmV0dXJuIHBhZGRlZFN0cmluZztcbn1cblxuIl19