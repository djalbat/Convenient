'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = log;

var _path = _interopRequireDefault(require("path"));

var _array = require("../../utilities/array");

var _path2 = require("../../utilities/path");

var _fileSystem = require("../../utilities/fileSystem");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var TRACE = 'TRACE',
    DEBUG = 'DEBUG',
    INFO = 'INFO',
    WARNING = 'WARNING',
    ERROR = 'ERROR',
    FATAL = 'FATAL';
var logLevel = WARNING,
    logFileBaseName = 'default',
    logDirectoryPath = null;

function log(messageOrError) {
  var level = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';
  var pertinentStackMessageIndex = 1;
  var levels = [TRACE, DEBUG, INFO, WARNING, ERROR, FATAL];

  if (level !== '') {
    var levelIndex = levels.indexOf(level),
        logLevelIndex = levels.indexOf(logLevel);

    if (levelIndex < logLevelIndex) {
      return;
    }

    pertinentStackMessageIndex += 1;
    level = "".concat(level, " "); ///
  }

  var error, message;

  if (messageOrError instanceof Error) {
    error = messageOrError; ///

    var _error = error;
    message = _error.message;
  } else {
    message = messageOrError; ///

    error = new Error(message);
  }

  var _error2 = error,
      stack = _error2.stack,
      stackMessages = stackMessagesFromStack(stack),
      pertinentStackMessage = stackMessages[pertinentStackMessageIndex],
      stackMessage = pertinentStackMessage,
      currentDateAndTimeString = getCurrentDateAndTimeString(),
      filePath = filePathFromStackMessage(stackMessage),
      lineNumber = lineNumberFromStackMessage(stackMessage),
      logMessage = "".concat(level).concat(currentDateAndTimeString, " ").concat(filePath, "(").concat(lineNumber, ") ").concat(message);
  console.log(logMessage);

  if (logDirectoryPath !== null) {
    rollOverLogFile();
    var logFilePath = getLogFilePath(),
        logFileContent = "".concat(logMessage, "\n");
    (0, _fileSystem.appendToFile)(logFilePath, logFileContent);
  }

  return logMessage;
}

function trace(message) {
  return log(message, TRACE);
}

function debug(message) {
  return log(message, DEBUG);
}

function info(message) {
  return log(message, INFO);
}

function warning(message) {
  return log(message, WARNING);
}

function error(message) {
  return log(message, ERROR);
}

function fatal(message) {
  return log(message, FATAL);
}

function setLogLevel(level) {
  logLevel = level;
}

function setLogFileBaseName(fileBaseName) {
  logFileBaseName = fileBaseName;
}

function setLogDirectoryPath(directoryPath) {
  logDirectoryPath = directoryPath;
}

function setLogOptions(logOptions) {
  var level = logOptions.level,
      fileBaseName = logOptions.fileBaseName,
      directoryPath = logOptions.directoryPath;
  setLogLevel(level);
  setLogFileBaseName(fileBaseName);
  setLogDirectoryPath(directoryPath);
}

function getLogFileContent() {
  var logFilePath = getLogFilePath(),
      logFileContent = (0, _fileSystem.readFile)(logFilePath);
  return logFileContent;
}

Object.assign(log, {
  TRACE: TRACE,
  DEBUG: DEBUG,
  INFO: INFO,
  WARNING: WARNING,
  ERROR: ERROR,
  FATAL: FATAL,
  trace: trace,
  debug: debug,
  info: info,
  warning: warning,
  error: error,
  fatal: fatal,
  setLogLevel: setLogLevel,
  setLogFileBaseName: setLogFileBaseName,
  setLogDirectoryPath: setLogDirectoryPath,
  setLogOptions: setLogOptions,
  getLogFileContent: getLogFileContent
});

function getLogFilePath() {
  var logFileName = "".concat(logFileBaseName, ".log"),
      logFilePath = (0, _path2.concatenatePaths)(logDirectoryPath, logFileName);
  return logFilePath;
}

function getRolledOverLogFilePath() {
  var currentDateString = getCurrentDateString(),
      rolledOverLogFileName = "".concat(logFileBaseName, ".").concat(currentDateString, ".log"),
      rolledOverLogFilePath = (0, _path2.concatenatePaths)(logDirectoryPath, rolledOverLogFileName);
  return rolledOverLogFilePath;
}

function getLogFileLastModifiedDate() {
  var logFilePath = getLogFilePath(),
      logFileStats = (0, _fileSystem.getStats)(logFilePath),
      mtime = logFileStats.mtime,
      logFileLastModifiedDate = new Date(mtime); ///

  return logFileLastModifiedDate;
}

function rollOverLogFile() {
  var logFilePath = getLogFilePath(),
      logFileExists = (0, _fileSystem.checkFileExists)(logFilePath);

  if (!logFileExists) {
    return;
  }

  var logFileLastModifiedDate = getLogFileLastModifiedDate(),
      logFileLastModifiedDateCurrentDate = isDateCurrentDate(logFileLastModifiedDate);

  if (!logFileLastModifiedDateCurrentDate) {
    var rolledOverLogFilePath = getRolledOverLogFilePath();
    (0, _fileSystem.renameFile)(logFilePath, rolledOverLogFilePath);
  }
}

function isDateCurrentDate(date) {
  var currentDate = new Date(),
      dateString = date.toDateString(),
      currentDateString = currentDate.toDateString(),
      dateCurrentDate = dateString === currentDateString;
  return dateCurrentDate;
}

function getCurrentDateString() {
  var date = new Date(),
      day = padStartWithZeroes(date.getDate(), 2),
      ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
      ///
  year = date.getFullYear(),
      currentDateAndTimeString = "".concat(day, "-").concat(month, "-").concat(year);
  return currentDateAndTimeString;
}

function getCurrentDateAndTimeString() {
  var date = new Date(),
      day = padStartWithZeroes(date.getDate(), 2),
      ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
      ///
  year = date.getFullYear(),
      hours = padStartWithZeroes(date.getHours(), 2),
      minutes = padStartWithZeroes(date.getMinutes(), 2),
      seconds = padStartWithZeroes(date.getSeconds(), 2),
      milliseconds = padStartWithZeroes(date.getMilliseconds(), 3),
      currentDateAndTimeString = "".concat(day, "-").concat(month, "-").concat(year, " ").concat(hours, ":").concat(minutes, ":").concat(seconds, ".").concat(milliseconds);
  return currentDateAndTimeString;
}

function stackMessagesFromStack(stack) {
  var stackMessages = [],
      stackLines = stack.split(/\r\n|\n/);
  var stackMessage = "";
  stackLines.forEach(function (stackLine) {
    var matches = /^\s*at.*/.test(stackLine);
    stackMessage = stackMessage === "" ? stackLine : "".concat(stackMessage, "\n").concat(stackLine);

    if (matches) {
      stackMessages.push(stackMessage);
      stackMessage = "";
    }
  });
  return stackMessages;
}

function filePathFromStackMessage(stackMessage) {
  var matches = stackMessage.match(/(\/.+):\d+:\d+/m),
      secondMatch = (0, _array.second)(matches),
      absoluteFilePath = secondMatch,
      ///
  currentWorkingDirectoryPath = _path["default"].resolve('.'),
      ///
  currentWorkingDirectoryPathLength = currentWorkingDirectoryPath.length,
      start = currentWorkingDirectoryPathLength + 1,
      ///
  filePath = absoluteFilePath.substr(start);

  return filePath;
}

function lineNumberFromStackMessage(stackMessage) {
  var matches = stackMessage.match(/:(\d+)/m),
      secondMatch = (0, _array.second)(matches),
      lineNumber = secondMatch; ///

  return lineNumber;
}

function padStartWithZeroes(string, targetLength) {
  var padString = '0',
      paddedString = padStart(string, targetLength, padString);
  return paddedString;
}

function padStart(string, targetLength, padString) {
  var padding = '';

  for (var index = 0; index < targetLength; index++) {
    padding += padString;
  }

  var paddedString = "".concat(padding).concat(string).substr(-targetLength);
  return paddedString;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxvZy5qcyJdLCJuYW1lcyI6WyJUUkFDRSIsIkRFQlVHIiwiSU5GTyIsIldBUk5JTkciLCJFUlJPUiIsIkZBVEFMIiwibG9nTGV2ZWwiLCJsb2dGaWxlQmFzZU5hbWUiLCJsb2dEaXJlY3RvcnlQYXRoIiwibG9nIiwibWVzc2FnZU9yRXJyb3IiLCJsZXZlbCIsInBlcnRpbmVudFN0YWNrTWVzc2FnZUluZGV4IiwibGV2ZWxzIiwibGV2ZWxJbmRleCIsImluZGV4T2YiLCJsb2dMZXZlbEluZGV4IiwiZXJyb3IiLCJtZXNzYWdlIiwiRXJyb3IiLCJzdGFjayIsInN0YWNrTWVzc2FnZXMiLCJzdGFja01lc3NhZ2VzRnJvbVN0YWNrIiwicGVydGluZW50U3RhY2tNZXNzYWdlIiwic3RhY2tNZXNzYWdlIiwiY3VycmVudERhdGVBbmRUaW1lU3RyaW5nIiwiZ2V0Q3VycmVudERhdGVBbmRUaW1lU3RyaW5nIiwiZmlsZVBhdGgiLCJmaWxlUGF0aEZyb21TdGFja01lc3NhZ2UiLCJsaW5lTnVtYmVyIiwibGluZU51bWJlckZyb21TdGFja01lc3NhZ2UiLCJsb2dNZXNzYWdlIiwiY29uc29sZSIsInJvbGxPdmVyTG9nRmlsZSIsImxvZ0ZpbGVQYXRoIiwiZ2V0TG9nRmlsZVBhdGgiLCJsb2dGaWxlQ29udGVudCIsInRyYWNlIiwiZGVidWciLCJpbmZvIiwid2FybmluZyIsImZhdGFsIiwic2V0TG9nTGV2ZWwiLCJzZXRMb2dGaWxlQmFzZU5hbWUiLCJmaWxlQmFzZU5hbWUiLCJzZXRMb2dEaXJlY3RvcnlQYXRoIiwiZGlyZWN0b3J5UGF0aCIsInNldExvZ09wdGlvbnMiLCJsb2dPcHRpb25zIiwiZ2V0TG9nRmlsZUNvbnRlbnQiLCJPYmplY3QiLCJhc3NpZ24iLCJsb2dGaWxlTmFtZSIsImdldFJvbGxlZE92ZXJMb2dGaWxlUGF0aCIsImN1cnJlbnREYXRlU3RyaW5nIiwiZ2V0Q3VycmVudERhdGVTdHJpbmciLCJyb2xsZWRPdmVyTG9nRmlsZU5hbWUiLCJyb2xsZWRPdmVyTG9nRmlsZVBhdGgiLCJnZXRMb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSIsImxvZ0ZpbGVTdGF0cyIsIm10aW1lIiwibG9nRmlsZUxhc3RNb2RpZmllZERhdGUiLCJEYXRlIiwibG9nRmlsZUV4aXN0cyIsImxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlQ3VycmVudERhdGUiLCJpc0RhdGVDdXJyZW50RGF0ZSIsImRhdGUiLCJjdXJyZW50RGF0ZSIsImRhdGVTdHJpbmciLCJ0b0RhdGVTdHJpbmciLCJkYXRlQ3VycmVudERhdGUiLCJkYXkiLCJwYWRTdGFydFdpdGhaZXJvZXMiLCJnZXREYXRlIiwibW9udGgiLCJnZXRNb250aCIsInllYXIiLCJnZXRGdWxsWWVhciIsImhvdXJzIiwiZ2V0SG91cnMiLCJtaW51dGVzIiwiZ2V0TWludXRlcyIsInNlY29uZHMiLCJnZXRTZWNvbmRzIiwibWlsbGlzZWNvbmRzIiwiZ2V0TWlsbGlzZWNvbmRzIiwic3RhY2tMaW5lcyIsInNwbGl0IiwiZm9yRWFjaCIsInN0YWNrTGluZSIsIm1hdGNoZXMiLCJ0ZXN0IiwicHVzaCIsIm1hdGNoIiwic2Vjb25kTWF0Y2giLCJhYnNvbHV0ZUZpbGVQYXRoIiwiY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoIiwicGF0aCIsInJlc29sdmUiLCJjdXJyZW50V29ya2luZ0RpcmVjdG9yeVBhdGhMZW5ndGgiLCJsZW5ndGgiLCJzdGFydCIsInN1YnN0ciIsInN0cmluZyIsInRhcmdldExlbmd0aCIsInBhZFN0cmluZyIsInBhZGRlZFN0cmluZyIsInBhZFN0YXJ0IiwicGFkZGluZyIsImluZGV4Il0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOztBQUVBOztBQUNBOztBQUNBOzs7O0FBRUEsSUFBTUEsS0FBSyxHQUFHLE9BQWQ7QUFBQSxJQUNNQyxLQUFLLEdBQUcsT0FEZDtBQUFBLElBRU1DLElBQUksR0FBRyxNQUZiO0FBQUEsSUFHTUMsT0FBTyxHQUFHLFNBSGhCO0FBQUEsSUFJTUMsS0FBSyxHQUFHLE9BSmQ7QUFBQSxJ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QUFDRDs7QUFFRCxTQUFTRywwQkFBVCxDQUFvQ04sWUFBcEMsRUFBa0Q7QUFDaEQsTUFBTWtFLE9BQU8sR0FBR2xFLFlBQVksQ0FBQ3FFLEtBQWIsQ0FBbUIsU0FBbkIsQ0FBaEI7QUFBQSxNQUNNQyxXQUFXLEdBQUcsbUJBQU9KLE9BQVAsQ0FEcEI7QUFBQSxNQUVNN0QsVUFBVSxHQUFHaUUsV0FGbkIsQ0FEZ0QsQ0FHaEI7O0FBRWhDLFNBQU9qRSxVQUFQO0FBQ0Q7O0FBRUQsU0FBUzJDLGtCQUFULENBQTRCK0IsTUFBNUIsRUFBb0NDLFlBQXBDLEVBQWtEO0FBQ2hELE1BQU1DLFNBQVMsR0FBRyxHQUFsQjtBQUFBLE1BQ01DLFlBQVksR0FBR0MsUUFBUSxDQUFDSixNQUFELEVBQVNDLFlBQVQsRUFBdUJDLFNBQXZCLENBRDdCO0FBR0EsU0FBT0MsWUFBUDtBQUNEOztBQUVELFNBQVNDLFFBQVQsQ0FBa0JKLE1BQWxCLEVBQTBCQyxZQUExQixFQUF3Q0MsU0FBeEMsRUFBbUQ7QUFDakQsTUFBSUcsT0FBTyxHQUFHLEVBQWQ7O0FBRUEsT0FBSyxJQUFJQyxLQUFLLEdBQUcsQ0FBakIsRUFBb0JBLEtBQUssR0FBR0wsWUFBNUIsRUFBMENLLEtBQUssRUFBL0MsRUFBbUQ7QUFDakRELElBQUFBLE9BQU8sSUFBSUgsU0FBWDtBQUNEOztBQUVELE1BQU1DLFlBQVksR0FBRyxVQUFHRSxPQUFILFNBQWFMLE1BQWIsRUFBc0JELE1BQXRCLENBQTZCLENBQUNFLFlBQTlCLENBQXJCO0FBRUEsU0FBT0UsWUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IHsgc2Vjb25kIH0gZnJvbSAnLi4vLi4vdXRpbGl0aWVzL2FycmF5JztcbmltcG9ydCB7IGNvbmNhdGVuYXRlUGF0aHMgfSBmcm9tICcuLi8uLi91dGlsaXRpZXMvcGF0aCc7XG5pbXBvcnQgeyBjaGVja0ZpbGVFeGlzdHMsIHJlYWRGaWxlLCBhcHBlbmRUb0ZpbGUsIHJlbmFtZUZpbGUsIGdldFN0YXRzIH0gZnJvbSAnLi4vLi4vdXRpbGl0aWVzL2ZpbGVTeXN0ZW0nO1xuXG5jb25zdCBUUkFDRSA9ICdUUkFDRScsXG4gICAgICBERUJVRyA9ICdERUJVRycsXG4gICAgICBJTkZPID0gJ0lORk8nLFxuICAgICAgV0FSTklORyA9ICdXQVJOSU5HJyxcbiAgICAgIEVSUk9SID0gJ0VSUk9SJyxcbiAgICAgIEZBVEFMID0gJ0ZBVEFMJztcblxubGV0IGxvZ0xldmVsID0gV0FSTklORyxcbiAgICBsb2dGaWxlQmFzZU5hbWUgPSAnZGVmYXVsdCcsXG4gICAgbG9nRGlyZWN0b3J5UGF0aCA9IG51bGw7XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGxvZyhtZXNzYWdlT3JFcnJvciwgbGV2ZWwgPSAnJykge1xuICBsZXQgcGVydGluZW50U3RhY2tNZXNzYWdlSW5kZXggPSAxO1xuXG4gIGNvbnN0IGxldmVscyA9IFtcbiAgICBUUkFDRSxcbiAgICBERUJVRyxcbiAgICBJTkZPLFxuICAgIFdBUk5JTkcsXG4gICAgRVJST1IsXG4gICAgRkFUQUxcbiAgXTtcblxuICBpZiAobGV2ZWwgIT09ICcnKSB7XG4gICAgY29uc3QgbGV2ZWxJbmRleCA9IGxldmVscy5pbmRleE9mKGxldmVsKSxcbiAgICAgICAgICBsb2dMZXZlbEluZGV4ID0gbGV2ZWxzLmluZGV4T2YobG9nTGV2ZWwpO1xuXG4gICAgaWYgKGxldmVsSW5kZXggPCBsb2dMZXZlbEluZGV4KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcGVydGluZW50U3RhY2tNZXNzYWdlSW5kZXggKz0gMTtcblxuICAgIGxldmVsID0gYCR7bGV2ZWx9IGA7ICAvLy9cbiAgfVxuXG4gIGxldCBlcnJvcixcbiAgICAgIG1lc3NhZ2U7XG5cbiAgaWYgKG1lc3NhZ2VPckVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICBlcnJvciA9IG1lc3NhZ2VPckVycm9yOyAvLy9cblxuICAgICh7IG1lc3NhZ2UgfSA9IGVycm9yKTtcbiAgfSBlbHNlIHtcbiAgICBtZXNzYWdlID0gbWVzc2FnZU9yRXJyb3I7IC8vL1xuXG4gICAgZXJyb3IgPSBuZXcgRXJyb3IobWVzc2FnZSk7XG4gIH1cblxuICBjb25zdCB7IHN0YWNrIH0gPSBlcnJvcixcbiAgICAgICAgc3RhY2tNZXNzYWdlcyA9IHN0YWNrTWVzc2FnZXNGcm9tU3RhY2soc3RhY2spLFxuICAgICAgICBwZXJ0aW5lbnRTdGFja01lc3NhZ2UgPSBzdGFja01lc3NhZ2VzW3BlcnRpbmVudFN0YWNrTWVzc2FnZUluZGV4XSxcbiAgICAgICAgc3RhY2tNZXNzYWdlID0gcGVydGluZW50U3RhY2tNZXNzYWdlLCAvLy9cbiAgICAgICAgY3VycmVudERhdGVBbmRUaW1lU3RyaW5nID0gZ2V0Q3VycmVudERhdGVBbmRUaW1lU3RyaW5nKCksXG4gICAgICAgIGZpbGVQYXRoID0gZmlsZVBhdGhGcm9tU3RhY2tNZXNzYWdlKHN0YWNrTWVzc2FnZSksXG4gICAgICAgIGxpbmVOdW1iZXIgPSBsaW5lTnVtYmVyRnJvbVN0YWNrTWVzc2FnZShzdGFja01lc3NhZ2UpLFxuICAgICAgICBsb2dNZXNzYWdlID0gYCR7bGV2ZWx9JHtjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmd9ICR7ZmlsZVBhdGh9KCR7bGluZU51bWJlcn0pICR7bWVzc2FnZX1gO1xuXG4gIGNvbnNvbGUubG9nKGxvZ01lc3NhZ2UpO1xuXG4gIGlmIChsb2dEaXJlY3RvcnlQYXRoICE9PSBudWxsKSB7XG4gICAgcm9sbE92ZXJMb2dGaWxlKCk7XG5cbiAgICBjb25zdCBsb2dGaWxlUGF0aCA9IGdldExvZ0ZpbGVQYXRoKCksXG4gICAgICAgICAgbG9nRmlsZUNvbnRlbnQgPSBgJHtsb2dNZXNzYWdlfVxcbmA7XG5cbiAgICBhcHBlbmRUb0ZpbGUobG9nRmlsZVBhdGgsIGxvZ0ZpbGVDb250ZW50KTtcbiAgfVxuXG4gIHJldHVybiBsb2dNZXNzYWdlO1xufVxuXG5mdW5jdGlvbiB0cmFjZShtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgVFJBQ0UpOyB9XG5cbmZ1bmN0aW9uIGRlYnVnKG1lc3NhZ2UpIHsgcmV0dXJuIGxvZyhtZXNzYWdlLCBERUJVRyk7IH1cblxuZnVuY3Rpb24gaW5mbyhtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgSU5GTyk7IH1cblxuZnVuY3Rpb24gd2FybmluZyhtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgV0FSTklORyk7IH1cblxuZnVuY3Rpb24gZXJyb3IobWVzc2FnZSkgeyByZXR1cm4gbG9nKG1lc3NhZ2UsIEVSUk9SKTsgfVxuXG5mdW5jdGlvbiBmYXRhbChtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgRkFUQUwpOyB9XG5cbmZ1bmN0aW9uIHNldExvZ0xldmVsKGxldmVsKSB7IGxvZ0xldmVsID0gbGV2ZWw7IH1cblxuZnVuY3Rpb24gc2V0TG9nRmlsZUJhc2VOYW1lKGZpbGVCYXNlTmFtZSkgeyBsb2dGaWxlQmFzZU5hbWUgPSBmaWxlQmFzZU5hbWU7IH1cblxuZnVuY3Rpb24gc2V0TG9nRGlyZWN0b3J5UGF0aChkaXJlY3RvcnlQYXRoKSB7IGxvZ0RpcmVjdG9yeVBhdGggPSBkaXJlY3RvcnlQYXRoOyB9XG5cbmZ1bmN0aW9uIHNldExvZ09wdGlvbnMobG9nT3B0aW9ucykge1xuICBjb25zdCB7IGxldmVsLCBmaWxlQmFzZU5hbWUsIGRpcmVjdG9yeVBhdGggfSA9IGxvZ09wdGlvbnM7XG5cbiAgc2V0TG9nTGV2ZWwobGV2ZWwpO1xuXG4gIHNldExvZ0ZpbGVCYXNlTmFtZShmaWxlQmFzZU5hbWUpO1xuXG4gIHNldExvZ0RpcmVjdG9yeVBhdGgoZGlyZWN0b3J5UGF0aCk7XG59XG5cbmZ1bmN0aW9uIGdldExvZ0ZpbGVDb250ZW50KCkge1xuICBjb25zdCBsb2dGaWxlUGF0aCA9IGdldExvZ0ZpbGVQYXRoKCksXG4gICAgICAgIGxvZ0ZpbGVDb250ZW50ID0gcmVhZEZpbGUobG9nRmlsZVBhdGgpO1xuXG4gIHJldHVybiBsb2dGaWxlQ29udGVudDtcbn1cblxuT2JqZWN0LmFzc2lnbihsb2csIHtcbiAgVFJBQ0UsXG4gIERFQlVHLFxuICBJTkZPLFxuICBXQVJOSU5HLFxuICBFUlJPUixcbiAgRkFUQUwsXG4gIHRyYWNlLFxuICBkZWJ1ZyxcbiAgaW5mbyxcbiAgd2FybmluZyxcbiAgZXJyb3IsXG4gIGZhdGFsLFxuICBzZXRMb2dMZXZlbCxcbiAgc2V0TG9nRmlsZUJhc2VOYW1lLFxuICBzZXRMb2dEaXJlY3RvcnlQYXRoLFxuICBzZXRMb2dPcHRpb25zLFxuICBnZXRMb2dGaWxlQ29udGVudFxufSk7XG5cbmZ1bmN0aW9uIGdldExvZ0ZpbGVQYXRoKCkge1xuICBjb25zdCBsb2dGaWxlTmFtZSA9IGAke2xvZ0ZpbGVCYXNlTmFtZX0ubG9nYCxcbiAgICAgICAgbG9nRmlsZVBhdGggPSBjb25jYXRlbmF0ZVBhdGhzKGxvZ0RpcmVjdG9yeVBhdGgsIGxvZ0ZpbGVOYW1lKTtcblxuICByZXR1cm4gbG9nRmlsZVBhdGg7XG59XG5cbmZ1bmN0aW9uIGdldFJvbGxlZE92ZXJMb2dGaWxlUGF0aCgpIHtcbiAgY29uc3QgY3VycmVudERhdGVTdHJpbmcgPSBnZXRDdXJyZW50RGF0ZVN0cmluZygpLFxuICAgICAgICByb2xsZWRPdmVyTG9nRmlsZU5hbWUgPSBgJHtsb2dGaWxlQmFzZU5hbWV9LiR7Y3VycmVudERhdGVTdHJpbmd9LmxvZ2AsXG4gICAgICAgIHJvbGxlZE92ZXJMb2dGaWxlUGF0aCA9IGNvbmNhdGVuYXRlUGF0aHMobG9nRGlyZWN0b3J5UGF0aCwgcm9sbGVkT3ZlckxvZ0ZpbGVOYW1lKTtcblxuICByZXR1cm4gcm9sbGVkT3ZlckxvZ0ZpbGVQYXRoO1xufVxuXG5mdW5jdGlvbiBnZXRMb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSgpIHtcbiAgY29uc3QgbG9nRmlsZVBhdGggPSBnZXRMb2dGaWxlUGF0aCgpLFxuICAgICAgICBsb2dGaWxlU3RhdHMgPSBnZXRTdGF0cyhsb2dGaWxlUGF0aCksXG4gICAgICAgIHsgbXRpbWUgfSA9IGxvZ0ZpbGVTdGF0cyxcbiAgICAgICAgbG9nRmlsZUxhc3RNb2RpZmllZERhdGUgPSBuZXcgRGF0ZShtdGltZSk7ICAvLy9cblxuICByZXR1cm4gbG9nRmlsZUxhc3RNb2RpZmllZERhdGU7XG59XG5cbmZ1bmN0aW9uIHJvbGxPdmVyTG9nRmlsZSgpIHtcbiAgY29uc3QgbG9nRmlsZVBhdGggPSBnZXRMb2dGaWxlUGF0aCgpLFxuICAgICAgICBsb2dGaWxlRXhpc3RzID0gY2hlY2tGaWxlRXhpc3RzKGxvZ0ZpbGVQYXRoKTtcblxuICBpZiAoIWxvZ0ZpbGVFeGlzdHMpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSA9IGdldExvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlKCksXG4gICAgICAgIGxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlQ3VycmVudERhdGUgPSBpc0RhdGVDdXJyZW50RGF0ZShsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSk7XG5cbiAgaWYgKCFsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZUN1cnJlbnREYXRlKSB7XG4gICAgY29uc3Qgcm9sbGVkT3ZlckxvZ0ZpbGVQYXRoID0gZ2V0Um9sbGVkT3ZlckxvZ0ZpbGVQYXRoKCk7XG5cbiAgICByZW5hbWVGaWxlKGxvZ0ZpbGVQYXRoLCByb2xsZWRPdmVyTG9nRmlsZVBhdGgpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzRGF0ZUN1cnJlbnREYXRlKGRhdGUpIHtcbiAgY29uc3QgY3VycmVudERhdGUgPSBuZXcgRGF0ZSgpLFxuICAgICAgICBkYXRlU3RyaW5nID0gZGF0ZS50b0RhdGVTdHJpbmcoKSxcbiAgICAgICAgY3VycmVudERhdGVTdHJpbmcgPSBjdXJyZW50RGF0ZS50b0RhdGVTdHJpbmcoKSxcbiAgICAgICAgZGF0ZUN1cnJlbnREYXRlID0gKGRhdGVTdHJpbmcgPT09IGN1cnJlbnREYXRlU3RyaW5nKTtcblxuICByZXR1cm4gZGF0ZUN1cnJlbnREYXRlO1xufVxuXG5mdW5jdGlvbiBnZXRDdXJyZW50RGF0ZVN0cmluZygpIHtcbiAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCksXG4gICAgICAgIGRheSA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldERhdGUoKSwgMiksICAvLy9cbiAgICAgICAgbW9udGggPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRNb250aCgpICsgMSwgMiksIC8vL1xuICAgICAgICB5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpLFxuICAgICAgICBjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmcgPSBgJHtkYXl9LSR7bW9udGh9LSR7eWVhcn1gO1xuXG4gIHJldHVybiBjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmc7XG59XG5cbmZ1bmN0aW9uIGdldEN1cnJlbnREYXRlQW5kVGltZVN0cmluZygpIHtcbiAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCksXG4gICAgICAgIGRheSA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldERhdGUoKSwgMiksICAvLy9cbiAgICAgICAgbW9udGggPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRNb250aCgpICsgMSwgMiksIC8vL1xuICAgICAgICB5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpLFxuICAgICAgICBob3VycyA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldEhvdXJzKCksIDIpLFxuICAgICAgICBtaW51dGVzID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0TWludXRlcygpLCAyKSxcbiAgICAgICAgc2Vjb25kcyA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldFNlY29uZHMoKSwgMiksXG4gICAgICAgIG1pbGxpc2Vjb25kcyA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldE1pbGxpc2Vjb25kcygpLCAzKSxcbiAgICAgICAgY3VycmVudERhdGVBbmRUaW1lU3RyaW5nID0gYCR7ZGF5fS0ke21vbnRofS0ke3llYXJ9ICR7aG91cnN9OiR7bWludXRlc306JHtzZWNvbmRzfS4ke21pbGxpc2Vjb25kc31gO1xuXG4gIHJldHVybiBjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmc7XG59XG5cbmZ1bmN0aW9uIHN0YWNrTWVzc2FnZXNGcm9tU3RhY2soc3RhY2spIHtcbiAgY29uc3Qgc3RhY2tNZXNzYWdlcyA9IFtdLFxuICAgICAgICBzdGFja0xpbmVzID0gc3RhY2suc3BsaXQoL1xcclxcbnxcXG4vKTtcblxuICBsZXQgc3RhY2tNZXNzYWdlID0gXCJcIjtcblxuICBzdGFja0xpbmVzLmZvckVhY2goKHN0YWNrTGluZSkgPT4ge1xuICAgIGNvbnN0IG1hdGNoZXMgPSAvXlxccyphdC4qLy50ZXN0KHN0YWNrTGluZSk7XG5cbiAgICBzdGFja01lc3NhZ2UgPSAoc3RhY2tNZXNzYWdlID09PSBcIlwiKSA/XG4gICAgICAgICAgICAgICAgICAgICAgc3RhY2tMaW5lIDpcbiAgICAgICAgICAgICAgICAgICAgICAgIGAke3N0YWNrTWVzc2FnZX1cXG4ke3N0YWNrTGluZX1gO1xuXG4gICAgaWYgKG1hdGNoZXMpIHtcbiAgICAgIHN0YWNrTWVzc2FnZXMucHVzaChzdGFja01lc3NhZ2UpO1xuXG4gICAgICBzdGFja01lc3NhZ2UgPSBcIlwiO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHN0YWNrTWVzc2FnZXM7XG59XG5cbmZ1bmN0aW9uIGZpbGVQYXRoRnJvbVN0YWNrTWVzc2FnZShzdGFja01lc3NhZ2UpIHtcbiAgY29uc3QgbWF0Y2hlcyA9IHN0YWNrTWVzc2FnZS5tYXRjaCgvKFxcLy4rKTpcXGQrOlxcZCsvbSksXG4gICAgICAgIHNlY29uZE1hdGNoID0gc2Vjb25kKG1hdGNoZXMpLFxuICAgICAgICBhYnNvbHV0ZUZpbGVQYXRoID0gc2Vjb25kTWF0Y2gsICAvLy9cbiAgICAgICAgY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoID0gcGF0aC5yZXNvbHZlKCcuJyksICAvLy9cbiAgICAgICAgY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoTGVuZ3RoID0gY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoLmxlbmd0aCxcbiAgICAgICAgc3RhcnQgPSBjdXJyZW50V29ya2luZ0RpcmVjdG9yeVBhdGhMZW5ndGggKyAxLCAgLy8vXG4gICAgICAgIGZpbGVQYXRoID0gYWJzb2x1dGVGaWxlUGF0aC5zdWJzdHIoc3RhcnQpO1xuXG4gIHJldHVybiBmaWxlUGF0aDtcbn1cblxuZnVuY3Rpb24gbGluZU51bWJlckZyb21TdGFja01lc3NhZ2Uoc3RhY2tNZXNzYWdlKSB7XG4gIGNvbnN0IG1hdGNoZXMgPSBzdGFja01lc3NhZ2UubWF0Y2goLzooXFxkKykvbSksXG4gICAgICAgIHNlY29uZE1hdGNoID0gc2Vjb25kKG1hdGNoZXMpLFxuICAgICAgICBsaW5lTnVtYmVyID0gc2Vjb25kTWF0Y2g7IC8vL1xuXG4gIHJldHVybiBsaW5lTnVtYmVyO1xufVxuXG5mdW5jdGlvbiBwYWRTdGFydFdpdGhaZXJvZXMoc3RyaW5nLCB0YXJnZXRMZW5ndGgpIHtcbiAgY29uc3QgcGFkU3RyaW5nID0gJzAnLFxuICAgICAgICBwYWRkZWRTdHJpbmcgPSBwYWRTdGFydChzdHJpbmcsIHRhcmdldExlbmd0aCwgcGFkU3RyaW5nKTtcblxuICByZXR1cm4gcGFkZGVkU3RyaW5nO1xufVxuXG5mdW5jdGlvbiBwYWRTdGFydChzdHJpbmcsIHRhcmdldExlbmd0aCwgcGFkU3RyaW5nKSB7XG4gIGxldCBwYWRkaW5nID0gJyc7XG5cbiAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHRhcmdldExlbmd0aDsgaW5kZXgrKykge1xuICAgIHBhZGRpbmcgKz0gcGFkU3RyaW5nO1xuICB9XG5cbiAgY29uc3QgcGFkZGVkU3RyaW5nID0gYCR7cGFkZGluZ30ke3N0cmluZ31gLnN1YnN0cigtdGFyZ2V0TGVuZ3RoKTtcblxuICByZXR1cm4gcGFkZGVkU3RyaW5nO1xufVxuIl19