"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.log = log;

var _path = _interopRequireDefault(require("path"));

var _array = require("../../utilities/array");

var _path2 = require("../../utilities/path");

var _fileSystem = require("../../utilities/fileSystem");

var _constants = require("../../constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var levels = [_constants.TRACE, _constants.DEBUG, _constants.INFO, _constants.WARNING, _constants.ERROR, _constants.FATAL];
var logLevel = _constants.DEFAULT_LOG_LEVEL,
    logFileBaseName = _constants.DEFAULT_LOG_FILE_BASE_NAME,
    logDirectoryPath = _constants.DEFAULT_LOG_DIRECTORY_PATH;

function log(messageOrError) {
  var level = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : "";
  var salientStackMessageIndex = 1;

  if (level !== "") {
    var levelIndex = levels.indexOf(level),
        logLevelIndex = levels.indexOf(logLevel);

    if (levelIndex < logLevelIndex) {
      return;
    }

    salientStackMessageIndex += 1;
    level = "".concat(level, " "); ///
  }

  var error, message;

  if (messageOrError instanceof Error) {
    error = messageOrError; ///

    var _error = error;
    message = _error.message;
  } else {
    message = messageOrError; ///

    error = new Error(message);
  }

  var _error2 = error,
      stack = _error2.stack,
      stackMessages = stackMessagesFromStack(stack),
      pertinentStackMessage = stackMessages[salientStackMessageIndex],
      stackMessage = pertinentStackMessage,
      currentDateAndTimeString = getCurrentDateAndTimeString(),
      filePath = filePathFromStackMessage(stackMessage),
      lineNumber = lineNumberFromStackMessage(stackMessage),
      logMessage = "".concat(level).concat(currentDateAndTimeString, " ").concat(filePath, "(").concat(lineNumber, ") ").concat(message);
  console.log(logMessage);

  if (logDirectoryPath !== null) {
    rollOverLogFile();
    var logFilePath = getLogFilePath(),
        logFileContent = "".concat(logMessage, "\n");
    (0, _fileSystem.appendToFile)(logFilePath, logFileContent);
  }

  return logMessage;
}

function trace(message) {
  return log(message, _constants.TRACE);
}

function debug(message) {
  return log(message, _constants.DEBUG);
}

function info(message) {
  return log(message, _constants.INFO);
}

function warning(message) {
  return log(message, _constants.WARNING);
}

function error(message) {
  return log(message, _constants.ERROR);
}

function fatal(message) {
  return log(message, _constants.FATAL);
}

function setLogLevel(level) {
  logLevel = level;
}

function setLogFileBaseName(fileBaseName) {
  logFileBaseName = fileBaseName;
}

function setLogDirectoryPath(directoryPath) {
  logDirectoryPath = directoryPath;
}

function setLogOptions(logOptions) {
  var level = logOptions.level,
      fileBaseName = logOptions.fileBaseName,
      directoryPath = logOptions.directoryPath;
  setLogLevel(level);
  setLogFileBaseName(fileBaseName);
  setLogDirectoryPath(directoryPath);
}

function getLogFileContent() {
  var logFilePath = getLogFilePath(),
      logFileContent = (0, _fileSystem.readFile)(logFilePath);
  return logFileContent;
}

Object.assign(log, {
  TRACE: _constants.TRACE,
  DEBUG: _constants.DEBUG,
  INFO: _constants.INFO,
  WARNING: _constants.WARNING,
  ERROR: _constants.ERROR,
  FATAL: _constants.FATAL,
  trace: trace,
  debug: debug,
  info: info,
  warning: warning,
  error: error,
  fatal: fatal,
  setLogLevel: setLogLevel,
  setLogFileBaseName: setLogFileBaseName,
  setLogDirectoryPath: setLogDirectoryPath,
  setLogOptions: setLogOptions,
  getLogFileContent: getLogFileContent
});

function getLogFilePath() {
  var logFileName = "".concat(logFileBaseName, ".log"),
      logFilePath = (0, _path2.concatenatePaths)(logDirectoryPath, logFileName);
  return logFilePath;
}

function getRolledOverLogFilePath() {
  var currentDateString = getCurrentDateString(),
      rolledOverLogFileName = "".concat(logFileBaseName, ".").concat(currentDateString, ".log"),
      rolledOverLogFilePath = (0, _path2.concatenatePaths)(logDirectoryPath, rolledOverLogFileName);
  return rolledOverLogFilePath;
}

function getLogFileLastModifiedDate() {
  var logFilePath = getLogFilePath(),
      logFileStats = (0, _fileSystem.getStats)(logFilePath),
      mtime = logFileStats.mtime,
      logFileLastModifiedDate = new Date(mtime); ///

  return logFileLastModifiedDate;
}

function rollOverLogFile() {
  var logFilePath = getLogFilePath(),
      logFileExists = (0, _fileSystem.checkFileExists)(logFilePath);

  if (!logFileExists) {
    return;
  }

  var logFileLastModifiedDate = getLogFileLastModifiedDate(),
      logFileLastModifiedDateCurrentDate = isDateCurrentDate(logFileLastModifiedDate);

  if (!logFileLastModifiedDateCurrentDate) {
    var rolledOverLogFilePath = getRolledOverLogFilePath();
    (0, _fileSystem.renameFile)(logFilePath, rolledOverLogFilePath);
  }
}

function isDateCurrentDate(date) {
  var currentDate = new Date(),
      dateString = date.toDateString(),
      currentDateString = currentDate.toDateString(),
      dateCurrentDate = dateString === currentDateString;
  return dateCurrentDate;
}

function getCurrentDateString() {
  var date = new Date(),
      day = padStartWithZeroes(date.getDate(), 2),
      ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
      ///
  year = date.getFullYear(),
      currentDateAndTimeString = "".concat(day, "-").concat(month, "-").concat(year);
  return currentDateAndTimeString;
}

function getCurrentDateAndTimeString() {
  var date = new Date(),
      day = padStartWithZeroes(date.getDate(), 2),
      ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
      ///
  year = date.getFullYear(),
      hours = padStartWithZeroes(date.getHours(), 2),
      minutes = padStartWithZeroes(date.getMinutes(), 2),
      seconds = padStartWithZeroes(date.getSeconds(), 2),
      milliseconds = padStartWithZeroes(date.getMilliseconds(), 3),
      currentDateAndTimeString = "".concat(day, "-").concat(month, "-").concat(year, " ").concat(hours, ":").concat(minutes, ":").concat(seconds, ".").concat(milliseconds);
  return currentDateAndTimeString;
}

function stackMessagesFromStack(stack) {
  var stackMessages = [],
      stackLines = stack.split(/\r\n|\n/);
  var stackMessage = "";
  stackLines.forEach(function (stackLine) {
    var matches = /^\s*at.*/.test(stackLine);
    stackMessage = stackMessage === "" ? stackLine : "".concat(stackMessage, "\n").concat(stackLine);

    if (matches) {
      stackMessages.push(stackMessage);
      stackMessage = "";
    }
  });
  return stackMessages;
}

function filePathFromStackMessage(stackMessage) {
  var matches = stackMessage.match(/(\/.+):\d+:\d+/m),
      secondMatch = (0, _array.second)(matches),
      absoluteFilePath = secondMatch,
      ///
  currentWorkingDirectoryPath = _path["default"].resolve("."),
      ///
  currentWorkingDirectoryPathLength = currentWorkingDirectoryPath.length,
      start = currentWorkingDirectoryPathLength + 1,
      ///
  filePath = absoluteFilePath.substr(start);

  return filePath;
}

function lineNumberFromStackMessage(stackMessage) {
  var matches = stackMessage.match(/:(\d+)/m),
      secondMatch = (0, _array.second)(matches),
      lineNumber = secondMatch; ///

  return lineNumber;
}

function padStartWithZeroes(string, targetLength) {
  var padString = "0",
      paddedString = padStart(string, targetLength, padString);
  return paddedString;
}

function padStart(string, targetLength, padString) {
  var padding = "";

  for (var index = 0; index < targetLength; index++) {
    padding += padString;
  }

  var paddedString = "".concat(padding).concat(string).substr(-targetLength);
  return paddedString;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxvZy5qcyJdLCJuYW1lcyI6WyJsZXZlbHMiLCJUUkFDRSIsIkRFQlVHIiwiSU5GTyIsIldBUk5JTkciLCJFUlJPUiIsIkZBVEFMIiwibG9nTGV2ZWwiLCJERUZBVUxUX0xPR19MRVZFTCIsImxvZ0ZpbGVCYXNlTmFtZSIsIkRFRkFVTFRfTE9HX0ZJTEVfQkFTRV9OQU1FIiwibG9nRGlyZWN0b3J5UGF0aCIsIkRFRkFVTFRfTE9HX0RJUkVDVE9SWV9QQVRIIiwibG9nIiwibWVzc2FnZU9yRXJyb3IiLCJsZXZlbCIsInNhbGllbnRTdGFja01lc3NhZ2VJbmRleCIsImxldmVsSW5kZXgiLCJpbmRleE9mIiwibG9nTGV2ZWxJbmRleCIsImVycm9yIiwibWVzc2FnZSIsIkVycm9yIiwic3RhY2siLCJzdGFja01lc3NhZ2VzIiwic3RhY2tNZXNzYWdlc0Zyb21TdGFjayIsInBlcnRpbmVudFN0YWNrTWVzc2FnZSIsInN0YWNrTWVzc2FnZSIsImN1cnJlbnREYXRlQW5kVGltZVN0cmluZyIsImdldEN1cnJlbnREYXRlQW5kVGltZVN0cmluZyIsImZpbGVQYXRoIiwiZmlsZVBhdGhGcm9tU3RhY2tNZXNzYWdlIiwibGluZU51bWJlciIsImxpbmVOdW1iZXJGcm9tU3RhY2tNZXNzYWdlIiwibG9nTWVzc2FnZSIsImNvbnNvbGUiLCJyb2xsT3ZlckxvZ0ZpbGUiLCJsb2dGaWxlUGF0aCIsImdldExvZ0ZpbGVQYXRoIiwibG9nRmlsZUNvbnRlbnQiLCJ0cmFjZSIsImRlYnVnIiwiaW5mbyIsIndhcm5pbmciLCJmYXRhbCIsInNldExvZ0xldmVsIiwic2V0TG9nRmlsZUJhc2VOYW1lIiwiZmlsZUJhc2VOYW1lIiwic2V0TG9nRGlyZWN0b3J5UGF0aCIsImRpcmVjdG9yeVBhdGgiLCJzZXRMb2dPcHRpb25zIiwibG9nT3B0aW9ucyIsImdldExvZ0ZpbGVDb250ZW50IiwiT2JqZWN0IiwiYXNzaWduIiwibG9nRmlsZU5hbWUiLCJnZXRSb2xsZWRPdmVyTG9nRmlsZVBhdGgiLCJjdXJyZW50RGF0ZVN0cmluZyIsImdldEN1cnJlbnREYXRlU3RyaW5nIiwicm9sbGVkT3ZlckxvZ0ZpbGVOYW1lIiwicm9sbGVkT3ZlckxvZ0ZpbGVQYXRoIiwiZ2V0TG9nRmlsZUxhc3RNb2RpZmllZERhdGUiLCJsb2dGaWxlU3RhdHMiLCJtdGltZSIsImxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlIiwiRGF0ZSIsImxvZ0ZpbGVFeGlzdHMiLCJsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZUN1cnJlbnREYXRlIiwiaXNEYXRlQ3VycmVudERhdGUiLCJkYXRlIiwiY3VycmVudERhdGUiLCJkYXRlU3RyaW5nIiwidG9EYXRlU3RyaW5nIiwiZGF0ZUN1cnJlbnREYXRlIiwiZGF5IiwicGFkU3RhcnRXaXRoWmVyb2VzIiwiZ2V0RGF0ZSIsIm1vbnRoIiwiZ2V0TW9udGgiLCJ5ZWFyIiwiZ2V0RnVsbFllYXIiLCJob3VycyIsImdldEhvdXJzIiwibWludXRlcyIsImdldE1pbnV0ZXMiLCJzZWNvbmRzIiwiZ2V0U2Vjb25kcyIsIm1pbGxpc2Vjb25kcyIsImdldE1pbGxpc2Vjb25kcyIsInN0YWNrTGluZXMiLCJzcGxpdCIsImZvckVhY2giLCJzdGFja0xpbmUiLCJtYXRjaGVzIiwidGVzdCIsInB1c2giLCJtYXRjaCIsInNlY29uZE1hdGNoIiwiYWJzb2x1dGVGaWxlUGF0aCIsImN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aCIsInBhdGgiLCJyZXNvbHZlIiwiY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoTGVuZ3RoIiwibGVuZ3RoIiwic3RhcnQiLCJzdWJzdHIiLCJzdHJpbmciLCJ0YXJnZXRMZW5ndGgiLCJwYWRTdHJpbmciLCJwYWRkZWRTdHJpbmciLCJwYWRTdGFydCIsInBhZGRpbmciLCJpbmRleCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7QUFFQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLElBQU1BLE1BQU0sR0FBRyxDQUNiQyxnQkFEYSxFQUViQyxnQkFGYSxFQUdiQyxlQUhh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QUFNa0UsT0FBTyxHQUFHbEUsWUFBWSxDQUFDcUUsS0FBYixDQUFtQixTQUFuQixDQUFoQjtBQUFBLE1BQ01DLFdBQVcsR0FBRyxtQkFBT0osT0FBUCxDQURwQjtBQUFBLE1BRU03RCxVQUFVLEdBQUdpRSxXQUZuQixDQURnRCxDQUdoQjs7QUFFaEMsU0FBT2pFLFVBQVA7QUFDRDs7QUFFRCxTQUFTMkMsa0JBQVQsQ0FBNEIrQixNQUE1QixFQUFvQ0MsWUFBcEMsRUFBa0Q7QUFDaEQsTUFBTUMsU0FBUyxHQUFHLEdBQWxCO0FBQUEsTUFDTUMsWUFBWSxHQUFHQyxRQUFRLENBQUNKLE1BQUQsRUFBU0MsWUFBVCxFQUF1QkMsU0FBdkIsQ0FEN0I7QUFHQSxTQUFPQyxZQUFQO0FBQ0Q7O0FBRUQsU0FBU0MsUUFBVCxDQUFrQkosTUFBbEIsRUFBMEJDLFlBQTFCLEVBQXdDQyxTQUF4QyxFQUFtRDtBQUNqRCxNQUFJRyxPQUFPLEdBQUcsRUFBZDs7QUFFQSxPQUFLLElBQUlDLEtBQUssR0FBRyxDQUFqQixFQUFvQkEsS0FBSyxHQUFHTCxZQUE1QixFQUEwQ0ssS0FBSyxFQUEvQyxFQUFtRDtBQUNqREQsSUFBQUEsT0FBTyxJQUFJSCxTQUFYO0FBQ0Q7O0FBRUQsTUFBTUMsWUFBWSxHQUFHLFVBQUdFLE9BQUgsU0FBYUwsTUFBYixFQUFzQkQsTUFBdEIsQ0FBNkIsQ0FBQ0UsWUFBOUIsQ0FBckI7QUFFQSxTQUFPRSxZQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIjtcblxuaW1wb3J0IHsgc2Vjb25kIH0gZnJvbSBcIi4uLy4uL3V0aWxpdGllcy9hcnJheVwiO1xuaW1wb3J0IHsgY29uY2F0ZW5hdGVQYXRocyB9IGZyb20gXCIuLi8uLi91dGlsaXRpZXMvcGF0aFwiO1xuaW1wb3J0IHsgY2hlY2tGaWxlRXhpc3RzLCByZWFkRmlsZSwgYXBwZW5kVG9GaWxlLCByZW5hbWVGaWxlLCBnZXRTdGF0cyB9IGZyb20gXCIuLi8uLi91dGlsaXRpZXMvZmlsZVN5c3RlbVwiO1xuaW1wb3J0IHsgVFJBQ0UsIERFQlVHLCBJTkZPLCBXQVJOSU5HLCBFUlJPUiwgRkFUQUwsIERFRkFVTFRfTE9HX0xFVkVMLCBERUZBVUxUX0xPR19GSUxFX0JBU0VfTkFNRSwgREVGQVVMVF9MT0dfRElSRUNUT1JZX1BBVEggfSBmcm9tIFwiLi4vLi4vY29uc3RhbnRzXCI7XG5cbmNvbnN0IGxldmVscyA9IFtcbiAgVFJBQ0UsXG4gIERFQlVHLFxuICBJTkZPLFxuICBXQVJOSU5HLFxuICBFUlJPUixcbiAgRkFUQUwsXG5dO1xuXG5sZXQgbG9nTGV2ZWwgPSBERUZBVUxUX0xPR19MRVZFTCxcbiAgICBsb2dGaWxlQmFzZU5hbWUgPSBERUZBVUxUX0xPR19GSUxFX0JBU0VfTkFNRSxcbiAgICBsb2dEaXJlY3RvcnlQYXRoID0gREVGQVVMVF9MT0dfRElSRUNUT1JZX1BBVEg7XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2cobWVzc2FnZU9yRXJyb3IsIGxldmVsID0gXCJcIikge1xuICBsZXQgc2FsaWVudFN0YWNrTWVzc2FnZUluZGV4ID0gMTtcblxuICBpZiAobGV2ZWwgIT09IFwiXCIpIHtcbiAgICBjb25zdCBsZXZlbEluZGV4ID0gbGV2ZWxzLmluZGV4T2YobGV2ZWwpLFxuICAgICAgICAgIGxvZ0xldmVsSW5kZXggPSBsZXZlbHMuaW5kZXhPZihsb2dMZXZlbCk7XG5cbiAgICBpZiAobGV2ZWxJbmRleCA8IGxvZ0xldmVsSW5kZXgpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBzYWxpZW50U3RhY2tNZXNzYWdlSW5kZXggKz0gMTtcblxuICAgIGxldmVsID0gYCR7bGV2ZWx9IGA7ICAvLy9cbiAgfVxuXG4gIGxldCBlcnJvcixcbiAgICAgIG1lc3NhZ2U7XG5cbiAgaWYgKG1lc3NhZ2VPckVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICBlcnJvciA9IG1lc3NhZ2VPckVycm9yOyAvLy9cblxuICAgICh7IG1lc3NhZ2UgfSA9IGVycm9yKTtcbiAgfSBlbHNlIHtcbiAgICBtZXNzYWdlID0gbWVzc2FnZU9yRXJyb3I7IC8vL1xuXG4gICAgZXJyb3IgPSBuZXcgRXJyb3IobWVzc2FnZSk7XG4gIH1cblxuICBjb25zdCB7IHN0YWNrIH0gPSBlcnJvcixcbiAgICAgICAgc3RhY2tNZXNzYWdlcyA9IHN0YWNrTWVzc2FnZXNGcm9tU3RhY2soc3RhY2spLFxuICAgICAgICBwZXJ0aW5lbnRTdGFja01lc3NhZ2UgPSBzdGFja01lc3NhZ2VzW3NhbGllbnRTdGFja01lc3NhZ2VJbmRleF0sXG4gICAgICAgIHN0YWNrTWVzc2FnZSA9IHBlcnRpbmVudFN0YWNrTWVzc2FnZSwgLy8vXG4gICAgICAgIGN1cnJlbnREYXRlQW5kVGltZVN0cmluZyA9IGdldEN1cnJlbnREYXRlQW5kVGltZVN0cmluZygpLFxuICAgICAgICBmaWxlUGF0aCA9IGZpbGVQYXRoRnJvbVN0YWNrTWVzc2FnZShzdGFja01lc3NhZ2UpLFxuICAgICAgICBsaW5lTnVtYmVyID0gbGluZU51bWJlckZyb21TdGFja01lc3NhZ2Uoc3RhY2tNZXNzYWdlKSxcbiAgICAgICAgbG9nTWVzc2FnZSA9IGAke2xldmVsfSR7Y3VycmVudERhdGVBbmRUaW1lU3RyaW5nfSAke2ZpbGVQYXRofSgke2xpbmVOdW1iZXJ9KSAke21lc3NhZ2V9YDtcblxuICBjb25zb2xlLmxvZyhsb2dNZXNzYWdlKTtcblxuICBpZiAobG9nRGlyZWN0b3J5UGF0aCAhPT0gbnVsbCkge1xuICAgIHJvbGxPdmVyTG9nRmlsZSgpO1xuXG4gICAgY29uc3QgbG9nRmlsZVBhdGggPSBnZXRMb2dGaWxlUGF0aCgpLFxuICAgICAgICAgIGxvZ0ZpbGVDb250ZW50ID0gYCR7bG9nTWVzc2FnZX1cXG5gO1xuXG4gICAgYXBwZW5kVG9GaWxlKGxvZ0ZpbGVQYXRoLCBsb2dGaWxlQ29udGVudCk7XG4gIH1cblxuICByZXR1cm4gbG9nTWVzc2FnZTtcbn1cblxuZnVuY3Rpb24gdHJhY2UobWVzc2FnZSkgeyByZXR1cm4gbG9nKG1lc3NhZ2UsIFRSQUNFKTsgfVxuXG5mdW5jdGlvbiBkZWJ1ZyhtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgREVCVUcpOyB9XG5cbmZ1bmN0aW9uIGluZm8obWVzc2FnZSkgeyByZXR1cm4gbG9nKG1lc3NhZ2UsIElORk8pOyB9XG5cbmZ1bmN0aW9uIHdhcm5pbmcobWVzc2FnZSkgeyByZXR1cm4gbG9nKG1lc3NhZ2UsIFdBUk5JTkcpOyB9XG5cbmZ1bmN0aW9uIGVycm9yKG1lc3NhZ2UpIHsgcmV0dXJuIGxvZyhtZXNzYWdlLCBFUlJPUik7IH1cblxuZnVuY3Rpb24gZmF0YWwobWVzc2FnZSkgeyByZXR1cm4gbG9nKG1lc3NhZ2UsIEZBVEFMKTsgfVxuXG5mdW5jdGlvbiBzZXRMb2dMZXZlbChsZXZlbCkgeyBsb2dMZXZlbCA9IGxldmVsOyB9XG5cbmZ1bmN0aW9uIHNldExvZ0ZpbGVCYXNlTmFtZShmaWxlQmFzZU5hbWUpIHsgbG9nRmlsZUJhc2VOYW1lID0gZmlsZUJhc2VOYW1lOyB9XG5cbmZ1bmN0aW9uIHNldExvZ0RpcmVjdG9yeVBhdGgoZGlyZWN0b3J5UGF0aCkgeyBsb2dEaXJlY3RvcnlQYXRoID0gZGlyZWN0b3J5UGF0aDsgfVxuXG5mdW5jdGlvbiBzZXRMb2dPcHRpb25zKGxvZ09wdGlvbnMpIHtcbiAgY29uc3QgeyBsZXZlbCwgZmlsZUJhc2VOYW1lLCBkaXJlY3RvcnlQYXRoIH0gPSBsb2dPcHRpb25zO1xuXG4gIHNldExvZ0xldmVsKGxldmVsKTtcblxuICBzZXRMb2dGaWxlQmFzZU5hbWUoZmlsZUJhc2VOYW1lKTtcblxuICBzZXRMb2dEaXJlY3RvcnlQYXRoKGRpcmVjdG9yeVBhdGgpO1xufVxuXG5mdW5jdGlvbiBnZXRMb2dGaWxlQ29udGVudCgpIHtcbiAgY29uc3QgbG9nRmlsZVBhdGggPSBnZXRMb2dGaWxlUGF0aCgpLFxuICAgICAgICBsb2dGaWxlQ29udGVudCA9IHJlYWRGaWxlKGxvZ0ZpbGVQYXRoKTtcblxuICByZXR1cm4gbG9nRmlsZUNvbnRlbnQ7XG59XG5cbk9iamVjdC5hc3NpZ24obG9nLCB7XG4gIFRSQUNFLFxuICBERUJVRyxcbiAgSU5GTyxcbiAgV0FSTklORyxcbiAgRVJST1IsXG4gIEZBVEFMLFxuICB0cmFjZSxcbiAgZGVidWcsXG4gIGluZm8sXG4gIHdhcm5pbmcsXG4gIGVycm9yLFxuICBmYXRhbCxcbiAgc2V0TG9nTGV2ZWwsXG4gIHNldExvZ0ZpbGVCYXNlTmFtZSxcbiAgc2V0TG9nRGlyZWN0b3J5UGF0aCxcbiAgc2V0TG9nT3B0aW9ucyxcbiAgZ2V0TG9nRmlsZUNvbnRlbnRcbn0pO1xuXG5mdW5jdGlvbiBnZXRMb2dGaWxlUGF0aCgpIHtcbiAgY29uc3QgbG9nRmlsZU5hbWUgPSBgJHtsb2dGaWxlQmFzZU5hbWV9LmxvZ2AsXG4gICAgICAgIGxvZ0ZpbGVQYXRoID0gY29uY2F0ZW5hdGVQYXRocyhsb2dEaXJlY3RvcnlQYXRoLCBsb2dGaWxlTmFtZSk7XG5cbiAgcmV0dXJuIGxvZ0ZpbGVQYXRoO1xufVxuXG5mdW5jdGlvbiBnZXRSb2xsZWRPdmVyTG9nRmlsZVBhdGgoKSB7XG4gIGNvbnN0IGN1cnJlbnREYXRlU3RyaW5nID0gZ2V0Q3VycmVudERhdGVTdHJpbmcoKSxcbiAgICAgICAgcm9sbGVkT3ZlckxvZ0ZpbGVOYW1lID0gYCR7bG9nRmlsZUJhc2VOYW1lfS4ke2N1cnJlbnREYXRlU3RyaW5nfS5sb2dgLFxuICAgICAgICByb2xsZWRPdmVyTG9nRmlsZVBhdGggPSBjb25jYXRlbmF0ZVBhdGhzKGxvZ0RpcmVjdG9yeVBhdGgsIHJvbGxlZE92ZXJMb2dGaWxlTmFtZSk7XG5cbiAgcmV0dXJuIHJvbGxlZE92ZXJMb2dGaWxlUGF0aDtcbn1cblxuZnVuY3Rpb24gZ2V0TG9nRmlsZUxhc3RNb2RpZmllZERhdGUoKSB7XG4gIGNvbnN0IGxvZ0ZpbGVQYXRoID0gZ2V0TG9nRmlsZVBhdGgoKSxcbiAgICAgICAgbG9nRmlsZVN0YXRzID0gZ2V0U3RhdHMobG9nRmlsZVBhdGgpLFxuICAgICAgICB7IG10aW1lIH0gPSBsb2dGaWxlU3RhdHMsXG4gICAgICAgIGxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlID0gbmV3IERhdGUobXRpbWUpOyAgLy8vXG5cbiAgcmV0dXJuIGxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlO1xufVxuXG5mdW5jdGlvbiByb2xsT3ZlckxvZ0ZpbGUoKSB7XG4gIGNvbnN0IGxvZ0ZpbGVQYXRoID0gZ2V0TG9nRmlsZVBhdGgoKSxcbiAgICAgICAgbG9nRmlsZUV4aXN0cyA9IGNoZWNrRmlsZUV4aXN0cyhsb2dGaWxlUGF0aCk7XG5cbiAgaWYgKCFsb2dGaWxlRXhpc3RzKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgbG9nRmlsZUxhc3RNb2RpZmllZERhdGUgPSBnZXRMb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSgpLFxuICAgICAgICBsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZUN1cnJlbnREYXRlID0gaXNEYXRlQ3VycmVudERhdGUobG9nRmlsZUxhc3RNb2RpZmllZERhdGUpO1xuXG4gIGlmICghbG9nRmlsZUxhc3RNb2RpZmllZERhdGVDdXJyZW50RGF0ZSkge1xuICAgIGNvbnN0IHJvbGxlZE92ZXJMb2dGaWxlUGF0aCA9IGdldFJvbGxlZE92ZXJMb2dGaWxlUGF0aCgpO1xuXG4gICAgcmVuYW1lRmlsZShsb2dGaWxlUGF0aCwgcm9sbGVkT3ZlckxvZ0ZpbGVQYXRoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpc0RhdGVDdXJyZW50RGF0ZShkYXRlKSB7XG4gIGNvbnN0IGN1cnJlbnREYXRlID0gbmV3IERhdGUoKSxcbiAgICAgICAgZGF0ZVN0cmluZyA9IGRhdGUudG9EYXRlU3RyaW5nKCksXG4gICAgICAgIGN1cnJlbnREYXRlU3RyaW5nID0gY3VycmVudERhdGUudG9EYXRlU3RyaW5nKCksXG4gICAgICAgIGRhdGVDdXJyZW50RGF0ZSA9IChkYXRlU3RyaW5nID09PSBjdXJyZW50RGF0ZVN0cmluZyk7XG5cbiAgcmV0dXJuIGRhdGVDdXJyZW50RGF0ZTtcbn1cblxuZnVuY3Rpb24gZ2V0Q3VycmVudERhdGVTdHJpbmcoKSB7XG4gIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSgpLFxuICAgICAgICBkYXkgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXREYXRlKCksIDIpLCAgLy8vXG4gICAgICAgIG1vbnRoID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0TW9udGgoKSArIDEsIDIpLCAvLy9cbiAgICAgICAgeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgY3VycmVudERhdGVBbmRUaW1lU3RyaW5nID0gYCR7ZGF5fS0ke21vbnRofS0ke3llYXJ9YDtcblxuICByZXR1cm4gY3VycmVudERhdGVBbmRUaW1lU3RyaW5nO1xufVxuXG5mdW5jdGlvbiBnZXRDdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmcoKSB7XG4gIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSgpLFxuICAgICAgICBkYXkgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXREYXRlKCksIDIpLCAgLy8vXG4gICAgICAgIG1vbnRoID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0TW9udGgoKSArIDEsIDIpLCAvLy9cbiAgICAgICAgeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgaG91cnMgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRIb3VycygpLCAyKSxcbiAgICAgICAgbWludXRlcyA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldE1pbnV0ZXMoKSwgMiksXG4gICAgICAgIHNlY29uZHMgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRTZWNvbmRzKCksIDIpLFxuICAgICAgICBtaWxsaXNlY29uZHMgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRNaWxsaXNlY29uZHMoKSwgMyksXG4gICAgICAgIGN1cnJlbnREYXRlQW5kVGltZVN0cmluZyA9IGAke2RheX0tJHttb250aH0tJHt5ZWFyfSAke2hvdXJzfToke21pbnV0ZXN9OiR7c2Vjb25kc30uJHttaWxsaXNlY29uZHN9YDtcblxuICByZXR1cm4gY3VycmVudERhdGVBbmRUaW1lU3RyaW5nO1xufVxuXG5mdW5jdGlvbiBzdGFja01lc3NhZ2VzRnJvbVN0YWNrKHN0YWNrKSB7XG4gIGNvbnN0IHN0YWNrTWVzc2FnZXMgPSBbXSxcbiAgICAgICAgc3RhY2tMaW5lcyA9IHN0YWNrLnNwbGl0KC9cXHJcXG58XFxuLyk7XG5cbiAgbGV0IHN0YWNrTWVzc2FnZSA9IFwiXCI7XG5cbiAgc3RhY2tMaW5lcy5mb3JFYWNoKChzdGFja0xpbmUpID0+IHtcbiAgICBjb25zdCBtYXRjaGVzID0gL15cXHMqYXQuKi8udGVzdChzdGFja0xpbmUpO1xuXG4gICAgc3RhY2tNZXNzYWdlID0gKHN0YWNrTWVzc2FnZSA9PT0gXCJcIikgP1xuICAgICAgICAgICAgICAgICAgICAgIHN0YWNrTGluZSA6XG4gICAgICAgICAgICAgICAgICAgICAgICBgJHtzdGFja01lc3NhZ2V9XFxuJHtzdGFja0xpbmV9YDtcblxuICAgIGlmIChtYXRjaGVzKSB7XG4gICAgICBzdGFja01lc3NhZ2VzLnB1c2goc3RhY2tNZXNzYWdlKTtcblxuICAgICAgc3RhY2tNZXNzYWdlID0gXCJcIjtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBzdGFja01lc3NhZ2VzO1xufVxuXG5mdW5jdGlvbiBmaWxlUGF0aEZyb21TdGFja01lc3NhZ2Uoc3RhY2tNZXNzYWdlKSB7XG4gIGNvbnN0IG1hdGNoZXMgPSBzdGFja01lc3NhZ2UubWF0Y2goLyhcXC8uKyk6XFxkKzpcXGQrL20pLFxuICAgICAgICBzZWNvbmRNYXRjaCA9IHNlY29uZChtYXRjaGVzKSxcbiAgICAgICAgYWJzb2x1dGVGaWxlUGF0aCA9IHNlY29uZE1hdGNoLCAgLy8vXG4gICAgICAgIGN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aCA9IHBhdGgucmVzb2x2ZShcIi5cIiksICAvLy9cbiAgICAgICAgY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoTGVuZ3RoID0gY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoLmxlbmd0aCxcbiAgICAgICAgc3RhcnQgPSBjdXJyZW50V29ya2luZ0RpcmVjdG9yeVBhdGhMZW5ndGggKyAxLCAgLy8vXG4gICAgICAgIGZpbGVQYXRoID0gYWJzb2x1dGVGaWxlUGF0aC5zdWJzdHIoc3RhcnQpO1xuXG4gIHJldHVybiBmaWxlUGF0aDtcbn1cblxuZnVuY3Rpb24gbGluZU51bWJlckZyb21TdGFja01lc3NhZ2Uoc3RhY2tNZXNzYWdlKSB7XG4gIGNvbnN0IG1hdGNoZXMgPSBzdGFja01lc3NhZ2UubWF0Y2goLzooXFxkKykvbSksXG4gICAgICAgIHNlY29uZE1hdGNoID0gc2Vjb25kKG1hdGNoZXMpLFxuICAgICAgICBsaW5lTnVtYmVyID0gc2Vjb25kTWF0Y2g7IC8vL1xuXG4gIHJldHVybiBsaW5lTnVtYmVyO1xufVxuXG5mdW5jdGlvbiBwYWRTdGFydFdpdGhaZXJvZXMoc3RyaW5nLCB0YXJnZXRMZW5ndGgpIHtcbiAgY29uc3QgcGFkU3RyaW5nID0gXCIwXCIsXG4gICAgICAgIHBhZGRlZFN0cmluZyA9IHBhZFN0YXJ0KHN0cmluZywgdGFyZ2V0TGVuZ3RoLCBwYWRTdHJpbmcpO1xuXG4gIHJldHVybiBwYWRkZWRTdHJpbmc7XG59XG5cbmZ1bmN0aW9uIHBhZFN0YXJ0KHN0cmluZywgdGFyZ2V0TGVuZ3RoLCBwYWRTdHJpbmcpIHtcbiAgbGV0IHBhZGRpbmcgPSBcIlwiO1xuXG4gIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB0YXJnZXRMZW5ndGg7IGluZGV4KyspIHtcbiAgICBwYWRkaW5nICs9IHBhZFN0cmluZztcbiAgfVxuXG4gIGNvbnN0IHBhZGRlZFN0cmluZyA9IGAke3BhZGRpbmd9JHtzdHJpbmd9YC5zdWJzdHIoLXRhcmdldExlbmd0aCk7XG5cbiAgcmV0dXJuIHBhZGRlZFN0cmluZztcbn1cbiJdfQ==