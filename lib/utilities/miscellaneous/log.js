'use strict';

var path = require('path');

var pathUtilities = require('../../utilities/path'),
    arrayUtilities = require('../../utilities/array'),
    fileSystemUtilities = require('../../utilities/fileSystem');

var second = arrayUtilities.second,
    concatenatePaths = pathUtilities.concatenatePaths,
    checkFileExists = fileSystemUtilities.checkFileExists,
    readFile = fileSystemUtilities.readFile,
    appendToFile = fileSystemUtilities.appendToFile,
    renameFile = fileSystemUtilities.renameFile,
    getStats = fileSystemUtilities.getStats;
var TRACE = 'TRACE',
    DEBUG = 'DEBUG',
    INFO = 'INFO',
    WARNING = 'WARNING',
    ERROR = 'ERROR',
    FATAL = 'FATAL';
var logLevel = WARNING,
    logFileBaseName = 'default',
    logDirectoryPath = null;

function log(messageOrError) {
  var level = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';
  var pertinentStackMessageIndex = 2;
  var levels = [TRACE, DEBUG, INFO, WARNING, ERROR, FATAL];

  if (level) {
    ///
    var levelIndex = levels.indexOf(level),
        logLevelIndex = levels.indexOf(logLevel);

    if (levelIndex < logLevelIndex) {
      return;
    }

    pertinentStackMessageIndex += 1;
    level = "".concat(level, " "); ///
  }

  var error, message;

  if (messageOrError instanceof Error) {
    error = messageOrError; ///

    var _error = error;
    message = _error.message;
  } else {
    message = messageOrError; ///

    error = new Error(message);
  }

  var _error2 = error,
      stack = _error2.stack,
      stackMessages = stack.split(/\r\n|\n/),
      pertinentStackMessage = stackMessages[pertinentStackMessageIndex],
      stackMessage = pertinentStackMessage,
      currentDateAndTimeString = getCurrentDateAndTimeString(),
      filePath = filePathFromStackMessage(stackMessage),
      lineNumber = lineNumberFromStackMessage(stackMessage),
      logMessage = "".concat(level).concat(currentDateAndTimeString, " ").concat(filePath, "(").concat(lineNumber, ") ").concat(message);
  console.log(logMessage);

  if (logDirectoryPath !== null) {
    rollOverLogFile();
    var logFilePath = getLogFilePath(),
        logFileContent = "".concat(logMessage, "\n");
    appendToFile(logFilePath, logFileContent);
  }

  return logMessage;
}

function trace(message) {
  return log(message, TRACE);
}

function debug(message) {
  return log(message, DEBUG);
}

function info(message) {
  return log(message, INFO);
}

function warning(message) {
  return log(message, WARNING);
}

function error(message) {
  return log(message, ERROR);
}

function fatal(message) {
  return log(message, FATAL);
}

function setLogLevel(level) {
  logLevel = level;
}

function setLogFileBaseName(fileBaseName) {
  logFileBaseName = fileBaseName;
}

function setLogDirectoryPath(directoryPath) {
  logDirectoryPath = directoryPath;
}

function setLogOptions(logOptions) {
  var level = logOptions.level,
      fileBaseName = logOptions.fileBaseName,
      directoryPath = logOptions.directoryPath;
  setLogLevel(level);
  setLogFileBaseName(fileBaseName);
  setLogDirectoryPath(directoryPath);
}

function getLogFileContent() {
  var logFilePath = getLogFilePath(),
      logFileContent = readFile(logFilePath);
  return logFileContent;
}

Object.assign(log, {
  TRACE: TRACE,
  DEBUG: DEBUG,
  INFO: INFO,
  WARNING: WARNING,
  ERROR: ERROR,
  FATAL: FATAL,
  trace: trace,
  debug: debug,
  info: info,
  warning: warning,
  error: error,
  fatal: fatal,
  setLogLevel: setLogLevel,
  setLogFileBaseName: setLogFileBaseName,
  setLogDirectoryPath: setLogDirectoryPath,
  setLogOptions: setLogOptions,
  getLogFileContent: getLogFileContent
});
module.exports = log;

function getLogFilePath() {
  var logFileName = "".concat(logFileBaseName, ".log"),
      logFilePath = concatenatePaths(logDirectoryPath, logFileName);
  return logFilePath;
}

function getRolledOverLogFilePath() {
  var currentDateString = getCurrentDateString(),
      rolledOverLogFileName = "".concat(logFileBaseName, ".").concat(currentDateString, ".log"),
      rolledOverLogFilePath = concatenatePaths(logDirectoryPath, rolledOverLogFileName);
  return rolledOverLogFilePath;
}

function getLogFileLastModifiedDate() {
  var logFilePath = getLogFilePath(),
      logFileStats = getStats(logFilePath),
      mtime = logFileStats.mtime,
      logFileLastModifiedDate = new Date(mtime); ///

  return logFileLastModifiedDate;
}

function rollOverLogFile() {
  var logFilePath = getLogFilePath(),
      logFileExists = checkFileExists(logFilePath);

  if (!logFileExists) {
    return;
  }

  var logFileLastModifiedDate = getLogFileLastModifiedDate(),
      logFileLastModifiedDateCurrentDate = isDateCurrentDate(logFileLastModifiedDate);

  if (!logFileLastModifiedDateCurrentDate) {
    var rolledOverLogFilePath = getRolledOverLogFilePath();
    renameFile(logFilePath, rolledOverLogFilePath);
  }
}

function isDateCurrentDate(date) {
  var currentDate = new Date(),
      dateString = date.toDateString(),
      currentDateString = currentDate.toDateString(),
      dateCurrentDate = dateString === currentDateString;
  return dateCurrentDate;
}

function getCurrentDateString() {
  var date = new Date(),
      day = padStartWithZeroes(date.getDate(), 2),
      ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
      ///
  year = date.getFullYear(),
      currentDateAndTimeString = "".concat(day, "-").concat(month, "-").concat(year);
  return currentDateAndTimeString;
}

function getCurrentDateAndTimeString() {
  var date = new Date(),
      day = padStartWithZeroes(date.getDate(), 2),
      ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
      ///
  year = date.getFullYear(),
      hours = padStartWithZeroes(date.getHours(), 2),
      minutes = padStartWithZeroes(date.getMinutes(), 2),
      seconds = padStartWithZeroes(date.getSeconds(), 2),
      milliseconds = padStartWithZeroes(date.getMilliseconds(), 3),
      currentDateAndTimeString = "".concat(day, "-").concat(month, "-").concat(year, " ").concat(hours, ":").concat(minutes, ":").concat(seconds, ".").concat(milliseconds);
  return currentDateAndTimeString;
}

function filePathFromStackMessage(stackMessage) {
  var matches = stackMessage.match(/(\/.+)\:\d+\:\d+/),
      secondMatch = second(matches),
      absoluteFilePath = secondMatch,
      ///
  currentWorkingDirectoryPath = path.resolve('.'),
      ///
  currentWorkingDirectoryPathLength = currentWorkingDirectoryPath.length,
      start = currentWorkingDirectoryPathLength + 1,
      ///
  filePath = absoluteFilePath.substr(start);
  return filePath;
}

function lineNumberFromStackMessage(stackMessage) {
  var matches = stackMessage.match(/\:(\d+)/),
      secondMatch = second(matches),
      lineNumber = secondMatch; ///

  return lineNumber;
}

function padStartWithZeroes(string, targetLength) {
  var padString = '0',
      paddedString = padStart(string, targetLength, padString);
  return paddedString;
}

function padStart(string, targetLength, padString) {
  var padding = '';

  for (var index = 0; index < targetLength; index++) {
    padding += padString;
  }

  var paddedString = "".concat(padding).concat(string).substr(-targetLength);
  return paddedString;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxvZy5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsInBhdGhVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsImZpbGVTeXN0ZW1VdGlsaXRpZXMiLCJzZWNvbmQiLCJjb25jYXRlbmF0ZVBhdGhzIiwiY2hlY2tGaWxlRXhpc3RzIiwicmVhZEZpbGUiLCJhcHBlbmRUb0ZpbGUiLCJyZW5hbWVGaWxlIiwiZ2V0U3RhdHMiLCJUUkFDRSIsIkRFQlVHIiwiSU5GTyIsIldBUk5JTkciLCJFUlJPUiIsIkZBVEFMIiwibG9nTGV2ZWwiLCJsb2dGaWxlQmFzZU5hbWUiLCJsb2dEaXJlY3RvcnlQYXRoIiwibG9nIiwibWVzc2FnZU9yRXJyb3IiLCJsZXZlbCIsInBlcnRpbmVudFN0YWNrTWVzc2FnZUluZGV4IiwibGV2ZWxzIiwibGV2ZWxJbmRleCIsImluZGV4T2YiLCJsb2dMZXZlbEluZGV4IiwiZXJyb3IiLCJtZXNzYWdlIiwiRXJyb3IiLCJzdGFjayIsInN0YWNrTWVzc2FnZXMiLCJzcGxpdCIsInBlcnRpbmVudFN0YWNrTWVzc2FnZSIsInN0YWNrTWVzc2FnZSIsImN1cnJlbnREYXRlQW5kVGltZVN0cmluZyIsImdldEN1cnJlbnREYXRlQW5kVGltZVN0cmluZyIsImZpbGVQYXRoIiwiZmlsZVBhdGhGcm9tU3RhY2tNZXNzYWdlIiwibGluZU51bWJlciIsImxpbmVOdW1iZXJGcm9tU3RhY2tNZXNzYWdlIiwibG9nTWVzc2FnZSIsImNvbnNvbGUiLCJyb2xsT3ZlckxvZ0ZpbGUiLCJsb2dGaWxlUGF0aCIsImdldExvZ0ZpbGVQYXRoIiwibG9nRmlsZUNvbnRlbnQiLCJ0cmFjZSIsImRlYnVnIiwiaW5mbyIsIndhcm5pbmciLCJmYXRhbCIsInNldExvZ0xldmVsIiwic2V0TG9nRmlsZUJhc2VOYW1lIiwiZmlsZUJhc2VOYW1lIiwic2V0TG9nRGlyZWN0b3J5UGF0aCIsImRpcmVjdG9yeVBhdGgiLCJzZXRMb2dPcHRpb25zIiwibG9nT3B0aW9ucyIsImdldExvZ0ZpbGVDb250ZW50IiwiT2JqZWN0IiwiYXNzaWduIiwibW9kdWxlIiwiZXhwb3J0cyIsImxvZ0ZpbGVOYW1lIiwiZ2V0Um9sbGVkT3ZlckxvZ0ZpbGVQYXRoIiwiY3VycmVudERhdGVTdHJpbmciLCJnZXRDdXJyZW50RGF0ZVN0cmluZyIsInJvbGxlZE92ZXJMb2dGaWxlTmFtZSIsInJvbGxlZE92ZXJMb2dGaWxlUGF0aCIsImdldExvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlIiwibG9nRmlsZVN0YXRzIiwibXRpbWUiLCJsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSIsIkRhdGUiLCJsb2dGaWxlRXhpc3RzIiwibG9nRmlsZUxhc3RNb2RpZmllZERhdGVDdXJyZW50RGF0ZSIsImlzRGF0ZUN1cnJlbnREYXRlIiwiZGF0ZSIsImN1cnJlbnREYXRlIiwiZGF0ZVN0cmluZyIsInRvRGF0ZVN0cmluZyIsImRhdGVDdXJyZW50RGF0ZSIsImRheSIsInBhZFN0YXJ0V2l0aFplcm9lcyIsImdldERhdGUiLCJtb250aCIsImdldE1vbnRoIiwieWVhciIsImdldEZ1bGxZZWFyIiwiaG91cnMiLCJnZXRIb3VycyIsIm1pbnV0ZXMiLCJnZXRNaW51dGVzIiwic2Vjb25kcyIsImdldFNlY29uZHMiLCJtaWxsaXNlY29uZHMiLCJnZXRNaWxsaXNlY29uZHMiLCJtYXRjaGVzIiwibWF0Y2giLCJzZWNvbmRNYXRjaCIsImFic29sdXRlRmlsZVBhdGgiLCJjdXJyZW50V29ya2luZ0RpcmVjdG9yeVBhdGgiLCJyZXNvbHZlIiwiY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoTGVuZ3RoIiwibGVuZ3RoIiwic3RhcnQiLCJzdWJzdHIiLCJzdHJpbmciLCJ0YXJnZXRMZW5ndGgiLCJwYWRTdHJpbmciLCJwYWRkZWRTdHJpbmciLCJwYWRTdGFydCIsInBhZGRpbmciLCJpbmRleCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFFQSxJQUFNQyxhQUFhLEdB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ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcblxuY29uc3QgcGF0aFV0aWxpdGllcyA9IHJlcXVpcmUoJy4uLy4uL3V0aWxpdGllcy9wYXRoJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4uLy4uL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgZmlsZVN5c3RlbVV0aWxpdGllcyA9IHJlcXVpcmUoJy4uLy4uL3V0aWxpdGllcy9maWxlU3lzdGVtJyk7XG5cbmNvbnN0IHsgc2Vjb25kIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgY29uY2F0ZW5hdGVQYXRocyB9ID0gcGF0aFV0aWxpdGllcyxcbiAgICAgIHsgY2hlY2tGaWxlRXhpc3RzLCByZWFkRmlsZSwgYXBwZW5kVG9GaWxlLCByZW5hbWVGaWxlLCBnZXRTdGF0cyB9ID0gZmlsZVN5c3RlbVV0aWxpdGllcztcblxuY29uc3QgVFJBQ0UgPSAnVFJBQ0UnLFxuICAgICAgREVCVUcgPSAnREVCVUcnLFxuICAgICAgSU5GTyA9ICdJTkZPJyxcbiAgICAgIFdBUk5JTkcgPSAnV0FSTklORycsXG4gICAgICBFUlJPUiA9ICdFUlJPUicsXG4gICAgICBGQVRBTCA9ICdGQVRBTCc7XG5cbmxldCBsb2dMZXZlbCA9IFdBUk5JTkcsXG4gICAgbG9nRmlsZUJhc2VOYW1lID0gJ2RlZmF1bHQnLFxuICAgIGxvZ0RpcmVjdG9yeVBhdGggPSBudWxsO1xuXG5mdW5jdGlvbiBsb2cobWVzc2FnZU9yRXJyb3IsIGxldmVsID0gJycpIHtcbiAgbGV0IHBlcnRpbmVudFN0YWNrTWVzc2FnZUluZGV4ID0gMjtcblxuICBjb25zdCBsZXZlbHMgPSBbXG4gICAgVFJBQ0UsXG4gICAgREVCVUcsXG4gICAgSU5GTyxcbiAgICBXQVJOSU5HLFxuICAgIEVSUk9SLFxuICAgIEZBVEFMXG4gIF07XG5cbiAgaWYgKGxldmVsKSB7IC8vL1xuICAgIGNvbnN0IGxldmVsSW5kZXggPSBsZXZlbHMuaW5kZXhPZihsZXZlbCksXG4gICAgICAgICAgbG9nTGV2ZWxJbmRleCA9IGxldmVscy5pbmRleE9mKGxvZ0xldmVsKTtcblxuICAgIGlmIChsZXZlbEluZGV4IDwgbG9nTGV2ZWxJbmRleCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHBlcnRpbmVudFN0YWNrTWVzc2FnZUluZGV4ICs9IDE7XG5cbiAgICBsZXZlbCA9IGAke2xldmVsfSBgOyAgLy8vXG4gIH1cblxuICBsZXQgZXJyb3IsXG4gICAgICBtZXNzYWdlO1xuXG4gIGlmIChtZXNzYWdlT3JFcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgZXJyb3IgPSBtZXNzYWdlT3JFcnJvcjsgLy8vXG5cbiAgICAoeyBtZXNzYWdlIH0gPSBlcnJvcik7XG4gIH0gZWxzZSB7XG4gICAgbWVzc2FnZSA9IG1lc3NhZ2VPckVycm9yOyAvLy9cblxuICAgIGVycm9yID0gbmV3IEVycm9yKG1lc3NhZ2UpO1xuICB9XG5cbiAgY29uc3QgeyBzdGFjayB9ID0gZXJyb3IsXG4gICAgICAgIHN0YWNrTWVzc2FnZXMgPSBzdGFjay5zcGxpdCgvXFxyXFxufFxcbi8pLFxuICAgICAgICBwZXJ0aW5lbnRTdGFja01lc3NhZ2UgPSBzdGFja01lc3NhZ2VzW3BlcnRpbmVudFN0YWNrTWVzc2FnZUluZGV4XSxcbiAgICAgICAgc3RhY2tNZXNzYWdlID0gcGVydGluZW50U3RhY2tNZXNzYWdlLCAvLy9cbiAgICAgICAgY3VycmVudERhdGVBbmRUaW1lU3RyaW5nID0gZ2V0Q3VycmVudERhdGVBbmRUaW1lU3RyaW5nKCksXG4gICAgICAgIGZpbGVQYXRoID0gZmlsZVBhdGhGcm9tU3RhY2tNZXNzYWdlKHN0YWNrTWVzc2FnZSksXG4gICAgICAgIGxpbmVOdW1iZXIgPSBsaW5lTnVtYmVyRnJvbVN0YWNrTWVzc2FnZShzdGFja01lc3NhZ2UpLFxuICAgICAgICBsb2dNZXNzYWdlID0gYCR7bGV2ZWx9JHtjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmd9ICR7ZmlsZVBhdGh9KCR7bGluZU51bWJlcn0pICR7bWVzc2FnZX1gO1xuXG4gIGNvbnNvbGUubG9nKGxvZ01lc3NhZ2UpO1xuXG4gIGlmIChsb2dEaXJlY3RvcnlQYXRoICE9PSBudWxsKSB7XG4gICAgcm9sbE92ZXJMb2dGaWxlKCk7XG5cbiAgICBjb25zdCBsb2dGaWxlUGF0aCA9IGdldExvZ0ZpbGVQYXRoKCksXG4gICAgICAgICAgbG9nRmlsZUNvbnRlbnQgPSBgJHtsb2dNZXNzYWdlfVxcbmA7XG5cbiAgICBhcHBlbmRUb0ZpbGUobG9nRmlsZVBhdGgsIGxvZ0ZpbGVDb250ZW50KTtcbiAgfVxuXG4gIHJldHVybiBsb2dNZXNzYWdlO1xufVxuXG5mdW5jdGlvbiB0cmFjZShtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgVFJBQ0UpOyB9XG5cbmZ1bmN0aW9uIGRlYnVnKG1lc3NhZ2UpIHsgcmV0dXJuIGxvZyhtZXNzYWdlLCBERUJVRyk7IH1cblxuZnVuY3Rpb24gaW5mbyhtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgSU5GTyk7IH1cblxuZnVuY3Rpb24gd2FybmluZyhtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgV0FSTklORyk7IH1cblxuZnVuY3Rpb24gZXJyb3IobWVzc2FnZSkgeyByZXR1cm4gbG9nKG1lc3NhZ2UsIEVSUk9SKTsgfVxuXG5mdW5jdGlvbiBmYXRhbChtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgRkFUQUwpOyB9XG5cbmZ1bmN0aW9uIHNldExvZ0xldmVsKGxldmVsKSB7IGxvZ0xldmVsID0gbGV2ZWw7IH1cblxuZnVuY3Rpb24gc2V0TG9nRmlsZUJhc2VOYW1lKGZpbGVCYXNlTmFtZSkgeyBsb2dGaWxlQmFzZU5hbWUgPSBmaWxlQmFzZU5hbWU7IH1cblxuZnVuY3Rpb24gc2V0TG9nRGlyZWN0b3J5UGF0aChkaXJlY3RvcnlQYXRoKSB7IGxvZ0RpcmVjdG9yeVBhdGggPSBkaXJlY3RvcnlQYXRoOyB9XG5cbmZ1bmN0aW9uIHNldExvZ09wdGlvbnMobG9nT3B0aW9ucykge1xuICBjb25zdCB7IGxldmVsLCBmaWxlQmFzZU5hbWUsIGRpcmVjdG9yeVBhdGggfSA9IGxvZ09wdGlvbnM7XG5cbiAgc2V0TG9nTGV2ZWwobGV2ZWwpO1xuXG4gIHNldExvZ0ZpbGVCYXNlTmFtZShmaWxlQmFzZU5hbWUpO1xuXG4gIHNldExvZ0RpcmVjdG9yeVBhdGgoZGlyZWN0b3J5UGF0aCk7XG59XG5cbmZ1bmN0aW9uIGdldExvZ0ZpbGVDb250ZW50KCkge1xuICBjb25zdCBsb2dGaWxlUGF0aCA9IGdldExvZ0ZpbGVQYXRoKCksXG4gICAgICAgIGxvZ0ZpbGVDb250ZW50ID0gcmVhZEZpbGUobG9nRmlsZVBhdGgpO1xuXG4gIHJldHVybiBsb2dGaWxlQ29udGVudDtcbn1cblxuT2JqZWN0LmFzc2lnbihsb2csIHtcbiAgVFJBQ0UsXG4gIERFQlVHLFxuICBJTkZPLFxuICBXQVJOSU5HLFxuICBFUlJPUixcbiAgRkFUQUwsXG4gIHRyYWNlLFxuICBkZWJ1ZyxcbiAgaW5mbyxcbiAgd2FybmluZyxcbiAgZXJyb3IsXG4gIGZhdGFsLFxuICBzZXRMb2dMZXZlbCxcbiAgc2V0TG9nRmlsZUJhc2VOYW1lLFxuICBzZXRMb2dEaXJlY3RvcnlQYXRoLFxuICBzZXRMb2dPcHRpb25zLFxuICBnZXRMb2dGaWxlQ29udGVudFxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gbG9nO1xuXG5mdW5jdGlvbiBnZXRMb2dGaWxlUGF0aCgpIHtcbiAgY29uc3QgbG9nRmlsZU5hbWUgPSBgJHtsb2dGaWxlQmFzZU5hbWV9LmxvZ2AsXG4gICAgICAgIGxvZ0ZpbGVQYXRoID0gY29uY2F0ZW5hdGVQYXRocyhsb2dEaXJlY3RvcnlQYXRoLCBsb2dGaWxlTmFtZSk7XG5cbiAgcmV0dXJuIGxvZ0ZpbGVQYXRoO1xufVxuXG5mdW5jdGlvbiBnZXRSb2xsZWRPdmVyTG9nRmlsZVBhdGgoKSB7XG4gIGNvbnN0IGN1cnJlbnREYXRlU3RyaW5nID0gZ2V0Q3VycmVudERhdGVTdHJpbmcoKSxcbiAgICAgICAgcm9sbGVkT3ZlckxvZ0ZpbGVOYW1lID0gYCR7bG9nRmlsZUJhc2VOYW1lfS4ke2N1cnJlbnREYXRlU3RyaW5nfS5sb2dgLFxuICAgICAgICByb2xsZWRPdmVyTG9nRmlsZVBhdGggPSBjb25jYXRlbmF0ZVBhdGhzKGxvZ0RpcmVjdG9yeVBhdGgsIHJvbGxlZE92ZXJMb2dGaWxlTmFtZSk7XG5cbiAgcmV0dXJuIHJvbGxlZE92ZXJMb2dGaWxlUGF0aDtcbn1cblxuZnVuY3Rpb24gZ2V0TG9nRmlsZUxhc3RNb2RpZmllZERhdGUoKSB7XG4gIGNvbnN0IGxvZ0ZpbGVQYXRoID0gZ2V0TG9nRmlsZVBhdGgoKSxcbiAgICAgICAgbG9nRmlsZVN0YXRzID0gZ2V0U3RhdHMobG9nRmlsZVBhdGgpLFxuICAgICAgICB7IG10aW1lIH0gPSBsb2dGaWxlU3RhdHMsXG4gICAgICAgIGxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlID0gbmV3IERhdGUobXRpbWUpOyAgLy8vXG5cbiAgcmV0dXJuIGxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlO1xufVxuXG5mdW5jdGlvbiByb2xsT3ZlckxvZ0ZpbGUoKSB7XG4gIGNvbnN0IGxvZ0ZpbGVQYXRoID0gZ2V0TG9nRmlsZVBhdGgoKSxcbiAgICAgICAgbG9nRmlsZUV4aXN0cyA9IGNoZWNrRmlsZUV4aXN0cyhsb2dGaWxlUGF0aCk7XG5cbiAgaWYgKCFsb2dGaWxlRXhpc3RzKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgbG9nRmlsZUxhc3RNb2RpZmllZERhdGUgPSBnZXRMb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSgpLFxuICAgICAgICBsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZUN1cnJlbnREYXRlID0gaXNEYXRlQ3VycmVudERhdGUobG9nRmlsZUxhc3RNb2RpZmllZERhdGUpO1xuXG4gIGlmICghbG9nRmlsZUxhc3RNb2RpZmllZERhdGVDdXJyZW50RGF0ZSkge1xuICAgIGNvbnN0IHJvbGxlZE92ZXJMb2dGaWxlUGF0aCA9IGdldFJvbGxlZE92ZXJMb2dGaWxlUGF0aCgpO1xuXG4gICAgcmVuYW1lRmlsZShsb2dGaWxlUGF0aCwgcm9sbGVkT3ZlckxvZ0ZpbGVQYXRoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpc0RhdGVDdXJyZW50RGF0ZShkYXRlKSB7XG4gIGNvbnN0IGN1cnJlbnREYXRlID0gbmV3IERhdGUoKSxcbiAgICAgICAgZGF0ZVN0cmluZyA9IGRhdGUudG9EYXRlU3RyaW5nKCksXG4gICAgICAgIGN1cnJlbnREYXRlU3RyaW5nID0gY3VycmVudERhdGUudG9EYXRlU3RyaW5nKCksXG4gICAgICAgIGRhdGVDdXJyZW50RGF0ZSA9IChkYXRlU3RyaW5nID09PSBjdXJyZW50RGF0ZVN0cmluZyk7XG5cbiAgcmV0dXJuIGRhdGVDdXJyZW50RGF0ZTtcbn1cblxuZnVuY3Rpb24gZ2V0Q3VycmVudERhdGVTdHJpbmcoKSB7XG4gIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSgpLFxuICAgICAgICBkYXkgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXREYXRlKCksIDIpLCAgLy8vXG4gICAgICAgIG1vbnRoID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0TW9udGgoKSArIDEsIDIpLCAvLy9cbiAgICAgICAgeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgY3VycmVudERhdGVBbmRUaW1lU3RyaW5nID0gYCR7ZGF5fS0ke21vbnRofS0ke3llYXJ9YDtcblxuICByZXR1cm4gY3VycmVudERhdGVBbmRUaW1lU3RyaW5nO1xufVxuXG5mdW5jdGlvbiBnZXRDdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmcoKSB7XG4gIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSgpLFxuICAgICAgICBkYXkgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXREYXRlKCksIDIpLCAgLy8vXG4gICAgICAgIG1vbnRoID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0TW9udGgoKSArIDEsIDIpLCAvLy9cbiAgICAgICAgeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgaG91cnMgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRIb3VycygpLCAyKSxcbiAgICAgICAgbWludXRlcyA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldE1pbnV0ZXMoKSwgMiksXG4gICAgICAgIHNlY29uZHMgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRTZWNvbmRzKCksIDIpLFxuICAgICAgICBtaWxsaXNlY29uZHMgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRNaWxsaXNlY29uZHMoKSwgMyksXG4gICAgICAgIGN1cnJlbnREYXRlQW5kVGltZVN0cmluZyA9IGAke2RheX0tJHttb250aH0tJHt5ZWFyfSAke2hvdXJzfToke21pbnV0ZXN9OiR7c2Vjb25kc30uJHttaWxsaXNlY29uZHN9YDtcblxuICByZXR1cm4gY3VycmVudERhdGVBbmRUaW1lU3RyaW5nO1xufVxuXG5mdW5jdGlvbiBmaWxlUGF0aEZyb21TdGFja01lc3NhZ2Uoc3RhY2tNZXNzYWdlKSB7XG4gIGNvbnN0IG1hdGNoZXMgPSBzdGFja01lc3NhZ2UubWF0Y2goLyhcXC8uKylcXDpcXGQrXFw6XFxkKy8pLFxuICAgICAgICBzZWNvbmRNYXRjaCA9IHNlY29uZChtYXRjaGVzKSxcbiAgICAgICAgYWJzb2x1dGVGaWxlUGF0aCA9IHNlY29uZE1hdGNoLCAgLy8vXG4gICAgICAgIGN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aCA9IHBhdGgucmVzb2x2ZSgnLicpLCAgLy8vXG4gICAgICAgIGN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aExlbmd0aCA9IGN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aC5sZW5ndGgsXG4gICAgICAgIHN0YXJ0ID0gY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoTGVuZ3RoICsgMSwgIC8vL1xuICAgICAgICBmaWxlUGF0aCA9IGFic29sdXRlRmlsZVBhdGguc3Vic3RyKHN0YXJ0KTtcblxuICByZXR1cm4gZmlsZVBhdGg7XG59XG5cbmZ1bmN0aW9uIGxpbmVOdW1iZXJGcm9tU3RhY2tNZXNzYWdlKHN0YWNrTWVzc2FnZSkge1xuICBjb25zdCBtYXRjaGVzID0gc3RhY2tNZXNzYWdlLm1hdGNoKC9cXDooXFxkKykvKSxcbiAgICAgICAgc2Vjb25kTWF0Y2ggPSBzZWNvbmQobWF0Y2hlcyksXG4gICAgICAgIGxpbmVOdW1iZXIgPSBzZWNvbmRNYXRjaDsgLy8vXG5cbiAgcmV0dXJuIGxpbmVOdW1iZXI7XG59XG5cbmZ1bmN0aW9uIHBhZFN0YXJ0V2l0aFplcm9lcyhzdHJpbmcsIHRhcmdldExlbmd0aCkge1xuICBjb25zdCBwYWRTdHJpbmcgPSAnMCcsXG4gICAgICAgIHBhZGRlZFN0cmluZyA9IHBhZFN0YXJ0KHN0cmluZywgdGFyZ2V0TGVuZ3RoLCBwYWRTdHJpbmcpO1xuXG4gIHJldHVybiBwYWRkZWRTdHJpbmc7XG59XG5cbmZ1bmN0aW9uIHBhZFN0YXJ0KHN0cmluZywgdGFyZ2V0TGVuZ3RoLCBwYWRTdHJpbmcpIHtcbiAgbGV0IHBhZGRpbmcgPSAnJztcblxuICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdGFyZ2V0TGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgcGFkZGluZyArPSBwYWRTdHJpbmc7XG4gIH1cblxuICBjb25zdCBwYWRkZWRTdHJpbmcgPSBgJHtwYWRkaW5nfSR7c3RyaW5nfWAuc3Vic3RyKC10YXJnZXRMZW5ndGgpO1xuXG4gIHJldHVybiBwYWRkZWRTdHJpbmc7XG59XG5cbiJdfQ==