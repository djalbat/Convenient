'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = prompt;

var _onETX = _interopRequireDefault(require("./onETX"));

var _asynchronous = require("../../utilities/asynchronous");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var _process = process,
    stdin = _process.stdin,
    stdout = _process.stdout,
    exit = _process.exit;
var BACKSPACE_CHARACTER = String.fromCharCode(127),
    LINE_FEED_CHARACTER = '\n',
    CARRIAGE_RETURN_CHARACTER = '\r';

function prompt(options, callback) {
  var value = null,
      _options$attempts = options.attempts,
      attempts = _options$attempts === void 0 ? 3 : _options$attempts,
      context = {
    value: value,
    attempts: attempts,
    options: options
  };
  (0, _asynchronous.whilst)(attempt, function () {
    var value = context.value;
    callback(value);
  }, context);
}

function attempt(next, done, context) {
  var attempts = context.attempts;
  var terminate = attempts-- === 0;

  if (terminate) {
    done();
    return;
  }

  var options = context.options,
      _options$hidden = options.hidden,
      hidden = _options$hidden === void 0 ? false : _options$hidden,
      _options$encoding = options.encoding,
      encoding = _options$encoding === void 0 ? 'utf8' : _options$encoding,
      description = options.description,
      _options$initialValue = options.initialValue,
      initialValue = _options$initialValue === void 0 ? '' : _options$initialValue,
      errorMessage = options.errorMessage,
      validationPattern = options.validationPattern,
      validationFunction = options.validationFunction;
  input(description, initialValue, encoding, hidden, callback);

  function callback(value) {
    var valid = validationFunction ? ///
    validationFunction(value) : validationPattern.test(value);

    if (valid) {
      Object.assign(context, {
        value: value
      });
      done();
    } else {
      console.log(errorMessage);
      Object.assign(context, {
        attempts: attempts
      });
      next();
    }
  }
}

function input(description, initialValue, encoding, hidden, callback) {
  var value = initialValue; ///

  var rawMode = true,
      offETX = (0, _onETX["default"])(function () {
    console.log('^C');
    exit();
  });
  stdin.setEncoding(encoding);
  stdin.setRawMode(rawMode);
  stdout.write(description);

  if (!hidden) {
    stdout.write(value);
  }

  stdin.resume();
  stdin.on('data', listener);

  function listener(chunk) {
    var character = chunk.toString(encoding);

    switch (character) {
      case LINE_FEED_CHARACTER:
      case CARRIAGE_RETURN_CHARACTER:
        stdout.write(LINE_FEED_CHARACTER);
        stdin.removeListener('data', listener);
        stdin.pause();
        offETX();
        callback(value);
        break;

      case BACKSPACE_CHARACTER:
        value = value.slice(0, value.length - 1);
        stdout.clearLine();
        stdout.cursorTo(0);
        stdout.write(description);

        if (!hidden) {
          stdout.write(value);
        }

        break;

      default:
        value += character;

        if (!hidden) {
          stdout.clearLine();
          stdout.cursorTo(0);
          stdout.write(description);
          stdout.write(value);
        }

        break;
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb21wdC5qcyJdLCJuYW1lcyI6WyJwcm9jZXNzIiwic3RkaW4iLCJzdGRvdXQiLCJleGl0IiwiQkFDS1NQQUNFX0NIQVJBQ1RFUiIsIlN0cmluZyIsImZyb21DaGFyQ29kZSIsIkxJTkVfRkVFRF9DSEFSQUNURVIiLCJDQVJSSUFHRV9SRVRVUk5fQ0hBUkFDVEVSIiwicHJvbXB0Iiwib3B0aW9ucyIsImNhbGxiYWNrIiwidmFsdWUiLCJhdHRlbXB0cyIsImNvbnRleHQiLCJhdHRlbXB0IiwibmV4dCIsImRvbmUiLCJ0ZXJtaW5hdGUiLCJoaWRkZW4iLCJlbmNvZGluZyIsImRlc2NyaXB0aW9uIiwiaW5pdGlhbFZhbHVlIiwiZXJyb3JNZXNzYWdlIiwidmFsaWRhdGlvblBhdHRlcm4iLCJ2YWxpZGF0aW9uRnVuY3Rpb24iLCJpbnB1dCIsInZhbGlkIiwidGVzdCIsIk9iamVjdCIsImFzc2lnbiIsImNvbnNvbGUiLCJsb2ciLCJyYXdNb2RlIiwib2ZmRVRYIiwic2V0RW5jb2RpbmciLCJzZXRSYXdNb2RlIiwid3JpdGUiLCJyZXN1bWUiLCJvbiIsImxpc3RlbmVyIiwiY2h1bmsiLCJjaGFyYWN0ZXIiLCJ0b1N0cmluZyIsInJlbW92ZUxpc3RlbmVyIiwicGF1c2UiLCJzbGljZSIsImxlbmd0aCIsImNsZWFyTGluZSIsImN1cnNvclRvIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOztBQUVBOzs7O2VBRWdDQSxPO0lBQXhCQyxLLFlBQUFBLEs7SUFBT0MsTSxZQUFBQSxNO0lBQVFDLEksWUFBQUEsSTtBQUV2QixJQUFNQyxtQkFBbUIsR0FBR0MsTUFBTSxDQUFDQyxZQUFQLENBQW9CLEdBQXBCLENBQTVCO0FBQUEsSUFDTUMsbUJBQW1CLEdBQUcsSUFENUI7QUFBQSxJQUVNQyx5QkFBeUIsR0FBRyxJQUZsQzs7QUFJZSxTQUFTQyxNQUFULENBQWdCQyxPQUFoQixFQUF5QkMsUUFBekIsRUFBbUM7QUFDMUMsTUFBQUMsS0FBSyxHQUFHLElBQVI7QUFB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QyxVQUFBQSxNQUFNLENBQUNtQyxLQUFQLENBQWFoQixXQUFiO0FBRUFuQixVQUFBQSxNQUFNLENBQUNtQyxLQUFQLENBQWF6QixLQUFiO0FBQ0Q7O0FBQ0Q7QUF4Q0o7QUEwQ0Q7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IG9uRVRYIGZyb20gJy4vb25FVFgnO1xuXG5pbXBvcnQgeyB3aGlsc3QgfSBmcm9tICcuLi8uLi91dGlsaXRpZXMvYXN5bmNocm9ub3VzJztcblxuY29uc3QgeyBzdGRpbiwgc3Rkb3V0LCBleGl0IH0gPSBwcm9jZXNzO1xuXG5jb25zdCBCQUNLU1BBQ0VfQ0hBUkFDVEVSID0gU3RyaW5nLmZyb21DaGFyQ29kZSgxMjcpLFxuICAgICAgTElORV9GRUVEX0NIQVJBQ1RFUiA9ICdcXG4nLFxuICAgICAgQ0FSUklBR0VfUkVUVVJOX0NIQVJBQ1RFUiA9ICdcXHInO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBwcm9tcHQob3B0aW9ucywgY2FsbGJhY2spIHtcbiAgY29uc3QgdmFsdWUgPSBudWxsLFxuICAgICAgICB7IGF0dGVtcHRzID0gMyB9ID0gb3B0aW9ucyxcbiAgICAgICAgY29udGV4dCA9IHtcbiAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgICBhdHRlbXB0cyxcbiAgICAgICAgICBvcHRpb25zXG4gICAgICAgIH07XG5cbiAgd2hpbHN0KGF0dGVtcHQsIGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IHsgdmFsdWUgfSA9IGNvbnRleHQ7XG4gICAgXG4gICAgY2FsbGJhY2sodmFsdWUpO1xuICB9LCBjb250ZXh0KTtcbn1cblxuZnVuY3Rpb24gYXR0ZW1wdChuZXh0LCBkb25lLCBjb250ZXh0KSB7XG4gIGxldCB7IGF0dGVtcHRzIH0gPSBjb250ZXh0O1xuXG4gIGNvbnN0IHRlcm1pbmF0ZSA9IChhdHRlbXB0cy0tID09PSAwKTtcbiAgXG4gIGlmICh0ZXJtaW5hdGUpIHtcbiAgICBkb25lKCk7XG4gICAgXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgeyBvcHRpb25zIH0gPSBjb250ZXh0LFxuICAgICAgICB7IGhpZGRlbiA9IGZhbHNlLFxuICAgICAgICAgIGVuY29kaW5nID0gJ3V0ZjgnLFxuICAgICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICAgIGluaXRpYWxWYWx1ZSA9ICcnLFxuICAgICAgICAgIGVycm9yTWVzc2FnZSxcbiAgICAgICAgICB2YWxpZGF0aW9uUGF0dGVybixcbiAgICAgICAgICB2YWxpZGF0aW9uRnVuY3Rpb24gfSA9IG9wdGlvbnM7XG5cbiAgaW5wdXQoZGVzY3JpcHRpb24sIGluaXRpYWxWYWx1ZSwgZW5jb2RpbmcsIGhpZGRlbiwgY2FsbGJhY2spO1xuXG4gIGZ1bmN0aW9uIGNhbGxiYWNrKHZhbHVlKSB7XG4gICAgY29uc3QgdmFsaWQgPSB2YWxpZGF0aW9uRnVuY3Rpb24gPyAgLy8vXG4gICAgICAgICAgICAgICAgICAgIHZhbGlkYXRpb25GdW5jdGlvbih2YWx1ZSkgOlxuICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRpb25QYXR0ZXJuLnRlc3QodmFsdWUpO1xuXG4gICAgaWYgKHZhbGlkKSB7XG4gICAgICBPYmplY3QuYXNzaWduKGNvbnRleHQsIHtcbiAgICAgICAgdmFsdWU6IHZhbHVlXG4gICAgICB9KTtcblxuICAgICAgZG9uZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZyhlcnJvck1lc3NhZ2UpO1xuXG4gICAgICBPYmplY3QuYXNzaWduKGNvbnRleHQsIHtcbiAgICAgICAgYXR0ZW1wdHNcbiAgICAgIH0pO1xuXG4gICAgICBuZXh0KCk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGlucHV0KGRlc2NyaXB0aW9uLCBpbml0aWFsVmFsdWUsIGVuY29kaW5nLCBoaWRkZW4sIGNhbGxiYWNrKSB7XG4gIGxldCB2YWx1ZSA9IGluaXRpYWxWYWx1ZTsgLy8vXG5cbiAgY29uc3QgcmF3TW9kZSA9IHRydWUsXG4gICAgICAgIG9mZkVUWCA9IG9uRVRYKGZ1bmN0aW9uKCkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdeQycpO1xuXG4gICAgICAgICAgZXhpdCgpO1xuICAgICAgICB9KTtcblxuICBzdGRpbi5zZXRFbmNvZGluZyhlbmNvZGluZyk7XG5cbiAgc3RkaW4uc2V0UmF3TW9kZShyYXdNb2RlKTtcblxuICBzdGRvdXQud3JpdGUoZGVzY3JpcHRpb24pO1xuXG4gIGlmICghaGlkZGVuKSB7XG4gICAgc3Rkb3V0LndyaXRlKHZhbHVlKTtcbiAgfVxuXG4gIHN0ZGluLnJlc3VtZSgpO1xuXG4gIHN0ZGluLm9uKCdkYXRhJywgbGlzdGVuZXIpO1xuXG4gIGZ1bmN0aW9uIGxpc3RlbmVyKGNodW5rKSB7XG4gICAgY29uc3QgY2hhcmFjdGVyID0gY2h1bmsudG9TdHJpbmcoZW5jb2RpbmcpO1xuXG4gICAgc3dpdGNoIChjaGFyYWN0ZXIpIHtcbiAgICAgIGNhc2UgTElORV9GRUVEX0NIQVJBQ1RFUiA6XG4gICAgICBjYXNlIENBUlJJQUdFX1JFVFVSTl9DSEFSQUNURVIgOlxuICAgICAgICBzdGRvdXQud3JpdGUoTElORV9GRUVEX0NIQVJBQ1RFUik7XG5cbiAgICAgICAgc3RkaW4ucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCBsaXN0ZW5lcik7XG5cbiAgICAgICAgc3RkaW4ucGF1c2UoKTtcblxuICAgICAgICBvZmZFVFgoKTtcblxuICAgICAgICBjYWxsYmFjayh2YWx1ZSk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIEJBQ0tTUEFDRV9DSEFSQUNURVIgOlxuICAgICAgICB2YWx1ZSA9IHZhbHVlLnNsaWNlKDAsIHZhbHVlLmxlbmd0aCAtIDEpO1xuXG4gICAgICAgIHN0ZG91dC5jbGVhckxpbmUoKTtcblxuICAgICAgICBzdGRvdXQuY3Vyc29yVG8oMCk7XG5cbiAgICAgICAgc3Rkb3V0LndyaXRlKGRlc2NyaXB0aW9uKTtcblxuICAgICAgICBpZiAoIWhpZGRlbikge1xuICAgICAgICAgIHN0ZG91dC53cml0ZSh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHZhbHVlICs9IGNoYXJhY3RlcjtcblxuICAgICAgICBpZiAoIWhpZGRlbikge1xuICAgICAgICAgIHN0ZG91dC5jbGVhckxpbmUoKTtcblxuICAgICAgICAgIHN0ZG91dC5jdXJzb3JUbygwKTtcblxuICAgICAgICAgIHN0ZG91dC53cml0ZShkZXNjcmlwdGlvbik7XG5cbiAgICAgICAgICBzdGRvdXQud3JpdGUodmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxufVxuIl19