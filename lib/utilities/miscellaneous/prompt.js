"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = prompt;

var _onETX = _interopRequireDefault(require("./onETX"));

var _asynchronous = require("../../utilities/asynchronous");

var _constants = require("../../constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function prompt(options, callback) {
  var value = null,
      _options$attempts = options.attempts,
      attempts = _options$attempts === void 0 ? 3 : _options$attempts,
      context = {
    value: value,
    attempts: attempts,
    options: options
  };
  (0, _asynchronous.whilst)(attempt, function () {
    var value = context.value;
    callback(value);
  }, context);
}

function attempt(next, done, context) {
  var attempts = context.attempts;
  var terminate = attempts-- === 0;

  if (terminate) {
    done();
    return;
  }

  var options = context.options,
      _options$hidden = options.hidden,
      hidden = _options$hidden === void 0 ? false : _options$hidden,
      _options$encoding = options.encoding,
      encoding = _options$encoding === void 0 ? "utf8" : _options$encoding,
      description = options.description,
      _options$initialValue = options.initialValue,
      initialValue = _options$initialValue === void 0 ? "" : _options$initialValue,
      errorMessage = options.errorMessage,
      validationPattern = options.validationPattern,
      validationFunction = options.validationFunction;
  input(description, initialValue, encoding, hidden, callback);

  function callback(value) {
    var valid = validationFunction ? ///
    validationFunction(value) : validationPattern.test(value);

    if (valid) {
      Object.assign(context, {
        value: value
      });
      done();
    } else {
      console.log(errorMessage);
      Object.assign(context, {
        attempts: attempts
      });
      next();
    }
  }
}

function input(description, initialValue, encoding, hidden, callback) {
  var value = initialValue; ///

  var event = _constants.DATA_EVENT,
      rawMode = true,
      offETX = (0, _onETX["default"])(function () {
    console.log(_constants.CTRL_C);
    process.exit();
  });
  process.stdin.setEncoding(encoding);
  process.stdin.setRawMode(rawMode);
  process.stdout.write(description);

  if (!hidden) {
    process.stdout.write(value);
  }

  process.stdin.resume();
  process.stdin.on(event, listener);

  function listener(chunk) {
    var character = chunk.toString(encoding);

    switch (character) {
      case _constants.LINE_FEED_CHARACTER:
      case _constants.CARRIAGE_RETURN_CHARACTER:
        process.stdout.write(_constants.LINE_FEED_CHARACTER);
        process.stdin.removeListener(event, listener);
        process.stdin.pause();
        offETX();
        callback(value);
        break;

      case _constants.BACKSPACE_CHARACTER:
        value = value.slice(0, value.length - 1);
        process.stdout.clearLine();
        process.stdout.cursorTo(0);
        process.stdout.write(description);

        if (!hidden) {
          process.stdout.write(value);
        }

        break;

      default:
        value += character;

        if (!hidden) {
          process.stdout.clearLine();
          process.stdout.cursorTo(0);
          process.stdout.write(description);
          process.stdout.write(value);
        }

        break;
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb21wdC5qcyJdLCJuYW1lcyI6WyJwcm9tcHQiLCJvcHRpb25zIiwiY2FsbGJhY2siLCJ2YWx1ZSIsImF0dGVtcHRzIiwiY29udGV4dCIsImF0dGVtcHQiLCJuZXh0IiwiZG9uZSIsInRlcm1pbmF0ZSIsImhpZGRlbiIsImVuY29kaW5nIiwiZGVzY3JpcHRpb24iLCJpbml0aWFsVmFsdWUiLCJlcnJvck1lc3NhZ2UiLCJ2YWxpZGF0aW9uUGF0dGVybiIsInZhbGlkYXRpb25GdW5jdGlvbiIsImlucHV0IiwidmFsaWQiLCJ0ZXN0IiwiT2JqZWN0IiwiYXNzaWduIiwiY29uc29sZSIsImxvZyIsImV2ZW50IiwiREFUQV9FVkVOVCIsInJhd01vZGUiLCJvZmZFVFgiLCJDVFJMX0MiLCJwcm9jZXNzIiwiZXhpdCIsInN0ZGluIiwic2V0RW5jb2RpbmciLCJzZXRSYXdNb2RlIiwic3Rkb3V0Iiwid3JpdGUiLCJyZXN1bWUiLCJvbiIsImxpc3RlbmVyIiwiY2h1bmsiLCJjaGFyYWN0ZXIiLCJ0b1N0cmluZyIsIkxJTkVfRkVFRF9DSEFSQUNURVIiLCJDQVJSSUFHRV9SRVRVUk5fQ0hBUkFDVEVSIiwicmVtb3ZlTGlzdGVuZXIiLCJwYXVzZSIsIkJBQ0tTUEFDRV9DSEFSQUNURVIiLCJzbGljZSIsImxlbmd0aCIsImNsZWFyTGluZSIsImN1cnNvclRvIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOztBQUVBOztBQUVBOzs7O0FBRWUsU0FBU0EsTUFBVCxDQUFnQkMsT0FBaEIsRUFBeUJDLFFBQXpCLEVBQW1DO0FBQzFDLE1BQUFDLEtBQUssR0FBRyxJQUFSO0FBQUEsMEJBQ21CRixPQURuQixDQUNFRyxRQURGO0FBQUEsTUFDRUEsUUFERixrQ0FDYSxDQURiO0FBQUEsTUFFQUMsT0FGQSxHQUVVO0FBQ1JGLElBQUFBLEtBQUssRUFBTEEsS0FEUTtBQUVSQyxJQUFBQSxRQUFRLEVBQVJBLFFBRlE7QUFHUkgsSUFBQUEsT0FBTyxFQUFQQTtBQUhRLEdBRlY7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QUFDSyxNQUFSLENBQWVnQixRQUFmLENBQXdCLENBQXhCO0FBRUFyQixVQUFBQSxPQUFPLENBQUNLLE1BQVIsQ0FBZUMsS0FBZixDQUFxQnZCLFdBQXJCO0FBRUFpQixVQUFBQSxPQUFPLENBQUNLLE1BQVIsQ0FBZUMsS0FBZixDQUFxQmhDLEtBQXJCO0FBQ0Q7O0FBQ0Q7QUF4Q0o7QUEwQ0Q7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgb25FVFggZnJvbSBcIi4vb25FVFhcIjtcblxuaW1wb3J0IHsgd2hpbHN0IH0gZnJvbSBcIi4uLy4uL3V0aWxpdGllcy9hc3luY2hyb25vdXNcIjtcblxuaW1wb3J0IHsgQ1RSTF9DLCBEQVRBX0VWRU5ULCBCQUNLU1BBQ0VfQ0hBUkFDVEVSLCBMSU5FX0ZFRURfQ0hBUkFDVEVSLCBDQVJSSUFHRV9SRVRVUk5fQ0hBUkFDVEVSIH0gZnJvbSBcIi4uLy4uL2NvbnN0YW50c1wiO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBwcm9tcHQob3B0aW9ucywgY2FsbGJhY2spIHtcbiAgY29uc3QgdmFsdWUgPSBudWxsLFxuICAgICAgICB7IGF0dGVtcHRzID0gMyB9ID0gb3B0aW9ucyxcbiAgICAgICAgY29udGV4dCA9IHtcbiAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgICBhdHRlbXB0cyxcbiAgICAgICAgICBvcHRpb25zXG4gICAgICAgIH07XG5cbiAgd2hpbHN0KGF0dGVtcHQsICgpID0+IHtcbiAgICBjb25zdCB7IHZhbHVlIH0gPSBjb250ZXh0O1xuICAgIFxuICAgIGNhbGxiYWNrKHZhbHVlKTtcbiAgfSwgY29udGV4dCk7XG59XG5cbmZ1bmN0aW9uIGF0dGVtcHQobmV4dCwgZG9uZSwgY29udGV4dCkge1xuICBsZXQgeyBhdHRlbXB0cyB9ID0gY29udGV4dDtcblxuICBjb25zdCB0ZXJtaW5hdGUgPSAoYXR0ZW1wdHMtLSA9PT0gMCk7XG4gIFxuICBpZiAodGVybWluYXRlKSB7XG4gICAgZG9uZSgpO1xuICAgIFxuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHsgb3B0aW9ucyB9ID0gY29udGV4dCxcbiAgICAgICAgeyBoaWRkZW4gPSBmYWxzZSxcbiAgICAgICAgICBlbmNvZGluZyA9IFwidXRmOFwiLFxuICAgICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICAgIGluaXRpYWxWYWx1ZSA9IFwiXCIsXG4gICAgICAgICAgZXJyb3JNZXNzYWdlLFxuICAgICAgICAgIHZhbGlkYXRpb25QYXR0ZXJuLFxuICAgICAgICAgIHZhbGlkYXRpb25GdW5jdGlvbiB9ID0gb3B0aW9ucztcblxuICBpbnB1dChkZXNjcmlwdGlvbiwgaW5pdGlhbFZhbHVlLCBlbmNvZGluZywgaGlkZGVuLCBjYWxsYmFjayk7XG5cbiAgZnVuY3Rpb24gY2FsbGJhY2sodmFsdWUpIHtcbiAgICBjb25zdCB2YWxpZCA9IHZhbGlkYXRpb25GdW5jdGlvbiA/ICAvLy9cbiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGlvbkZ1bmN0aW9uKHZhbHVlKSA6XG4gICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGlvblBhdHRlcm4udGVzdCh2YWx1ZSk7XG5cbiAgICBpZiAodmFsaWQpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24oY29udGV4dCwge1xuICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgIH0pO1xuXG4gICAgICBkb25lKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKGVycm9yTWVzc2FnZSk7XG5cbiAgICAgIE9iamVjdC5hc3NpZ24oY29udGV4dCwge1xuICAgICAgICBhdHRlbXB0c1xuICAgICAgfSk7XG5cbiAgICAgIG5leHQoKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gaW5wdXQoZGVzY3JpcHRpb24sIGluaXRpYWxWYWx1ZSwgZW5jb2RpbmcsIGhpZGRlbiwgY2FsbGJhY2spIHtcbiAgbGV0IHZhbHVlID0gaW5pdGlhbFZhbHVlOyAvLy9cblxuICBjb25zdCBldmVudCA9IERBVEFfRVZFTlQsXG4gICAgICAgIHJhd01vZGUgPSB0cnVlLFxuICAgICAgICBvZmZFVFggPSBvbkVUWCgoKSA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coQ1RSTF9DKTtcblxuICAgICAgICAgIHByb2Nlc3MuZXhpdCgpO1xuICAgICAgICB9KTtcblxuICBwcm9jZXNzLnN0ZGluLnNldEVuY29kaW5nKGVuY29kaW5nKTtcblxuICBwcm9jZXNzLnN0ZGluLnNldFJhd01vZGUocmF3TW9kZSk7XG5cbiAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoZGVzY3JpcHRpb24pO1xuXG4gIGlmICghaGlkZGVuKSB7XG4gICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUodmFsdWUpO1xuICB9XG5cbiAgcHJvY2Vzcy5zdGRpbi5yZXN1bWUoKTtcblxuICBwcm9jZXNzLnN0ZGluLm9uKGV2ZW50LCBsaXN0ZW5lcik7XG5cbiAgZnVuY3Rpb24gbGlzdGVuZXIoY2h1bmspIHtcbiAgICBjb25zdCBjaGFyYWN0ZXIgPSBjaHVuay50b1N0cmluZyhlbmNvZGluZyk7XG5cbiAgICBzd2l0Y2ggKGNoYXJhY3Rlcikge1xuICAgICAgY2FzZSBMSU5FX0ZFRURfQ0hBUkFDVEVSIDpcbiAgICAgIGNhc2UgQ0FSUklBR0VfUkVUVVJOX0NIQVJBQ1RFUiA6XG4gICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKExJTkVfRkVFRF9DSEFSQUNURVIpO1xuXG4gICAgICAgIHByb2Nlc3Muc3RkaW4ucmVtb3ZlTGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyKTtcblxuICAgICAgICBwcm9jZXNzLnN0ZGluLnBhdXNlKCk7XG5cbiAgICAgICAgb2ZmRVRYKCk7XG5cbiAgICAgICAgY2FsbGJhY2sodmFsdWUpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBCQUNLU1BBQ0VfQ0hBUkFDVEVSIDpcbiAgICAgICAgdmFsdWUgPSB2YWx1ZS5zbGljZSgwLCB2YWx1ZS5sZW5ndGggLSAxKTtcblxuICAgICAgICBwcm9jZXNzLnN0ZG91dC5jbGVhckxpbmUoKTtcblxuICAgICAgICBwcm9jZXNzLnN0ZG91dC5jdXJzb3JUbygwKTtcblxuICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShkZXNjcmlwdGlvbik7XG5cbiAgICAgICAgaWYgKCFoaWRkZW4pIHtcbiAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHZhbHVlICs9IGNoYXJhY3RlcjtcblxuICAgICAgICBpZiAoIWhpZGRlbikge1xuICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0LmNsZWFyTGluZSgpO1xuXG4gICAgICAgICAgcHJvY2Vzcy5zdGRvdXQuY3Vyc29yVG8oMCk7XG5cbiAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShkZXNjcmlwdGlvbik7XG5cbiAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG59XG4iXX0=