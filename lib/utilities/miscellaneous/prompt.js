'use strict';

var onETX = require('./onETX'),
    asynchronousUtilities = require('../../utilities/asynchronous');

var _process = process,
    stdin = _process.stdin,
    stdout = _process.stdout,
    whilst = asynchronousUtilities.whilst,
    _process2 = process,
    exit = _process2.exit;
var BACKSPACE_CHARACTER = String.fromCharCode(127),
    LINE_FEED_CHARACTER = '\n',
    CARRIAGE_RETURN_CHARACTER = '\r';

function prompt(options, callback) {
  var value = null,
      _options$attempts = options.attempts,
      attempts = _options$attempts === void 0 ? 3 : _options$attempts,
      context = {
    value: value,
    attempts: attempts,
    options: options
  };
  whilst(attempt, function () {
    var value = context.value;
    callback(value);
  }, context);
}

module.exports = prompt;

function attempt(next, done, context) {
  var attempts = context.attempts;
  var terminate = attempts-- === 0;

  if (terminate) {
    done();
    return;
  }

  var options = context.options,
      _options$hidden = options.hidden,
      hidden = _options$hidden === void 0 ? false : _options$hidden,
      _options$encoding = options.encoding,
      encoding = _options$encoding === void 0 ? 'utf8' : _options$encoding,
      description = options.description,
      _options$initialValue = options.initialValue,
      initialValue = _options$initialValue === void 0 ? '' : _options$initialValue,
      errorMessage = options.errorMessage,
      validationPattern = options.validationPattern,
      validationFunction = options.validationFunction;
  input(description, initialValue, encoding, hidden, callback);

  function callback(value) {
    var valid = validationFunction ? ///
    validationFunction(value) : validationPattern.test(value);

    if (valid) {
      Object.assign(context, {
        value: value
      });
      done();
    } else {
      console.log(errorMessage);
      Object.assign(context, {
        attempts: attempts
      });
      next();
    }
  }
}

function input(description, initialValue, encoding, hidden, callback) {
  var value = initialValue; ///

  var rawMode = true,
      offETX = onETX(function () {
    console.log('^C');
    exit();
  });
  stdin.setEncoding(encoding);
  stdin.setRawMode(rawMode);
  stdout.write(description);

  if (!hidden) {
    stdout.write(value);
  }

  stdin.resume();
  stdin.on('data', listener);

  function listener(chunk) {
    var character = chunk.toString(encoding);

    switch (character) {
      case LINE_FEED_CHARACTER:
      case CARRIAGE_RETURN_CHARACTER:
        stdout.write(LINE_FEED_CHARACTER);
        stdin.removeListener('data', listener);
        stdin.pause();
        offETX();
        callback(value);
        break;

      case BACKSPACE_CHARACTER:
        value = value.slice(0, value.length - 1);
        stdout.clearLine();
        stdout.cursorTo(0);
        stdout.write(description);

        if (!hidden) {
          stdout.write(value);
        }

        break;

      default:
        value += character;

        if (!hidden) {
          stdout.clearLine();
          stdout.cursorTo(0);
          stdout.write(description);
          stdout.write(value);
        }

        break;
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb21wdC5qcyJdLCJuYW1lcyI6WyJvbkVUWCIsInJlcXVpcmUiLCJhc3luY2hyb25vdXNVdGlsaXRpZXMiLCJwcm9jZXNzIiwic3RkaW4iLCJzdGRvdXQiLCJ3aGlsc3QiLCJleGl0IiwiQkFDS1NQQUNFX0NIQVJBQ1RFUiIsIlN0cmluZyIsImZyb21DaGFyQ29kZSIsIkxJTkVfRkVFRF9DSEFSQUNURVIiLCJDQVJSSUFHRV9SRVRVUk5fQ0hBUkFDVEVSIiwicHJvbXB0Iiwib3B0aW9ucyIsImNhbGxiYWNrIiwidmFsdWUiLCJhdHRlbXB0cyIsImNvbnRleHQiLCJhdHRlbXB0IiwibW9kdWxlIiwiZXhwb3J0cyIsIm5leHQiLCJkb25lIiwidGVybWluYXRlIiwiaGlkZGVuIiwiZW5jb2RpbmciLCJkZXNjcmlwdGlvbiIsImluaXRpYWxWYWx1ZSIsImVycm9yTWVzc2FnZSIsInZhbGlkYXRpb25QYXR0ZXJuIiwidmFsaWRhdGlvbkZ1bmN0aW9uIiwiaW5wdXQiLCJ2YWxpZCIsInRlc3QiLCJPYmplY3QiLCJhc3NpZ24iLCJjb25zb2xlIiwibG9nIiwicmF3TW9kZSIsIm9mZkVUWCIsInNldEVuY29kaW5nIiwic2V0UmF3TW9kZSIsIndyaXRlIiwicmVzdW1lIiwib24iLCJsaXN0ZW5lciIsImNodW5rIiwiY2hhcmFjdGVyIiwidG9TdHJpbmciLCJyZW1vdmVMaXN0ZW5lciIsInBhdXNlIiwic2xpY2UiLCJsZW5ndGgiLCJjbGVhckxpbmUiLCJjdXJzb3JUbyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsS0FBSyxHQUFHQyxPQUFPLENBQUMsU0FBRCxDQUFyQjtBQUFBLElBQ01DLHFCQUFxQixHQUFHRCxPQUFPLENBQUMsOEJBQUQsQ0FEckM7O2VBRzBCRSxPO0lBQWxCQyxLLFlBQUFBLEs7SUFBT0MsTSxZQUFBQSxNO0lBQ1BDLE0sR0FBV0oscUIsQ0FBWEksTTtnQkFDU0gsTztJQUFUSSxJLGFBQUFBLEk7QUFFUixJQUFNQyxtQkFBbUIsR0FB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QyxLQUFQLENBQWFoQixXQUFiOztBQUVBLFlBQUksQ0FBQ0YsTUFBTCxFQUFhO0FBQ1hwQixVQUFBQSxNQUFNLENBQUNzQyxLQUFQLENBQWEzQixLQUFiO0FBQ0Q7O0FBQ0Q7O0FBRUY7QUFDRUEsUUFBQUEsS0FBSyxJQUFJZ0MsU0FBVDs7QUFFQSxZQUFJLENBQUN2QixNQUFMLEVBQWE7QUFDWHBCLFVBQUFBLE1BQU0sQ0FBQ2lELFNBQVA7QUFFQWpELFVBQUFBLE1BQU0sQ0FBQ2tELFFBQVAsQ0FBZ0IsQ0FBaEI7QUFFQWxELFVBQUFBLE1BQU0sQ0FBQ3NDLEtBQVAsQ0FBYWhCLFdBQWI7QUFFQXRCLFVBQUFBLE1BQU0sQ0FBQ3NDLEtBQVAsQ0FBYTNCLEtBQWI7QUFDRDs7QUFDRDtBQXhDSjtBQTBDRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBvbkVUWCA9IHJlcXVpcmUoJy4vb25FVFgnKSxcbiAgICAgIGFzeW5jaHJvbm91c1V0aWxpdGllcyA9IHJlcXVpcmUoJy4uLy4uL3V0aWxpdGllcy9hc3luY2hyb25vdXMnKTtcblxuY29uc3QgeyBzdGRpbiwgc3Rkb3V0IH0gPSBwcm9jZXNzLFxuICAgICAgeyB3aGlsc3QgfSA9IGFzeW5jaHJvbm91c1V0aWxpdGllcyxcbiAgICAgIHsgZXhpdCB9ID0gcHJvY2VzcztcblxuY29uc3QgQkFDS1NQQUNFX0NIQVJBQ1RFUiA9IFN0cmluZy5mcm9tQ2hhckNvZGUoMTI3KSxcbiAgICAgIExJTkVfRkVFRF9DSEFSQUNURVIgPSAnXFxuJyxcbiAgICAgIENBUlJJQUdFX1JFVFVSTl9DSEFSQUNURVIgPSAnXFxyJztcblxuZnVuY3Rpb24gcHJvbXB0KG9wdGlvbnMsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IHZhbHVlID0gbnVsbCxcbiAgICAgICAgeyBhdHRlbXB0cyA9IDMgfSA9IG9wdGlvbnMsXG4gICAgICAgIGNvbnRleHQgPSB7XG4gICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgYXR0ZW1wdHMsXG4gICAgICAgICAgb3B0aW9uc1xuICAgICAgICB9O1xuXG4gIHdoaWxzdChhdHRlbXB0LCBmdW5jdGlvbigpIHtcbiAgICBjb25zdCB7IHZhbHVlIH0gPSBjb250ZXh0O1xuICAgIFxuICAgIGNhbGxiYWNrKHZhbHVlKTtcbiAgfSwgY29udGV4dCk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gcHJvbXB0O1xuXG5mdW5jdGlvbiBhdHRlbXB0KG5leHQsIGRvbmUsIGNvbnRleHQpIHtcbiAgbGV0IHsgYXR0ZW1wdHMgfSA9IGNvbnRleHQ7XG5cbiAgY29uc3QgdGVybWluYXRlID0gKGF0dGVtcHRzLS0gPT09IDApO1xuICBcbiAgaWYgKHRlcm1pbmF0ZSkge1xuICAgIGRvbmUoKTtcbiAgICBcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCB7IG9wdGlvbnMgfSA9IGNvbnRleHQsXG4gICAgICAgIHsgaGlkZGVuID0gZmFsc2UsXG4gICAgICAgICAgZW5jb2RpbmcgPSAndXRmOCcsXG4gICAgICAgICAgZGVzY3JpcHRpb24sXG4gICAgICAgICAgaW5pdGlhbFZhbHVlID0gJycsXG4gICAgICAgICAgZXJyb3JNZXNzYWdlLFxuICAgICAgICAgIHZhbGlkYXRpb25QYXR0ZXJuLFxuICAgICAgICAgIHZhbGlkYXRpb25GdW5jdGlvbiB9ID0gb3B0aW9ucztcblxuICBpbnB1dChkZXNjcmlwdGlvbiwgaW5pdGlhbFZhbHVlLCBlbmNvZGluZywgaGlkZGVuLCBjYWxsYmFjayk7XG5cbiAgZnVuY3Rpb24gY2FsbGJhY2sodmFsdWUpIHtcbiAgICBjb25zdCB2YWxpZCA9IHZhbGlkYXRpb25GdW5jdGlvbiA/ICAvLy9cbiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGlvbkZ1bmN0aW9uKHZhbHVlKSA6XG4gICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGlvblBhdHRlcm4udGVzdCh2YWx1ZSk7XG5cbiAgICBpZiAodmFsaWQpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24oY29udGV4dCwge1xuICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgIH0pO1xuXG4gICAgICBkb25lKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKGVycm9yTWVzc2FnZSk7XG5cbiAgICAgIE9iamVjdC5hc3NpZ24oY29udGV4dCwge1xuICAgICAgICBhdHRlbXB0c1xuICAgICAgfSk7XG5cbiAgICAgIG5leHQoKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gaW5wdXQoZGVzY3JpcHRpb24sIGluaXRpYWxWYWx1ZSwgZW5jb2RpbmcsIGhpZGRlbiwgY2FsbGJhY2spIHtcbiAgbGV0IHZhbHVlID0gaW5pdGlhbFZhbHVlOyAvLy9cblxuICBjb25zdCByYXdNb2RlID0gdHJ1ZSxcbiAgICAgICAgb2ZmRVRYID0gb25FVFgoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ15DJyk7XG5cbiAgICAgICAgICBleGl0KCk7XG4gICAgICAgIH0pO1xuXG4gIHN0ZGluLnNldEVuY29kaW5nKGVuY29kaW5nKTtcblxuICBzdGRpbi5zZXRSYXdNb2RlKHJhd01vZGUpO1xuXG4gIHN0ZG91dC53cml0ZShkZXNjcmlwdGlvbik7XG5cbiAgaWYgKCFoaWRkZW4pIHtcbiAgICBzdGRvdXQud3JpdGUodmFsdWUpO1xuICB9XG5cbiAgc3RkaW4ucmVzdW1lKCk7XG5cbiAgc3RkaW4ub24oJ2RhdGEnLCBsaXN0ZW5lcik7XG5cbiAgZnVuY3Rpb24gbGlzdGVuZXIoY2h1bmspIHtcbiAgICBjb25zdCBjaGFyYWN0ZXIgPSBjaHVuay50b1N0cmluZyhlbmNvZGluZyk7XG5cbiAgICBzd2l0Y2ggKGNoYXJhY3Rlcikge1xuICAgICAgY2FzZSBMSU5FX0ZFRURfQ0hBUkFDVEVSIDpcbiAgICAgIGNhc2UgQ0FSUklBR0VfUkVUVVJOX0NIQVJBQ1RFUiA6XG4gICAgICAgIHN0ZG91dC53cml0ZShMSU5FX0ZFRURfQ0hBUkFDVEVSKTtcblxuICAgICAgICBzdGRpbi5yZW1vdmVMaXN0ZW5lcignZGF0YScsIGxpc3RlbmVyKTtcblxuICAgICAgICBzdGRpbi5wYXVzZSgpO1xuXG4gICAgICAgIG9mZkVUWCgpO1xuXG4gICAgICAgIGNhbGxiYWNrKHZhbHVlKTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgQkFDS1NQQUNFX0NIQVJBQ1RFUiA6XG4gICAgICAgIHZhbHVlID0gdmFsdWUuc2xpY2UoMCwgdmFsdWUubGVuZ3RoIC0gMSk7XG5cbiAgICAgICAgc3Rkb3V0LmNsZWFyTGluZSgpO1xuXG4gICAgICAgIHN0ZG91dC5jdXJzb3JUbygwKTtcblxuICAgICAgICBzdGRvdXQud3JpdGUoZGVzY3JpcHRpb24pO1xuXG4gICAgICAgIGlmICghaGlkZGVuKSB7XG4gICAgICAgICAgc3Rkb3V0LndyaXRlKHZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdmFsdWUgKz0gY2hhcmFjdGVyO1xuXG4gICAgICAgIGlmICghaGlkZGVuKSB7XG4gICAgICAgICAgc3Rkb3V0LmNsZWFyTGluZSgpO1xuXG4gICAgICAgICAgc3Rkb3V0LmN1cnNvclRvKDApO1xuXG4gICAgICAgICAgc3Rkb3V0LndyaXRlKGRlc2NyaXB0aW9uKTtcblxuICAgICAgICAgIHN0ZG91dC53cml0ZSh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG59XG4iXX0=