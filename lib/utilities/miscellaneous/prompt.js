"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = prompt;

var _onETX = _interopRequireDefault(require("./onETX"));

var _asynchronous = require("../../utilities/asynchronous");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var _process = process,
    stdin = _process.stdin,
    stdout = _process.stdout,
    exit = _process.exit;
var BACKSPACE_CHARACTER = String.fromCharCode(127),
    LINE_FEED_CHARACTER = "\n",
    CARRIAGE_RETURN_CHARACTER = "\r";

function prompt(options, callback) {
  var value = null,
      _options$attempts = options.attempts,
      attempts = _options$attempts === void 0 ? 3 : _options$attempts,
      context = {
    value: value,
    attempts: attempts,
    options: options
  };
  (0, _asynchronous.whilst)(attempt, function () {
    var value = context.value;
    callback(value);
  }, context);
}

function attempt(next, done, context) {
  var attempts = context.attempts;
  var terminate = attempts-- === 0;

  if (terminate) {
    done();
    return;
  }

  var options = context.options,
      _options$hidden = options.hidden,
      hidden = _options$hidden === void 0 ? false : _options$hidden,
      _options$encoding = options.encoding,
      encoding = _options$encoding === void 0 ? "utf8" : _options$encoding,
      description = options.description,
      _options$initialValue = options.initialValue,
      initialValue = _options$initialValue === void 0 ? "" : _options$initialValue,
      errorMessage = options.errorMessage,
      validationPattern = options.validationPattern,
      validationFunction = options.validationFunction;
  input(description, initialValue, encoding, hidden, callback);

  function callback(value) {
    var valid = validationFunction ? ///
    validationFunction(value) : validationPattern.test(value);

    if (valid) {
      Object.assign(context, {
        value: value
      });
      done();
    } else {
      console.log(errorMessage);
      Object.assign(context, {
        attempts: attempts
      });
      next();
    }
  }
}

function input(description, initialValue, encoding, hidden, callback) {
  var value = initialValue; ///

  var rawMode = true,
      offETX = (0, _onETX["default"])(function () {
    console.log("^C");
    exit();
  });
  stdin.setEncoding(encoding);
  stdin.setRawMode(rawMode);
  stdout.write(description);

  if (!hidden) {
    stdout.write(value);
  }

  stdin.resume();
  stdin.on("data", listener);

  function listener(chunk) {
    var character = chunk.toString(encoding);

    switch (character) {
      case LINE_FEED_CHARACTER:
      case CARRIAGE_RETURN_CHARACTER:
        stdout.write(LINE_FEED_CHARACTER);
        stdin.removeListener("data", listener);
        stdin.pause();
        offETX();
        callback(value);
        break;

      case BACKSPACE_CHARACTER:
        value = value.slice(0, value.length - 1);
        stdout.clearLine();
        stdout.cursorTo(0);
        stdout.write(description);

        if (!hidden) {
          stdout.write(value);
        }

        break;

      default:
        value += character;

        if (!hidden) {
          stdout.clearLine();
          stdout.cursorTo(0);
          stdout.write(description);
          stdout.write(value);
        }

        break;
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb21wdC5qcyJdLCJuYW1lcyI6WyJwcm9jZXNzIiwic3RkaW4iLCJzdGRvdXQiLCJleGl0IiwiQkFDS1NQQUNFX0NIQVJBQ1RFUiIsIlN0cmluZyIsImZyb21DaGFyQ29kZSIsIkxJTkVfRkVFRF9DSEFSQUNURVIiLCJDQVJSSUFHRV9SRVRVUk5fQ0hBUkFDVEVSIiwicHJvbXB0Iiwib3B0aW9ucyIsImNhbGxiYWNrIiwidmFsdWUiLCJhdHRlbXB0cyIsImNvbnRleHQiLCJhdHRlbXB0IiwibmV4dCIsImRvbmUiLCJ0ZXJtaW5hdGUiLCJoaWRkZW4iLCJlbmNvZGluZyIsImRlc2NyaXB0aW9uIiwiaW5pdGlhbFZhbHVlIiwiZXJyb3JNZXNzYWdlIiwidmFsaWRhdGlvblBhdHRlcm4iLCJ2YWxpZGF0aW9uRnVuY3Rpb24iLCJpbnB1dCIsInZhbGlkIiwidGVzdCIsIk9iamVjdCIsImFzc2lnbiIsImNvbnNvbGUiLCJsb2ciLCJyYXdNb2RlIiwib2ZmRVRYIiwic2V0RW5jb2RpbmciLCJzZXRSYXdNb2RlIiwid3JpdGUiLCJyZXN1bWUiLCJvbiIsImxpc3RlbmVyIiwiY2h1bmsiLCJjaGFyYWN0ZXIiLCJ0b1N0cmluZyIsInJlbW92ZUxpc3RlbmVyIiwicGF1c2UiLCJzbGljZSIsImxlbmd0aCIsImNsZWFyTGluZSIsImN1cnNvclRvIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOztBQUVBOzs7O2VBRWdDQSxPO0lBQXhCQyxLLFlBQUFBLEs7SUFBT0MsTSxZQUFBQSxNO0lBQVFDLEksWUFBQUEsSTtBQUV2QixJQUFNQyxtQkFBbUIsR0FBR0MsTUFBTSxDQUFDQyxZQUFQLENBQW9CLEdBQXBCLENBQTVCO0FBQUEsSUFDTUMsbUJBQW1CLEdBQUcsSUFENUI7QUFBQSxJQUVNQyx5QkFBeUIsR0FBRyxJQUZsQzs7QUFJZSxTQUFTQyxNQUFULENBQWdCQyxPQUFoQixFQUF5QkMsUUFBekIsRUFBbUM7QUFDMUMsTUFBQUMsS0FBSyxHQUFHLElBQVI7QUFB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QUFBLE1BQU0sQ0FBQ21DLEtBQVAsQ0FBYWhCLFdBQWI7QUFFQW5CLFVBQUFBLE1BQU0sQ0FBQ21DLEtBQVAsQ0FBYXpCLEtBQWI7QUFDRDs7QUFDRDtBQXhDSjtBQTBDRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCBvbkVUWCBmcm9tIFwiLi9vbkVUWFwiO1xuXG5pbXBvcnQgeyB3aGlsc3QgfSBmcm9tIFwiLi4vLi4vdXRpbGl0aWVzL2FzeW5jaHJvbm91c1wiO1xuXG5jb25zdCB7IHN0ZGluLCBzdGRvdXQsIGV4aXQgfSA9IHByb2Nlc3M7XG5cbmNvbnN0IEJBQ0tTUEFDRV9DSEFSQUNURVIgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDEyNyksXG4gICAgICBMSU5FX0ZFRURfQ0hBUkFDVEVSID0gXCJcXG5cIixcbiAgICAgIENBUlJJQUdFX1JFVFVSTl9DSEFSQUNURVIgPSBcIlxcclwiO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBwcm9tcHQob3B0aW9ucywgY2FsbGJhY2spIHtcbiAgY29uc3QgdmFsdWUgPSBudWxsLFxuICAgICAgICB7IGF0dGVtcHRzID0gMyB9ID0gb3B0aW9ucyxcbiAgICAgICAgY29udGV4dCA9IHtcbiAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgICBhdHRlbXB0cyxcbiAgICAgICAgICBvcHRpb25zXG4gICAgICAgIH07XG5cbiAgd2hpbHN0KGF0dGVtcHQsICgpID0+IHtcbiAgICBjb25zdCB7IHZhbHVlIH0gPSBjb250ZXh0O1xuICAgIFxuICAgIGNhbGxiYWNrKHZhbHVlKTtcbiAgfSwgY29udGV4dCk7XG59XG5cbmZ1bmN0aW9uIGF0dGVtcHQobmV4dCwgZG9uZSwgY29udGV4dCkge1xuICBsZXQgeyBhdHRlbXB0cyB9ID0gY29udGV4dDtcblxuICBjb25zdCB0ZXJtaW5hdGUgPSAoYXR0ZW1wdHMtLSA9PT0gMCk7XG4gIFxuICBpZiAodGVybWluYXRlKSB7XG4gICAgZG9uZSgpO1xuICAgIFxuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHsgb3B0aW9ucyB9ID0gY29udGV4dCxcbiAgICAgICAgeyBoaWRkZW4gPSBmYWxzZSxcbiAgICAgICAgICBlbmNvZGluZyA9IFwidXRmOFwiLFxuICAgICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICAgIGluaXRpYWxWYWx1ZSA9IFwiXCIsXG4gICAgICAgICAgZXJyb3JNZXNzYWdlLFxuICAgICAgICAgIHZhbGlkYXRpb25QYXR0ZXJuLFxuICAgICAgICAgIHZhbGlkYXRpb25GdW5jdGlvbiB9ID0gb3B0aW9ucztcblxuICBpbnB1dChkZXNjcmlwdGlvbiwgaW5pdGlhbFZhbHVlLCBlbmNvZGluZywgaGlkZGVuLCBjYWxsYmFjayk7XG5cbiAgZnVuY3Rpb24gY2FsbGJhY2sodmFsdWUpIHtcbiAgICBjb25zdCB2YWxpZCA9IHZhbGlkYXRpb25GdW5jdGlvbiA/ICAvLy9cbiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGlvbkZ1bmN0aW9uKHZhbHVlKSA6XG4gICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGlvblBhdHRlcm4udGVzdCh2YWx1ZSk7XG5cbiAgICBpZiAodmFsaWQpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24oY29udGV4dCwge1xuICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgIH0pO1xuXG4gICAgICBkb25lKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKGVycm9yTWVzc2FnZSk7XG5cbiAgICAgIE9iamVjdC5hc3NpZ24oY29udGV4dCwge1xuICAgICAgICBhdHRlbXB0c1xuICAgICAgfSk7XG5cbiAgICAgIG5leHQoKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gaW5wdXQoZGVzY3JpcHRpb24sIGluaXRpYWxWYWx1ZSwgZW5jb2RpbmcsIGhpZGRlbiwgY2FsbGJhY2spIHtcbiAgbGV0IHZhbHVlID0gaW5pdGlhbFZhbHVlOyAvLy9cblxuICBjb25zdCByYXdNb2RlID0gdHJ1ZSxcbiAgICAgICAgb2ZmRVRYID0gb25FVFgoKCkgPT4ge1xuICAgICAgICAgIGNvbnNvbGUubG9nKFwiXkNcIik7XG5cbiAgICAgICAgICBleGl0KCk7XG4gICAgICAgIH0pO1xuXG4gIHN0ZGluLnNldEVuY29kaW5nKGVuY29kaW5nKTtcblxuICBzdGRpbi5zZXRSYXdNb2RlKHJhd01vZGUpO1xuXG4gIHN0ZG91dC53cml0ZShkZXNjcmlwdGlvbik7XG5cbiAgaWYgKCFoaWRkZW4pIHtcbiAgICBzdGRvdXQud3JpdGUodmFsdWUpO1xuICB9XG5cbiAgc3RkaW4ucmVzdW1lKCk7XG5cbiAgc3RkaW4ub24oXCJkYXRhXCIsIGxpc3RlbmVyKTtcblxuICBmdW5jdGlvbiBsaXN0ZW5lcihjaHVuaykge1xuICAgIGNvbnN0IGNoYXJhY3RlciA9IGNodW5rLnRvU3RyaW5nKGVuY29kaW5nKTtcblxuICAgIHN3aXRjaCAoY2hhcmFjdGVyKSB7XG4gICAgICBjYXNlIExJTkVfRkVFRF9DSEFSQUNURVIgOlxuICAgICAgY2FzZSBDQVJSSUFHRV9SRVRVUk5fQ0hBUkFDVEVSIDpcbiAgICAgICAgc3Rkb3V0LndyaXRlKExJTkVfRkVFRF9DSEFSQUNURVIpO1xuXG4gICAgICAgIHN0ZGluLnJlbW92ZUxpc3RlbmVyKFwiZGF0YVwiLCBsaXN0ZW5lcik7XG5cbiAgICAgICAgc3RkaW4ucGF1c2UoKTtcblxuICAgICAgICBvZmZFVFgoKTtcblxuICAgICAgICBjYWxsYmFjayh2YWx1ZSk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIEJBQ0tTUEFDRV9DSEFSQUNURVIgOlxuICAgICAgICB2YWx1ZSA9IHZhbHVlLnNsaWNlKDAsIHZhbHVlLmxlbmd0aCAtIDEpO1xuXG4gICAgICAgIHN0ZG91dC5jbGVhckxpbmUoKTtcblxuICAgICAgICBzdGRvdXQuY3Vyc29yVG8oMCk7XG5cbiAgICAgICAgc3Rkb3V0LndyaXRlKGRlc2NyaXB0aW9uKTtcblxuICAgICAgICBpZiAoIWhpZGRlbikge1xuICAgICAgICAgIHN0ZG91dC53cml0ZSh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHZhbHVlICs9IGNoYXJhY3RlcjtcblxuICAgICAgICBpZiAoIWhpZGRlbikge1xuICAgICAgICAgIHN0ZG91dC5jbGVhckxpbmUoKTtcblxuICAgICAgICAgIHN0ZG91dC5jdXJzb3JUbygwKTtcblxuICAgICAgICAgIHN0ZG91dC53cml0ZShkZXNjcmlwdGlvbik7XG5cbiAgICAgICAgICBzdGRvdXQud3JpdGUodmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxufVxuIl19