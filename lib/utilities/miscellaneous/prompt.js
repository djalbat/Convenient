'use strict';

var onETX = require('./onETX'),
    asynchronousUtilities = require('../../utilities/asynchronous');

var _process = process,
    stdin = _process.stdin,
    stdout = _process.stdout,
    whilst = asynchronousUtilities.whilst,
    _process2 = process,
    exit = _process2.exit;


var BACKSPACE_CHARACTER = String.fromCharCode(127),
    LINE_FEED_CHARACTER = '\n',
    CARRIAGE_RETURN_CHARACTER = '\r';

function prompt(options, callback) {
  var value = null,
      _options$attempts = options.attempts,
      attempts = _options$attempts === undefined ? 3 : _options$attempts,
      context = {
    value: value,
    attempts: attempts,
    options: options
  };


  whilst(attempt, function () {
    var value = context.value;


    callback(value);
  }, context);
}

module.exports = prompt;

function attempt(next, done, context) {
  var attempts = context.attempts;


  var terminate = attempts-- === 0;

  if (terminate) {
    done();

    return;
  }

  var options = context.options,
      description = options.description,
      errorMessage = options.errorMessage,
      validationPattern = options.validationPattern,
      validationFunction = options.validationFunction,
      _options$encoding = options.encoding,
      encoding = _options$encoding === undefined ? 'utf8' : _options$encoding,
      _options$hidden = options.hidden,
      hidden = _options$hidden === undefined ? false : _options$hidden;


  hidden ? hiddenInput(description, encoding, callback) : visibleInput(description, encoding, callback);

  function callback(value) {
    var valid = validationFunction ? ///
    validationFunction(value) : validationPattern.test(value);

    if (valid) {
      Object.assign(context, {
        value: value
      });

      done();
    } else {
      console.log(errorMessage);

      Object.assign(context, {
        attempts: attempts
      });

      next();
    }
  }
}

function visibleInput(description, encoding, callback) {
  var rawMode = false;

  stdout.write(description);

  stdin.setEncoding(encoding);

  stdin.setRawMode(rawMode);

  stdin.resume();

  var value = void 0;

  var listener = function listener(chunk) {
    value = chunk.trim();

    stdin.removeListener('data', listener);

    stdin.pause();

    callback(value);
  };

  stdin.on('data', listener);
}

function hiddenInput(description, encoding, callback) {
  var rawMode = true,
      offETX = onETX(function () {
    console.log('^C');

    exit();
  });

  stdout.write(description);

  stdin.setEncoding(encoding);

  stdin.setRawMode(rawMode);

  stdin.resume();

  var value = '';

  var listener = function listener(chunk) {
    var character = chunk.toString(encoding);

    switch (character) {
      case LINE_FEED_CHARACTER:
      case CARRIAGE_RETURN_CHARACTER:
        stdout.write(LINE_FEED_CHARACTER);

        stdin.removeListener('data', listener);

        stdin.pause();

        offETX();

        callback(value);
        break;

      case BACKSPACE_CHARACTER:
        value = truncate(value);

        stdout.clearLine();

        stdout.cursorTo(0);

        stdout.write(description);
        break;

      default:
        value += character;
        break;
    }
  };

  stdin.on('data', listener);
}

function truncate(value) {
  return value.slice(0, value.length - 1);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2VzNi91dGlsaXRpZXMvbWlzY2VsbGFuZW91cy9wcm9tcHQuanMiXSwibmFtZXMiOlsib25FVFgiLCJyZXF1aXJlIiwiYXN5bmNocm9ub3VzVXRpbGl0aWVzIiwicHJvY2VzcyIsInN0ZGluIiwic3Rkb3V0Iiwid2hpbHN0IiwiZXhpdCIsIkJBQ0tTUEFDRV9DSEFSQUNURVIiLCJTdHJpbmciLCJmcm9tQ2hhckNvZGUiLCJMSU5FX0ZFRURfQ0hBUkFDVEVSIiwiQ0FSUklBR0VfUkVUVVJOX0NIQVJBQ1RFUiIsInByb21wdCIsIm9wdGlvbnMiLCJjYWxsYmFjayIsImF0dGVtcHRzIiwiY29udGV4dCIsInZhbHVlIiwiYXR0ZW1wdCIsIm1vZHVsZSIsImV4cG9ydHMiLCJuZXh0IiwiZG9uZSIsInRlcm1pbmF0ZSIsImRlc2NyaXB0aW9uIiwiZXJyb3JNZXNzYWdlIiwidmFsaWRhdGlvblBhdHRlcm4iLCJ2YWxpZGF0aW9uRnVuY3Rpb24iLCJlbmNvZGluZyIsImhpZGRlbiIsImhpZGRlbklucHV0IiwidmlzaWJsZUlucHV0IiwidmFsaWQiLCJ0ZXN0IiwiT2JqZWN0IiwiYXNzaWduIiwiY29uc29sZSIsImxvZyIsInJhd01vZGUiLCJ3cml0ZSIsInNldEVuY29kaW5nIiwic2V0UmF3TW9kZSIsInJlc3VtZSIsImxpc3RlbmVyIiwiY2h1bmsiLCJ0cmltIiwicmVtb3ZlTGlzdGVuZXIiLCJwYXVzZSIsIm9uIiwib2ZmRVRYIiwiY2hhcmFjdGVyIiwidG9TdHJpbmciLCJ0cnVuY2F0ZSIsImNsZWFyTGluZSIsImN1cnNvclRvIiwic2xpY2UiLCJsZW5ndGgiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQU1BLFFBQVFDLFFBQVEsU0FBUixDQUFkO0FBQUEsSUFDTUMsd0JBQXdCRCxRQUFRLDhCQUFSLENBRDlCOztlQUcwQkUsTztJQUFsQkMsSyxZQUFBQSxLO0lBQU9DLE0sWUFBQUEsTTtJQUNQQyxNLEdBQVdKLHFCLENBQVhJLE07Z0JBQ1NI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T0EsTUFBTXNDLEtBQU4sQ0FBWSxDQUFaLEVBQWV0QyxNQUFNdUMsTUFBTixHQUFlLENBQTlCLENBQVA7QUFBMEMiLCJmaWxlIjoicHJvbXB0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBvbkVUWCA9IHJlcXVpcmUoJy4vb25FVFgnKSxcbiAgICAgIGFzeW5jaHJvbm91c1V0aWxpdGllcyA9IHJlcXVpcmUoJy4uLy4uL3V0aWxpdGllcy9hc3luY2hyb25vdXMnKTtcblxuY29uc3QgeyBzdGRpbiwgc3Rkb3V0IH0gPSBwcm9jZXNzLFxuICAgICAgeyB3aGlsc3QgfSA9IGFzeW5jaHJvbm91c1V0aWxpdGllcyxcbiAgICAgIHsgZXhpdCB9ID0gcHJvY2VzcztcblxuY29uc3QgQkFDS1NQQUNFX0NIQVJBQ1RFUiA9IFN0cmluZy5mcm9tQ2hhckNvZGUoMTI3KSxcbiAgICAgIExJTkVfRkVFRF9DSEFSQUNURVIgPSAnXFxuJyxcbiAgICAgIENBUlJJQUdFX1JFVFVSTl9DSEFSQUNURVIgPSAnXFxyJztcblxuZnVuY3Rpb24gcHJvbXB0KG9wdGlvbnMsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IHZhbHVlID0gbnVsbCxcbiAgICAgICAgeyBhdHRlbXB0cyA9IDMgfSA9IG9wdGlvbnMsXG4gICAgICAgIGNvbnRleHQgPSB7XG4gICAgICAgICAgdmFsdWU6IHZhbHVlLFxuICAgICAgICAgIGF0dGVtcHRzOiBhdHRlbXB0cyxcbiAgICAgICAgICBvcHRpb25zOiBvcHRpb25zXG4gICAgICAgIH07XG5cbiAgd2hpbHN0KGF0dGVtcHQsIGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IHsgdmFsdWUgfSA9IGNvbnRleHQ7XG4gICAgXG4gICAgY2FsbGJhY2sodmFsdWUpO1xuICB9LCBjb250ZXh0KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBwcm9tcHQ7XG5cbmZ1bmN0aW9uIGF0dGVtcHQobmV4dCwgZG9uZSwgY29udGV4dCkge1xuICBsZXQgeyBhdHRlbXB0cyB9ID0gY29udGV4dDtcblxuICBjb25zdCB0ZXJtaW5hdGUgPSAoYXR0ZW1wdHMtLSA9PT0gMCk7XG4gIFxuICBpZiAodGVybWluYXRlKSB7XG4gICAgZG9uZSgpO1xuICAgIFxuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHsgb3B0aW9ucyB9ID0gY29udGV4dCxcbiAgICAgICAgeyBkZXNjcmlwdGlvbixcbiAgICAgICAgICBlcnJvck1lc3NhZ2UsXG4gICAgICAgICAgdmFsaWRhdGlvblBhdHRlcm4sXG4gICAgICAgICAgdmFsaWRhdGlvbkZ1bmN0aW9uLFxuICAgICAgICAgIGVuY29kaW5nID0gJ3V0ZjgnLFxuICAgICAgICAgIGhpZGRlbiA9IGZhbHNlIH0gPSBvcHRpb25zO1xuXG4gIGhpZGRlbiA/IFxuICAgIGhpZGRlbklucHV0KGRlc2NyaXB0aW9uLCBlbmNvZGluZywgY2FsbGJhY2spIDpcbiAgICAgIHZpc2libGVJbnB1dChkZXNjcmlwdGlvbiwgZW5jb2RpbmcsIGNhbGxiYWNrKTtcblxuICBmdW5jdGlvbiBjYWxsYmFjayh2YWx1ZSkge1xuICAgIGNvbnN0IHZhbGlkID0gdmFsaWRhdGlvbkZ1bmN0aW9uID8gIC8vL1xuICAgICAgICAgICAgICAgICAgICB2YWxpZGF0aW9uRnVuY3Rpb24odmFsdWUpIDpcbiAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0aW9uUGF0dGVybi50ZXN0KHZhbHVlKTtcblxuICAgIGlmICh2YWxpZCkge1xuICAgICAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCB7XG4gICAgICAgIHZhbHVlOiB2YWx1ZVxuICAgICAgfSk7XG5cbiAgICAgIGRvbmUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coZXJyb3JNZXNzYWdlKTtcblxuICAgICAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCB7XG4gICAgICAgIGF0dGVtcHRzOiBhdHRlbXB0c1xuICAgICAgfSk7XG5cbiAgICAgIG5leHQoKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gdmlzaWJsZUlucHV0KGRlc2NyaXB0aW9uLCBlbmNvZGluZywgY2FsbGJhY2spIHtcbiAgY29uc3QgcmF3TW9kZSA9IGZhbHNlO1xuXG4gIHN0ZG91dC53cml0ZShkZXNjcmlwdGlvbik7XG5cbiAgc3RkaW4uc2V0RW5jb2RpbmcoZW5jb2RpbmcpO1xuXG4gIHN0ZGluLnNldFJhd01vZGUocmF3TW9kZSk7XG5cbiAgc3RkaW4ucmVzdW1lKCk7XG5cbiAgbGV0IHZhbHVlO1xuXG4gIGNvbnN0IGxpc3RlbmVyID0gZnVuY3Rpb24oY2h1bmspIHtcbiAgICB2YWx1ZSA9IGNodW5rLnRyaW0oKTtcblxuICAgIHN0ZGluLnJlbW92ZUxpc3RlbmVyKCdkYXRhJywgbGlzdGVuZXIpO1xuXG4gICAgc3RkaW4ucGF1c2UoKTtcblxuICAgIGNhbGxiYWNrKHZhbHVlKTtcbiAgfTtcblxuICBzdGRpbi5vbignZGF0YScsIGxpc3RlbmVyKTtcbn1cblxuZnVuY3Rpb24gaGlkZGVuSW5wdXQoZGVzY3JpcHRpb24sIGVuY29kaW5nLCBjYWxsYmFjaykge1xuICBjb25zdCByYXdNb2RlID0gdHJ1ZSxcbiAgICAgICAgb2ZmRVRYID0gb25FVFgoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ15DJyk7XG5cbiAgICAgICAgICBleGl0KCk7XG4gICAgICAgIH0pO1xuXG4gIHN0ZG91dC53cml0ZShkZXNjcmlwdGlvbik7XG5cbiAgc3RkaW4uc2V0RW5jb2RpbmcoZW5jb2RpbmcpO1xuXG4gIHN0ZGluLnNldFJhd01vZGUocmF3TW9kZSk7XG5cbiAgc3RkaW4ucmVzdW1lKCk7XG5cbiAgbGV0IHZhbHVlID0gJyc7XG5cbiAgY29uc3QgbGlzdGVuZXIgPSBmdW5jdGlvbihjaHVuaykge1xuICAgIGNvbnN0IGNoYXJhY3RlciA9IGNodW5rLnRvU3RyaW5nKGVuY29kaW5nKTtcblxuICAgIHN3aXRjaCAoY2hhcmFjdGVyKSB7XG4gICAgICBjYXNlIExJTkVfRkVFRF9DSEFSQUNURVIgOlxuICAgICAgY2FzZSBDQVJSSUFHRV9SRVRVUk5fQ0hBUkFDVEVSIDpcbiAgICAgICAgc3Rkb3V0LndyaXRlKExJTkVfRkVFRF9DSEFSQUNURVIpO1xuXG4gICAgICAgIHN0ZGluLnJlbW92ZUxpc3RlbmVyKCdkYXRhJywgbGlzdGVuZXIpO1xuXG4gICAgICAgIHN0ZGluLnBhdXNlKCk7XG5cbiAgICAgICAgb2ZmRVRYKCk7XG5cbiAgICAgICAgY2FsbGJhY2sodmFsdWUpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBCQUNLU1BBQ0VfQ0hBUkFDVEVSIDpcbiAgICAgICAgdmFsdWUgPSB0cnVuY2F0ZSh2YWx1ZSk7XG5cbiAgICAgICAgc3Rkb3V0LmNsZWFyTGluZSgpO1xuXG4gICAgICAgIHN0ZG91dC5jdXJzb3JUbygwKTtcblxuICAgICAgICBzdGRvdXQud3JpdGUoZGVzY3JpcHRpb24pO1xuICAgICAgICBicmVhaztcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdmFsdWUgKz0gY2hhcmFjdGVyO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH07XG5cbiAgc3RkaW4ub24oJ2RhdGEnLCBsaXN0ZW5lcik7XG59XG5cbmZ1bmN0aW9uIHRydW5jYXRlKHZhbHVlKSB7IHJldHVybiB2YWx1ZS5zbGljZSgwLCB2YWx1ZS5sZW5ndGggLSAxKTsgfVxuIl19