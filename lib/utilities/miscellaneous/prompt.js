'use strict';

var onETX = require('./onETX'),
    asynchronousUtilities = require('../../utilities/asynchronous');

var _process = process,
    stdin = _process.stdin,
    stdout = _process.stdout,
    whilst = asynchronousUtilities.whilst,
    _process2 = process,
    exit = _process2.exit;


var BACKSPACE_CHARACTER = String.fromCharCode(127),
    LINE_FEED_CHARACTER = '\n',
    CARRIAGE_RETURN_CHARACTER = '\r';

function prompt(options, callback) {
  var value = null,
      _options$attempts = options.attempts,
      attempts = _options$attempts === undefined ? 3 : _options$attempts,
      context = {
    value: value,
    attempts: attempts,
    options: options
  };


  whilst(attempt, function () {
    var value = context.value;


    callback(value);
  }, context);
}

module.exports = prompt;

function attempt(next, done, context) {
  var attempts = context.attempts;


  var terminate = attempts-- === 0;

  if (terminate) {
    done();

    return;
  }

  var options = context.options,
      description = options.description,
      errorMessage = options.errorMessage,
      validationPattern = options.validationPattern,
      validationFunction = options.validationFunction,
      _options$encoding = options.encoding,
      encoding = _options$encoding === undefined ? 'utf8' : _options$encoding,
      _options$hidden = options.hidden,
      hidden = _options$hidden === undefined ? false : _options$hidden;


  hidden ? hiddenInput(description, encoding, callback) : visibleInput(description, encoding, callback);

  function callback(value) {
    var valid = validationFunction ? ///
    validationFunction(value) : validationPattern.test(value);

    if (valid) {
      Object.assign(context, {
        value: value
      });

      done();
    } else {
      console.log(errorMessage);

      Object.assign(context, {
        attempts: attempts
      });

      next();
    }
  }
}

function visibleInput(description, encoding, callback) {
  var rawMode = false;

  stdout.write(description);

  stdin.setEncoding(encoding);

  stdin.setRawMode(rawMode);

  stdin.resume();

  var value = void 0;

  var listener = function listener(chunk) {
    value = chunk.trim();

    stdin.removeListener('data', listener);

    stdin.pause();

    callback(value);
  };

  stdin.on('data', listener);
}

function hiddenInput(description, encoding, callback) {
  var rawMode = true,
      offETX = onETX(function () {
    console.log('^C');

    exit();
  });

  stdout.write(description);

  stdin.setEncoding(encoding);

  stdin.setRawMode(rawMode);

  stdin.resume();

  var value = '';

  var listener = function listener(chunk) {
    var character = chunk.toString(encoding);

    switch (character) {
      case LINE_FEED_CHARACTER:
      case CARRIAGE_RETURN_CHARACTER:
        stdout.write(LINE_FEED_CHARACTER);

        stdin.removeListener('data', listener);

        stdin.pause();

        offETX();

        callback(value);
        break;

      case BACKSPACE_CHARACTER:
        value = truncate(value);

        stdout.clearLine();

        stdout.cursorTo(0);

        stdout.write(description);
        break;

      default:
        value += character;
        break;
    }
  };

  stdin.on('data', listener);
}

function truncate(value) {
  return value.slice(0, value.length - 1);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2VzNi91dGlsaXRpZXMvbWlzY2VsbGFuZW91cy9wcm9tcHQuanMiXSwibmFtZXMiOlsib25FVFgiLCJyZXF1aXJlIiwiYXN5bmNocm9ub3VzVXRpbGl0aWVzIiwicHJvY2VzcyIsInN0ZGluIiwic3Rkb3V0Iiwid2hpbHN0IiwiZXhpdCIsIkJBQ0tTUEFDRV9DSEFSQUNURVIiLCJTdHJpbmciLCJmcm9tQ2hhckNvZGUiLCJMSU5FX0ZFRURfQ0hBUkFDVEVSIiwiQ0FSUklBR0VfUkVUVVJOX0NIQVJBQ1RFUiIsInByb21wdCIsIm9wdGlvbnMiLCJjYWxsYmFjayIsImF0dGVtcHRzIiwiY29udGV4dCIsInZhbHVlIiwiYXR0ZW1wdCIsIm1vZHVsZSIsImV4cG9ydHMiLCJuZXh0IiwiZG9uZSIsInRlcm1pbmF0ZSIsImRlc2NyaXB0aW9uIiwiZXJyb3JNZXNzYWdlIiwidmFsaWRhdGlvblBhdHRlcm4iLCJ2YWxpZGF0aW9uRnVuY3Rpb24iLCJlbmNvZGluZyIsImhpZGRlbiIsImhpZGRlbklucHV0IiwidmlzaWJsZUlucHV0IiwidmFsaWQiLCJ0ZXN0IiwiT2JqZWN0IiwiYXNzaWduIiwiY29uc29sZSIsImxvZyIsInJhd01vZGUiLCJ3cml0ZSIsInNldEVuY29kaW5nIiwic2V0UmF3TW9kZSIsInJlc3VtZSIsImxpc3RlbmVyIiwiY2h1bmsiLCJ0cmltIiwicmVtb3ZlTGlzdGVuZXIiLCJwYXVzZSIsIm9uIiwib2ZmRVRYIiwiY2hhcmFjdGVyIiwidG9TdHJpbmciLCJ0cnVuY2F0ZSIsImNsZWFyTGluZSIsImN1cnNvclRvIiwic2xpY2UiLCJsZW5ndGgiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQU1BLFFBQVFDLFFBQVEsU0FBUixDQUFkO0FBQUEsSUFDTUMsd0JBQXdCRCxRQUFRLDhCQUFSLENBRDlCOztlQUcwQkUsTztJQUFsQkMsSyxZQUFBQSxLO0lBQU9DLE0sWUFBQUEsTTtJQUNQQyxNLEdBQVdKLHFCLENBQVhJLE07Z0JBQ1NI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QVosRUFBZXRDLE1BQU11QyxNQUFOLEdBQWUsQ0FBOUIsQ0FBUDtBQUEwQyIsImZpbGUiOiJwcm9tcHQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IG9uRVRYID0gcmVxdWlyZSgnLi9vbkVUWCcpLFxuICAgICAgYXN5bmNocm9ub3VzVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vLi4vdXRpbGl0aWVzL2FzeW5jaHJvbm91cycpO1xuXG5jb25zdCB7IHN0ZGluLCBzdGRvdXQgfSA9IHByb2Nlc3MsXG4gICAgICB7IHdoaWxzdCB9ID0gYXN5bmNocm9ub3VzVXRpbGl0aWVzLFxuICAgICAgeyBleGl0IH0gPSBwcm9jZXNzO1xuXG5jb25zdCBCQUNLU1BBQ0VfQ0hBUkFDVEVSID0gU3RyaW5nLmZyb21DaGFyQ29kZSgxMjcpLFxuICAgICAgTElORV9GRUVEX0NIQVJBQ1RFUiA9ICdcXG4nLFxuICAgICAgQ0FSUklBR0VfUkVUVVJOX0NIQVJBQ1RFUiA9ICdcXHInO1xuXG5mdW5jdGlvbiBwcm9tcHQob3B0aW9ucywgY2FsbGJhY2spIHtcbiAgY29uc3QgdmFsdWUgPSBudWxsLFxuICAgICAgICB7IGF0dGVtcHRzID0gMyB9ID0gb3B0aW9ucyxcbiAgICAgICAgY29udGV4dCA9IHtcbiAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgICBhdHRlbXB0cyxcbiAgICAgICAgICBvcHRpb25zXG4gICAgICAgIH07XG5cbiAgd2hpbHN0KGF0dGVtcHQsIGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IHsgdmFsdWUgfSA9IGNvbnRleHQ7XG4gICAgXG4gICAgY2FsbGJhY2sodmFsdWUpO1xuICB9LCBjb250ZXh0KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBwcm9tcHQ7XG5cbmZ1bmN0aW9uIGF0dGVtcHQobmV4dCwgZG9uZSwgY29udGV4dCkge1xuICBsZXQgeyBhdHRlbXB0cyB9ID0gY29udGV4dDtcblxuICBjb25zdCB0ZXJtaW5hdGUgPSAoYXR0ZW1wdHMtLSA9PT0gMCk7XG4gIFxuICBpZiAodGVybWluYXRlKSB7XG4gICAgZG9uZSgpO1xuICAgIFxuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHsgb3B0aW9ucyB9ID0gY29udGV4dCxcbiAgICAgICAgeyBkZXNjcmlwdGlvbixcbiAgICAgICAgICBlcnJvck1lc3NhZ2UsXG4gICAgICAgICAgdmFsaWRhdGlvblBhdHRlcm4sXG4gICAgICAgICAgdmFsaWRhdGlvbkZ1bmN0aW9uLFxuICAgICAgICAgIGVuY29kaW5nID0gJ3V0ZjgnLFxuICAgICAgICAgIGhpZGRlbiA9IGZhbHNlIH0gPSBvcHRpb25zO1xuXG4gIGhpZGRlbiA/IFxuICAgIGhpZGRlbklucHV0KGRlc2NyaXB0aW9uLCBlbmNvZGluZywgY2FsbGJhY2spIDpcbiAgICAgIHZpc2libGVJbnB1dChkZXNjcmlwdGlvbiwgZW5jb2RpbmcsIGNhbGxiYWNrKTtcblxuICBmdW5jdGlvbiBjYWxsYmFjayh2YWx1ZSkge1xuICAgIGNvbnN0IHZhbGlkID0gdmFsaWRhdGlvbkZ1bmN0aW9uID8gIC8vL1xuICAgICAgICAgICAgICAgICAgICB2YWxpZGF0aW9uRnVuY3Rpb24odmFsdWUpIDpcbiAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0aW9uUGF0dGVybi50ZXN0KHZhbHVlKTtcblxuICAgIGlmICh2YWxpZCkge1xuICAgICAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCB7XG4gICAgICAgIHZhbHVlOiB2YWx1ZVxuICAgICAgfSk7XG5cbiAgICAgIGRvbmUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coZXJyb3JNZXNzYWdlKTtcblxuICAgICAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCB7XG4gICAgICAgIGF0dGVtcHRzXG4gICAgICB9KTtcblxuICAgICAgbmV4dCgpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiB2aXNpYmxlSW5wdXQoZGVzY3JpcHRpb24sIGVuY29kaW5nLCBjYWxsYmFjaykge1xuICBjb25zdCByYXdNb2RlID0gZmFsc2U7XG5cbiAgc3Rkb3V0LndyaXRlKGRlc2NyaXB0aW9uKTtcblxuICBzdGRpbi5zZXRFbmNvZGluZyhlbmNvZGluZyk7XG5cbiAgc3RkaW4uc2V0UmF3TW9kZShyYXdNb2RlKTtcblxuICBzdGRpbi5yZXN1bWUoKTtcblxuICBsZXQgdmFsdWU7XG5cbiAgY29uc3QgbGlzdGVuZXIgPSBmdW5jdGlvbihjaHVuaykge1xuICAgIHZhbHVlID0gY2h1bmsudHJpbSgpO1xuXG4gICAgc3RkaW4ucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCBsaXN0ZW5lcik7XG5cbiAgICBzdGRpbi5wYXVzZSgpO1xuXG4gICAgY2FsbGJhY2sodmFsdWUpO1xuICB9O1xuXG4gIHN0ZGluLm9uKCdkYXRhJywgbGlzdGVuZXIpO1xufVxuXG5mdW5jdGlvbiBoaWRkZW5JbnB1dChkZXNjcmlwdGlvbiwgZW5jb2RpbmcsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IHJhd01vZGUgPSB0cnVlLFxuICAgICAgICBvZmZFVFggPSBvbkVUWChmdW5jdGlvbigpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnXkMnKTtcblxuICAgICAgICAgIGV4aXQoKTtcbiAgICAgICAgfSk7XG5cbiAgc3Rkb3V0LndyaXRlKGRlc2NyaXB0aW9uKTtcblxuICBzdGRpbi5zZXRFbmNvZGluZyhlbmNvZGluZyk7XG5cbiAgc3RkaW4uc2V0UmF3TW9kZShyYXdNb2RlKTtcblxuICBzdGRpbi5yZXN1bWUoKTtcblxuICBsZXQgdmFsdWUgPSAnJztcblxuICBjb25zdCBsaXN0ZW5lciA9IGZ1bmN0aW9uKGNodW5rKSB7XG4gICAgY29uc3QgY2hhcmFjdGVyID0gY2h1bmsudG9TdHJpbmcoZW5jb2RpbmcpO1xuXG4gICAgc3dpdGNoIChjaGFyYWN0ZXIpIHtcbiAgICAgIGNhc2UgTElORV9GRUVEX0NIQVJBQ1RFUiA6XG4gICAgICBjYXNlIENBUlJJQUdFX1JFVFVSTl9DSEFSQUNURVIgOlxuICAgICAgICBzdGRvdXQud3JpdGUoTElORV9GRUVEX0NIQVJBQ1RFUik7XG5cbiAgICAgICAgc3RkaW4ucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCBsaXN0ZW5lcik7XG5cbiAgICAgICAgc3RkaW4ucGF1c2UoKTtcblxuICAgICAgICBvZmZFVFgoKTtcblxuICAgICAgICBjYWxsYmFjayh2YWx1ZSk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIEJBQ0tTUEFDRV9DSEFSQUNURVIgOlxuICAgICAgICB2YWx1ZSA9IHRydW5jYXRlKHZhbHVlKTtcblxuICAgICAgICBzdGRvdXQuY2xlYXJMaW5lKCk7XG5cbiAgICAgICAgc3Rkb3V0LmN1cnNvclRvKDApO1xuXG4gICAgICAgIHN0ZG91dC53cml0ZShkZXNjcmlwdGlvbik7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICB2YWx1ZSArPSBjaGFyYWN0ZXI7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfTtcblxuICBzdGRpbi5vbignZGF0YScsIGxpc3RlbmVyKTtcbn1cblxuZnVuY3Rpb24gdHJ1bmNhdGUodmFsdWUpIHsgcmV0dXJuIHZhbHVlLnNsaWNlKDAsIHZhbHVlLmxlbmd0aCAtIDEpOyB9XG4iXX0=