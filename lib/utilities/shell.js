"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.onETX = onETX;
exports.prompt = prompt;
exports["default"] = void 0;

var _asynchronous = require("../utilities/asynchronous");

var _constants = require("../constants");

function onETX(handler) {
  var event = _constants.DATA_EVENT;

  if (process.stdin.setRawMode) {
    var rawMode = true,
        encoding = _constants.UTF8_ENCODING;
    process.stdin.setRawMode(rawMode);
    process.stdin.setEncoding(encoding);
    process.stdin.resume();
    process.stdin.addListener(event, dataHandler);
    return offExt;
  }

  function offExt() {
    process.stdin.removeListener(event, dataHandler);
  }

  function dataHandler(character) {
    if (character === _constants.ETX_CHARACTER) {
      handler();
    }
  }
}

function prompt(options, callback) {
  var _options$answer = options.answer,
      answer = _options$answer === void 0 ? null : _options$answer;

  if (answer !== null) {
    callback(answer);
    return;
  }

  answer = null;
  var _options$attempts = options.attempts,
      attempts = _options$attempts === void 0 ? _constants.DEFAULT_ATTEMPTS : _options$attempts,
      context = {
    answer: answer,
    attempts: attempts,
    options: options
  };
  (0, _asynchronous.whilst)(attempt, function () {
    var answer = context.answer;
    callback(answer);
  }, context);
}

var _default = {
  onETX: onETX,
  prompt: prompt
};
exports["default"] = _default;

function attempt(next, done, context) {
  var attempts = context.attempts;
  var terminate = attempts-- === 0;

  if (terminate) {
    done();
    return;
  }

  var options = context.options,
      _options$hidden = options.hidden,
      hidden = _options$hidden === void 0 ? false : _options$hidden,
      _options$encoding = options.encoding,
      encoding = _options$encoding === void 0 ? _constants.DEFAULT_ENCODING : _options$encoding,
      description = options.description,
      errorMessage = options.errorMessage,
      _options$initialAnswe = options.initialAnswer,
      initialAnswer = _options$initialAnswe === void 0 ? _constants.DEFAULT_INITIAL_ANSWER : _options$initialAnswe,
      validationPattern = options.validationPattern,
      validationFunction = options.validationFunction;
  input(description, initialAnswer, encoding, hidden, callback);

  function callback(answer) {
    var valid = validationFunction ? ///
    validationFunction(answer) : validationPattern.test(answer);

    if (valid) {
      Object.assign(context, {
        answer: answer
      });
      done();
    } else {
      console.log(errorMessage);
      Object.assign(context, {
        attempts: attempts
      });
      next();
    }
  }
}

function input(description, initialAnswer, encoding, hidden, callback) {
  var answer = initialAnswer; ///

  var event = _constants.DATA_EVENT,
      rawMode = true,
      offETX = onETX(function () {
    console.log(_constants.CTRL_C);
    process.exit();
  });
  process.stdin.setEncoding(encoding);
  process.stdin.setRawMode(rawMode);
  process.stdout.write(description);

  if (!hidden) {
    process.stdout.write(answer);
  }

  process.stdin.resume();
  process.stdin.on(event, listener);

  function listener(chunk) {
    var character = chunk.toString(encoding);

    switch (character) {
      case _constants.LINE_FEED_CHARACTER:
      case _constants.CARRIAGE_RETURN_CHARACTER:
        process.stdout.write(_constants.LINE_FEED_CHARACTER);
        process.stdin.removeListener(event, listener);
        process.stdin.pause();
        offETX();
        callback(answer);
        break;

      case _constants.BACKSPACE_CHARACTER:
        answer = answer.slice(0, answer.length - 1);
        process.stdout.clearLine();
        process.stdout.cursorTo(0);
        process.stdout.write(description);

        if (!hidden) {
          process.stdout.write(answer);
        }

        break;

      default:
        answer += character;

        if (!hidden) {
          process.stdout.clearLine();
          process.stdout.cursorTo(0);
          process.stdout.write(description);
          process.stdout.write(answer);
        }

        break;
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNoZWxsLmpzIl0sIm5hbWVzIjpbIm9uRVRYIiwiaGFuZGxlciIsImV2ZW50IiwiREFUQV9FVkVOVCIsInByb2Nlc3MiLCJzdGRpbiIsInNldFJhd01vZGUiLCJyYXdNb2RlIiwiZW5jb2RpbmciLCJVVEY4X0VOQ09ESU5HIiwic2V0RW5jb2RpbmciLCJyZXN1bWUiLCJhZGRMaXN0ZW5lciIsImRhdGFIYW5kbGVyIiwib2ZmRXh0IiwicmVtb3ZlTGlzdGVuZXIiLCJjaGFyYWN0ZXIiLCJFVFhfQ0hBUkFDVEVSIiwicHJvbXB0Iiwib3B0aW9ucyIsImNhbGxiYWNrIiwiYW5zd2VyIiwiYXR0ZW1wdHMiLCJERUZBVUxUX0FUVEVNUFRTIiwiY29udGV4dCIsImF0dGVtcHQiLCJuZXh0IiwiZG9uZSIsInRlcm1pbmF0ZSIsImhpZGRlbiIsIkRFRkFVTFRfRU5DT0RJTkciLCJkZXNjcmlwdGlvbiIsImVycm9yTWVzc2FnZSIsImluaXRpYWxBbnN3ZXIiLCJERUZBVUxUX0lOSVRJQUxfQU5TV0VSIiwidmFsaWRhdGlvblBhdHRlcm4iLCJ2YWxpZGF0aW9uRnVuY3Rpb24iLCJpbnB1dCIsInZhbGlkIiwidGVzdCIsIk9iamVjdCIsImFzc2lnbiIsImNvbnNvbGUiLCJsb2ciLCJvZmZFVFgiLCJDVFJMX0MiLCJleGl0Iiwic3Rkb3V0Iiwid3JpdGUiLCJvbiIsImxpc3RlbmVyIiwiY2h1bmsiLCJ0b1N0cmluZyIsIkxJTkVfRkVFRF9DSEFSQUNURVIiLCJDQVJSSUFHRV9SRVRVUk5fQ0hBUkFDVEVSIiwicGF1c2UiLCJCQUNLU1BBQ0VfQ0hBUkFDVEVSIiwic2xpY2UiLCJsZW5ndGgiLCJjbGVhckxpbmUiLCJjdXJzb3JUbyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7OztBQUVBOztBQUVBOztBQVdPLFNBQVNBLEtBQVQsQ0FBZUMsT0FBZixFQUF3QjtBQUM3QixNQUFNQyxLQUFLLEdBQUdDLHFCQUFkOztBQUVBLE1BQUlDLE9BQU8sQ0FBQ0MsS0FBUixDQUFjQyxV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QSxNQUFNLElBQUlMLFNBQVY7O0FBRUEsWUFBSSxDQUFDYSxNQUFMLEVBQWE7QUFDWHpCLFVBQUFBLE9BQU8sQ0FBQzJDLE1BQVIsQ0FBZVksU0FBZjtBQUVBdkQsVUFBQUEsT0FBTyxDQUFDMkMsTUFBUixDQUFlYSxRQUFmLENBQXdCLENBQXhCO0FBRUF4RCxVQUFBQSxPQUFPLENBQUMyQyxNQUFSLENBQWVDLEtBQWYsQ0FBcUJqQixXQUFyQjtBQUVBM0IsVUFBQUEsT0FBTyxDQUFDMkMsTUFBUixDQUFlQyxLQUFmLENBQXFCM0IsTUFBckI7QUFDRDs7QUFFRDtBQTNDSjtBQTZDRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7IHdoaWxzdCB9IGZyb20gXCIuLi91dGlsaXRpZXMvYXN5bmNocm9ub3VzXCI7XG5cbmltcG9ydCB7IENUUkxfQyxcbiAgICAgICAgIERBVEFfRVZFTlQsXG4gICAgICAgICBVVEY4X0VOQ09ESU5HLFxuICAgICAgICAgRVRYX0NIQVJBQ1RFUixcbiAgICAgICAgIERFRkFVTFRfRU5DT0RJTkcsXG4gICAgICAgICBERUZBVUxUX0FUVEVNUFRTLFxuICAgICAgICAgQkFDS1NQQUNFX0NIQVJBQ1RFUixcbiAgICAgICAgIExJTkVfRkVFRF9DSEFSQUNURVIsXG4gICAgICAgICBERUZBVUxUX0lOSVRJQUxfQU5TV0VSLFxuICAgICAgICAgQ0FSUklBR0VfUkVUVVJOX0NIQVJBQ1RFUiB9IGZyb20gXCIuLi9jb25zdGFudHNcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIG9uRVRYKGhhbmRsZXIpIHtcbiAgY29uc3QgZXZlbnQgPSBEQVRBX0VWRU5UO1xuXG4gIGlmIChwcm9jZXNzLnN0ZGluLnNldFJhd01vZGUpIHtcbiAgICBjb25zdCByYXdNb2RlID0gdHJ1ZSxcbiAgICAgICAgICBlbmNvZGluZyA9IFVURjhfRU5DT0RJTkc7XG5cbiAgICBwcm9jZXNzLnN0ZGluLnNldFJhd01vZGUocmF3TW9kZSk7XG4gICAgcHJvY2Vzcy5zdGRpbi5zZXRFbmNvZGluZyhlbmNvZGluZyk7XG5cbiAgICBwcm9jZXNzLnN0ZGluLnJlc3VtZSgpO1xuXG4gICAgcHJvY2Vzcy5zdGRpbi5hZGRMaXN0ZW5lcihldmVudCwgZGF0YUhhbmRsZXIpO1xuXG4gICAgcmV0dXJuIG9mZkV4dDtcbiAgfVxuXG4gIGZ1bmN0aW9uIG9mZkV4dCgpIHtcbiAgICBwcm9jZXNzLnN0ZGluLnJlbW92ZUxpc3RlbmVyKGV2ZW50LCBkYXRhSGFuZGxlcik7XG4gIH1cblxuICBmdW5jdGlvbiBkYXRhSGFuZGxlcihjaGFyYWN0ZXIpIHtcbiAgICBpZiAoY2hhcmFjdGVyID09PSBFVFhfQ0hBUkFDVEVSKSB7XG4gICAgICBoYW5kbGVyKCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcm9tcHQob3B0aW9ucywgY2FsbGJhY2spIHtcbiAgbGV0IHsgYW5zd2VyID0gbnVsbCB9ID0gb3B0aW9ucztcblxuICBpZiAoYW5zd2VyICE9PSBudWxsKSB7XG4gICAgY2FsbGJhY2soYW5zd2VyKTtcblxuICAgIHJldHVybjtcbiAgfVxuXG4gIGFuc3dlciA9IG51bGw7XG5cbiAgY29uc3QgeyBhdHRlbXB0cyA9IERFRkFVTFRfQVRURU1QVFMgfSA9IG9wdGlvbnMsXG4gICAgICAgIGNvbnRleHQgPSB7XG4gICAgICAgICAgYW5zd2VyLFxuICAgICAgICAgIGF0dGVtcHRzLFxuICAgICAgICAgIG9wdGlvbnNcbiAgICAgICAgfTtcblxuICB3aGlsc3QoYXR0ZW1wdCwgKCkgPT4ge1xuICAgIGNvbnN0IHsgYW5zd2VyIH0gPSBjb250ZXh0O1xuICAgIFxuICAgIGNhbGxiYWNrKGFuc3dlcik7XG4gIH0sIGNvbnRleHQpO1xufVxuXG5leHBvcnQgZGVmYXVsdCB7XG4gIG9uRVRYLFxuICBwcm9tcHRcbn1cblxuZnVuY3Rpb24gYXR0ZW1wdChuZXh0LCBkb25lLCBjb250ZXh0KSB7XG4gIGxldCB7IGF0dGVtcHRzIH0gPSBjb250ZXh0O1xuXG4gIGNvbnN0IHRlcm1pbmF0ZSA9IChhdHRlbXB0cy0tID09PSAwKTtcbiAgXG4gIGlmICh0ZXJtaW5hdGUpIHtcbiAgICBkb25lKCk7XG4gICAgXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgeyBvcHRpb25zIH0gPSBjb250ZXh0LFxuICAgICAgICB7IGhpZGRlbiA9IGZhbHNlLFxuICAgICAgICAgIGVuY29kaW5nID0gREVGQVVMVF9FTkNPRElORyxcbiAgICAgICAgICBkZXNjcmlwdGlvbixcbiAgICAgICAgICBlcnJvck1lc3NhZ2UsXG4gICAgICAgICAgaW5pdGlhbEFuc3dlciA9IERFRkFVTFRfSU5JVElBTF9BTlNXRVIsXG4gICAgICAgICAgdmFsaWRhdGlvblBhdHRlcm4sXG4gICAgICAgICAgdmFsaWRhdGlvbkZ1bmN0aW9uIH0gPSBvcHRpb25zO1xuXG4gIGlucHV0KGRlc2NyaXB0aW9uLCBpbml0aWFsQW5zd2VyLCBlbmNvZGluZywgaGlkZGVuLCBjYWxsYmFjayk7XG5cbiAgZnVuY3Rpb24gY2FsbGJhY2soYW5zd2VyKSB7XG4gICAgY29uc3QgdmFsaWQgPSB2YWxpZGF0aW9uRnVuY3Rpb24gPyAgLy8vXG4gICAgICAgICAgICAgICAgICAgIHZhbGlkYXRpb25GdW5jdGlvbihhbnN3ZXIpIDpcbiAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0aW9uUGF0dGVybi50ZXN0KGFuc3dlcik7XG5cbiAgICBpZiAodmFsaWQpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24oY29udGV4dCwge1xuICAgICAgICBhbnN3ZXJcbiAgICAgIH0pO1xuXG4gICAgICBkb25lKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKGVycm9yTWVzc2FnZSk7XG5cbiAgICAgIE9iamVjdC5hc3NpZ24oY29udGV4dCwge1xuICAgICAgICBhdHRlbXB0c1xuICAgICAgfSk7XG5cbiAgICAgIG5leHQoKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gaW5wdXQoZGVzY3JpcHRpb24sIGluaXRpYWxBbnN3ZXIsIGVuY29kaW5nLCBoaWRkZW4sIGNhbGxiYWNrKSB7XG4gIGxldCBhbnN3ZXIgPSBpbml0aWFsQW5zd2VyOyAvLy9cblxuICBjb25zdCBldmVudCA9IERBVEFfRVZFTlQsXG4gICAgICAgIHJhd01vZGUgPSB0cnVlLFxuICAgICAgICBvZmZFVFggPSBvbkVUWCgoKSA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coQ1RSTF9DKTtcblxuICAgICAgICAgIHByb2Nlc3MuZXhpdCgpO1xuICAgICAgICB9KTtcblxuICBwcm9jZXNzLnN0ZGluLnNldEVuY29kaW5nKGVuY29kaW5nKTtcblxuICBwcm9jZXNzLnN0ZGluLnNldFJhd01vZGUocmF3TW9kZSk7XG5cbiAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoZGVzY3JpcHRpb24pO1xuXG4gIGlmICghaGlkZGVuKSB7XG4gICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoYW5zd2VyKTtcbiAgfVxuXG4gIHByb2Nlc3Muc3RkaW4ucmVzdW1lKCk7XG5cbiAgcHJvY2Vzcy5zdGRpbi5vbihldmVudCwgbGlzdGVuZXIpO1xuXG4gIGZ1bmN0aW9uIGxpc3RlbmVyKGNodW5rKSB7XG4gICAgY29uc3QgY2hhcmFjdGVyID0gY2h1bmsudG9TdHJpbmcoZW5jb2RpbmcpO1xuXG4gICAgc3dpdGNoIChjaGFyYWN0ZXIpIHtcbiAgICAgIGNhc2UgTElORV9GRUVEX0NIQVJBQ1RFUiA6XG4gICAgICBjYXNlIENBUlJJQUdFX1JFVFVSTl9DSEFSQUNURVIgOlxuICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShMSU5FX0ZFRURfQ0hBUkFDVEVSKTtcblxuICAgICAgICBwcm9jZXNzLnN0ZGluLnJlbW92ZUxpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lcik7XG5cbiAgICAgICAgcHJvY2Vzcy5zdGRpbi5wYXVzZSgpO1xuXG4gICAgICAgIG9mZkVUWCgpO1xuXG4gICAgICAgIGNhbGxiYWNrKGFuc3dlcik7XG5cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgQkFDS1NQQUNFX0NIQVJBQ1RFUiA6XG4gICAgICAgIGFuc3dlciA9IGFuc3dlci5zbGljZSgwLCBhbnN3ZXIubGVuZ3RoIC0gMSk7XG5cbiAgICAgICAgcHJvY2Vzcy5zdGRvdXQuY2xlYXJMaW5lKCk7XG5cbiAgICAgICAgcHJvY2Vzcy5zdGRvdXQuY3Vyc29yVG8oMCk7XG5cbiAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoZGVzY3JpcHRpb24pO1xuXG4gICAgICAgIGlmICghaGlkZGVuKSB7XG4gICAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoYW5zd2VyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICBhbnN3ZXIgKz0gY2hhcmFjdGVyO1xuXG4gICAgICAgIGlmICghaGlkZGVuKSB7XG4gICAgICAgICAgcHJvY2Vzcy5zdGRvdXQuY2xlYXJMaW5lKCk7XG5cbiAgICAgICAgICBwcm9jZXNzLnN0ZG91dC5jdXJzb3JUbygwKTtcblxuICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKGRlc2NyaXB0aW9uKTtcblxuICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKGFuc3dlcik7XG4gICAgICAgIH1cblxuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cbn1cbiJdfQ==