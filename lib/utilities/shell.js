"use strict";

import { whilst } from "../utilities/asynchronous";
import { CTRL_C, DATA_EVENT, UTF8_ENCODING, ETX_CHARACTER, DEFAULT_ENCODING, DEFAULT_ATTEMPTS, BACKSPACE_CHARACTER, LINE_FEED_CHARACTER, DEFAULT_INITIAL_ANSWER, CARRIAGE_RETURN_CHARACTER } from "../constants";
export function onETX(handler) {
  const event = DATA_EVENT;

  if (process.stdin.setRawMode) {
    const rawMode = true,
          encoding = UTF8_ENCODING;
    process.stdin.setRawMode(rawMode);
    process.stdin.setEncoding(encoding);
    process.stdin.addListener(event, dataHandler);
    process.stdin.resume();
    return offExt;
  }

  function offExt() {
    process.stdin.removeListener(event, dataHandler);
  }

  function dataHandler(character) {
    if (character === ETX_CHARACTER) {
      handler();
    }
  }
}
export function prompt(options, callback) {
  let {
    answer = null
  } = options;

  if (answer !== null) {
    callback(answer);
    return;
  }

  const {
    attempts = DEFAULT_ATTEMPTS
  } = options,
        context = {
    answer,
    options,
    attempts
  };
  whilst(attempt, () => {
    const {
      answer
    } = context;
    callback(answer);
  }, context);
}
export default {
  onETX,
  prompt
};

function attempt(next, done, context) {
  let {
    attempts
  } = context;
  const terminate = attempts-- === 0;

  if (terminate) {
    done();
    return;
  }

  const {
    options
  } = context,
        {
    hidden = false,
    encoding = DEFAULT_ENCODING,
    description,
    errorMessage,
    initialAnswer = DEFAULT_INITIAL_ANSWER,
    validationPattern = null,
    validationFunction = null
  } = options;
  input(initialAnswer, hidden, description, encoding, callback);

  function callback(answer) {
    const valid = validationFunction ? ///
    validationFunction(answer) : validationPattern.test(answer);

    if (valid) {
      Object.assign(context, {
        answer
      });
      done();
    } else {
      console.log(errorMessage);
      Object.assign(context, {
        attempts
      });
      next();
    }
  }
}

function input(initialAnswer, hidden, description, encoding, callback) {
  const answer = initialAnswer; ///

  hidden ? hiddenInput(answer, description, encoding, callback) : visibleInput(answer, description, encoding, callback);
}

function hiddenInput(answer, description, encoding, callback) {
  const event = DATA_EVENT,
        rawMode = true;
  process.stdout.write(description);
  process.stdin.setEncoding(encoding);
  process.stdin.setRawMode(rawMode);
  process.stdin.on(event, listener);
  process.stdin.resume();

  function listener(data) {
    const character = data.toString(encoding);

    switch (character) {
      case LINE_FEED_CHARACTER:
      case CARRIAGE_RETURN_CHARACTER:
        process.stdout.write(LINE_FEED_CHARACTER);
        process.stdin.removeListener(event, listener);
        process.stdin.pause();
        callback(answer);
        break;

      case BACKSPACE_CHARACTER:
        answer = answer.slice(0, answer.length - 1);
        break;

      default:
        answer += character;
        break;

      case ETX_CHARACTER:
        console.log(CTRL_C);
        process.exit();
    }
  }
}

function visibleInput(answer, description, encoding, callback) {
  process.stdout.write(description);
  process.stdout.write(answer);
  process.stdin.setEncoding(encoding);
  process.stdin.once(DATA_EVENT, listener);
  process.stdin.resume();

  function listener(data) {
    const answer = data.replace(/\n$/, "");
    process.stdin.pause();
    callback(answer);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNoZWxsLmpzIl0sIm5hbWVzIjpbIndoaWxzdCIsIkNUUkxfQyIsIkRBVEFfRVZFTlQiLCJVVEY4X0VOQ09ESU5HIiwiRVRYX0NIQVJBQ1RFUiIsIkRFRkFVTFRfRU5DT0RJTkciLCJERUZBVUxUX0FUVEVNUFRTIiwiQkFDS1NQQUNFX0NIQVJBQ1RFUiIsIkxJTkVfRkVFRF9DSEFSQUNURVIiLCJERUZBVUxUX0lOSVRJQUxfQU5TV0VSIiwiQ0FSUklBR0VfUkVUVVJOX0NIQVJBQ1RFUiIsIm9uRVRYIiwiaGFuZGxlciIsImV2ZW50IiwicHJvY2VzcyIsInN0ZGluIiwic2V0UmF3TW9kZSIsInJhd01vZGUiLCJlbmNvZGluZyIsInNldEVuY29kaW5nIiwiYWRkTGlzdGVuZXIiLCJkYXRhSGFuZGxlciIsInJlc3VtZSIsIm9mZkV4dCIsInJlbW92ZUxpc3RlbmVyIiwiY2hhcmFjdGVyIiwicHJvbXB0Iiwib3B0aW9ucyIsImNhbGxiYWNrIiwiYW5zd2VyIiwiYXR0ZW1wdHMiLCJjb250ZXh0IiwiYXR0ZW1wdCIsIm5leHQiLCJkb25lIiwidGVybWluYXRlIiwiaGlkZGVuIiwiZGVzY3JpcHRpb24iLCJlcnJvck1lc3NhZ2UiLCJpbml0aWFsQW5zd2VyIiwidmFsaWRhdGlvblBhdHRlcm4iLCJ2YWxpZGF0aW9uRnVuY3Rpb24iLCJpbnB1dCIsInZhbGlkIiwidGVzdCIsIk9iamVjdCIsImFzc2lnbiIsImNvbnNvbGUiLCJsb2ciLCJoaWRkZW5JbnB1dCIsInZpc2libGVJbnB1dCIsInN0ZG91dCIsIndyaXRlIiwib24iLCJsaXN0ZW5lciIsImRhdGEiLCJ0b1N0cmluZyIsInBhdXNlIiwic2xpY2UiLCJsZW5ndGgiLCJleGl0Iiwib25jZSIsInJlcGxhY2UiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLFNBQVNBLE1BQVQsUUFBdUIsMkJBQXZCO0FBRUEsU0FBU0MsTUFBVCxFQUNTQyxVQURULEVBRVNDLGFBRlQsRUFHU0MsYUFIVCxFQUlTQyxnQkFKVCxFQUtT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QSxPQUFPLENBQUNDLEtBQVIsQ0FBY0ksV0FBZCxDQUEwQkQsUUFBMUI7QUFFQUosRUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWM4QyxJQUFkLENBQW1CM0QsVUFBbkIsRUFBK0JvRCxRQUEvQjtBQUVBeEMsRUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWNPLE1BQWQ7O0FBRUEsV0FBU2dDLFFBQVQsQ0FBa0JDLElBQWxCLEVBQXdCO0FBQ3RCLFVBQU0xQixNQUFNLEdBQUcwQixJQUFJLENBQUNPLE9BQUwsQ0FBYSxLQUFiLEVBQW9CLEVBQXBCLENBQWY7QUFFQWhELElBQUFBLE9BQU8sQ0FBQ0MsS0FBUixDQUFjMEMsS0FBZDtBQUVBN0IsSUFBQUEsUUFBUSxDQUFDQyxNQUFELENBQVI7QUFDRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7IHdoaWxzdCB9IGZyb20gXCIuLi91dGlsaXRpZXMvYXN5bmNocm9ub3VzXCI7XG5cbmltcG9ydCB7IENUUkxfQyxcbiAgICAgICAgIERBVEFfRVZFTlQsXG4gICAgICAgICBVVEY4X0VOQ09ESU5HLFxuICAgICAgICAgRVRYX0NIQVJBQ1RFUixcbiAgICAgICAgIERFRkFVTFRfRU5DT0RJTkcsXG4gICAgICAgICBERUZBVUxUX0FUVEVNUFRTLFxuICAgICAgICAgQkFDS1NQQUNFX0NIQVJBQ1RFUixcbiAgICAgICAgIExJTkVfRkVFRF9DSEFSQUNURVIsXG4gICAgICAgICBERUZBVUxUX0lOSVRJQUxfQU5TV0VSLFxuICAgICAgICAgQ0FSUklBR0VfUkVUVVJOX0NIQVJBQ1RFUiB9IGZyb20gXCIuLi9jb25zdGFudHNcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIG9uRVRYKGhhbmRsZXIpIHtcbiAgY29uc3QgZXZlbnQgPSBEQVRBX0VWRU5UO1xuXG4gIGlmIChwcm9jZXNzLnN0ZGluLnNldFJhd01vZGUpIHtcbiAgICBjb25zdCByYXdNb2RlID0gdHJ1ZSxcbiAgICAgICAgICBlbmNvZGluZyA9IFVURjhfRU5DT0RJTkc7XG5cbiAgICBwcm9jZXNzLnN0ZGluLnNldFJhd01vZGUocmF3TW9kZSk7XG5cbiAgICBwcm9jZXNzLnN0ZGluLnNldEVuY29kaW5nKGVuY29kaW5nKTtcblxuICAgIHByb2Nlc3Muc3RkaW4uYWRkTGlzdGVuZXIoZXZlbnQsIGRhdGFIYW5kbGVyKTtcblxuICAgIHByb2Nlc3Muc3RkaW4ucmVzdW1lKCk7XG5cbiAgICByZXR1cm4gb2ZmRXh0O1xuICB9XG5cbiAgZnVuY3Rpb24gb2ZmRXh0KCkge1xuICAgIHByb2Nlc3Muc3RkaW4ucmVtb3ZlTGlzdGVuZXIoZXZlbnQsIGRhdGFIYW5kbGVyKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGRhdGFIYW5kbGVyKGNoYXJhY3Rlcikge1xuICAgIGlmIChjaGFyYWN0ZXIgPT09IEVUWF9DSEFSQUNURVIpIHtcbiAgICAgIGhhbmRsZXIoKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByb21wdChvcHRpb25zLCBjYWxsYmFjaykge1xuICBsZXQgeyBhbnN3ZXIgPSBudWxsIH0gPSBvcHRpb25zO1xuXG4gIGlmIChhbnN3ZXIgIT09IG51bGwpIHtcbiAgICBjYWxsYmFjayhhbnN3ZXIpO1xuXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgeyBhdHRlbXB0cyA9IERFRkFVTFRfQVRURU1QVFMgfSA9IG9wdGlvbnMsXG4gICAgICAgIGNvbnRleHQgPSB7XG4gICAgICAgICAgYW5zd2VyLFxuICAgICAgICAgIG9wdGlvbnMsXG4gICAgICAgICAgYXR0ZW1wdHNcbiAgICAgICAgfTtcblxuICB3aGlsc3QoYXR0ZW1wdCwgKCkgPT4ge1xuICAgIGNvbnN0IHsgYW5zd2VyIH0gPSBjb250ZXh0O1xuICAgIFxuICAgIGNhbGxiYWNrKGFuc3dlcik7XG4gIH0sIGNvbnRleHQpO1xufVxuXG5leHBvcnQgZGVmYXVsdCB7XG4gIG9uRVRYLFxuICBwcm9tcHRcbn1cblxuZnVuY3Rpb24gYXR0ZW1wdChuZXh0LCBkb25lLCBjb250ZXh0KSB7XG4gIGxldCB7IGF0dGVtcHRzIH0gPSBjb250ZXh0O1xuXG4gIGNvbnN0IHRlcm1pbmF0ZSA9IChhdHRlbXB0cy0tID09PSAwKTtcbiAgXG4gIGlmICh0ZXJtaW5hdGUpIHtcbiAgICBkb25lKCk7XG4gICAgXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgeyBvcHRpb25zIH0gPSBjb250ZXh0LFxuICAgICAgICB7IGhpZGRlbiA9IGZhbHNlLFxuICAgICAgICAgIGVuY29kaW5nID0gREVGQVVMVF9FTkNPRElORyxcbiAgICAgICAgICBkZXNjcmlwdGlvbixcbiAgICAgICAgICBlcnJvck1lc3NhZ2UsXG4gICAgICAgICAgaW5pdGlhbEFuc3dlciA9IERFRkFVTFRfSU5JVElBTF9BTlNXRVIsXG4gICAgICAgICAgdmFsaWRhdGlvblBhdHRlcm4gPSBudWxsLFxuICAgICAgICAgIHZhbGlkYXRpb25GdW5jdGlvbiA9IG51bGwgfSA9IG9wdGlvbnM7XG5cbiAgaW5wdXQoaW5pdGlhbEFuc3dlciwgaGlkZGVuLCBkZXNjcmlwdGlvbiwgZW5jb2RpbmcsIGNhbGxiYWNrKTtcblxuICBmdW5jdGlvbiBjYWxsYmFjayhhbnN3ZXIpIHtcbiAgICBjb25zdCB2YWxpZCA9IHZhbGlkYXRpb25GdW5jdGlvbiA/ICAvLy9cbiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGlvbkZ1bmN0aW9uKGFuc3dlcikgOlxuICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRpb25QYXR0ZXJuLnRlc3QoYW5zd2VyKTtcblxuICAgIGlmICh2YWxpZCkge1xuICAgICAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCB7XG4gICAgICAgIGFuc3dlclxuICAgICAgfSk7XG5cbiAgICAgIGRvbmUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coZXJyb3JNZXNzYWdlKTtcblxuICAgICAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCB7XG4gICAgICAgIGF0dGVtcHRzXG4gICAgICB9KTtcblxuICAgICAgbmV4dCgpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBpbnB1dChpbml0aWFsQW5zd2VyLCBoaWRkZW4sIGRlc2NyaXB0aW9uLCBlbmNvZGluZywgY2FsbGJhY2spIHtcbiAgY29uc3QgYW5zd2VyID0gaW5pdGlhbEFuc3dlcjsgLy8vXG5cbiAgaGlkZGVuID9cbiAgICBoaWRkZW5JbnB1dChhbnN3ZXIsIGRlc2NyaXB0aW9uLCBlbmNvZGluZywgY2FsbGJhY2spIDpcbiAgICAgIHZpc2libGVJbnB1dChhbnN3ZXIsIGRlc2NyaXB0aW9uLCBlbmNvZGluZywgY2FsbGJhY2spO1xufVxuXG5mdW5jdGlvbiBoaWRkZW5JbnB1dChhbnN3ZXIsIGRlc2NyaXB0aW9uLCBlbmNvZGluZywgY2FsbGJhY2spIHtcbiAgY29uc3QgZXZlbnQgPSBEQVRBX0VWRU5ULFxuICAgICAgICByYXdNb2RlID0gdHJ1ZTtcblxuICBwcm9jZXNzLnN0ZG91dC53cml0ZShkZXNjcmlwdGlvbik7XG5cbiAgcHJvY2Vzcy5zdGRpbi5zZXRFbmNvZGluZyhlbmNvZGluZyk7XG5cbiAgcHJvY2Vzcy5zdGRpbi5zZXRSYXdNb2RlKHJhd01vZGUpO1xuXG4gIHByb2Nlc3Muc3RkaW4ub24oZXZlbnQsIGxpc3RlbmVyKTtcblxuICBwcm9jZXNzLnN0ZGluLnJlc3VtZSgpO1xuXG4gIGZ1bmN0aW9uIGxpc3RlbmVyKGRhdGEpIHtcbiAgICBjb25zdCBjaGFyYWN0ZXIgPSBkYXRhLnRvU3RyaW5nKGVuY29kaW5nKTtcblxuICAgIHN3aXRjaCAoY2hhcmFjdGVyKSB7XG4gICAgICBjYXNlIExJTkVfRkVFRF9DSEFSQUNURVIgOlxuICAgICAgY2FzZSBDQVJSSUFHRV9SRVRVUk5fQ0hBUkFDVEVSIDpcbiAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoTElORV9GRUVEX0NIQVJBQ1RFUik7XG5cbiAgICAgICAgcHJvY2Vzcy5zdGRpbi5yZW1vdmVMaXN0ZW5lcihldmVudCwgbGlzdGVuZXIpO1xuXG4gICAgICAgIHByb2Nlc3Muc3RkaW4ucGF1c2UoKTtcblxuICAgICAgICBjYWxsYmFjayhhbnN3ZXIpO1xuXG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIEJBQ0tTUEFDRV9DSEFSQUNURVIgOlxuICAgICAgICBhbnN3ZXIgPSBhbnN3ZXIuc2xpY2UoMCwgYW5zd2VyLmxlbmd0aCAtIDEpO1xuXG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICBhbnN3ZXIgKz0gY2hhcmFjdGVyO1xuXG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIEVUWF9DSEFSQUNURVIgOlxuICAgICAgICBjb25zb2xlLmxvZyhDVFJMX0MpO1xuXG4gICAgICAgIHByb2Nlc3MuZXhpdCgpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiB2aXNpYmxlSW5wdXQoYW5zd2VyLCBkZXNjcmlwdGlvbiwgZW5jb2RpbmcsIGNhbGxiYWNrKSB7XG4gIHByb2Nlc3Muc3Rkb3V0LndyaXRlKGRlc2NyaXB0aW9uKTtcblxuICBwcm9jZXNzLnN0ZG91dC53cml0ZShhbnN3ZXIpO1xuXG4gIHByb2Nlc3Muc3RkaW4uc2V0RW5jb2RpbmcoZW5jb2RpbmcpO1xuXG4gIHByb2Nlc3Muc3RkaW4ub25jZShEQVRBX0VWRU5ULCBsaXN0ZW5lcik7XG5cbiAgcHJvY2Vzcy5zdGRpbi5yZXN1bWUoKTtcblxuICBmdW5jdGlvbiBsaXN0ZW5lcihkYXRhKSB7XG4gICAgY29uc3QgYW5zd2VyID0gZGF0YS5yZXBsYWNlKC9cXG4kLywgXCJcIik7XG5cbiAgICBwcm9jZXNzLnN0ZGluLnBhdXNlKCk7XG5cbiAgICBjYWxsYmFjayhhbnN3ZXIpO1xuICB9XG59XG4iXX0=