"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.onETX = onETX;
exports.prompt = prompt;
exports["default"] = void 0;

var _asynchronous = require("../utilities/asynchronous");

var _constants = require("../constants");

function onETX(handler) {
  var event = _constants.DATA_EVENT;

  if (process.stdin.setRawMode) {
    var rawMode = true,
        encoding = _constants.UTF8_ENCODING;
    process.stdin.setRawMode(rawMode);
    process.stdin.setEncoding(encoding);
    process.stdin.resume();
    process.stdin.addListener(event, dataHandler);
    return offExt;
  }

  function offExt() {
    process.stdin.removeListener(event, dataHandler);
  }

  function dataHandler(character) {
    if (character === _constants.ETX_CHARACTER) {
      handler();
    }
  }
}

function prompt(options, callback) {
  var _options$answer = options.answer,
      answer = _options$answer === void 0 ? null : _options$answer;

  if (answer !== null) {
    callback(answer);
    return;
  }

  answer = null;
  var _options$attempts = options.attempts,
      attempts = _options$attempts === void 0 ? _constants.DEFAULT_ATTEMPTS : _options$attempts,
      context = {
    answer: answer,
    attempts: attempts,
    options: options
  };
  (0, _asynchronous.whilst)(attempt, function () {
    var answer = context.answer;
    callback(answer);
  }, context);
}

var _default = {
  onETX: onETX,
  prompt: prompt
};
exports["default"] = _default;

function attempt(next, done, context) {
  var attempts = context.attempts;
  var terminate = attempts-- === 0;

  if (terminate) {
    done();
    return;
  }

  var options = context.options,
      _options$hidden = options.hidden,
      hidden = _options$hidden === void 0 ? false : _options$hidden,
      _options$encoding = options.encoding,
      encoding = _options$encoding === void 0 ? _constants.DEFAULT_ENCODING : _options$encoding,
      description = options.description,
      errorMessage = options.errorMessage,
      _options$initialAnswe = options.initialAnswer,
      initialAnswer = _options$initialAnswe === void 0 ? _constants.DEFAULT_INITIAL_ANSWER : _options$initialAnswe,
      validationPattern = options.validationPattern,
      validationFunction = options.validationFunction;
  input(description, initialAnswer, encoding, hidden, callback);

  function callback(answer) {
    var valid = validationFunction ? ///
    validationFunction(answer) : validationPattern.test(answer);

    if (valid) {
      Object.assign(context, {
        answer: answer
      });
      done();
    } else {
      console.log(errorMessage);
      Object.assign(context, {
        attempts: attempts
      });
      next();
    }
  }
}

function input(description, initialAnswer, encoding, hidden, callback) {
  var answer = initialAnswer; ///

  var event = _constants.DATA_EVENT,
      rawMode = true,
      offETX = onETX(function () {
    console.log(_constants.CTRL_C);
    process.exit();
  });
  process.stdin.setEncoding(encoding);
  process.stdin.setRawMode(rawMode);
  process.stdout.write(description);

  if (!hidden) {
    process.stdout.write(answer);
  }

  process.stdin.resume();
  process.stdin.on(event, listener);

  function listener(chunk) {
    var character = chunk.toString(encoding);

    switch (character) {
      case _constants.LINE_FEED_CHARACTER:
      case _constants.CARRIAGE_RETURN_CHARACTER:
        process.stdout.write(_constants.LINE_FEED_CHARACTER);
        process.stdin.removeListener(event, listener);
        process.stdin.pause();
        offETX();
        callback(answer);
        break;

      case _constants.BACKSPACE_CHARACTER:
        answer = answer.slice(0, answer.length - 1);
        process.stdout.clearLine();
        process.stdout.cursorTo(0);
        process.stdout.write(description);

        if (!hidden) {
          process.stdout.write(answer);
        }

        break;

      default:
        answer += character;

        if (!hidden) {
          process.stdout.clearLine();
          process.stdout.cursorTo(0);
          process.stdout.write(description);
          process.stdout.write(answer);
        }

        break;
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvc2hlbGwuanMiXSwibmFtZXMiOlsib25FVFgiLCJoYW5kbGVyIiwiZXZlbnQiLCJEQVRBX0VWRU5UIiwicHJvY2VzcyIsInN0ZGluIiwic2V0UmF3TW9kZSIsInJhd01vZGUiLCJlbmNvZGluZyIsIlVURjhfRU5DT0RJTkciLCJzZXRFbmNvZGluZyIsInJlc3VtZSIsImFkZExpc3RlbmVyIiwiZGF0YUhhbmRsZXIiLCJvZmZFeHQiLCJyZW1vdmVMaXN0ZW5lciIsImNoYXJhY3RlciIsIkVUWF9DSEFSQUNURVIiLCJwcm9tcHQiLCJvcHRpb25zIiwiY2FsbGJhY2siLCJhbnN3ZXIiLCJhdHRlbXB0cyIsIkRFRkFVTFRfQVRURU1QVFMiLCJjb250ZXh0IiwiYXR0ZW1wdCIsIm5leHQiLCJkb25lIiwidGVybWluYXRlIiwiaGlkZGVuIiwiREVGQVVMVF9FTkNPRElORyIsImRlc2NyaXB0aW9uIiwiZXJyb3JNZXNzYWdlIiwiaW5pdGlhbEFuc3dlciIsIkRFRkFVTFRfSU5JVElBTF9BTlNXRVIiLCJ2YWxpZGF0aW9uUGF0dGVybiIsInZhbGlkYXRpb25GdW5jdGlvbiIsImlucHV0IiwidmFsaWQiLCJ0ZXN0IiwiT2JqZWN0IiwiYXNzaWduIiwiY29uc29sZSIsImxvZyIsIm9mZkVUWCIsIkNUUkxfQyIsImV4aXQiLCJzdGRvdXQiLCJ3cml0ZSIsIm9uIiwibGlzdGVuZXIiLCJjaHVuayIsInRvU3RyaW5nIiwiTElORV9GRUVEX0NIQVJBQ1RFUiIsIkNBUlJJQUdFX1JFVFVSTl9DSEFSQUNURVIiLCJwYXVzZSIsIkJBQ0tTUEFDRV9DSEFSQUNURVIiLCJzbGljZSIsImxlbmd0aCIsImNsZWFyTGluZSIsImN1cnNvclRvIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7O0FBRUE7O0FBRUE7O0FBV08sU0FBU0EsS0FBVCxDQUFlQyxPQUFmLEVBQXdCO0FBQzdCLE1BQU1DLEtBQUssR0FBR0MscUJBQWQ7O0FBRUEsTUFBSUMsT0FBTyxDQUFDQyxLQUFSLENBQWNDLFVBQWxCLEVBQThCO0FBQzVCLFFBQU1DLE9BQU8sR0FBRyxJQUFoQjtBQUFBLFFBQ01DLFFBQVEsR0FBR0Msd0JBRGpCO0FBR0FMLElBQUFBLE9BQU8sQ0FBQ0MsS0FBUixDQUFjQyxVQUFkLENBQXlCQyxPQUF6QjtBQUNBSCxJQUFBQSxPQUFPLENBQUNDLEtBQVIsQ0FBY0ssV0FBZCxDQUEwQkYsUUFBMUI7QUFFQUosSUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWNNLE1BQWQ7QUFFQVAsSUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWNPLFdBQWQsQ0FBMEJWLEtBQTFCLEVBQWlDVyxXQUFqQztBQUVBLFdBQU9DLE1BQVA7QUFDRDs7QUFFRCxXQUFTQSxNQUFULEdBQWtCO0FBQ2hCVixJQUFBQSxPQUFPLENBQUNDLEtBQVIsQ0FBY1UsY0FBZCxDQUE2QmIsS0FBN0IsRUFBb0NXLFdBQXBDO0FBQ0Q7O0FBRUQsV0FBU0EsV0FBVCxDQUFxQkcsU0FBckIsRUFBZ0M7QUFDOUIsUUFBSUEsU0FBUyxLQUFLQyx3QkFBbEIsRUFBaUM7QUFDL0JoQixNQUFBQSxPQUFPO0FBQ1I7QUFDRjtBQUNGOztBQUVNLFNBQVNpQixNQUFULENBQWdCQyxPQUFoQixFQUF5QkMsUUFBekIsRUFBbUM7QUFBQSx3QkFDaEJELE9BRGdCLENBQ2xDRSxNQURrQztBQUFBLE1BQ2xDQSxNQURrQyxnQ0FDekIsSUFEeUI7O0FBR3hDLE1BQUlBLE1BQU0sS0FBSyxJQUFmLEVBQXFCO0FBQ25CRCxJQUFBQSxRQUFRLENBQUNDLE1BQUQsQ0FBUjtBQUVBO0FBQ0Q7O0FBRURBLEVBQUFBLE1BQU0sR0FBRyxJQUFUO0FBVHdDLDBCQVdBRixPQVhBLENBV2hDRyxRQVhnQztBQUFBLE1BV2hDQSxRQVhnQyxrQ0FXckJDLDJCQVhxQjtBQUFBLE1BWWxDQyxPQVprQyxHQVl4QjtBQUNSSCxJQUFBQSxNQUFNLEVBQU5BLE1BRFE7QUFFUkMsSUFBQUEsUUFBUSxFQUFSQSxRQUZRO0FBR1JILElBQUFBLE9BQU8sRUFBUEE7QUFIUSxHQVp3QjtBQWtCeEMsNEJBQU9NLE9BQVAsRUFBZ0IsWUFBTTtBQUFBLFFBQ1pKLE1BRFksR0FDREcsT0FEQyxDQUNaSCxNQURZO0FBR3BCRCxJQUFBQSxRQUFRLENBQUNDLE1BQUQsQ0FBUjtBQUNELEdBSkQsRUFJR0csT0FKSDtBQUtEOztlQUVjO0FBQ2J4QixFQUFBQSxLQUFLLEVBQUxBLEtBRGE7QUFFYmtCLEVBQUFBLE1BQU0sRUFBTkE7QUFGYSxDOzs7QUFLZixTQUFTTyxPQUFULENBQWlCQyxJQUFqQixFQUF1QkMsSUFBdkIsRUFBNkJILE9BQTdCLEVBQXNDO0FBQUEsTUFDOUJGLFFBRDhCLEdBQ2pCRSxPQURpQixDQUM5QkYsUUFEOEI7QUFHcEMsTUFBTU0sU0FBUyxHQUFJTixRQUFRLE9BQU8sQ0FBbEM7O0FBRUEsTUFBSU0sU0FBSixFQUFlO0FBQ2JELElBQUFBLElBQUk7QUFFSjtBQUNEOztBQUVLLE1BQUVSLE9BQUYsR0FBY0ssT0FBZCxDQUFFTCxPQUFGO0FBQUEsd0JBT3lCQSxPQVB6QixDQUNFVSxNQURGO0FBQUEsTUFDRUEsTUFERixnQ0FDVyxLQURYO0FBQUEsMEJBT3lCVixPQVB6QixDQUVFWCxRQUZGO0FBQUEsTUFFRUEsUUFGRixrQ0FFYXNCLDJCQUZiO0FBQUEsTUFHRUMsV0FIRixHQU95QlosT0FQekIsQ0FHRVksV0FIRjtBQUFBLE1BSUVDLFlBSkYsR0FPeUJiLE9BUHpCLENBSUVhLFlBSkY7QUFBQSw4QkFPeUJiLE9BUHpCLENBS0VjLGFBTEY7QUFBQSxNQUtFQSxhQUxGLHNDQUtrQkMsaUNBTGxCO0FBQUEsTUFNRUMsaUJBTkYsR0FPeUJoQixPQVB6QixDQU1FZ0IsaUJBTkY7QUFBQSxNQU9FQyxrQkFQRixHQU95QmpCLE9BUHpCLENBT0VpQixrQkFQRjtBQVNOQyxFQUFBQSxLQUFLLENBQUNOLFdBQUQsRUFBY0UsYUFBZCxFQUE2QnpCLFFBQTdCLEVBQXVDcUIsTUFBdkMsRUFBK0NULFFBQS9DLENBQUw7O0FBRUEsV0FBU0EsUUFBVCxDQUFrQkMsTUFBbEIsRUFBMEI7QUFDeEIsUUFBTWlCLEtBQUssR0FBR0Ysa0JBQWtCLEdBQUk7QUFDcEJBLElBQUFBLGtCQUFrQixDQUFDZixNQUFELENBREYsR0FFZGMsaUJBQWlCLENBQUNJLElBQWxCLENBQXVCbEIsTUFBdkIsQ0FGbEI7O0FBSUEsUUFBSWlCLEtBQUosRUFBVztBQUNURSxNQUFBQSxNQUFNLENBQUNDLE1BQVAsQ0FBY2pCLE9BQWQsRUFBdUI7QUFDckJILFFBQUFBLE1BQU0sRUFBTkE7QUFEcUIsT0FBdkI7QUFJQU0sTUFBQUEsSUFBSTtBQUNMLEtBTkQsTUFNTztBQUNMZSxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWVgsWUFBWjtBQUVBUSxNQUFBQSxNQUFNLENBQUNDLE1BQVAsQ0FBY2pCLE9BQWQsRUFBdUI7QUFDckJGLFFBQUFBLFFBQVEsRUFBUkE7QUFEcUIsT0FBdkI7QUFJQUksTUFBQUEsSUFBSTtBQUNMO0FBQ0Y7QUFDRjs7QUFFRCxTQUFTVyxLQUFULENBQWVOLFdBQWYsRUFBNEJFLGFBQTVCLEVBQTJDekIsUUFBM0MsRUFBcURxQixNQUFyRCxFQUE2RFQsUUFBN0QsRUFBdUU7QUFDckUsTUFBSUMsTUFBTSxHQUFHWSxhQUFiLENBRHFFLENBQ3pDOztBQUU1QixNQUFNL0IsS0FBSyxHQUFHQyxxQkFBZDtBQUFBLE1BQ01JLE9BQU8sR0FBRyxJQURoQjtBQUFBLE1BRU1xQyxNQUFNLEdBQUc1QyxLQUFLLENBQUMsWUFBTTtBQUNuQjBDLElBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZRSxpQkFBWjtBQUVBekMsSUFBQUEsT0FBTyxDQUFDMEMsSUFBUjtBQUNELEdBSmEsQ0FGcEI7QUFRQTFDLEVBQUFBLE9BQU8sQ0FBQ0MsS0FBUixDQUFjSyxXQUFkLENBQTBCRixRQUExQjtBQUVBSixFQUFBQSxPQUFPLENBQUNDLEtBQVIsQ0FBY0MsVUFBZCxDQUF5QkMsT0FBekI7QUFFQUgsRUFBQUEsT0FBTyxDQUFDMkMsTUFBUixDQUFlQyxLQUFmLENBQXFCakIsV0FBckI7O0FBRUEsTUFBSSxDQUFDRixNQUFMLEVBQWE7QUFDWHpCLElBQUFBLE9BQU8sQ0FBQzJDLE1BQVIsQ0FBZUMsS0FBZixDQUFxQjNCLE1BQXJCO0FBQ0Q7O0FBRURqQixFQUFBQSxPQUFPLENBQUNDLEtBQVIsQ0FBY00sTUFBZDtBQUVBUCxFQUFBQSxPQUFPLENBQUNDLEtBQVIsQ0FBYzRDLEVBQWQsQ0FBaUIvQyxLQUFqQixFQUF3QmdELFFBQXhCOztBQUVBLFdBQVNBLFFBQVQsQ0FBa0JDLEtBQWxCLEVBQXlCO0FBQ3ZCLFFBQU1uQyxTQUFTLEdBQUdtQyxLQUFLLENBQUNDLFFBQU4sQ0FBZTVDLFFBQWYsQ0FBbEI7O0FBRUEsWUFBUVEsU0FBUjtBQUNFLFdBQUtxQyw4QkFBTDtBQUNBLFdBQUtDLG9DQUFMO0FBQ0VsRCxRQUFBQSxPQUFPLENBQUMyQyxNQUFSLENBQWVDLEtBQWYsQ0FBcUJLLDhCQUFyQjtBQUVBakQsUUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWNVLGNBQWQsQ0FBNkJiLEtBQTdCLEVBQW9DZ0QsUUFBcEM7QUFFQTlDLFFBQUFBLE9BQU8sQ0FBQ0MsS0FBUixDQUFja0QsS0FBZDtBQUVBWCxRQUFBQSxNQUFNO0FBRU54QixRQUFBQSxRQUFRLENBQUNDLE1BQUQsQ0FBUjtBQUVBOztBQUVGLFdBQUttQyw4QkFBTDtBQUNFbkMsUUFBQUEsTUFBTSxHQUFHQSxNQUFNLENBQUNvQyxLQUFQLENBQWEsQ0FBYixFQUFnQnBDLE1BQU0sQ0FBQ3FDLE1BQVAsR0FBZ0IsQ0FBaEMsQ0FBVDtBQUVBdEQsUUFBQUEsT0FBTyxDQUFDMkMsTUFBUixDQUFlWSxTQUFmO0FBRUF2RCxRQUFBQSxPQUFPLENBQUMyQyxNQUFSLENBQWVhLFFBQWYsQ0FBd0IsQ0FBeEI7QUFFQXhELFFBQUFBLE9BQU8sQ0FBQzJDLE1BQVIsQ0FBZUMsS0FBZixDQUFxQmpCLFdBQXJCOztBQUVBLFlBQUksQ0FBQ0YsTUFBTCxFQUFhO0FBQ1h6QixVQUFBQSxPQUFPLENBQUMyQyxNQUFSLENBQWVDLEtBQWYsQ0FBcUIzQixNQUFyQjtBQUNEOztBQUVEOztBQUVGO0FBQ0VBLFFBQUFBLE1BQU0sSUFBSUwsU0FBVjs7QUFFQSxZQUFJLENBQUNhLE1BQUwsRUFBYTtBQUNYekIsVUFBQUEsT0FBTyxDQUFDMkMsTUFBUixDQUFlWSxTQUFmO0FBRUF2RCxVQUFBQSxPQUFPLENBQUMyQyxNQUFSLENBQWVhLFFBQWYsQ0FBd0IsQ0FBeEI7QUFFQXhELFVBQUFBLE9BQU8sQ0FBQzJDLE1BQVIsQ0FBZUMsS0FBZixDQUFxQmpCLFdBQXJCO0FBRUEzQixVQUFBQSxPQUFPLENBQUMyQyxNQUFSLENBQWVDLEtBQWYsQ0FBcUIzQixNQUFyQjtBQUNEOztBQUVEO0FBM0NKO0FBNkNEO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IHsgd2hpbHN0IH0gZnJvbSBcIi4uL3V0aWxpdGllcy9hc3luY2hyb25vdXNcIjtcblxuaW1wb3J0IHsgQ1RSTF9DLFxuICAgICAgICAgREFUQV9FVkVOVCxcbiAgICAgICAgIFVURjhfRU5DT0RJTkcsXG4gICAgICAgICBFVFhfQ0hBUkFDVEVSLFxuICAgICAgICAgREVGQVVMVF9FTkNPRElORyxcbiAgICAgICAgIERFRkFVTFRfQVRURU1QVFMsXG4gICAgICAgICBCQUNLU1BBQ0VfQ0hBUkFDVEVSLFxuICAgICAgICAgTElORV9GRUVEX0NIQVJBQ1RFUixcbiAgICAgICAgIERFRkFVTFRfSU5JVElBTF9BTlNXRVIsXG4gICAgICAgICBDQVJSSUFHRV9SRVRVUk5fQ0hBUkFDVEVSIH0gZnJvbSBcIi4uL2NvbnN0YW50c1wiO1xuXG5leHBvcnQgZnVuY3Rpb24gb25FVFgoaGFuZGxlcikge1xuICBjb25zdCBldmVudCA9IERBVEFfRVZFTlQ7XG5cbiAgaWYgKHByb2Nlc3Muc3RkaW4uc2V0UmF3TW9kZSkge1xuICAgIGNvbnN0IHJhd01vZGUgPSB0cnVlLFxuICAgICAgICAgIGVuY29kaW5nID0gVVRGOF9FTkNPRElORztcblxuICAgIHByb2Nlc3Muc3RkaW4uc2V0UmF3TW9kZShyYXdNb2RlKTtcbiAgICBwcm9jZXNzLnN0ZGluLnNldEVuY29kaW5nKGVuY29kaW5nKTtcblxuICAgIHByb2Nlc3Muc3RkaW4ucmVzdW1lKCk7XG5cbiAgICBwcm9jZXNzLnN0ZGluLmFkZExpc3RlbmVyKGV2ZW50LCBkYXRhSGFuZGxlcik7XG5cbiAgICByZXR1cm4gb2ZmRXh0O1xuICB9XG5cbiAgZnVuY3Rpb24gb2ZmRXh0KCkge1xuICAgIHByb2Nlc3Muc3RkaW4ucmVtb3ZlTGlzdGVuZXIoZXZlbnQsIGRhdGFIYW5kbGVyKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGRhdGFIYW5kbGVyKGNoYXJhY3Rlcikge1xuICAgIGlmIChjaGFyYWN0ZXIgPT09IEVUWF9DSEFSQUNURVIpIHtcbiAgICAgIGhhbmRsZXIoKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByb21wdChvcHRpb25zLCBjYWxsYmFjaykge1xuICBsZXQgeyBhbnN3ZXIgPSBudWxsIH0gPSBvcHRpb25zO1xuXG4gIGlmIChhbnN3ZXIgIT09IG51bGwpIHtcbiAgICBjYWxsYmFjayhhbnN3ZXIpO1xuXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgYW5zd2VyID0gbnVsbDtcblxuICBjb25zdCB7IGF0dGVtcHRzID0gREVGQVVMVF9BVFRFTVBUUyB9ID0gb3B0aW9ucyxcbiAgICAgICAgY29udGV4dCA9IHtcbiAgICAgICAgICBhbnN3ZXIsXG4gICAgICAgICAgYXR0ZW1wdHMsXG4gICAgICAgICAgb3B0aW9uc1xuICAgICAgICB9O1xuXG4gIHdoaWxzdChhdHRlbXB0LCAoKSA9PiB7XG4gICAgY29uc3QgeyBhbnN3ZXIgfSA9IGNvbnRleHQ7XG4gICAgXG4gICAgY2FsbGJhY2soYW5zd2VyKTtcbiAgfSwgY29udGV4dCk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgb25FVFgsXG4gIHByb21wdFxufVxuXG5mdW5jdGlvbiBhdHRlbXB0KG5leHQsIGRvbmUsIGNvbnRleHQpIHtcbiAgbGV0IHsgYXR0ZW1wdHMgfSA9IGNvbnRleHQ7XG5cbiAgY29uc3QgdGVybWluYXRlID0gKGF0dGVtcHRzLS0gPT09IDApO1xuICBcbiAgaWYgKHRlcm1pbmF0ZSkge1xuICAgIGRvbmUoKTtcbiAgICBcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCB7IG9wdGlvbnMgfSA9IGNvbnRleHQsXG4gICAgICAgIHsgaGlkZGVuID0gZmFsc2UsXG4gICAgICAgICAgZW5jb2RpbmcgPSBERUZBVUxUX0VOQ09ESU5HLFxuICAgICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICAgIGVycm9yTWVzc2FnZSxcbiAgICAgICAgICBpbml0aWFsQW5zd2VyID0gREVGQVVMVF9JTklUSUFMX0FOU1dFUixcbiAgICAgICAgICB2YWxpZGF0aW9uUGF0dGVybixcbiAgICAgICAgICB2YWxpZGF0aW9uRnVuY3Rpb24gfSA9IG9wdGlvbnM7XG5cbiAgaW5wdXQoZGVzY3JpcHRpb24sIGluaXRpYWxBbnN3ZXIsIGVuY29kaW5nLCBoaWRkZW4sIGNhbGxiYWNrKTtcblxuICBmdW5jdGlvbiBjYWxsYmFjayhhbnN3ZXIpIHtcbiAgICBjb25zdCB2YWxpZCA9IHZhbGlkYXRpb25GdW5jdGlvbiA/ICAvLy9cbiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGlvbkZ1bmN0aW9uKGFuc3dlcikgOlxuICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRpb25QYXR0ZXJuLnRlc3QoYW5zd2VyKTtcblxuICAgIGlmICh2YWxpZCkge1xuICAgICAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCB7XG4gICAgICAgIGFuc3dlclxuICAgICAgfSk7XG5cbiAgICAgIGRvbmUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coZXJyb3JNZXNzYWdlKTtcblxuICAgICAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCB7XG4gICAgICAgIGF0dGVtcHRzXG4gICAgICB9KTtcblxuICAgICAgbmV4dCgpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBpbnB1dChkZXNjcmlwdGlvbiwgaW5pdGlhbEFuc3dlciwgZW5jb2RpbmcsIGhpZGRlbiwgY2FsbGJhY2spIHtcbiAgbGV0IGFuc3dlciA9IGluaXRpYWxBbnN3ZXI7IC8vL1xuXG4gIGNvbnN0IGV2ZW50ID0gREFUQV9FVkVOVCxcbiAgICAgICAgcmF3TW9kZSA9IHRydWUsXG4gICAgICAgIG9mZkVUWCA9IG9uRVRYKCgpID0+IHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhDVFJMX0MpO1xuXG4gICAgICAgICAgcHJvY2Vzcy5leGl0KCk7XG4gICAgICAgIH0pO1xuXG4gIHByb2Nlc3Muc3RkaW4uc2V0RW5jb2RpbmcoZW5jb2RpbmcpO1xuXG4gIHByb2Nlc3Muc3RkaW4uc2V0UmF3TW9kZShyYXdNb2RlKTtcblxuICBwcm9jZXNzLnN0ZG91dC53cml0ZShkZXNjcmlwdGlvbik7XG5cbiAgaWYgKCFoaWRkZW4pIHtcbiAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShhbnN3ZXIpO1xuICB9XG5cbiAgcHJvY2Vzcy5zdGRpbi5yZXN1bWUoKTtcblxuICBwcm9jZXNzLnN0ZGluLm9uKGV2ZW50LCBsaXN0ZW5lcik7XG5cbiAgZnVuY3Rpb24gbGlzdGVuZXIoY2h1bmspIHtcbiAgICBjb25zdCBjaGFyYWN0ZXIgPSBjaHVuay50b1N0cmluZyhlbmNvZGluZyk7XG5cbiAgICBzd2l0Y2ggKGNoYXJhY3Rlcikge1xuICAgICAgY2FzZSBMSU5FX0ZFRURfQ0hBUkFDVEVSIDpcbiAgICAgIGNhc2UgQ0FSUklBR0VfUkVUVVJOX0NIQVJBQ1RFUiA6XG4gICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKExJTkVfRkVFRF9DSEFSQUNURVIpO1xuXG4gICAgICAgIHByb2Nlc3Muc3RkaW4ucmVtb3ZlTGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyKTtcblxuICAgICAgICBwcm9jZXNzLnN0ZGluLnBhdXNlKCk7XG5cbiAgICAgICAgb2ZmRVRYKCk7XG5cbiAgICAgICAgY2FsbGJhY2soYW5zd2VyKTtcblxuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBCQUNLU1BBQ0VfQ0hBUkFDVEVSIDpcbiAgICAgICAgYW5zd2VyID0gYW5zd2VyLnNsaWNlKDAsIGFuc3dlci5sZW5ndGggLSAxKTtcblxuICAgICAgICBwcm9jZXNzLnN0ZG91dC5jbGVhckxpbmUoKTtcblxuICAgICAgICBwcm9jZXNzLnN0ZG91dC5jdXJzb3JUbygwKTtcblxuICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShkZXNjcmlwdGlvbik7XG5cbiAgICAgICAgaWYgKCFoaWRkZW4pIHtcbiAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShhbnN3ZXIpO1xuICAgICAgICB9XG5cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGFuc3dlciArPSBjaGFyYWN0ZXI7XG5cbiAgICAgICAgaWYgKCFoaWRkZW4pIHtcbiAgICAgICAgICBwcm9jZXNzLnN0ZG91dC5jbGVhckxpbmUoKTtcblxuICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0LmN1cnNvclRvKDApO1xuXG4gICAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoZGVzY3JpcHRpb24pO1xuXG4gICAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoYW5zd2VyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxufVxuIl19