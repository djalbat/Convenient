'use strict';

var path = require('path');

var pathUtilities = require('../utilities/path'),
    arrayUtilities = require('../utilities/array'),
    fileSystemUtilities = require('../utilities/fileSystem');

var second = arrayUtilities.second,
    concatenatePaths = pathUtilities.concatenatePaths,
    doesFileExist = fileSystemUtilities.doesFileExist,
    readFile = fileSystemUtilities.readFile,
    appendToFile = fileSystemUtilities.appendToFile,
    renameFile = fileSystemUtilities.renameFile,
    getStats = fileSystemUtilities.getStats;


var GET_METHOD = 'GET',
    POST_METHOD = 'POST',
    ETX_CHARACTER = '\x03';

function log(message) {
  var level = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';

  var pertinentStackMessageIndex = 2;

  if (level) {
    ///
    var levelIndex = levels.indexOf(level),
        logLevelIndex = levels.indexOf(logLevel);

    if (levelIndex > logLevelIndex) {
      return;
    }

    pertinentStackMessageIndex += 1;

    level = level + ' '; ///
  }

  var error = new Error(),
      stack = error.stack,
      stackMessages = stack.split(/\r\n|\n/),
      pertinentStackMessage = stackMessages[pertinentStackMessageIndex],
      currentDateAndTimeString = getCurrentDateAndTimeString(),
      filePath = filePathFromStackMessage(pertinentStackMessage),
      lineNumber = lineNumberFromStackMessage(pertinentStackMessage),
      logMessage = '' + level + currentDateAndTimeString + ' ' + filePath + '(' + lineNumber + ') ' + message;


  console.log(logMessage);

  if (logDirectoryPath !== null) {
    rollOverLogFile();

    var logFilePath = getLogFilePath(),
        logFileContent = logMessage + '\n';

    appendToFile(logFilePath, logFileContent);
  }
}

function get(host, uri, parameters, callback) {
  if (callback === undefined) {
    callback = parameters; ///
    parameters = {};
  }

  var method = GET_METHOD,
      body = undefined;

  request(host, uri, parameters, method, body, callback);
}

function post(host, uri, json, parameters, callback) {
  if (callback === undefined) {
    callback = parameters; ///
    parameters = {};
  }

  var method = POST_METHOD,
      body = JSON.stringify(json);

  request(host, uri, parameters, method, body, callback);
}

function onETX(handler) {
  var _process = process,
      stdin = _process.stdin,
      setRawMode = stdin.setRawMode;


  if (setRawMode) {
    var rawMode = true,
        encoding = 'utf8';

    stdin.setRawMode(rawMode);
    stdin.setEncoding(encoding);

    stdin.resume();

    stdin.addListener('data', dataHandler);

    return offExt;
  }

  function offExt() {
    stdin.removeListener('data', dataHandler);
  }

  function dataHandler(character) {
    if (character === ETX_CHARACTER) {
      handler();
    }
  }
}

module.exports = {
  log: log,
  get: get,
  post: post,
  onETX: onETX
};

function request(host, uri, parameters, method, body, callback) {
  var url = urlFromHostURIAndParameters(host, uri, parameters),
      xmlHttpRequest = new XMLHttpRequest();

  xmlHttpRequest.onreadystatechange = function () {
    var readyState = xmlHttpRequest.readyState,
        status = xmlHttpRequest.status,
        responseText = xmlHttpRequest.responseText;


    if (readyState == 4) {
      if (status == 200) {
        var jsonString = responseText,
            ///
        json = JSON.parse(jsonString);

        callback(json);
      } else {
        callback(null);
      }
    }
  };

  xmlHttpRequest.open(method, url, true);

  xmlHttpRequest.send(body);
}

function urlFromHostURIAndParameters(host, uri, parameters) {
  var queryString = queryStringFromParameters(parameters),
      url = queryString === '' ? host + '/' + uri : host + '/' + uri + '?' + queryString;

  return url;
}

function queryStringFromParameters(parameters) {
  var names = Object.keys(parameters),
      namesLength = names.length,
      lastIndex = namesLength - 1,
      queryString = names.reduce(function (queryString, name, index) {
    var value = parameters[name],
        encodedName = encodeURIComponent(name),
        encodedValue = encodeURIComponent(value),
        ampersandOrNothing = index !== lastIndex ? '&' : '';

    queryString += encodedName + '=' + encodedValue + ampersandOrNothing;

    return queryString;
  }, '');

  return queryString;
}

var TRACE = 'TRACE',
    DEBUG = 'DEBUG',
    INFO = 'INFO',
    WARNING = 'WARNING',
    ERROR = 'ERROR',
    FATAL = 'FATAL',
    levels = [TRACE, DEBUG, INFO, WARNING, ERROR, FATAL],
    currentWorkingDirectoryPath = path.resolve('.'),
    ///
currentWorkingDirectoryPathLength = currentWorkingDirectoryPath.length;

var logLevel = WARNING,
    logFileBaseName = 'default',
    logDirectoryPath = null;

function fatal(message) {
  log(message, FATAL);
}

function error(message) {
  log(message, ERROR);
}

function warning(message) {
  log(message, WARNING);
}

function info(message) {
  log(message, INFO);
}

function debug(message) {
  log(message, DEBUG);
}

function trace(message) {
  log(message, TRACE);
}

function setLogLevel(level) {
  logLevel = level;
}

function setLogFileBaseName(fileBaeName) {
  logFileBaseName = fileBaeName;
}

function setLogDirectoryPath(directoryPath) {
  logDirectoryPath = directoryPath;
}

function getLogFileContent() {
  var logFilePath = getLogFilePath(),
      logFileContent = readFile(logFilePath);

  return logFileContent;
}

Object.assign(log, {
  FATAL: FATAL,
  ERROR: ERROR,
  WARNING: WARNING,
  INFO: INFO,
  DEBUG: DEBUG,
  TRACE: TRACE,
  fatal: fatal,
  error: error,
  warning: warning,
  info: info,
  debug: debug,
  trace: trace,
  setLogLevel: setLogLevel,
  setLogFileBaseName: setLogFileBaseName,
  setLogDirectoryPath: setLogDirectoryPath,
  getLogFileContent: getLogFileContent
});

function getLogFilePath() {
  var logFileName = logFileBaseName + '.log',
      logFilePath = concatenatePaths(logDirectoryPath, logFileName);

  return logFilePath;
}

function getRolledOverLogFilePath() {
  var currentDateString = getCurrentDateString(),
      rolledOverLogFileName = logFileBaseName + '.' + currentDateString + '.log',
      rolledOverLogFilePath = concatenatePaths(logDirectoryPath, rolledOverLogFileName);

  return rolledOverLogFilePath;
}

function getLogFileLastModifiedDate() {
  var logFilePath = getLogFilePath(),
      logFileStats = getStats(logFilePath),
      mtime = logFileStats.mtime,
      logFileLastModifiedDate = new Date(mtime); ///

  return logFileLastModifiedDate;
}

function rollOverLogFile() {
  var logFilePath = getLogFilePath(),
      logFileExists = doesFileExist(logFilePath);

  if (!logFileExists) {
    return;
  }

  var logFileLastModifiedDate = getLogFileLastModifiedDate(),
      logFileLastModifiedDateCurrentDate = isDateCurrentDate(logFileLastModifiedDate);

  if (!logFileLastModifiedDateCurrentDate) {
    var rolledOverLogFilePath = getRolledOverLogFilePath();

    renameFile(logFilePath, rolledOverLogFilePath);
  }
}

function isDateCurrentDate(date) {
  var currentDate = new Date(),
      dateString = date.toDateString(),
      currentDateString = currentDate.toDateString(),
      dateCurrentDate = dateString === currentDateString;

  return dateCurrentDate;
}

function getCurrentDateString() {
  var date = new Date(),
      day = padStartWithZeroes(date.getDate(), 2),
      ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
      ///
  year = date.getFullYear(),
      currentDateAndTimeString = day + '-' + month + '-' + year;

  return currentDateAndTimeString;
}

function getCurrentDateAndTimeString() {
  var date = new Date(),
      day = padStartWithZeroes(date.getDate(), 2),
      ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
      ///
  year = date.getFullYear(),
      hours = padStartWithZeroes(date.getHours(), 2),
      minutes = padStartWithZeroes(date.getMinutes(), 2),
      seconds = padStartWithZeroes(date.getSeconds(), 2),
      milliseconds = padStartWithZeroes(date.getMilliseconds(), 3),
      currentDateAndTimeString = day + '-' + month + '-' + year + ' ' + hours + ':' + minutes + ':' + seconds + '.' + milliseconds;

  return currentDateAndTimeString;
}

function filePathFromStackMessage(stackMessage) {
  var matches = stackMessage.match(/(\/.+)\:\d+\:\d+/),
      secondMatch = second(matches),
      absoluteFilePath = secondMatch,
      ///
  start = currentWorkingDirectoryPathLength + 1,
      ///
  filePath = absoluteFilePath.substr(start);

  return filePath;
}

function lineNumberFromStackMessage(stackMessage) {
  var matches = stackMessage.match(/\:(\d+)/),
      secondMatch = second(matches),
      lineNumber = secondMatch; ///

  return lineNumber;
}

function padStartWithZeroes(string, targetLength) {
  var padString = '0',
      paddedString = padStart(string, targetLength, padString);

  return paddedString;
}

function padStart(string, targetLength, padString) {
  var padding = '';

  for (var index = 0; index < targetLength; index++) {
    padding += padString;
  }

  var paddedString = ('' + padding + string).substr(-targetLength);

  return paddedString;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvbWlzY2VsbGFuZW91cy5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsInBhdGhVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsImZpbGVTeXN0ZW1VdGlsaXRpZXMiLCJzZWNvbmQiLCJjb25jYXRlbmF0ZVBhdGhzIiwiZG9lc0ZpbGVFeGlzdCIsInJlYWRGaWxlIiwiYXBwZW5kVG9GaWxlIiwicmVuYW1lRmlsZSIsImdldFN0YXRzIiwiR0VUX01FVEhPRCIsIlBPU1RfTUVUSE9EIiwiRVRYX0NIQVJBQ1RFUiIsImxvZyIsIm1lc3NhZ2UiLCJsZXZlbCIsInBlcnRpbmVudFN0YWNrTWVzc2FnZUluZGV4IiwibGV2ZWxJbmRleCIsImxldmVscyIsImluZGV4T2YiLCJsb2dMZXZlbEluZGV4IiwibG9nTGV2ZWwiLCJFcnJvciIsInN0YWNrIiwiZXJyb3IiLCJzdGFja01lc3NhZ2VzIiwic3BsaXQiLCJwZXJ0aW5lbnRTdGFja01lc3NhZ2UiLCJjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmciLCJnZXRDdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmciLCJmaWxlUGF0aCIsImZpbGVQYXRoRnJvbVN0YWNrTWVzc2FnZSIsImxpbmVOdW1iZXIiLCJsaW5lTnVtYmVyRnJvbVN0YWNrTWVzc2FnZSIsImxvZ01lc3NhZ2UiLCJjb25zb2xlIiwibG9nRGlyZWN0b3J5UGF0aCIsInJvbGxPdmVyTG9nRmlsZSIsImxvZ0ZpbGVQYXRoIiwiZ2V0TG9nRmlsZVBhdGgiLCJsb2dGaWxlQ29udGVudCIsImdldCIsImhvc3QiLCJ1cmkiLCJwYXJhbWV0ZXJzIiwiY2FsbGJhY2siLCJ1bmRlZmluZWQiLCJtZXRob2QiLCJib2R5IiwicmVxdWVzdCIsInBvc3QiLCJqc29uIiwiSlNPTiIsInN0cmluZ2lmeSIsIm9uRVRYIiwiaGFuZGxlciIsInByb2Nlc3MiLCJzdGRpbiIsInNldFJhd01vZGUiLCJyYXdNb2RlIiwiZW5jb2RpbmciLCJzZXRFbmNvZGluZyIsInJlc3VtZSIsImFkZExpc3RlbmVyIiwiZGF0YUhhbmRsZXIiLCJvZmZFeHQiLCJyZW1vdmVMaXN0ZW5lciIsImNoYXJhY3RlciIsIm1vZHVsZSIsImV4cG9ydHMiLCJ1cmwiLCJ1cmxGcm9tSG9zdFVSSUFuZFBhcmFtZXRlcnMiLCJ4bWxIdHRwUmVxdWVzdCIsIlhNTEh0dHBSZXF1ZXN0Iiwib25yZWFkeXN0YXRlY2hhbmdlIiwicmVhZHlTdGF0ZSIsInN0YXR1cyIsInJlc3BvbnNlVGV4dCIsImpzb25TdHJpbmciLCJwYXJzZSIsIm9wZW4iLCJzZW5kIiwicXVlcnlTdHJpbmciLCJxdWVyeVN0cmluZ0Zyb21QYXJhbWV0ZXJzIiwibmFtZXMiLCJPYmplY3QiLCJrZXlzIiwibmFtZXNMZW5ndGgiLCJsZW5ndGgiLCJsYXN0SW5kZXgiLCJyZWR1Y2UiLCJuYW1lIiwiaW5kZXgiLCJ2YWx1ZSIsImVuY29kZWROYW1lIiwiZW5jb2RlVVJJQ29tcG9uZW50IiwiZW5jb2RlZFZhbHVlIiwiYW1wZXJzYW5kT3JOb3RoaW5nIiwiVFJBQ0UiLCJERUJVRyIsIklORk8iLCJXQVJOSU5HIiwiRVJST1IiLCJGQVRBTCIsImN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aCIsInJlc29sdmUiLCJjdXJyZW50V29ya2luZ0RpcmVjdG9yeVBhdGhMZW5ndGgiLCJsb2dGaWxlQmFzZU5hbWUiLCJmYXRhbCIsIndhcm5pbmciLCJpbmZvIiwiZGVidWciLCJ0cmFjZSIsInNldExvZ0xldmVsIiwic2V0TG9nRmlsZUJhc2VOYW1lIiwiZmlsZUJhZU5hbWUiLCJzZXRMb2dEaXJlY3RvcnlQYXRoIiwiZGlyZWN0b3J5UGF0aCIsImdldExvZ0ZpbGVDb250ZW50IiwiYXNzaWduIiwibG9nRmlsZU5hbWUiLCJnZXRSb2xsZWRPdmVyTG9nRmlsZVBhdGgiLCJjdXJyZW50RGF0ZVN0cmluZyIsImdldEN1cnJlbnREYXRlU3RyaW5nIiwicm9sbGVkT3ZlckxvZ0ZpbGVOYW1lIiwicm9sbGVkT3ZlckxvZ0ZpbGVQYXRoIiwiZ2V0TG9nRmlsZUxhc3RNb2RpZmllZERhdGUiLCJsb2dGaWxlU3RhdHMiLCJtdGltZSIsImxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlIiwiRGF0ZSIsImxvZ0ZpbGVFeGlzdHMiLCJsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZUN1cnJlbnREYXRlIiwiaXNEYXRlQ3VycmVudERhdGUiLCJkYXRlIiwiY3VycmVudERhdGUiLCJkYXRlU3RyaW5nIiwidG9EYXRlU3RyaW5nIiwiZGF0ZUN1cnJlbnREYXRlIiwiZGF5IiwicGFkU3RhcnRXaXRoWmVyb2VzIiwiZ2V0RGF0ZSIsIm1vbnRoIiwiZ2V0TW9udGgiLCJ5ZWFyIiwiZ2V0RnVsbFllYXIiLCJob3VycyIsImdldEhvdXJzIiwibWludXRlcyIsImdldE1pbnV0ZXMiLCJzZWNvbmRzIiwiZ2V0U2Vjb25kcyIsIm1pbGxpc2Vjb25kcyIsImdldE1pbGxpc2Vjb25kcyIsInN0YWNrTWVzc2FnZSIsIm1hdGNoZXMiLCJtYXRjaCIsInNlY29uZE1hdGNoIiwiYWJzb2x1dGVGaWxlUGF0aCIsInN0YXJ0Iiwic3Vic3RyIiwic3RyaW5nIiwidGFyZ2V0TGVuZ3RoIiwicGFkU3RyaW5nIiwicGFkZGVkU3RyaW5nIiwicGFkU3RhcnQiLCJwYWRkaW5nIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxJQUFNQSxPQUFPQyxRQUFRLE1BQVIsQ0FBYjs7QUFFQSxJQUFNQyxnQkFBZ0JELFFBQVEsbUJBQVIsQ0FBdEI7QUFBQSxJQUNNRSxpQkFBaUJGLFFBQVEsb0JBQVIsQ0FEdkI7QUFBQSxJQUVNRyxzQkFBc0JILFFBQVEseUJBQVIsQ0FGNUI7O0FBSU0sSUFBRUksTUFBRixHQUFhRixjQUFiLENBQUVFLE1BQUY7QUFBQSxJQUNFQyxnQkFERixHQUN1QkosYUFEdkIsQ0FDRUksZ0JBREY7QUFBQSxJQUVFQyxhQUZGLEdBRWtFSCxtQkFGbEUsQ0FFRUcsYUFGRjtBQUFBLElBRWlCQyxRQUZqQixHQUVrRUosbUJBRmxFLENBRWlCSSxRQUZqQjtBQUFBLElBRTJCQyxZQUYz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LENBSmpCOztBQU1BLFNBQU9qSSxRQUFQO0FBQ0Q7O0FBRUQsU0FBU0csMEJBQVQsQ0FBb0N5SCxZQUFwQyxFQUFrRDtBQUNoRCxNQUFNQyxVQUFVRCxhQUFhRSxLQUFiLENBQW1CLFNBQW5CLENBQWhCO0FBQUEsTUFDTUMsY0FBYzFKLE9BQU93SixPQUFQLENBRHBCO0FBQUEsTUFFTTNILGFBQWE2SCxXQUZuQixDQURnRCxDQUdoQjs7QUFFaEMsU0FBTzdILFVBQVA7QUFDRDs7QUFFRCxTQUFTNEcsa0JBQVQsQ0FBNEJxQixNQUE1QixFQUFvQ0MsWUFBcEMsRUFBa0Q7QUFDaEQsTUFBTUMsWUFBWSxHQUFsQjtBQUFBLE1BQ01DLGVBQWVDLFNBQVNKLE1BQVQsRUFBaUJDLFlBQWpCLEVBQStCQyxTQUEvQixDQURyQjs7QUFHQSxTQUFPQyxZQUFQO0FBQ0Q7O0FBRUQsU0FBU0MsUUFBVCxDQUFrQkosTUFBbEIsRUFBMEJDLFlBQTFCLEVBQXdDQyxTQUF4QyxFQUFtRDtBQUNqRCxNQUFJRyxVQUFVLEVBQWQ7O0FBRUEsT0FBSyxJQUFJMUUsUUFBUSxDQUFqQixFQUFvQkEsUUFBUXNFLFlBQTVCLEVBQTBDdEUsT0FBMUMsRUFBbUQ7QUFDakQwRSxlQUFXSCxTQUFYO0FBQ0Q7O0FBRUQsTUFBTUMsZUFBZSxNQUFHRSxPQUFILEdBQWFMLE1BQWIsRUFBc0JELE1BQXRCLENBQTZCLENBQUNFLFlBQTlCLENBQXJCOztBQUVBLFNBQU9FLFlBQVA7QUFDRCIsImZpbGUiOiJtaXNjZWxsYW5lb3VzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuXG5jb25zdCBwYXRoVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL3BhdGgnKSxcbiAgICAgIGFycmF5VXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICBmaWxlU3lzdGVtVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL2ZpbGVTeXN0ZW0nKTtcblxuY29uc3QgeyBzZWNvbmQgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBjb25jYXRlbmF0ZVBhdGhzIH0gPSBwYXRoVXRpbGl0aWVzLFxuICAgICAgeyBkb2VzRmlsZUV4aXN0LCByZWFkRmlsZSwgYXBwZW5kVG9GaWxlLCByZW5hbWVGaWxlLCBnZXRTdGF0cyB9ID0gZmlsZVN5c3RlbVV0aWxpdGllcztcblxuY29uc3QgR0VUX01FVEhPRCA9ICdHRVQnLFxuICAgICAgUE9TVF9NRVRIT0QgPSAnUE9TVCcsXG4gICAgICBFVFhfQ0hBUkFDVEVSID0gJ1xcdTAwMDMnO1xuXG5mdW5jdGlvbiBsb2cobWVzc2FnZSwgbGV2ZWwgPSAnJykge1xuICBsZXQgcGVydGluZW50U3RhY2tNZXNzYWdlSW5kZXggPSAyO1xuXG4gIGlmIChsZXZlbCkgeyAvLy9cbiAgICBjb25zdCBsZXZlbEluZGV4ID0gbGV2ZWxzLmluZGV4T2YobGV2ZWwpLFxuICAgICAgICAgIGxvZ0xldmVsSW5kZXggPSBsZXZlbHMuaW5kZXhPZihsb2dMZXZlbCk7XG5cbiAgICBpZiAobGV2ZWxJbmRleCA+IGxvZ0xldmVsSW5kZXgpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBwZXJ0aW5lbnRTdGFja01lc3NhZ2VJbmRleCArPSAxO1xuXG4gICAgbGV2ZWwgPSBgJHtsZXZlbH0gYDsgIC8vL1xuICB9XG5cbiAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoKSxcbiAgICAgIHsgc3RhY2sgfSA9IGVycm9yLFxuICAgICAgc3RhY2tNZXNzYWdlcyA9IHN0YWNrLnNwbGl0KC9cXHJcXG58XFxuLyksXG4gICAgICBwZXJ0aW5lbnRTdGFja01lc3NhZ2UgPSBzdGFja01lc3NhZ2VzW3BlcnRpbmVudFN0YWNrTWVzc2FnZUluZGV4XSxcbiAgICAgIGN1cnJlbnREYXRlQW5kVGltZVN0cmluZyA9IGdldEN1cnJlbnREYXRlQW5kVGltZVN0cmluZygpLFxuICAgICAgZmlsZVBhdGggPSBmaWxlUGF0aEZyb21TdGFja01lc3NhZ2UocGVydGluZW50U3RhY2tNZXNzYWdlKSxcbiAgICAgIGxpbmVOdW1iZXIgPSBsaW5lTnVtYmVyRnJvbVN0YWNrTWVzc2FnZShwZXJ0aW5lbnRTdGFja01lc3NhZ2UpLFxuICAgICAgbG9nTWVzc2FnZSA9IGAke2xldmVsfSR7Y3VycmVudERhdGVBbmRUaW1lU3RyaW5nfSAke2ZpbGVQYXRofSgke2xpbmVOdW1iZXJ9KSAke21lc3NhZ2V9YDtcblxuICBjb25zb2xlLmxvZyhsb2dNZXNzYWdlKTtcblxuICBpZiAobG9nRGlyZWN0b3J5UGF0aCAhPT0gbnVsbCkge1xuICAgIHJvbGxPdmVyTG9nRmlsZSgpO1xuXG4gICAgY29uc3QgbG9nRmlsZVBhdGggPSBnZXRMb2dGaWxlUGF0aCgpLFxuICAgICAgICAgIGxvZ0ZpbGVDb250ZW50ID0gYCR7bG9nTWVzc2FnZX1cXG5gO1xuXG4gICAgYXBwZW5kVG9GaWxlKGxvZ0ZpbGVQYXRoLCBsb2dGaWxlQ29udGVudCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0KGhvc3QsIHVyaSwgcGFyYW1ldGVycywgY2FsbGJhY2spIHtcbiAgaWYgKGNhbGxiYWNrID09PSB1bmRlZmluZWQpIHtcbiAgICBjYWxsYmFjayA9IHBhcmFtZXRlcnM7IC8vL1xuICAgIHBhcmFtZXRlcnMgPSB7fTtcbiAgfVxuXG4gIGNvbnN0IG1ldGhvZCA9IEdFVF9NRVRIT0QsXG4gICAgICAgIGJvZHkgPSB1bmRlZmluZWQ7XG5cbiAgcmVxdWVzdChob3N0LCB1cmksIHBhcmFtZXRlcnMsIG1ldGhvZCwgYm9keSwgY2FsbGJhY2spO1xufVxuXG5mdW5jdGlvbiBwb3N0KGhvc3QsIHVyaSwganNvbiwgcGFyYW1ldGVycywgY2FsbGJhY2spIHtcbiAgaWYgKGNhbGxiYWNrID09PSB1bmRlZmluZWQpIHtcbiAgICBjYWxsYmFjayA9IHBhcmFtZXRlcnM7IC8vL1xuICAgIHBhcmFtZXRlcnMgPSB7fTtcbiAgfVxuXG4gIGNvbnN0IG1ldGhvZCA9IFBPU1RfTUVUSE9ELFxuICAgICAgICBib2R5ID0gSlNPTi5zdHJpbmdpZnkoanNvbik7XG5cbiAgcmVxdWVzdChob3N0LCB1cmksIHBhcmFtZXRlcnMsIG1ldGhvZCwgYm9keSwgY2FsbGJhY2spO1xufVxuXG5mdW5jdGlvbiBvbkVUWChoYW5kbGVyKSB7XG4gIGNvbnN0IHsgc3RkaW4gfSA9IHByb2Nlc3MsXG4gICAgICAgIHsgc2V0UmF3TW9kZSB9ID0gc3RkaW47XG5cbiAgaWYgKHNldFJhd01vZGUpIHtcbiAgICBjb25zdCByYXdNb2RlID0gdHJ1ZSxcbiAgICAgICAgICBlbmNvZGluZyA9ICd1dGY4JztcblxuICAgIHN0ZGluLnNldFJhd01vZGUocmF3TW9kZSk7XG4gICAgc3RkaW4uc2V0RW5jb2RpbmcoZW5jb2RpbmcpO1xuXG4gICAgc3RkaW4ucmVzdW1lKCk7XG5cbiAgICBzdGRpbi5hZGRMaXN0ZW5lcignZGF0YScsIGRhdGFIYW5kbGVyKTtcblxuICAgIHJldHVybiBvZmZFeHQ7XG4gIH1cblxuICBmdW5jdGlvbiBvZmZFeHQoKSB7XG4gICAgc3RkaW4ucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCBkYXRhSGFuZGxlcik7XG4gIH1cblxuICBmdW5jdGlvbiBkYXRhSGFuZGxlcihjaGFyYWN0ZXIpIHtcbiAgICBpZiAoY2hhcmFjdGVyID09PSBFVFhfQ0hBUkFDVEVSKSB7XG4gICAgICBoYW5kbGVyKCk7XG4gICAgfVxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBsb2c6IGxvZyxcbiAgZ2V0OiBnZXQsXG4gIHBvc3Q6IHBvc3QsXG4gIG9uRVRYOiBvbkVUWFxufTtcblxuZnVuY3Rpb24gcmVxdWVzdChob3N0LCB1cmksIHBhcmFtZXRlcnMsIG1ldGhvZCwgYm9keSwgY2FsbGJhY2spIHtcbiAgY29uc3QgdXJsID0gdXJsRnJvbUhvc3RVUklBbmRQYXJhbWV0ZXJzKGhvc3QsIHVyaSwgcGFyYW1ldGVycyksXG4gICAgICAgIHhtbEh0dHBSZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG5cbiAgeG1sSHR0cFJlcXVlc3Qub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgeyByZWFkeVN0YXRlLCBzdGF0dXMsIHJlc3BvbnNlVGV4dCB9ID0geG1sSHR0cFJlcXVlc3Q7XG5cbiAgICBpZiAocmVhZHlTdGF0ZSA9PSA0KSB7XG4gICAgICBpZiAoc3RhdHVzID09IDIwMCkge1xuICAgICAgICBjb25zdCBqc29uU3RyaW5nID0gcmVzcG9uc2VUZXh0LCAvLy9cbiAgICAgICAgICAgICAganNvbiA9IEpTT04ucGFyc2UoanNvblN0cmluZyk7XG5cbiAgICAgICAgY2FsbGJhY2soanNvbik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjYWxsYmFjayhudWxsKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgeG1sSHR0cFJlcXVlc3Qub3BlbihtZXRob2QsIHVybCwgdHJ1ZSk7XG5cbiAgeG1sSHR0cFJlcXVlc3Quc2VuZChib2R5KTtcbn1cblxuZnVuY3Rpb24gdXJsRnJvbUhvc3RVUklBbmRQYXJhbWV0ZXJzKGhvc3QsIHVyaSwgcGFyYW1ldGVycykge1xuICBjb25zdCBxdWVyeVN0cmluZyA9IHF1ZXJ5U3RyaW5nRnJvbVBhcmFtZXRlcnMocGFyYW1ldGVycyksXG4gICAgICAgIHVybCA9IChxdWVyeVN0cmluZyA9PT0gJycpID9cbiAgICAgICAgICAgICAgICBgJHtob3N0fS8ke3VyaX1gIDpcbiAgICAgICAgICAgICAgICAgIGAke2hvc3R9LyR7dXJpfT8ke3F1ZXJ5U3RyaW5nfWA7XG5cbiAgcmV0dXJuIHVybDtcbn1cblxuZnVuY3Rpb24gcXVlcnlTdHJpbmdGcm9tUGFyYW1ldGVycyhwYXJhbWV0ZXJzKSB7XG4gIGNvbnN0IG5hbWVzID0gT2JqZWN0LmtleXMocGFyYW1ldGVycyksXG4gICAgICAgIG5hbWVzTGVuZ3RoID0gbmFtZXMubGVuZ3RoLFxuICAgICAgICBsYXN0SW5kZXggPSBuYW1lc0xlbmd0aCAtIDEsXG4gICAgICAgIHF1ZXJ5U3RyaW5nID0gbmFtZXMucmVkdWNlKGZ1bmN0aW9uKHF1ZXJ5U3RyaW5nLCBuYW1lLCBpbmRleCkge1xuICAgICAgICAgIGNvbnN0IHZhbHVlID0gcGFyYW1ldGVyc1tuYW1lXSxcbiAgICAgICAgICAgICAgICBlbmNvZGVkTmFtZSA9IGVuY29kZVVSSUNvbXBvbmVudChuYW1lKSxcbiAgICAgICAgICAgICAgICBlbmNvZGVkVmFsdWUgPSBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpLFxuICAgICAgICAgICAgICAgIGFtcGVyc2FuZE9yTm90aGluZyA9IChpbmRleCAhPT0gbGFzdEluZGV4KSA/ICcmJyA6ICcnO1xuICBcbiAgICAgICAgICBxdWVyeVN0cmluZyArPSBgJHtlbmNvZGVkTmFtZX09JHtlbmNvZGVkVmFsdWV9JHthbXBlcnNhbmRPck5vdGhpbmd9YDtcbiAgXG4gICAgICAgICAgcmV0dXJuIHF1ZXJ5U3RyaW5nO1xuICAgICAgICB9LCAnJyk7XG5cbiAgcmV0dXJuIHF1ZXJ5U3RyaW5nO1xufVxuXG5jb25zdCBUUkFDRSA9ICdUUkFDRScsXG4gICAgICBERUJVRyA9ICdERUJVRycsXG4gICAgICBJTkZPID0gJ0lORk8nLFxuICAgICAgV0FSTklORyA9ICdXQVJOSU5HJyxcbiAgICAgIEVSUk9SID0gJ0VSUk9SJyxcbiAgICAgIEZBVEFMID0gJ0ZBVEFMJyxcbiAgICAgIGxldmVscyA9IFtcbiAgICAgICAgVFJBQ0UsXG4gICAgICAgIERFQlVHLFxuICAgICAgICBJTkZPLFxuICAgICAgICBXQVJOSU5HLFxuICAgICAgICBFUlJPUixcbiAgICAgICAgRkFUQUxcbiAgICAgIF0sXG4gICAgICBjdXJyZW50V29ya2luZ0RpcmVjdG9yeVBhdGggPSBwYXRoLnJlc29sdmUoJy4nKSwgIC8vL1xuICAgICAgY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoTGVuZ3RoID0gY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoLmxlbmd0aDtcblxubGV0IGxvZ0xldmVsID0gV0FSTklORyxcbiAgICBsb2dGaWxlQmFzZU5hbWUgPSAnZGVmYXVsdCcsXG4gICAgbG9nRGlyZWN0b3J5UGF0aCA9IG51bGw7XG5cbmZ1bmN0aW9uIGZhdGFsKG1lc3NhZ2UpIHsgbG9nKG1lc3NhZ2UsIEZBVEFMKTsgfVxuXG5mdW5jdGlvbiBlcnJvcihtZXNzYWdlKSB7IGxvZyhtZXNzYWdlLCBFUlJPUik7IH1cblxuZnVuY3Rpb24gd2FybmluZyhtZXNzYWdlKSB7IGxvZyhtZXNzYWdlLCBXQVJOSU5HKTsgfVxuXG5mdW5jdGlvbiBpbmZvKG1lc3NhZ2UpIHsgbG9nKG1lc3NhZ2UsIElORk8pOyB9XG5cbmZ1bmN0aW9uIGRlYnVnKG1lc3NhZ2UpIHsgbG9nKG1lc3NhZ2UsIERFQlVHKTsgfVxuXG5mdW5jdGlvbiB0cmFjZShtZXNzYWdlKSB7IGxvZyhtZXNzYWdlLCBUUkFDRSk7IH1cblxuZnVuY3Rpb24gc2V0TG9nTGV2ZWwobGV2ZWwpIHtcbiAgbG9nTGV2ZWwgPSBsZXZlbDtcbn1cblxuZnVuY3Rpb24gc2V0TG9nRmlsZUJhc2VOYW1lKGZpbGVCYWVOYW1lKSB7XG4gIGxvZ0ZpbGVCYXNlTmFtZSA9IGZpbGVCYWVOYW1lO1xufVxuXG5mdW5jdGlvbiBzZXRMb2dEaXJlY3RvcnlQYXRoKGRpcmVjdG9yeVBhdGgpIHtcbiAgbG9nRGlyZWN0b3J5UGF0aCA9IGRpcmVjdG9yeVBhdGg7XG59XG5cbmZ1bmN0aW9uIGdldExvZ0ZpbGVDb250ZW50KCkge1xuICBjb25zdCBsb2dGaWxlUGF0aCA9IGdldExvZ0ZpbGVQYXRoKCksXG4gICAgICAgIGxvZ0ZpbGVDb250ZW50ID0gcmVhZEZpbGUobG9nRmlsZVBhdGgpO1xuXG4gIHJldHVybiBsb2dGaWxlQ29udGVudDtcbn1cblxuT2JqZWN0LmFzc2lnbihsb2csIHtcbiAgRkFUQUw6IEZBVEFMLFxuICBFUlJPUjogRVJST1IsXG4gIFdBUk5JTkc6IFdBUk5JTkcsXG4gIElORk86IElORk8sXG4gIERFQlVHOiBERUJVRyxcbiAgVFJBQ0U6IFRSQUNFLFxuICBmYXRhbDogZmF0YWwsXG4gIGVycm9yOiBlcnJvcixcbiAgd2FybmluZzogd2FybmluZyxcbiAgaW5mbzogaW5mbyxcbiAgZGVidWc6IGRlYnVnLFxuICB0cmFjZTogdHJhY2UsXG4gIHNldExvZ0xldmVsOiBzZXRMb2dMZXZlbCxcbiAgc2V0TG9nRmlsZUJhc2VOYW1lOiBzZXRMb2dGaWxlQmFzZU5hbWUsXG4gIHNldExvZ0RpcmVjdG9yeVBhdGg6IHNldExvZ0RpcmVjdG9yeVBhdGgsXG4gIGdldExvZ0ZpbGVDb250ZW50OiBnZXRMb2dGaWxlQ29udGVudFxufSk7XG5cbmZ1bmN0aW9uIGdldExvZ0ZpbGVQYXRoKCkge1xuICBjb25zdCBsb2dGaWxlTmFtZSA9IGAke2xvZ0ZpbGVCYXNlTmFtZX0ubG9nYCxcbiAgICAgICAgbG9nRmlsZVBhdGggPSBjb25jYXRlbmF0ZVBhdGhzKGxvZ0RpcmVjdG9yeVBhdGgsIGxvZ0ZpbGVOYW1lKTtcblxuICByZXR1cm4gbG9nRmlsZVBhdGg7XG59XG5cbmZ1bmN0aW9uIGdldFJvbGxlZE92ZXJMb2dGaWxlUGF0aCgpIHtcbiAgY29uc3QgY3VycmVudERhdGVTdHJpbmcgPSBnZXRDdXJyZW50RGF0ZVN0cmluZygpLFxuICAgICAgICByb2xsZWRPdmVyTG9nRmlsZU5hbWUgPSBgJHtsb2dGaWxlQmFzZU5hbWV9LiR7Y3VycmVudERhdGVTdHJpbmd9LmxvZ2AsXG4gICAgICAgIHJvbGxlZE92ZXJMb2dGaWxlUGF0aCA9IGNvbmNhdGVuYXRlUGF0aHMobG9nRGlyZWN0b3J5UGF0aCwgcm9sbGVkT3ZlckxvZ0ZpbGVOYW1lKTtcblxuICByZXR1cm4gcm9sbGVkT3ZlckxvZ0ZpbGVQYXRoO1xufVxuXG5mdW5jdGlvbiBnZXRMb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSgpIHtcbiAgY29uc3QgbG9nRmlsZVBhdGggPSBnZXRMb2dGaWxlUGF0aCgpLFxuICAgICAgICBsb2dGaWxlU3RhdHMgPSBnZXRTdGF0cyhsb2dGaWxlUGF0aCksXG4gICAgICAgIHsgbXRpbWUgfSA9IGxvZ0ZpbGVTdGF0cyxcbiAgICAgICAgbG9nRmlsZUxhc3RNb2RpZmllZERhdGUgPSBuZXcgRGF0ZShtdGltZSk7ICAvLy9cblxuICByZXR1cm4gbG9nRmlsZUxhc3RNb2RpZmllZERhdGU7XG59XG5cbmZ1bmN0aW9uIHJvbGxPdmVyTG9nRmlsZSgpIHtcbiAgY29uc3QgbG9nRmlsZVBhdGggPSBnZXRMb2dGaWxlUGF0aCgpLFxuICAgICAgICBsb2dGaWxlRXhpc3RzID0gZG9lc0ZpbGVFeGlzdChsb2dGaWxlUGF0aCk7XG5cbiAgaWYgKCFsb2dGaWxlRXhpc3RzKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgbG9nRmlsZUxhc3RNb2RpZmllZERhdGUgPSBnZXRMb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSgpLFxuICAgICAgICBsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZUN1cnJlbnREYXRlID0gaXNEYXRlQ3VycmVudERhdGUobG9nRmlsZUxhc3RNb2RpZmllZERhdGUpO1xuXG4gIGlmICghbG9nRmlsZUxhc3RNb2RpZmllZERhdGVDdXJyZW50RGF0ZSkge1xuICAgIGNvbnN0IHJvbGxlZE92ZXJMb2dGaWxlUGF0aCA9IGdldFJvbGxlZE92ZXJMb2dGaWxlUGF0aCgpO1xuXG4gICAgcmVuYW1lRmlsZShsb2dGaWxlUGF0aCwgcm9sbGVkT3ZlckxvZ0ZpbGVQYXRoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpc0RhdGVDdXJyZW50RGF0ZShkYXRlKSB7XG4gIGNvbnN0IGN1cnJlbnREYXRlID0gbmV3IERhdGUoKSxcbiAgICAgICAgZGF0ZVN0cmluZyA9IGRhdGUudG9EYXRlU3RyaW5nKCksXG4gICAgICAgIGN1cnJlbnREYXRlU3RyaW5nID0gY3VycmVudERhdGUudG9EYXRlU3RyaW5nKCksXG4gICAgICAgIGRhdGVDdXJyZW50RGF0ZSA9IChkYXRlU3RyaW5nID09PSBjdXJyZW50RGF0ZVN0cmluZyk7XG5cbiAgcmV0dXJuIGRhdGVDdXJyZW50RGF0ZTtcbn1cblxuZnVuY3Rpb24gZ2V0Q3VycmVudERhdGVTdHJpbmcoKSB7XG4gIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSgpLFxuICAgICAgICBkYXkgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXREYXRlKCksIDIpLCAgLy8vXG4gICAgICAgIG1vbnRoID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0TW9udGgoKSArIDEsIDIpLCAvLy9cbiAgICAgICAgeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgY3VycmVudERhdGVBbmRUaW1lU3RyaW5nID0gYCR7ZGF5fS0ke21vbnRofS0ke3llYXJ9YDtcblxuICByZXR1cm4gY3VycmVudERhdGVBbmRUaW1lU3RyaW5nO1xufVxuXG5mdW5jdGlvbiBnZXRDdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmcoKSB7XG4gIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSgpLFxuICAgICAgICBkYXkgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXREYXRlKCksIDIpLCAgLy8vXG4gICAgICAgIG1vbnRoID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0TW9udGgoKSArIDEsIDIpLCAvLy9cbiAgICAgICAgeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgaG91cnMgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRIb3VycygpLCAyKSxcbiAgICAgICAgbWludXRlcyA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldE1pbnV0ZXMoKSwgMiksXG4gICAgICAgIHNlY29uZHMgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRTZWNvbmRzKCksIDIpLFxuICAgICAgICBtaWxsaXNlY29uZHMgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRNaWxsaXNlY29uZHMoKSwgMyksXG4gICAgICAgIGN1cnJlbnREYXRlQW5kVGltZVN0cmluZyA9IGAke2RheX0tJHttb250aH0tJHt5ZWFyfSAke2hvdXJzfToke21pbnV0ZXN9OiR7c2Vjb25kc30uJHttaWxsaXNlY29uZHN9YDtcblxuICByZXR1cm4gY3VycmVudERhdGVBbmRUaW1lU3RyaW5nO1xufVxuXG5mdW5jdGlvbiBmaWxlUGF0aEZyb21TdGFja01lc3NhZ2Uoc3RhY2tNZXNzYWdlKSB7XG4gIGNvbnN0IG1hdGNoZXMgPSBzdGFja01lc3NhZ2UubWF0Y2goLyhcXC8uKylcXDpcXGQrXFw6XFxkKy8pLFxuICAgICAgICBzZWNvbmRNYXRjaCA9IHNlY29uZChtYXRjaGVzKSxcbiAgICAgICAgYWJzb2x1dGVGaWxlUGF0aCA9IHNlY29uZE1hdGNoLCAgLy8vXG4gICAgICAgIHN0YXJ0ID0gY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoTGVuZ3RoICsgMSwgIC8vL1xuICAgICAgICBmaWxlUGF0aCA9IGFic29sdXRlRmlsZVBhdGguc3Vic3RyKHN0YXJ0KTtcblxuICByZXR1cm4gZmlsZVBhdGg7XG59XG5cbmZ1bmN0aW9uIGxpbmVOdW1iZXJGcm9tU3RhY2tNZXNzYWdlKHN0YWNrTWVzc2FnZSkge1xuICBjb25zdCBtYXRjaGVzID0gc3RhY2tNZXNzYWdlLm1hdGNoKC9cXDooXFxkKykvKSxcbiAgICAgICAgc2Vjb25kTWF0Y2ggPSBzZWNvbmQobWF0Y2hlcyksXG4gICAgICAgIGxpbmVOdW1iZXIgPSBzZWNvbmRNYXRjaDsgLy8vXG5cbiAgcmV0dXJuIGxpbmVOdW1iZXI7XG59XG5cbmZ1bmN0aW9uIHBhZFN0YXJ0V2l0aFplcm9lcyhzdHJpbmcsIHRhcmdldExlbmd0aCkge1xuICBjb25zdCBwYWRTdHJpbmcgPSAnMCcsXG4gICAgICAgIHBhZGRlZFN0cmluZyA9IHBhZFN0YXJ0KHN0cmluZywgdGFyZ2V0TGVuZ3RoLCBwYWRTdHJpbmcpO1xuXG4gIHJldHVybiBwYWRkZWRTdHJpbmc7XG59XG5cbmZ1bmN0aW9uIHBhZFN0YXJ0KHN0cmluZywgdGFyZ2V0TGVuZ3RoLCBwYWRTdHJpbmcpIHtcbiAgbGV0IHBhZGRpbmcgPSAnJztcblxuICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdGFyZ2V0TGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgcGFkZGluZyArPSBwYWRTdHJpbmc7XG4gIH1cblxuICBjb25zdCBwYWRkZWRTdHJpbmcgPSBgJHtwYWRkaW5nfSR7c3RyaW5nfWAuc3Vic3RyKC10YXJnZXRMZW5ndGgpO1xuXG4gIHJldHVybiBwYWRkZWRTdHJpbmc7XG59XG5cbiJdfQ==