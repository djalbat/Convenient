"use strict";

import path from "path";
import { second } from "../utilities/array";
import { concatenatePaths } from "../utilities/path";
import { checkFileExists, readFile, appendToFile, renameFile, getStats } from "../utilities/fileSystem";
import { TRACE, DEBUG, INFO, WARNING, ERROR, FATAL, DEFAULT_LOG_LEVEL, DEFAULT_LOG_FILE_BASE_NAME, DEFAULT_LOG_DIRECTORY_PATH } from "../constants";
const levels = [TRACE, DEBUG, INFO, WARNING, ERROR, FATAL];
let logLevel = DEFAULT_LOG_LEVEL,
    logFileBaseName = DEFAULT_LOG_FILE_BASE_NAME,
    logDirectoryPath = DEFAULT_LOG_DIRECTORY_PATH;
export function log(messageOrError, level = "") {
  let salientStackMessageIndex = 1;

  if (level !== "") {
    const levelIndex = levels.indexOf(level),
          logLevelIndex = levels.indexOf(logLevel);

    if (levelIndex < logLevelIndex) {
      return;
    }

    salientStackMessageIndex += 1;
    level = `${level} `; ///
  }

  let error, message;

  if (messageOrError instanceof Error) {
    error = messageOrError; ///

    ({
      message
    } = error);
  } else {
    message = messageOrError; ///

    error = new Error(message);
  }

  const {
    stack
  } = error,
        stackMessages = stackMessagesFromStack(stack),
        pertinentStackMessage = stackMessages[salientStackMessageIndex],
        stackMessage = pertinentStackMessage,
        ///
  currentDateAndTimeString = getCurrentDateAndTimeString(),
        filePath = filePathFromStackMessage(stackMessage),
        lineNumber = lineNumberFromStackMessage(stackMessage),
        logMessage = `${level}${currentDateAndTimeString} ${filePath}(${lineNumber}) ${message}`;
  console.log(logMessage);

  if (logDirectoryPath !== null) {
    rollOverLogFile();
    const logFilePath = getLogFilePath(),
          logFileContent = `${logMessage}\n`;
    appendToFile(logFilePath, logFileContent);
  }

  return logMessage;
}
export default {
  log
};

function trace(message) {
  return log(message, TRACE);
}

function debug(message) {
  return log(message, DEBUG);
}

function info(message) {
  return log(message, INFO);
}

function warning(message) {
  return log(message, WARNING);
}

function error(message) {
  return log(message, ERROR);
}

function fatal(message) {
  return log(message, FATAL);
}

function setLogLevel(level) {
  logLevel = level;
}

function setLogFileBaseName(fileBaseName) {
  logFileBaseName = fileBaseName;
}

function setLogDirectoryPath(directoryPath) {
  logDirectoryPath = directoryPath;
}

function setLogOptions(logOptions) {
  const {
    level,
    fileBaseName,
    directoryPath
  } = logOptions;
  setLogLevel(level);
  setLogFileBaseName(fileBaseName);
  setLogDirectoryPath(directoryPath);
}

function getLogFileContent() {
  const logFilePath = getLogFilePath(),
        logFileContent = readFile(logFilePath);
  return logFileContent;
}

Object.assign(log, {
  TRACE,
  DEBUG,
  INFO,
  WARNING,
  ERROR,
  FATAL,
  trace,
  debug,
  info,
  warning,
  error,
  fatal,
  setLogLevel,
  setLogFileBaseName,
  setLogDirectoryPath,
  setLogOptions,
  getLogFileContent
});

function getLogFilePath() {
  const logFileName = `${logFileBaseName}.log`,
        logFilePath = concatenatePaths(logDirectoryPath, logFileName);
  return logFilePath;
}

function getRolledOverLogFilePath() {
  const currentDateString = getCurrentDateString(),
        rolledOverLogFileName = `${logFileBaseName}.${currentDateString}.log`,
        rolledOverLogFilePath = concatenatePaths(logDirectoryPath, rolledOverLogFileName);
  return rolledOverLogFilePath;
}

function getLogFileLastModifiedDate() {
  const logFilePath = getLogFilePath(),
        logFileStats = getStats(logFilePath),
        {
    mtime
  } = logFileStats,
        logFileLastModifiedDate = new Date(mtime); ///

  return logFileLastModifiedDate;
}

function rollOverLogFile() {
  const logFilePath = getLogFilePath(),
        logFileExists = checkFileExists(logFilePath);

  if (!logFileExists) {
    return;
  }

  const logFileLastModifiedDate = getLogFileLastModifiedDate(),
        logFileLastModifiedDateCurrentDate = isDateCurrentDate(logFileLastModifiedDate);

  if (!logFileLastModifiedDateCurrentDate) {
    const rolledOverLogFilePath = getRolledOverLogFilePath();
    renameFile(logFilePath, rolledOverLogFilePath);
  }
}

function isDateCurrentDate(date) {
  const currentDate = new Date(),
        dateString = date.toDateString(),
        currentDateString = currentDate.toDateString(),
        dateCurrentDate = dateString === currentDateString;
  return dateCurrentDate;
}

function getCurrentDateString() {
  const date = new Date(),
        day = padStartWithZeroes(date.getDate(), 2),
        ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
        ///
  year = date.getFullYear(),
        currentDateAndTimeString = `${day}-${month}-${year}`;
  return currentDateAndTimeString;
}

function getCurrentDateAndTimeString() {
  const date = new Date(),
        day = padStartWithZeroes(date.getDate(), 2),
        ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
        ///
  year = date.getFullYear(),
        hours = padStartWithZeroes(date.getHours(), 2),
        minutes = padStartWithZeroes(date.getMinutes(), 2),
        seconds = padStartWithZeroes(date.getSeconds(), 2),
        milliseconds = padStartWithZeroes(date.getMilliseconds(), 3),
        currentDateAndTimeString = `${day}-${month}-${year} ${hours}:${minutes}:${seconds}.${milliseconds}`;
  return currentDateAndTimeString;
}

function stackMessagesFromStack(stack) {
  const stackMessages = [],
        stackLines = stack.split(/\r\n|\n/);
  let stackMessage = "";
  stackLines.forEach(stackLine => {
    const matches = /^\s*at.*/.test(stackLine);
    stackMessage = stackMessage === "" ? stackLine : `${stackMessage}\n${stackLine}`;

    if (matches) {
      stackMessages.push(stackMessage);
      stackMessage = "";
    }
  });
  return stackMessages;
}

function filePathFromStackMessage(stackMessage) {
  const matches = stackMessage.match(/(\/.+):\d+:\d+/m),
        secondMatch = second(matches),
        absoluteFilePath = secondMatch,
        ///
  currentWorkingDirectoryPath = path.resolve("."),
        ///
  currentWorkingDirectoryPathLength = currentWorkingDirectoryPath.length,
        start = currentWorkingDirectoryPathLength + 1,
        ///
  filePath = absoluteFilePath.substr(start);
  return filePath;
}

function lineNumberFromStackMessage(stackMessage) {
  const matches = stackMessage.match(/:(\d+)/m),
        secondMatch = second(matches),
        lineNumber = secondMatch; ///

  return lineNumber;
}

function padStartWithZeroes(string, targetLength) {
  const padString = "0",
        paddedString = padStart(string, targetLength, padString);
  return paddedString;
}

function padStart(string, targetLength, padString) {
  let padding = "";

  for (let index = 0; index < targetLength; index++) {
    padding += padString;
  }

  const paddedString = `${padding}${string}`.substr(-targetLength);
  return paddedString;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxvZ2dpbmcuanMiXSwibmFtZXMiOlsicGF0aCIsInNlY29uZCIsImNvbmNhdGVuYXRlUGF0aHMiLCJjaGVja0ZpbGVFeGlzdHMiLCJyZWFkRmlsZSIsImFwcGVuZFRvRmlsZSIsInJlbmFtZUZpbGUiLCJnZXRTdGF0cyIsIlRSQUNFIiwiREVCVUciLCJJTkZPIiwiV0FSTklORyIsIkVSUk9SIiwiRkFUQUwiLCJERUZBVUxUX0xPR19MRVZFTCIsIkRFRkFVTFRfTE9HX0ZJTEVfQkFTRV9OQU1FIiwiREVGQVVMVF9MT0dfRElSRUNUT1JZX1BBVEgiLCJsZXZlbHMiLCJsb2dMZXZlbCIsImxvZ0ZpbGVCYXNlTmFtZSIsImxvZ0RpcmVjdG9yeVBhdGgiLCJsb2ciLCJtZXNzYWdlT3JFcnJvciIsImxldmVsIiwic2FsaWVudFN0YWNrTWVzc2FnZUluZGV4IiwibGV2ZWxJbmRleCIsImluZGV4T2YiLCJsb2dMZXZlbEluZGV4IiwiZXJyb3IiLCJtZXNzYWdlIiwiRXJyb3IiLCJzdGFjayIsInN0YWNrTWVzc2FnZXMiLCJzdGFja01lc3NhZ2VzRnJvbVN0YWNrIiwicGVydGluZW50U3RhY2tNZXNzYWdlIiwic3RhY2tNZXNzYWdlIiwiY3VycmVudERhdGVBbmRUaW1lU3RyaW5nIiwiZ2V0Q3VycmVudERhdGVBbmRUaW1lU3RyaW5nIiwiZmlsZVBhdGgiLCJmaWxlUGF0aEZyb21TdGFja01lc3NhZ2UiLCJsaW5lTnVtYmVyIiwibGluZU51bWJlckZyb21TdGFja01lc3NhZ2UiLCJsb2dNZXNzYWdlIiwiY29uc29sZSIsInJvbGxPdmVyTG9nRmlsZSIsImxvZ0ZpbGVQYXRoIiwiZ2V0TG9nRmlsZVBhdGgiLCJsb2dGaWxlQ29udGVudCIsInRyYWNlIiwiZGVidWciLCJpbmZvIiwid2FybmluZyIsImZhdGFsIiwic2V0TG9nTGV2ZWwiLCJzZXRMb2dGaWxlQmFzZU5hbWUiLCJmaWxlQmFzZU5hbWUiLCJzZXRMb2dEaXJlY3RvcnlQYXRoIiwiZGlyZWN0b3J5UGF0aCIsInNldExvZ09wdGlvbnMiLCJsb2dPcHRpb25zIiwiZ2V0TG9nRmlsZUNvbnRlbnQiLCJPYmplY3QiLCJhc3NpZ24iLCJsb2dGaWxlTmFtZSIsImdldFJvbGxlZE92ZXJMb2dGaWxlUGF0aCIsImN1cnJlbnREYXRlU3RyaW5nIiwiZ2V0Q3VycmVudERhdGVTdHJpbmciLCJyb2xsZWRPdmVyTG9nRmlsZU5hbWUiLCJyb2xsZWRPdmVyTG9nRmlsZVBhdGgiLCJnZXRMb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSIsImxvZ0ZpbGVTdGF0cyIsIm10aW1lIiwibG9nRmlsZUxhc3RNb2RpZmllZERhdGUiLCJEYXRlIiwibG9nRmlsZUV4aXN0cyIsImxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlQ3VycmVudERhdGUiLCJpc0RhdGVDdXJyZW50RGF0ZSIsImRhdGUiLCJjdXJyZW50RGF0ZSIsImRhdGVTdHJpbmciLCJ0b0RhdGVTdHJpbmciLCJkYXRlQ3VycmVudERhdGUiLCJkYXkiLCJwYWRTdGFydFdpdGhaZXJvZXMiLCJnZXREYXRlIiwibW9udGgiLCJnZXRNb250aCIsInllYXIiLCJnZXRGdWxsWWVhciIsImhvdXJzIiwiZ2V0SG91cnMiLCJtaW51dGVzIiwiZ2V0TWludXRlcyIsInNlY29uZHMiLCJnZXRTZWNvbmRzIiwibWlsbGlzZWNvbmRzIiwiZ2V0TWlsbGlzZWNvbmRzIiwic3RhY2tMaW5lcyIsInNwbGl0IiwiZm9yRWFjaCIsInN0YWNrTGluZSIsIm1hdGNoZXMiLCJ0ZXN0IiwicHVzaCIsIm1hdGNoIiwic2Vjb25kTWF0Y2giLCJhYnNvbHV0ZUZpbGVQYXRoIiwiY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoIiwicmVzb2x2ZSIsImN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aExlbmd0aCIsImxlbmd0aCIsInN0YXJ0Iiwic3Vic3RyIiwic3RyaW5nIiwidGFyZ2V0TGVuZ3RoIiwicGFkU3RyaW5nIiwicGFkZGVkU3RyaW5nIiwicGFkU3RhcnQiLCJwYWRkaW5nIiwiaW5kZXgiXSwibWFwcGluZ3Mi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LEdBQUdGLGlDQUFpQyxHQUFHLENBTGxEO0FBQUEsUUFLc0Q7QUFDaER2RSxFQUFBQSxRQUFRLEdBQUdvRSxnQkFBZ0IsQ0FBQ00sTUFBakIsQ0FBd0JELEtBQXhCLENBTmpCO0FBUUEsU0FBT3pFLFFBQVA7QUFDRDs7QUFFRCxTQUFTRywwQkFBVCxDQUFvQ04sWUFBcEMsRUFBa0Q7QUFDaEQsUUFBTWtFLE9BQU8sR0FBR2xFLFlBQVksQ0FBQ3FFLEtBQWIsQ0FBbUIsU0FBbkIsQ0FBaEI7QUFBQSxRQUNNQyxXQUFXLEdBQUd4RyxNQUFNLENBQUNvRyxPQUFELENBRDFCO0FBQUEsUUFFTTdELFVBQVUsR0FBR2lFLFdBRm5CLENBRGdELENBR2hCOztBQUVoQyxTQUFPakUsVUFBUDtBQUNEOztBQUVELFNBQVMyQyxrQkFBVCxDQUE0QjhCLE1BQTVCLEVBQW9DQyxZQUFwQyxFQUFrRDtBQUNoRCxRQUFNQyxTQUFTLEdBQUcsR0FBbEI7QUFBQSxRQUNNQyxZQUFZLEdBQUdDLFFBQVEsQ0FBQ0osTUFBRCxFQUFTQyxZQUFULEVBQXVCQyxTQUF2QixDQUQ3QjtBQUdBLFNBQU9DLFlBQVA7QUFDRDs7QUFFRCxTQUFTQyxRQUFULENBQWtCSixNQUFsQixFQUEwQkMsWUFBMUIsRUFBd0NDLFNBQXhDLEVBQW1EO0FBQ2pELE1BQUlHLE9BQU8sR0FBRyxFQUFkOztBQUVBLE9BQUssSUFBSUMsS0FBSyxHQUFHLENBQWpCLEVBQW9CQSxLQUFLLEdBQUdMLFlBQTVCLEVBQTBDSyxLQUFLLEVBQS9DLEVBQW1EO0FBQ2pERCxJQUFBQSxPQUFPLElBQUlILFNBQVg7QUFDRDs7QUFFRCxRQUFNQyxZQUFZLEdBQUksR0FBRUUsT0FBUSxHQUFFTCxNQUFPLEVBQXBCLENBQXNCRCxNQUF0QixDQUE2QixDQUFDRSxZQUE5QixDQUFyQjtBQUVBLFNBQU9FLFlBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiO1xuXG5pbXBvcnQgeyBzZWNvbmQgfSBmcm9tIFwiLi4vdXRpbGl0aWVzL2FycmF5XCI7XG5pbXBvcnQgeyBjb25jYXRlbmF0ZVBhdGhzIH0gZnJvbSBcIi4uL3V0aWxpdGllcy9wYXRoXCI7XG5pbXBvcnQgeyBjaGVja0ZpbGVFeGlzdHMsIHJlYWRGaWxlLCBhcHBlbmRUb0ZpbGUsIHJlbmFtZUZpbGUsIGdldFN0YXRzIH0gZnJvbSBcIi4uL3V0aWxpdGllcy9maWxlU3lzdGVtXCI7XG5pbXBvcnQgeyBUUkFDRSwgREVCVUcsIElORk8sIFdBUk5JTkcsIEVSUk9SLCBGQVRBTCwgREVGQVVMVF9MT0dfTEVWRUwsIERFRkFVTFRfTE9HX0ZJTEVfQkFTRV9OQU1FLCBERUZBVUxUX0xPR19ESVJFQ1RPUllfUEFUSCB9IGZyb20gXCIuLi9jb25zdGFudHNcIjtcblxuY29uc3QgbGV2ZWxzID0gW1xuICBUUkFDRSxcbiAgREVCVUcsXG4gIElORk8sXG4gIFdBUk5JTkcsXG4gIEVSUk9SLFxuICBGQVRBTCxcbl07XG5cbmxldCBsb2dMZXZlbCA9IERFRkFVTFRfTE9HX0xFVkVMLFxuICAgIGxvZ0ZpbGVCYXNlTmFtZSA9IERFRkFVTFRfTE9HX0ZJTEVfQkFTRV9OQU1FLFxuICAgIGxvZ0RpcmVjdG9yeVBhdGggPSBERUZBVUxUX0xPR19ESVJFQ1RPUllfUEFUSDtcblxuZXhwb3J0IGZ1bmN0aW9uIGxvZyhtZXNzYWdlT3JFcnJvciwgbGV2ZWwgPSBcIlwiKSB7XG4gIGxldCBzYWxpZW50U3RhY2tNZXNzYWdlSW5kZXggPSAxO1xuXG4gIGlmIChsZXZlbCAhPT0gXCJcIikge1xuICAgIGNvbnN0IGxldmVsSW5kZXggPSBsZXZlbHMuaW5kZXhPZihsZXZlbCksXG4gICAgICAgICAgbG9nTGV2ZWxJbmRleCA9IGxldmVscy5pbmRleE9mKGxvZ0xldmVsKTtcblxuICAgIGlmIChsZXZlbEluZGV4IDwgbG9nTGV2ZWxJbmRleCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHNhbGllbnRTdGFja01lc3NhZ2VJbmRleCArPSAxO1xuXG4gICAgbGV2ZWwgPSBgJHtsZXZlbH0gYDsgIC8vL1xuICB9XG5cbiAgbGV0IGVycm9yLFxuICAgICAgbWVzc2FnZTtcblxuICBpZiAobWVzc2FnZU9yRXJyb3IgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgIGVycm9yID0gbWVzc2FnZU9yRXJyb3I7IC8vL1xuXG4gICAgKHsgbWVzc2FnZSB9ID0gZXJyb3IpO1xuICB9IGVsc2Uge1xuICAgIG1lc3NhZ2UgPSBtZXNzYWdlT3JFcnJvcjsgLy8vXG5cbiAgICBlcnJvciA9IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgfVxuXG4gIGNvbnN0IHsgc3RhY2sgfSA9IGVycm9yLFxuICAgICAgICBzdGFja01lc3NhZ2VzID0gc3RhY2tNZXNzYWdlc0Zyb21TdGFjayhzdGFjayksXG4gICAgICAgIHBlcnRpbmVudFN0YWNrTWVzc2FnZSA9IHN0YWNrTWVzc2FnZXNbc2FsaWVudFN0YWNrTWVzc2FnZUluZGV4XSxcbiAgICAgICAgc3RhY2tNZXNzYWdlID0gcGVydGluZW50U3RhY2tNZXNzYWdlLCAvLy9cbiAgICAgICAgY3VycmVudERhdGVBbmRUaW1lU3RyaW5nID0gZ2V0Q3VycmVudERhdGVBbmRUaW1lU3RyaW5nKCksXG4gICAgICAgIGZpbGVQYXRoID0gZmlsZVBhdGhGcm9tU3RhY2tNZXNzYWdlKHN0YWNrTWVzc2FnZSksXG4gICAgICAgIGxpbmVOdW1iZXIgPSBsaW5lTnVtYmVyRnJvbVN0YWNrTWVzc2FnZShzdGFja01lc3NhZ2UpLFxuICAgICAgICBsb2dNZXNzYWdlID0gYCR7bGV2ZWx9JHtjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmd9ICR7ZmlsZVBhdGh9KCR7bGluZU51bWJlcn0pICR7bWVzc2FnZX1gO1xuXG4gIGNvbnNvbGUubG9nKGxvZ01lc3NhZ2UpO1xuXG4gIGlmIChsb2dEaXJlY3RvcnlQYXRoICE9PSBudWxsKSB7XG4gICAgcm9sbE92ZXJMb2dGaWxlKCk7XG5cbiAgICBjb25zdCBsb2dGaWxlUGF0aCA9IGdldExvZ0ZpbGVQYXRoKCksXG4gICAgICAgICAgbG9nRmlsZUNvbnRlbnQgPSBgJHtsb2dNZXNzYWdlfVxcbmA7XG5cbiAgICBhcHBlbmRUb0ZpbGUobG9nRmlsZVBhdGgsIGxvZ0ZpbGVDb250ZW50KTtcbiAgfVxuXG4gIHJldHVybiBsb2dNZXNzYWdlO1xufVxuXG5leHBvcnQgZGVmYXVsdCB7XG4gIGxvZ1xufVxuXG5mdW5jdGlvbiB0cmFjZShtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgVFJBQ0UpOyB9XG5cbmZ1bmN0aW9uIGRlYnVnKG1lc3NhZ2UpIHsgcmV0dXJuIGxvZyhtZXNzYWdlLCBERUJVRyk7IH1cblxuZnVuY3Rpb24gaW5mbyhtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgSU5GTyk7IH1cblxuZnVuY3Rpb24gd2FybmluZyhtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgV0FSTklORyk7IH1cblxuZnVuY3Rpb24gZXJyb3IobWVzc2FnZSkgeyByZXR1cm4gbG9nKG1lc3NhZ2UsIEVSUk9SKTsgfVxuXG5mdW5jdGlvbiBmYXRhbChtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgRkFUQUwpOyB9XG5cbmZ1bmN0aW9uIHNldExvZ0xldmVsKGxldmVsKSB7IGxvZ0xldmVsID0gbGV2ZWw7IH1cblxuZnVuY3Rpb24gc2V0TG9nRmlsZUJhc2VOYW1lKGZpbGVCYXNlTmFtZSkgeyBsb2dGaWxlQmFzZU5hbWUgPSBmaWxlQmFzZU5hbWU7IH1cblxuZnVuY3Rpb24gc2V0TG9nRGlyZWN0b3J5UGF0aChkaXJlY3RvcnlQYXRoKSB7IGxvZ0RpcmVjdG9yeVBhdGggPSBkaXJlY3RvcnlQYXRoOyB9XG5cbmZ1bmN0aW9uIHNldExvZ09wdGlvbnMobG9nT3B0aW9ucykge1xuICBjb25zdCB7IGxldmVsLCBmaWxlQmFzZU5hbWUsIGRpcmVjdG9yeVBhdGggfSA9IGxvZ09wdGlvbnM7XG5cbiAgc2V0TG9nTGV2ZWwobGV2ZWwpO1xuXG4gIHNldExvZ0ZpbGVCYXNlTmFtZShmaWxlQmFzZU5hbWUpO1xuXG4gIHNldExvZ0RpcmVjdG9yeVBhdGgoZGlyZWN0b3J5UGF0aCk7XG59XG5cbmZ1bmN0aW9uIGdldExvZ0ZpbGVDb250ZW50KCkge1xuICBjb25zdCBsb2dGaWxlUGF0aCA9IGdldExvZ0ZpbGVQYXRoKCksXG4gICAgICAgIGxvZ0ZpbGVDb250ZW50ID0gcmVhZEZpbGUobG9nRmlsZVBhdGgpO1xuXG4gIHJldHVybiBsb2dGaWxlQ29udGVudDtcbn1cblxuT2JqZWN0LmFzc2lnbihsb2csIHtcbiAgVFJBQ0UsXG4gIERFQlVHLFxuICBJTkZPLFxuICBXQVJOSU5HLFxuICBFUlJPUixcbiAgRkFUQUwsXG4gIHRyYWNlLFxuICBkZWJ1ZyxcbiAgaW5mbyxcbiAgd2FybmluZyxcbiAgZXJyb3IsXG4gIGZhdGFsLFxuICBzZXRMb2dMZXZlbCxcbiAgc2V0TG9nRmlsZUJhc2VOYW1lLFxuICBzZXRMb2dEaXJlY3RvcnlQYXRoLFxuICBzZXRMb2dPcHRpb25zLFxuICBnZXRMb2dGaWxlQ29udGVudFxufSk7XG5cbmZ1bmN0aW9uIGdldExvZ0ZpbGVQYXRoKCkge1xuICBjb25zdCBsb2dGaWxlTmFtZSA9IGAke2xvZ0ZpbGVCYXNlTmFtZX0ubG9nYCxcbiAgICAgICAgbG9nRmlsZVBhdGggPSBjb25jYXRlbmF0ZVBhdGhzKGxvZ0RpcmVjdG9yeVBhdGgsIGxvZ0ZpbGVOYW1lKTtcblxuICByZXR1cm4gbG9nRmlsZVBhdGg7XG59XG5cbmZ1bmN0aW9uIGdldFJvbGxlZE92ZXJMb2dGaWxlUGF0aCgpIHtcbiAgY29uc3QgY3VycmVudERhdGVTdHJpbmcgPSBnZXRDdXJyZW50RGF0ZVN0cmluZygpLFxuICAgICAgICByb2xsZWRPdmVyTG9nRmlsZU5hbWUgPSBgJHtsb2dGaWxlQmFzZU5hbWV9LiR7Y3VycmVudERhdGVTdHJpbmd9LmxvZ2AsXG4gICAgICAgIHJvbGxlZE92ZXJMb2dGaWxlUGF0aCA9IGNvbmNhdGVuYXRlUGF0aHMobG9nRGlyZWN0b3J5UGF0aCwgcm9sbGVkT3ZlckxvZ0ZpbGVOYW1lKTtcblxuICByZXR1cm4gcm9sbGVkT3ZlckxvZ0ZpbGVQYXRoO1xufVxuXG5mdW5jdGlvbiBnZXRMb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSgpIHtcbiAgY29uc3QgbG9nRmlsZVBhdGggPSBnZXRMb2dGaWxlUGF0aCgpLFxuICAgICAgICBsb2dGaWxlU3RhdHMgPSBnZXRTdGF0cyhsb2dGaWxlUGF0aCksXG4gICAgICAgIHsgbXRpbWUgfSA9IGxvZ0ZpbGVTdGF0cyxcbiAgICAgICAgbG9nRmlsZUxhc3RNb2RpZmllZERhdGUgPSBuZXcgRGF0ZShtdGltZSk7ICAvLy9cblxuICByZXR1cm4gbG9nRmlsZUxhc3RNb2RpZmllZERhdGU7XG59XG5cbmZ1bmN0aW9uIHJvbGxPdmVyTG9nRmlsZSgpIHtcbiAgY29uc3QgbG9nRmlsZVBhdGggPSBnZXRMb2dGaWxlUGF0aCgpLFxuICAgICAgICBsb2dGaWxlRXhpc3RzID0gY2hlY2tGaWxlRXhpc3RzKGxvZ0ZpbGVQYXRoKTtcblxuICBpZiAoIWxvZ0ZpbGVFeGlzdHMpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSA9IGdldExvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlKCksXG4gICAgICAgIGxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlQ3VycmVudERhdGUgPSBpc0RhdGVDdXJyZW50RGF0ZShsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSk7XG5cbiAgaWYgKCFsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZUN1cnJlbnREYXRlKSB7XG4gICAgY29uc3Qgcm9sbGVkT3ZlckxvZ0ZpbGVQYXRoID0gZ2V0Um9sbGVkT3ZlckxvZ0ZpbGVQYXRoKCk7XG5cbiAgICByZW5hbWVGaWxlKGxvZ0ZpbGVQYXRoLCByb2xsZWRPdmVyTG9nRmlsZVBhdGgpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzRGF0ZUN1cnJlbnREYXRlKGRhdGUpIHtcbiAgY29uc3QgY3VycmVudERhdGUgPSBuZXcgRGF0ZSgpLFxuICAgICAgICBkYXRlU3RyaW5nID0gZGF0ZS50b0RhdGVTdHJpbmcoKSxcbiAgICAgICAgY3VycmVudERhdGVTdHJpbmcgPSBjdXJyZW50RGF0ZS50b0RhdGVTdHJpbmcoKSxcbiAgICAgICAgZGF0ZUN1cnJlbnREYXRlID0gKGRhdGVTdHJpbmcgPT09IGN1cnJlbnREYXRlU3RyaW5nKTtcblxuICByZXR1cm4gZGF0ZUN1cnJlbnREYXRlO1xufVxuXG5mdW5jdGlvbiBnZXRDdXJyZW50RGF0ZVN0cmluZygpIHtcbiAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCksXG4gICAgICAgIGRheSA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldERhdGUoKSwgMiksICAvLy9cbiAgICAgICAgbW9udGggPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRNb250aCgpICsgMSwgMiksIC8vL1xuICAgICAgICB5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpLFxuICAgICAgICBjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmcgPSBgJHtkYXl9LSR7bW9udGh9LSR7eWVhcn1gO1xuXG4gIHJldHVybiBjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmc7XG59XG5cbmZ1bmN0aW9uIGdldEN1cnJlbnREYXRlQW5kVGltZVN0cmluZygpIHtcbiAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCksXG4gICAgICAgIGRheSA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldERhdGUoKSwgMiksICAvLy9cbiAgICAgICAgbW9udGggPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRNb250aCgpICsgMSwgMiksIC8vL1xuICAgICAgICB5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpLFxuICAgICAgICBob3VycyA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldEhvdXJzKCksIDIpLFxuICAgICAgICBtaW51dGVzID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0TWludXRlcygpLCAyKSxcbiAgICAgICAgc2Vjb25kcyA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldFNlY29uZHMoKSwgMiksXG4gICAgICAgIG1pbGxpc2Vjb25kcyA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldE1pbGxpc2Vjb25kcygpLCAzKSxcbiAgICAgICAgY3VycmVudERhdGVBbmRUaW1lU3RyaW5nID0gYCR7ZGF5fS0ke21vbnRofS0ke3llYXJ9ICR7aG91cnN9OiR7bWludXRlc306JHtzZWNvbmRzfS4ke21pbGxpc2Vjb25kc31gO1xuXG4gIHJldHVybiBjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmc7XG59XG5cbmZ1bmN0aW9uIHN0YWNrTWVzc2FnZXNGcm9tU3RhY2soc3RhY2spIHtcbiAgY29uc3Qgc3RhY2tNZXNzYWdlcyA9IFtdLFxuICAgICAgICBzdGFja0xpbmVzID0gc3RhY2suc3BsaXQoL1xcclxcbnxcXG4vKTtcblxuICBsZXQgc3RhY2tNZXNzYWdlID0gXCJcIjtcblxuICBzdGFja0xpbmVzLmZvckVhY2goKHN0YWNrTGluZSkgPT4ge1xuICAgIGNvbnN0IG1hdGNoZXMgPSAvXlxccyphdC4qLy50ZXN0KHN0YWNrTGluZSk7XG5cbiAgICBzdGFja01lc3NhZ2UgPSAoc3RhY2tNZXNzYWdlID09PSBcIlwiKSA/XG4gICAgICAgICAgICAgICAgICAgICAgc3RhY2tMaW5lIDpcbiAgICAgICAgICAgICAgICAgICAgICAgIGAke3N0YWNrTWVzc2FnZX1cXG4ke3N0YWNrTGluZX1gO1xuXG4gICAgaWYgKG1hdGNoZXMpIHtcbiAgICAgIHN0YWNrTWVzc2FnZXMucHVzaChzdGFja01lc3NhZ2UpO1xuXG4gICAgICBzdGFja01lc3NhZ2UgPSBcIlwiO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHN0YWNrTWVzc2FnZXM7XG59XG5cbmZ1bmN0aW9uIGZpbGVQYXRoRnJvbVN0YWNrTWVzc2FnZShzdGFja01lc3NhZ2UpIHtcbiAgY29uc3QgbWF0Y2hlcyA9IHN0YWNrTWVzc2FnZS5tYXRjaCgvKFxcLy4rKTpcXGQrOlxcZCsvbSksXG4gICAgICAgIHNlY29uZE1hdGNoID0gc2Vjb25kKG1hdGNoZXMpLFxuICAgICAgICBhYnNvbHV0ZUZpbGVQYXRoID0gc2Vjb25kTWF0Y2gsICAvLy9cbiAgICAgICAgY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoID0gcGF0aC5yZXNvbHZlKFwiLlwiKSwgIC8vL1xuICAgICAgICBjdXJyZW50V29ya2luZ0RpcmVjdG9yeVBhdGhMZW5ndGggPSBjdXJyZW50V29ya2luZ0RpcmVjdG9yeVBhdGgubGVuZ3RoLFxuICAgICAgICBzdGFydCA9IGN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aExlbmd0aCArIDEsICAvLy9cbiAgICAgICAgZmlsZVBhdGggPSBhYnNvbHV0ZUZpbGVQYXRoLnN1YnN0cihzdGFydCk7XG5cbiAgcmV0dXJuIGZpbGVQYXRoO1xufVxuXG5mdW5jdGlvbiBsaW5lTnVtYmVyRnJvbVN0YWNrTWVzc2FnZShzdGFja01lc3NhZ2UpIHtcbiAgY29uc3QgbWF0Y2hlcyA9IHN0YWNrTWVzc2FnZS5tYXRjaCgvOihcXGQrKS9tKSxcbiAgICAgICAgc2Vjb25kTWF0Y2ggPSBzZWNvbmQobWF0Y2hlcyksXG4gICAgICAgIGxpbmVOdW1iZXIgPSBzZWNvbmRNYXRjaDsgLy8vXG5cbiAgcmV0dXJuIGxpbmVOdW1iZXI7XG59XG5cbmZ1bmN0aW9uIHBhZFN0YXJ0V2l0aFplcm9lcyhzdHJpbmcsIHRhcmdldExlbmd0aCkge1xuICBjb25zdCBwYWRTdHJpbmcgPSBcIjBcIixcbiAgICAgICAgcGFkZGVkU3RyaW5nID0gcGFkU3RhcnQoc3RyaW5nLCB0YXJnZXRMZW5ndGgsIHBhZFN0cmluZyk7XG5cbiAgcmV0dXJuIHBhZGRlZFN0cmluZztcbn1cblxuZnVuY3Rpb24gcGFkU3RhcnQoc3RyaW5nLCB0YXJnZXRMZW5ndGgsIHBhZFN0cmluZykge1xuICBsZXQgcGFkZGluZyA9IFwiXCI7XG5cbiAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHRhcmdldExlbmd0aDsgaW5kZXgrKykge1xuICAgIHBhZGRpbmcgKz0gcGFkU3RyaW5nO1xuICB9XG5cbiAgY29uc3QgcGFkZGVkU3RyaW5nID0gYCR7cGFkZGluZ30ke3N0cmluZ31gLnN1YnN0cigtdGFyZ2V0TGVuZ3RoKTtcblxuICByZXR1cm4gcGFkZGVkU3RyaW5nO1xufVxuIl19