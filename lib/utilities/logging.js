"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.log = log;
exports["default"] = void 0;

var _path = _interopRequireDefault(require("path"));

var _array = require("../utilities/array");

var _path2 = require("../utilities/path");

var _fileSystem = require("../utilities/fileSystem");

var _constants = require("../constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var levels = [_constants.TRACE, _constants.DEBUG, _constants.INFO, _constants.WARNING, _constants.ERROR, _constants.FATAL];
var logLevel = _constants.DEFAULT_LOG_LEVEL,
    logFileBaseName = _constants.DEFAULT_LOG_FILE_BASE_NAME,
    logDirectoryPath = _constants.DEFAULT_LOG_DIRECTORY_PATH;

function log(messageOrError) {
  var level = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : "";
  var salientStackMessageIndex = 1;

  if (level !== "") {
    var levelIndex = levels.indexOf(level),
        logLevelIndex = levels.indexOf(logLevel);

    if (levelIndex < logLevelIndex) {
      return;
    }

    salientStackMessageIndex += 1;
    level = "".concat(level, " "); ///
  }

  var error, message;

  if (messageOrError instanceof Error) {
    error = messageOrError; ///

    var _error = error;
    message = _error.message;
  } else {
    message = messageOrError; ///

    error = new Error(message);
  }

  var _error2 = error,
      stack = _error2.stack,
      stackMessages = stackMessagesFromStack(stack),
      pertinentStackMessage = stackMessages[salientStackMessageIndex],
      stackMessage = pertinentStackMessage,
      currentDateAndTimeString = getCurrentDateAndTimeString(),
      filePath = filePathFromStackMessage(stackMessage),
      lineNumber = lineNumberFromStackMessage(stackMessage),
      logMessage = "".concat(level).concat(currentDateAndTimeString, " ").concat(filePath, "(").concat(lineNumber, ") ").concat(message);
  console.log(logMessage);

  if (logDirectoryPath !== null) {
    rollOverLogFile();
    var logFilePath = getLogFilePath(),
        logFileContent = "".concat(logMessage, "\n");
    (0, _fileSystem.appendToFile)(logFilePath, logFileContent);
  }

  return logMessage;
}

var _default = {
  log: log
};
exports["default"] = _default;

function trace(message) {
  return log(message, _constants.TRACE);
}

function debug(message) {
  return log(message, _constants.DEBUG);
}

function info(message) {
  return log(message, _constants.INFO);
}

function warning(message) {
  return log(message, _constants.WARNING);
}

function error(message) {
  return log(message, _constants.ERROR);
}

function fatal(message) {
  return log(message, _constants.FATAL);
}

function setLogLevel(level) {
  logLevel = level;
}

function setLogFileBaseName(fileBaseName) {
  logFileBaseName = fileBaseName;
}

function setLogDirectoryPath(directoryPath) {
  logDirectoryPath = directoryPath;
}

function setLogOptions(logOptions) {
  var level = logOptions.level,
      fileBaseName = logOptions.fileBaseName,
      directoryPath = logOptions.directoryPath;
  setLogLevel(level);
  setLogFileBaseName(fileBaseName);
  setLogDirectoryPath(directoryPath);
}

function getLogFileContent() {
  var logFilePath = getLogFilePath(),
      logFileContent = (0, _fileSystem.readFile)(logFilePath);
  return logFileContent;
}

Object.assign(log, {
  TRACE: _constants.TRACE,
  DEBUG: _constants.DEBUG,
  INFO: _constants.INFO,
  WARNING: _constants.WARNING,
  ERROR: _constants.ERROR,
  FATAL: _constants.FATAL,
  trace: trace,
  debug: debug,
  info: info,
  warning: warning,
  error: error,
  fatal: fatal,
  setLogLevel: setLogLevel,
  setLogFileBaseName: setLogFileBaseName,
  setLogDirectoryPath: setLogDirectoryPath,
  setLogOptions: setLogOptions,
  getLogFileContent: getLogFileContent
});

function getLogFilePath() {
  var logFileName = "".concat(logFileBaseName, ".log"),
      logFilePath = (0, _path2.concatenatePaths)(logDirectoryPath, logFileName);
  return logFilePath;
}

function getRolledOverLogFilePath() {
  var currentDateString = getCurrentDateString(),
      rolledOverLogFileName = "".concat(logFileBaseName, ".").concat(currentDateString, ".log"),
      rolledOverLogFilePath = (0, _path2.concatenatePaths)(logDirectoryPath, rolledOverLogFileName);
  return rolledOverLogFilePath;
}

function getLogFileLastModifiedDate() {
  var logFilePath = getLogFilePath(),
      logFileStats = (0, _fileSystem.getStats)(logFilePath),
      mtime = logFileStats.mtime,
      logFileLastModifiedDate = new Date(mtime); ///

  return logFileLastModifiedDate;
}

function rollOverLogFile() {
  var logFilePath = getLogFilePath(),
      logFileExists = (0, _fileSystem.checkFileExists)(logFilePath);

  if (!logFileExists) {
    return;
  }

  var logFileLastModifiedDate = getLogFileLastModifiedDate(),
      logFileLastModifiedDateCurrentDate = isDateCurrentDate(logFileLastModifiedDate);

  if (!logFileLastModifiedDateCurrentDate) {
    var rolledOverLogFilePath = getRolledOverLogFilePath();
    (0, _fileSystem.renameFile)(logFilePath, rolledOverLogFilePath);
  }
}

function isDateCurrentDate(date) {
  var currentDate = new Date(),
      dateString = date.toDateString(),
      currentDateString = currentDate.toDateString(),
      dateCurrentDate = dateString === currentDateString;
  return dateCurrentDate;
}

function getCurrentDateString() {
  var date = new Date(),
      day = padStartWithZeroes(date.getDate(), 2),
      ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
      ///
  year = date.getFullYear(),
      currentDateAndTimeString = "".concat(day, "-").concat(month, "-").concat(year);
  return currentDateAndTimeString;
}

function getCurrentDateAndTimeString() {
  var date = new Date(),
      day = padStartWithZeroes(date.getDate(), 2),
      ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
      ///
  year = date.getFullYear(),
      hours = padStartWithZeroes(date.getHours(), 2),
      minutes = padStartWithZeroes(date.getMinutes(), 2),
      seconds = padStartWithZeroes(date.getSeconds(), 2),
      milliseconds = padStartWithZeroes(date.getMilliseconds(), 3),
      currentDateAndTimeString = "".concat(day, "-").concat(month, "-").concat(year, " ").concat(hours, ":").concat(minutes, ":").concat(seconds, ".").concat(milliseconds);
  return currentDateAndTimeString;
}

function stackMessagesFromStack(stack) {
  var stackMessages = [],
      stackLines = stack.split(/\r\n|\n/);
  var stackMessage = "";
  stackLines.forEach(function (stackLine) {
    var matches = /^\s*at.*/.test(stackLine);
    stackMessage = stackMessage === "" ? stackLine : "".concat(stackMessage, "\n").concat(stackLine);

    if (matches) {
      stackMessages.push(stackMessage);
      stackMessage = "";
    }
  });
  return stackMessages;
}

function filePathFromStackMessage(stackMessage) {
  var matches = stackMessage.match(/(\/.+):\d+:\d+/m),
      secondMatch = (0, _array.second)(matches),
      absoluteFilePath = secondMatch,
      ///
  currentWorkingDirectoryPath = _path["default"].resolve("."),
      ///
  currentWorkingDirectoryPathLength = currentWorkingDirectoryPath.length,
      start = currentWorkingDirectoryPathLength + 1,
      ///
  filePath = absoluteFilePath.substr(start);

  return filePath;
}

function lineNumberFromStackMessage(stackMessage) {
  var matches = stackMessage.match(/:(\d+)/m),
      secondMatch = (0, _array.second)(matches),
      lineNumber = secondMatch; ///

  return lineNumber;
}

function padStartWithZeroes(string, targetLength) {
  var padString = "0",
      paddedString = padStart(string, targetLength, padString);
  return paddedString;
}

function padStart(string, targetLength, padString) {
  var padding = "";

  for (var index = 0; index < targetLength; index++) {
    padding += padString;
  }

  var paddedString = "".concat(padding).concat(string).substr(-targetLength);
  return paddedString;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxvZ2dpbmcuanMiXSwibmFtZXMiOlsibGV2ZWxzIiwiVFJBQ0UiLCJERUJVRyIsIklORk8iLCJXQVJOSU5HIiwiRVJST1IiLCJGQVRBTCIsImxvZ0xldmVsIiwiREVGQVVMVF9MT0dfTEVWRUwiLCJsb2dGaWxlQmFzZU5hbWUiLCJERUZBVUxUX0xPR19GSUxFX0JBU0VfTkFNRSIsImxvZ0RpcmVjdG9yeVBhdGgiLCJERUZBVUxUX0xPR19ESVJFQ1RPUllfUEFUSCIsImxvZyIsIm1lc3NhZ2VPckVycm9yIiwibGV2ZWwiLCJzYWxpZW50U3RhY2tNZXNzYWdlSW5kZXgiLCJsZXZlbEluZGV4IiwiaW5kZXhPZiIsImxvZ0xldmVsSW5kZXgiLCJlcnJvciIsIm1lc3NhZ2UiLCJFcnJvciIsInN0YWNrIiwic3RhY2tNZXNzYWdlcyIsInN0YWNrTWVzc2FnZXNGcm9tU3RhY2siLCJwZXJ0aW5lbnRTdGFja01lc3NhZ2UiLCJzdGFja01lc3NhZ2UiLCJjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmciLCJnZXRDdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmciLCJmaWxlUGF0aCIsImZpbGVQYXRoRnJvbVN0YWNrTWVzc2FnZSIsImxpbmVOdW1iZXIiLCJsaW5lTnVtYmVyRnJvbVN0YWNrTWVzc2FnZSIsImxvZ01lc3NhZ2UiLCJjb25zb2xlIiwicm9sbE92ZXJMb2dGaWxlIiwibG9nRmlsZVBhdGgiLCJnZXRMb2dGaWxlUGF0aCIsImxvZ0ZpbGVDb250ZW50IiwidHJhY2UiLCJkZWJ1ZyIsImluZm8iLCJ3YXJuaW5nIiwiZmF0YWwiLCJzZXRMb2dMZXZlbCIsInNldExvZ0ZpbGVCYXNlTmFtZSIsImZpbGVCYXNlTmFtZSIsInNldExvZ0RpcmVjdG9yeVBhdGgiLCJkaXJlY3RvcnlQYXRoIiwic2V0TG9nT3B0aW9ucyIsImxvZ09wdGlvbnMiLCJnZXRMb2dGaWxlQ29udGVudCIsIk9iamVjdCIsImFzc2lnbiIsImxvZ0ZpbGVOYW1lIiwiZ2V0Um9sbGVkT3ZlckxvZ0ZpbGVQYXRoIiwiY3VycmVudERhdGVTdHJpbmciLCJnZXRDdXJyZW50RGF0ZVN0cmluZyIsInJvbGxlZE92ZXJMb2dGaWxlTmFtZSIsInJvbGxlZE92ZXJMb2dGaWxlUGF0aCIsImdldExvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlIiwibG9nRmlsZVN0YXRzIiwibXRpbWUiLCJsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSIsIkRhdGUiLCJsb2dGaWxlRXhpc3RzIiwibG9nRmlsZUxhc3RNb2RpZmllZERhdGVDdXJyZW50RGF0ZSIsImlzRGF0ZUN1cnJlbnREYXRlIiwiZGF0ZSIsImN1cnJlbnREYXRlIiwiZGF0ZVN0cmluZyIsInRvRGF0ZVN0cmluZyIsImRhdGVDdXJyZW50RGF0ZSIsImRheSIsInBhZFN0YXJ0V2l0aFplcm9lcyIsImdldERhdGUiLCJtb250aCIsImdldE1vbnRoIiwieWVhciIsImdldEZ1bGxZZWFyIiwiaG91cnMiLCJnZXRIb3VycyIsIm1pbnV0ZXMiLCJnZXRNaW51dGVzIiwic2Vjb25kcyIsImdldFNlY29uZHMiLCJtaWxsaXNlY29uZHMiLCJnZXRNaWxsaXNlY29uZHMiLCJzdGFja0xpbmVzIiwic3BsaXQiLCJmb3JFYWNoIiwic3RhY2tMaW5lIiwibWF0Y2hlcyIsInRlc3QiLCJwdXNoIiwibWF0Y2giLCJzZWNvbmRNYXRjaCIsImFic29sdXRlRmlsZVBhdGgiLCJjdXJyZW50V29ya2luZ0RpcmVjdG9yeVBhdGgiLCJwYXRoIiwicmVzb2x2ZSIsImN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aExlbmd0aCIsImxlbmd0aCIsInN0YXJ0Iiwic3Vic3RyIiwic3RyaW5nIiwidGFyZ2V0TGVuZ3RoIiwicGFkU3RyaW5nIiwicGFkZGVkU3RyaW5nIiwicGFkU3RhcnQiLCJwYWRkaW5nIiwiaW5kZXgiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7OztBQUVBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsSUFBTUEsTUFBTSxHQUFHLENBQ2JDLGdCQURhLEVBRWJDLGdCQUZhLEVBR2JD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O0FBRUQsU0FBU0csMEJBQVQsQ0FBb0NOLFlBQXBDLEVBQWtEO0FBQ2hELE1BQU1rRSxPQUFPLEdBQUdsRSxZQUFZLENBQUNxRSxLQUFiLENBQW1CLFNBQW5CLENBQWhCO0FBQUEsTUFDTUMsV0FBVyxHQUFHLG1CQUFPSixPQUFQLENBRHBCO0FBQUEsTUFFTTdELFVBQVUsR0FBR2lFLFdBRm5CLENBRGdELENBR2hCOztBQUVoQyxTQUFPakUsVUFBUDtBQUNEOztBQUVELFNBQVMyQyxrQkFBVCxDQUE0QitCLE1BQTVCLEVBQW9DQyxZQUFwQyxFQUFrRDtBQUNoRCxNQUFNQyxTQUFTLEdBQUcsR0FBbEI7QUFBQSxNQUNNQyxZQUFZLEdBQUdDLFFBQVEsQ0FBQ0osTUFBRCxFQUFTQyxZQUFULEVBQXVCQyxTQUF2QixDQUQ3QjtBQUdBLFNBQU9DLFlBQVA7QUFDRDs7QUFFRCxTQUFTQyxRQUFULENBQWtCSixNQUFsQixFQUEwQkMsWUFBMUIsRUFBd0NDLFNBQXhDLEVBQW1EO0FBQ2pELE1BQUlHLE9BQU8sR0FBRyxFQUFkOztBQUVBLE9BQUssSUFBSUMsS0FBSyxHQUFHLENBQWpCLEVBQW9CQSxLQUFLLEdBQUdMLFlBQTVCLEVBQTBDSyxLQUFLLEVBQS9DLEVBQW1EO0FBQ2pERCxJQUFBQSxPQUFPLElBQUlILFNBQVg7QUFDRDs7QUFFRCxNQUFNQyxZQUFZLEdBQUcsVUFBR0UsT0FBSCxTQUFhTCxNQUFiLEVBQXNCRCxNQUF0QixDQUE2QixDQUFDRSxZQUE5QixDQUFyQjtBQUVBLFNBQU9FLFlBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiO1xuXG5pbXBvcnQgeyBzZWNvbmQgfSBmcm9tIFwiLi4vdXRpbGl0aWVzL2FycmF5XCI7XG5pbXBvcnQgeyBjb25jYXRlbmF0ZVBhdGhzIH0gZnJvbSBcIi4uL3V0aWxpdGllcy9wYXRoXCI7XG5pbXBvcnQgeyBjaGVja0ZpbGVFeGlzdHMsIHJlYWRGaWxlLCBhcHBlbmRUb0ZpbGUsIHJlbmFtZUZpbGUsIGdldFN0YXRzIH0gZnJvbSBcIi4uL3V0aWxpdGllcy9maWxlU3lzdGVtXCI7XG5pbXBvcnQgeyBUUkFDRSwgREVCVUcsIElORk8sIFdBUk5JTkcsIEVSUk9SLCBGQVRBTCwgREVGQVVMVF9MT0dfTEVWRUwsIERFRkFVTFRfTE9HX0ZJTEVfQkFTRV9OQU1FLCBERUZBVUxUX0xPR19ESVJFQ1RPUllfUEFUSCB9IGZyb20gXCIuLi9jb25zdGFudHNcIjtcblxuY29uc3QgbGV2ZWxzID0gW1xuICBUUkFDRSxcbiAgREVCVUcsXG4gIElORk8sXG4gIFdBUk5JTkcsXG4gIEVSUk9SLFxuICBGQVRBTCxcbl07XG5cbmxldCBsb2dMZXZlbCA9IERFRkFVTFRfTE9HX0xFVkVMLFxuICAgIGxvZ0ZpbGVCYXNlTmFtZSA9IERFRkFVTFRfTE9HX0ZJTEVfQkFTRV9OQU1FLFxuICAgIGxvZ0RpcmVjdG9yeVBhdGggPSBERUZBVUxUX0xPR19ESVJFQ1RPUllfUEFUSDtcblxuZXhwb3J0IGZ1bmN0aW9uIGxvZyhtZXNzYWdlT3JFcnJvciwgbGV2ZWwgPSBcIlwiKSB7XG4gIGxldCBzYWxpZW50U3RhY2tNZXNzYWdlSW5kZXggPSAxO1xuXG4gIGlmIChsZXZlbCAhPT0gXCJcIikge1xuICAgIGNvbnN0IGxldmVsSW5kZXggPSBsZXZlbHMuaW5kZXhPZihsZXZlbCksXG4gICAgICAgICAgbG9nTGV2ZWxJbmRleCA9IGxldmVscy5pbmRleE9mKGxvZ0xldmVsKTtcblxuICAgIGlmIChsZXZlbEluZGV4IDwgbG9nTGV2ZWxJbmRleCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHNhbGllbnRTdGFja01lc3NhZ2VJbmRleCArPSAxO1xuXG4gICAgbGV2ZWwgPSBgJHtsZXZlbH0gYDsgIC8vL1xuICB9XG5cbiAgbGV0IGVycm9yLFxuICAgICAgbWVzc2FnZTtcblxuICBpZiAobWVzc2FnZU9yRXJyb3IgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgIGVycm9yID0gbWVzc2FnZU9yRXJyb3I7IC8vL1xuXG4gICAgKHsgbWVzc2FnZSB9ID0gZXJyb3IpO1xuICB9IGVsc2Uge1xuICAgIG1lc3NhZ2UgPSBtZXNzYWdlT3JFcnJvcjsgLy8vXG5cbiAgICBlcnJvciA9IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgfVxuXG4gIGNvbnN0IHsgc3RhY2sgfSA9IGVycm9yLFxuICAgICAgICBzdGFja01lc3NhZ2VzID0gc3RhY2tNZXNzYWdlc0Zyb21TdGFjayhzdGFjayksXG4gICAgICAgIHBlcnRpbmVudFN0YWNrTWVzc2FnZSA9IHN0YWNrTWVzc2FnZXNbc2FsaWVudFN0YWNrTWVzc2FnZUluZGV4XSxcbiAgICAgICAgc3RhY2tNZXNzYWdlID0gcGVydGluZW50U3RhY2tNZXNzYWdlLCAvLy9cbiAgICAgICAgY3VycmVudERhdGVBbmRUaW1lU3RyaW5nID0gZ2V0Q3VycmVudERhdGVBbmRUaW1lU3RyaW5nKCksXG4gICAgICAgIGZpbGVQYXRoID0gZmlsZVBhdGhGcm9tU3RhY2tNZXNzYWdlKHN0YWNrTWVzc2FnZSksXG4gICAgICAgIGxpbmVOdW1iZXIgPSBsaW5lTnVtYmVyRnJvbVN0YWNrTWVzc2FnZShzdGFja01lc3NhZ2UpLFxuICAgICAgICBsb2dNZXNzYWdlID0gYCR7bGV2ZWx9JHtjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmd9ICR7ZmlsZVBhdGh9KCR7bGluZU51bWJlcn0pICR7bWVzc2FnZX1gO1xuXG4gIGNvbnNvbGUubG9nKGxvZ01lc3NhZ2UpO1xuXG4gIGlmIChsb2dEaXJlY3RvcnlQYXRoICE9PSBudWxsKSB7XG4gICAgcm9sbE92ZXJMb2dGaWxlKCk7XG5cbiAgICBjb25zdCBsb2dGaWxlUGF0aCA9IGdldExvZ0ZpbGVQYXRoKCksXG4gICAgICAgICAgbG9nRmlsZUNvbnRlbnQgPSBgJHtsb2dNZXNzYWdlfVxcbmA7XG5cbiAgICBhcHBlbmRUb0ZpbGUobG9nRmlsZVBhdGgsIGxvZ0ZpbGVDb250ZW50KTtcbiAgfVxuXG4gIHJldHVybiBsb2dNZXNzYWdlO1xufVxuXG5leHBvcnQgZGVmYXVsdCB7XG4gIGxvZ1xufVxuXG5mdW5jdGlvbiB0cmFjZShtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgVFJBQ0UpOyB9XG5cbmZ1bmN0aW9uIGRlYnVnKG1lc3NhZ2UpIHsgcmV0dXJuIGxvZyhtZXNzYWdlLCBERUJVRyk7IH1cblxuZnVuY3Rpb24gaW5mbyhtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgSU5GTyk7IH1cblxuZnVuY3Rpb24gd2FybmluZyhtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgV0FSTklORyk7IH1cblxuZnVuY3Rpb24gZXJyb3IobWVzc2FnZSkgeyByZXR1cm4gbG9nKG1lc3NhZ2UsIEVSUk9SKTsgfVxuXG5mdW5jdGlvbiBmYXRhbChtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgRkFUQUwpOyB9XG5cbmZ1bmN0aW9uIHNldExvZ0xldmVsKGxldmVsKSB7IGxvZ0xldmVsID0gbGV2ZWw7IH1cblxuZnVuY3Rpb24gc2V0TG9nRmlsZUJhc2VOYW1lKGZpbGVCYXNlTmFtZSkgeyBsb2dGaWxlQmFzZU5hbWUgPSBmaWxlQmFzZU5hbWU7IH1cblxuZnVuY3Rpb24gc2V0TG9nRGlyZWN0b3J5UGF0aChkaXJlY3RvcnlQYXRoKSB7IGxvZ0RpcmVjdG9yeVBhdGggPSBkaXJlY3RvcnlQYXRoOyB9XG5cbmZ1bmN0aW9uIHNldExvZ09wdGlvbnMobG9nT3B0aW9ucykge1xuICBjb25zdCB7IGxldmVsLCBmaWxlQmFzZU5hbWUsIGRpcmVjdG9yeVBhdGggfSA9IGxvZ09wdGlvbnM7XG5cbiAgc2V0TG9nTGV2ZWwobGV2ZWwpO1xuXG4gIHNldExvZ0ZpbGVCYXNlTmFtZShmaWxlQmFzZU5hbWUpO1xuXG4gIHNldExvZ0RpcmVjdG9yeVBhdGgoZGlyZWN0b3J5UGF0aCk7XG59XG5cbmZ1bmN0aW9uIGdldExvZ0ZpbGVDb250ZW50KCkge1xuICBjb25zdCBsb2dGaWxlUGF0aCA9IGdldExvZ0ZpbGVQYXRoKCksXG4gICAgICAgIGxvZ0ZpbGVDb250ZW50ID0gcmVhZEZpbGUobG9nRmlsZVBhdGgpO1xuXG4gIHJldHVybiBsb2dGaWxlQ29udGVudDtcbn1cblxuT2JqZWN0LmFzc2lnbihsb2csIHtcbiAgVFJBQ0UsXG4gIERFQlVHLFxuICBJTkZPLFxuICBXQVJOSU5HLFxuICBFUlJPUixcbiAgRkFUQUwsXG4gIHRyYWNlLFxuICBkZWJ1ZyxcbiAgaW5mbyxcbiAgd2FybmluZyxcbiAgZXJyb3IsXG4gIGZhdGFsLFxuICBzZXRMb2dMZXZlbCxcbiAgc2V0TG9nRmlsZUJhc2VOYW1lLFxuICBzZXRMb2dEaXJlY3RvcnlQYXRoLFxuICBzZXRMb2dPcHRpb25zLFxuICBnZXRMb2dGaWxlQ29udGVudFxufSk7XG5cbmZ1bmN0aW9uIGdldExvZ0ZpbGVQYXRoKCkge1xuICBjb25zdCBsb2dGaWxlTmFtZSA9IGAke2xvZ0ZpbGVCYXNlTmFtZX0ubG9nYCxcbiAgICAgICAgbG9nRmlsZVBhdGggPSBjb25jYXRlbmF0ZVBhdGhzKGxvZ0RpcmVjdG9yeVBhdGgsIGxvZ0ZpbGVOYW1lKTtcblxuICByZXR1cm4gbG9nRmlsZVBhdGg7XG59XG5cbmZ1bmN0aW9uIGdldFJvbGxlZE92ZXJMb2dGaWxlUGF0aCgpIHtcbiAgY29uc3QgY3VycmVudERhdGVTdHJpbmcgPSBnZXRDdXJyZW50RGF0ZVN0cmluZygpLFxuICAgICAgICByb2xsZWRPdmVyTG9nRmlsZU5hbWUgPSBgJHtsb2dGaWxlQmFzZU5hbWV9LiR7Y3VycmVudERhdGVTdHJpbmd9LmxvZ2AsXG4gICAgICAgIHJvbGxlZE92ZXJMb2dGaWxlUGF0aCA9IGNvbmNhdGVuYXRlUGF0aHMobG9nRGlyZWN0b3J5UGF0aCwgcm9sbGVkT3ZlckxvZ0ZpbGVOYW1lKTtcblxuICByZXR1cm4gcm9sbGVkT3ZlckxvZ0ZpbGVQYXRoO1xufVxuXG5mdW5jdGlvbiBnZXRMb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSgpIHtcbiAgY29uc3QgbG9nRmlsZVBhdGggPSBnZXRMb2dGaWxlUGF0aCgpLFxuICAgICAgICBsb2dGaWxlU3RhdHMgPSBnZXRTdGF0cyhsb2dGaWxlUGF0aCksXG4gICAgICAgIHsgbXRpbWUgfSA9IGxvZ0ZpbGVTdGF0cyxcbiAgICAgICAgbG9nRmlsZUxhc3RNb2RpZmllZERhdGUgPSBuZXcgRGF0ZShtdGltZSk7ICAvLy9cblxuICByZXR1cm4gbG9nRmlsZUxhc3RNb2RpZmllZERhdGU7XG59XG5cbmZ1bmN0aW9uIHJvbGxPdmVyTG9nRmlsZSgpIHtcbiAgY29uc3QgbG9nRmlsZVBhdGggPSBnZXRMb2dGaWxlUGF0aCgpLFxuICAgICAgICBsb2dGaWxlRXhpc3RzID0gY2hlY2tGaWxlRXhpc3RzKGxvZ0ZpbGVQYXRoKTtcblxuICBpZiAoIWxvZ0ZpbGVFeGlzdHMpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSA9IGdldExvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlKCksXG4gICAgICAgIGxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlQ3VycmVudERhdGUgPSBpc0RhdGVDdXJyZW50RGF0ZShsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSk7XG5cbiAgaWYgKCFsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZUN1cnJlbnREYXRlKSB7XG4gICAgY29uc3Qgcm9sbGVkT3ZlckxvZ0ZpbGVQYXRoID0gZ2V0Um9sbGVkT3ZlckxvZ0ZpbGVQYXRoKCk7XG5cbiAgICByZW5hbWVGaWxlKGxvZ0ZpbGVQYXRoLCByb2xsZWRPdmVyTG9nRmlsZVBhdGgpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzRGF0ZUN1cnJlbnREYXRlKGRhdGUpIHtcbiAgY29uc3QgY3VycmVudERhdGUgPSBuZXcgRGF0ZSgpLFxuICAgICAgICBkYXRlU3RyaW5nID0gZGF0ZS50b0RhdGVTdHJpbmcoKSxcbiAgICAgICAgY3VycmVudERhdGVTdHJpbmcgPSBjdXJyZW50RGF0ZS50b0RhdGVTdHJpbmcoKSxcbiAgICAgICAgZGF0ZUN1cnJlbnREYXRlID0gKGRhdGVTdHJpbmcgPT09IGN1cnJlbnREYXRlU3RyaW5nKTtcblxuICByZXR1cm4gZGF0ZUN1cnJlbnREYXRlO1xufVxuXG5mdW5jdGlvbiBnZXRDdXJyZW50RGF0ZVN0cmluZygpIHtcbiAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCksXG4gICAgICAgIGRheSA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldERhdGUoKSwgMiksICAvLy9cbiAgICAgICAgbW9udGggPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRNb250aCgpICsgMSwgMiksIC8vL1xuICAgICAgICB5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpLFxuICAgICAgICBjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmcgPSBgJHtkYXl9LSR7bW9udGh9LSR7eWVhcn1gO1xuXG4gIHJldHVybiBjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmc7XG59XG5cbmZ1bmN0aW9uIGdldEN1cnJlbnREYXRlQW5kVGltZVN0cmluZygpIHtcbiAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCksXG4gICAgICAgIGRheSA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldERhdGUoKSwgMiksICAvLy9cbiAgICAgICAgbW9udGggPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRNb250aCgpICsgMSwgMiksIC8vL1xuICAgICAgICB5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpLFxuICAgICAgICBob3VycyA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldEhvdXJzKCksIDIpLFxuICAgICAgICBtaW51dGVzID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0TWludXRlcygpLCAyKSxcbiAgICAgICAgc2Vjb25kcyA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldFNlY29uZHMoKSwgMiksXG4gICAgICAgIG1pbGxpc2Vjb25kcyA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldE1pbGxpc2Vjb25kcygpLCAzKSxcbiAgICAgICAgY3VycmVudERhdGVBbmRUaW1lU3RyaW5nID0gYCR7ZGF5fS0ke21vbnRofS0ke3llYXJ9ICR7aG91cnN9OiR7bWludXRlc306JHtzZWNvbmRzfS4ke21pbGxpc2Vjb25kc31gO1xuXG4gIHJldHVybiBjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmc7XG59XG5cbmZ1bmN0aW9uIHN0YWNrTWVzc2FnZXNGcm9tU3RhY2soc3RhY2spIHtcbiAgY29uc3Qgc3RhY2tNZXNzYWdlcyA9IFtdLFxuICAgICAgICBzdGFja0xpbmVzID0gc3RhY2suc3BsaXQoL1xcclxcbnxcXG4vKTtcblxuICBsZXQgc3RhY2tNZXNzYWdlID0gXCJcIjtcblxuICBzdGFja0xpbmVzLmZvckVhY2goKHN0YWNrTGluZSkgPT4ge1xuICAgIGNvbnN0IG1hdGNoZXMgPSAvXlxccyphdC4qLy50ZXN0KHN0YWNrTGluZSk7XG5cbiAgICBzdGFja01lc3NhZ2UgPSAoc3RhY2tNZXNzYWdlID09PSBcIlwiKSA/XG4gICAgICAgICAgICAgICAgICAgICAgc3RhY2tMaW5lIDpcbiAgICAgICAgICAgICAgICAgICAgICAgIGAke3N0YWNrTWVzc2FnZX1cXG4ke3N0YWNrTGluZX1gO1xuXG4gICAgaWYgKG1hdGNoZXMpIHtcbiAgICAgIHN0YWNrTWVzc2FnZXMucHVzaChzdGFja01lc3NhZ2UpO1xuXG4gICAgICBzdGFja01lc3NhZ2UgPSBcIlwiO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHN0YWNrTWVzc2FnZXM7XG59XG5cbmZ1bmN0aW9uIGZpbGVQYXRoRnJvbVN0YWNrTWVzc2FnZShzdGFja01lc3NhZ2UpIHtcbiAgY29uc3QgbWF0Y2hlcyA9IHN0YWNrTWVzc2FnZS5tYXRjaCgvKFxcLy4rKTpcXGQrOlxcZCsvbSksXG4gICAgICAgIHNlY29uZE1hdGNoID0gc2Vjb25kKG1hdGNoZXMpLFxuICAgICAgICBhYnNvbHV0ZUZpbGVQYXRoID0gc2Vjb25kTWF0Y2gsICAvLy9cbiAgICAgICAgY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoID0gcGF0aC5yZXNvbHZlKFwiLlwiKSwgIC8vL1xuICAgICAgICBjdXJyZW50V29ya2luZ0RpcmVjdG9yeVBhdGhMZW5ndGggPSBjdXJyZW50V29ya2luZ0RpcmVjdG9yeVBhdGgubGVuZ3RoLFxuICAgICAgICBzdGFydCA9IGN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aExlbmd0aCArIDEsICAvLy9cbiAgICAgICAgZmlsZVBhdGggPSBhYnNvbHV0ZUZpbGVQYXRoLnN1YnN0cihzdGFydCk7XG5cbiAgcmV0dXJuIGZpbGVQYXRoO1xufVxuXG5mdW5jdGlvbiBsaW5lTnVtYmVyRnJvbVN0YWNrTWVzc2FnZShzdGFja01lc3NhZ2UpIHtcbiAgY29uc3QgbWF0Y2hlcyA9IHN0YWNrTWVzc2FnZS5tYXRjaCgvOihcXGQrKS9tKSxcbiAgICAgICAgc2Vjb25kTWF0Y2ggPSBzZWNvbmQobWF0Y2hlcyksXG4gICAgICAgIGxpbmVOdW1iZXIgPSBzZWNvbmRNYXRjaDsgLy8vXG5cbiAgcmV0dXJuIGxpbmVOdW1iZXI7XG59XG5cbmZ1bmN0aW9uIHBhZFN0YXJ0V2l0aFplcm9lcyhzdHJpbmcsIHRhcmdldExlbmd0aCkge1xuICBjb25zdCBwYWRTdHJpbmcgPSBcIjBcIixcbiAgICAgICAgcGFkZGVkU3RyaW5nID0gcGFkU3RhcnQoc3RyaW5nLCB0YXJnZXRMZW5ndGgsIHBhZFN0cmluZyk7XG5cbiAgcmV0dXJuIHBhZGRlZFN0cmluZztcbn1cblxuZnVuY3Rpb24gcGFkU3RhcnQoc3RyaW5nLCB0YXJnZXRMZW5ndGgsIHBhZFN0cmluZykge1xuICBsZXQgcGFkZGluZyA9IFwiXCI7XG5cbiAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHRhcmdldExlbmd0aDsgaW5kZXgrKykge1xuICAgIHBhZGRpbmcgKz0gcGFkU3RyaW5nO1xuICB9XG5cbiAgY29uc3QgcGFkZGVkU3RyaW5nID0gYCR7cGFkZGluZ30ke3N0cmluZ31gLnN1YnN0cigtdGFyZ2V0TGVuZ3RoKTtcblxuICByZXR1cm4gcGFkZGVkU3RyaW5nO1xufVxuIl19