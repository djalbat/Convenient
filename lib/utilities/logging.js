"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.log = log;
exports["default"] = void 0;

var _path = _interopRequireDefault(require("path"));

var _array = require("../utilities/array");

var _path2 = require("../utilities/path");

var _fileSystem = require("../utilities/fileSystem");

var _constants = require("../constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var levels = [_constants.TRACE, _constants.DEBUG, _constants.INFO, _constants.WARNING, _constants.ERROR, _constants.FATAL];
var logLevel = _constants.DEFAULT_LOG_LEVEL,
    logFileBaseName = _constants.DEFAULT_LOG_FILE_BASE_NAME,
    logDirectoryPath = _constants.DEFAULT_LOG_DIRECTORY_PATH;

function log(messageOrError) {
  var level = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : "";
  var salientStackMessageIndex = 1;

  if (level !== "") {
    var levelIndex = levels.indexOf(level),
        logLevelIndex = levels.indexOf(logLevel);

    if (levelIndex < logLevelIndex) {
      return;
    }

    salientStackMessageIndex += 1;
    level = "".concat(level, " "); ///
  }

  var error, message;

  if (messageOrError instanceof Error) {
    error = messageOrError; ///

    var _error = error;
    message = _error.message;
  } else {
    message = messageOrError; ///

    error = new Error(message);
  }

  var _error2 = error,
      stack = _error2.stack,
      stackMessages = stackMessagesFromStack(stack),
      pertinentStackMessage = stackMessages[salientStackMessageIndex],
      stackMessage = pertinentStackMessage,
      currentDateAndTimeString = getCurrentDateAndTimeString(),
      filePath = filePathFromStackMessage(stackMessage),
      lineNumber = lineNumberFromStackMessage(stackMessage),
      logMessage = "".concat(level).concat(currentDateAndTimeString, " ").concat(filePath, "(").concat(lineNumber, ") ").concat(message);
  console.log(logMessage);

  if (logDirectoryPath !== null) {
    rollOverLogFile();
    var logFilePath = getLogFilePath(),
        logFileContent = "".concat(logMessage, "\n");
    (0, _fileSystem.appendToFile)(logFilePath, logFileContent);
  }

  return logMessage;
}

var _default = {
  log: log
};
exports["default"] = _default;

function trace(message) {
  return log(message, _constants.TRACE);
}

function debug(message) {
  return log(message, _constants.DEBUG);
}

function info(message) {
  return log(message, _constants.INFO);
}

function warning(message) {
  return log(message, _constants.WARNING);
}

function error(message) {
  return log(message, _constants.ERROR);
}

function fatal(message) {
  return log(message, _constants.FATAL);
}

function setLogLevel(level) {
  logLevel = level;
}

function setLogFileBaseName(fileBaseName) {
  logFileBaseName = fileBaseName;
}

function setLogDirectoryPath(directoryPath) {
  logDirectoryPath = directoryPath;
}

function setLogOptions(logOptions) {
  var level = logOptions.level,
      fileBaseName = logOptions.fileBaseName,
      directoryPath = logOptions.directoryPath;
  setLogLevel(level);
  setLogFileBaseName(fileBaseName);
  setLogDirectoryPath(directoryPath);
}

function getLogFileContent() {
  var logFilePath = getLogFilePath(),
      logFileContent = (0, _fileSystem.readFile)(logFilePath);
  return logFileContent;
}

Object.assign(log, {
  TRACE: _constants.TRACE,
  DEBUG: _constants.DEBUG,
  INFO: _constants.INFO,
  WARNING: _constants.WARNING,
  ERROR: _constants.ERROR,
  FATAL: _constants.FATAL,
  trace: trace,
  debug: debug,
  info: info,
  warning: warning,
  error: error,
  fatal: fatal,
  setLogLevel: setLogLevel,
  setLogFileBaseName: setLogFileBaseName,
  setLogDirectoryPath: setLogDirectoryPath,
  setLogOptions: setLogOptions,
  getLogFileContent: getLogFileContent
});

function getLogFilePath() {
  var logFileName = "".concat(logFileBaseName, ".log"),
      logFilePath = (0, _path2.concatenatePaths)(logDirectoryPath, logFileName);
  return logFilePath;
}

function getRolledOverLogFilePath() {
  var currentDateString = getCurrentDateString(),
      rolledOverLogFileName = "".concat(logFileBaseName, ".").concat(currentDateString, ".log"),
      rolledOverLogFilePath = (0, _path2.concatenatePaths)(logDirectoryPath, rolledOverLogFileName);
  return rolledOverLogFilePath;
}

function getLogFileLastModifiedDate() {
  var logFilePath = getLogFilePath(),
      logFileStats = (0, _fileSystem.getStats)(logFilePath),
      mtime = logFileStats.mtime,
      logFileLastModifiedDate = new Date(mtime); ///

  return logFileLastModifiedDate;
}

function rollOverLogFile() {
  var logFilePath = getLogFilePath(),
      logFileExists = (0, _fileSystem.checkFileExists)(logFilePath);

  if (!logFileExists) {
    return;
  }

  var logFileLastModifiedDate = getLogFileLastModifiedDate(),
      logFileLastModifiedDateCurrentDate = isDateCurrentDate(logFileLastModifiedDate);

  if (!logFileLastModifiedDateCurrentDate) {
    var rolledOverLogFilePath = getRolledOverLogFilePath();
    (0, _fileSystem.renameFile)(logFilePath, rolledOverLogFilePath);
  }
}

function isDateCurrentDate(date) {
  var currentDate = new Date(),
      dateString = date.toDateString(),
      currentDateString = currentDate.toDateString(),
      dateCurrentDate = dateString === currentDateString;
  return dateCurrentDate;
}

function getCurrentDateString() {
  var date = new Date(),
      day = padStartWithZeroes(date.getDate(), 2),
      ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
      ///
  year = date.getFullYear(),
      currentDateAndTimeString = "".concat(day, "-").concat(month, "-").concat(year);
  return currentDateAndTimeString;
}

function getCurrentDateAndTimeString() {
  var date = new Date(),
      day = padStartWithZeroes(date.getDate(), 2),
      ///
  month = padStartWithZeroes(date.getMonth() + 1, 2),
      ///
  year = date.getFullYear(),
      hours = padStartWithZeroes(date.getHours(), 2),
      minutes = padStartWithZeroes(date.getMinutes(), 2),
      seconds = padStartWithZeroes(date.getSeconds(), 2),
      milliseconds = padStartWithZeroes(date.getMilliseconds(), 3),
      currentDateAndTimeString = "".concat(day, "-").concat(month, "-").concat(year, " ").concat(hours, ":").concat(minutes, ":").concat(seconds, ".").concat(milliseconds);
  return currentDateAndTimeString;
}

function stackMessagesFromStack(stack) {
  var stackMessages = [],
      stackLines = stack.split(/\r\n|\n/);
  var stackMessage = "";
  stackLines.forEach(function (stackLine) {
    var matches = /^\s*at.*/.test(stackLine);
    stackMessage = stackMessage === "" ? stackLine : "".concat(stackMessage, "\n").concat(stackLine);

    if (matches) {
      stackMessages.push(stackMessage);
      stackMessage = "";
    }
  });
  return stackMessages;
}

function filePathFromStackMessage(stackMessage) {
  var matches = stackMessage.match(/(\/.+):\d+:\d+/m),
      secondMatch = (0, _array.second)(matches),
      absoluteFilePath = secondMatch,
      ///
  currentWorkingDirectoryPath = _path["default"].resolve("."),
      ///
  currentWorkingDirectoryPathLength = currentWorkingDirectoryPath.length,
      start = currentWorkingDirectoryPathLength + 1,
      ///
  filePath = absoluteFilePath.substr(start);

  return filePath;
}

function lineNumberFromStackMessage(stackMessage) {
  var matches = stackMessage.match(/:(\d+)/m),
      secondMatch = (0, _array.second)(matches),
      lineNumber = secondMatch; ///

  return lineNumber;
}

function padStartWithZeroes(string, targetLength) {
  var padString = "0",
      paddedString = padStart(string, targetLength, padString);
  return paddedString;
}

function padStart(string, targetLength, padString) {
  var padding = "";

  for (var index = 0; index < targetLength; index++) {
    padding += padString;
  }

  var paddedString = "".concat(padding).concat(string).substr(-targetLength);
  return paddedString;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvbG9nZ2luZy5qcyJdLCJuYW1lcyI6WyJsZXZlbHMiLCJUUkFDRSIsIkRFQlVHIiwiSU5GTyIsIldBUk5JTkciLCJFUlJPUiIsIkZBVEFMIiwibG9nTGV2ZWwiLCJERUZBVUxUX0xPR19MRVZFTCIsImxvZ0ZpbGVCYXNlTmFtZSIsIkRFRkFVTFRfTE9HX0ZJTEVfQkFTRV9OQU1FIiwibG9nRGlyZWN0b3J5UGF0aCIsIkRFRkFVTFRfTE9HX0RJUkVDVE9SWV9QQVRIIiwibG9nIiwibWVzc2FnZU9yRXJyb3IiLCJsZXZlbCIsInNhbGllbnRTdGFja01lc3NhZ2VJbmRleCIsImxldmVsSW5kZXgiLCJpbmRleE9mIiwibG9nTGV2ZWxJbmRleCIsImVycm9yIiwibWVzc2FnZSIsIkVycm9yIiwic3RhY2siLCJzdGFja01lc3NhZ2VzIiwic3RhY2tNZXNzYWdlc0Zyb21TdGFjayIsInBlcnRpbmVudFN0YWNrTWVzc2FnZSIsInN0YWNrTWVzc2FnZSIsImN1cnJlbnREYXRlQW5kVGltZVN0cmluZyIsImdldEN1cnJlbnREYXRlQW5kVGltZVN0cmluZyIsImZpbGVQYXRoIiwiZmlsZVBhdGhGcm9tU3RhY2tNZXNzYWdlIiwibGluZU51bWJlciIsImxpbmVOdW1iZXJGcm9tU3RhY2tNZXNzYWdlIiwibG9nTWVzc2FnZSIsImNvbnNvbGUiLCJyb2xsT3ZlckxvZ0ZpbGUiLCJsb2dGaWxlUGF0aCIsImdldExvZ0ZpbGVQYXRoIiwibG9nRmlsZUNvbnRlbnQiLCJ0cmFjZSIsImRlYnVnIiwiaW5mbyIsIndhcm5pbmciLCJmYXRhbCIsInNldExvZ0xldmVsIiwic2V0TG9nRmlsZUJhc2VOYW1lIiwiZmlsZUJhc2VOYW1lIiwic2V0TG9nRGlyZWN0b3J5UGF0aCIsImRpcmVjdG9yeVBhdGgiLCJzZXRMb2dPcHRpb25zIiwibG9nT3B0aW9ucyIsImdldExvZ0ZpbGVDb250ZW50IiwiT2JqZWN0IiwiYXNzaWduIiwibG9nRmlsZU5hbWUiLCJnZXRSb2xsZWRPdmVyTG9nRmlsZVBhdGgiLCJjdXJyZW50RGF0ZVN0cmluZyIsImdldEN1cnJlbnREYXRlU3RyaW5nIiwicm9sbGVkT3ZlckxvZ0ZpbGVOYW1lIiwicm9sbGVkT3ZlckxvZ0ZpbGVQYXRoIiwiZ2V0TG9nRmlsZUxhc3RNb2RpZmllZERhdGUiLCJsb2dGaWxlU3RhdHMiLCJtdGltZSIsImxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlIiwiRGF0ZSIsImxvZ0ZpbGVFeGlzdHMiLCJsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZUN1cnJlbnREYXRlIiwiaXNEYXRlQ3VycmVudERhdGUiLCJkYXRlIiwiY3VycmVudERhdGUiLCJkYXRlU3RyaW5nIiwidG9EYXRlU3RyaW5nIiwiZGF0ZUN1cnJlbnREYXRlIiwiZGF5IiwicGFkU3RhcnRXaXRoWmVyb2VzIiwiZ2V0RGF0ZSIsIm1vbnRoIiwiZ2V0TW9udGgiLCJ5ZWFyIiwiZ2V0RnVsbFllYXIiLCJob3VycyIsImdldEhvdXJzIiwibWludXRlcyIsImdldE1pbnV0ZXMiLCJzZWNvbmRzIiwiZ2V0U2Vjb25kcyIsIm1pbGxpc2Vjb25kcyIsImdldE1pbGxpc2Vjb25kcyIsInN0YWNrTGluZXMiLCJzcGxpdCIsImZvckVhY2giLCJzdGFja0xpbmUiLCJtYXRjaGVzIiwidGVzdCIsInB1c2giLCJtYXRjaCIsInNlY29uZE1hdGNoIiwiYWJzb2x1dGVGaWxlUGF0aCIsImN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aCIsInBhdGgiLCJyZXNvbHZlIiwiY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoTGVuZ3RoIiwibGVuZ3RoIiwic3RhcnQiLCJzdWJzdHIiLCJzdHJpbmciLCJ0YXJnZXRMZW5ndGgiLCJwYWRTdHJpbmciLCJwYWRkZWRTdHJpbmciLCJwYWRTdGFydCIsInBhZGRpbmciLCJpbmRleCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxJQUFNQSxNQUFNLEdBQUcsQ0FDYkMsZ0JBRGEsRUFFYkMsZ0JBRmEsRUFHYkMsZUFIYSxFQUliQyxrQkFKYSxFQUtiQyxnQkFMYSxFQU1iQyxnQkFOYSxDQUFmO0FBU0EsSUFBSUMsUUFBUSxHQUFHQyw0QkFBZjtBQUFBLElBQ0lDLGVBQWUsR0FBR0MscUNBRHRCO0FBQUEsSUFFSUMsZ0JBQWdCLEdBQUdDLHFDQUZ2Qjs7QUFJTyxTQUFTQyxHQUFULENBQWFDLGNBQWIsRUFBeUM7QUFBQSxNQUFaQyxLQUFZLHVFQUFKLEVBQUk7QUFDOUMsTUFBSUMsd0JBQXdCLEdBQUcsQ0FBL0I7O0FBRUEsTUFBSUQsS0FBSyxLQUFLLEVBQWQsRUFBa0I7QUFDaEIsUUFBTUUsVUFBVSxHQUFHakIsTUFBTSxDQUFDa0IsT0FBUCxDQUFlSCxLQUFmLENBQW5CO0FBQUEsUUFDTUksYUFBYSxHQUFHbkIsTUFBTSxDQUFDa0IsT0FBUCxDQUFlWCxRQUFmLENBRHRCOztBQUdBLFFBQUlVLFVBQVUsR0FBR0UsYUFBakIsRUFBZ0M7QUFDOUI7QUFDRDs7QUFFREgsSUFBQUEsd0JBQXdCLElBQUksQ0FBNUI7QUFFQUQsSUFBQUEsS0FBSyxhQUFNQSxLQUFOLE1BQUwsQ0FWZ0IsQ0FVTTtBQUN2Qjs7QUFFRCxNQUFJSyxLQUFKLEVBQ0lDLE9BREo7O0FBR0EsTUFBSVAsY0FBYyxZQUFZUSxLQUE5QixFQUFxQztBQUNuQ0YsSUFBQUEsS0FBSyxHQUFHTixjQUFSLENBRG1DLENBQ1g7O0FBRFcsaUJBR3BCTSxLQUhvQjtBQUdoQ0MsSUFBQUEsT0FIZ0MsVUFHaENBLE9BSGdDO0FBSXBDLEdBSkQsTUFJTztBQUNMQSxJQUFBQSxPQUFPLEdBQUdQLGNBQVYsQ0FESyxDQUNxQjs7QUFFMUJNLElBQUFBLEtBQUssR0FBRyxJQUFJRSxLQUFKLENBQVVELE9BQVYsQ0FBUjtBQUNEOztBQTNCNkMsZ0JBNkI1QkQsS0E3QjRCO0FBQUEsTUE2QnRDRyxLQTdCc0MsV0E2QnRDQSxLQTdCc0M7QUFBQSxNQThCeENDLGFBOUJ3QyxHQThCeEJDLHNCQUFzQixDQUFDRixLQUFELENBOUJFO0FBQUEsTUErQnhDRyxxQkEvQndDLEdBK0JoQkYsYUFBYSxDQUFDUix3QkFBRCxDQS9CRztBQUFBLE1BZ0N4Q1csWUFoQ3dDLEdBZ0N6QkQscUJBaEN5QjtBQUFBLE1BaUN4Q0Usd0JBakN3QyxHQWlDYkMsMkJBQTJCLEVBakNkO0FBQUEsTUFrQ3hDQyxRQWxDd0MsR0FrQzdCQyx3QkFBd0IsQ0FBQ0osWUFBRCxDQWxDSztBQUFBLE1BbUN4Q0ssVUFuQ3dDLEdBbUMzQkMsMEJBQTBCLENBQUNOLFlBQUQsQ0FuQ0M7QUFBQSxNQW9DeENPLFVBcEN3QyxhQW9DeEJuQixLQXBDd0IsU0FvQ2hCYSx3QkFwQ2dCLGNBb0NZRSxRQXBDWixjQW9Dd0JFLFVBcEN4QixlQW9DdUNYLE9BcEN2QztBQXNDOUNjLEVBQUFBLE9BQU8sQ0FBQ3RCLEdBQVIsQ0FBWXFCLFVBQVo7O0FBRUEsTUFBSXZCLGdCQUFnQixLQUFLLElBQXpCLEVBQStCO0FBQzdCeUIsSUFBQUEsZUFBZTtBQUVmLFFBQU1DLFdBQVcsR0FBR0MsY0FBYyxFQUFsQztBQUFBLFFBQ01DLGNBQWMsYUFBTUwsVUFBTixPQURwQjtBQUdBLGtDQUFhRyxXQUFiLEVBQTBCRSxjQUExQjtBQUNEOztBQUVELFNBQU9MLFVBQVA7QUFDRDs7ZUFFYztBQUNickIsRUFBQUEsR0FBRyxFQUFIQTtBQURhLEM7OztBQUlmLFNBQVMyQixLQUFULENBQWVuQixPQUFmLEVBQXdCO0FBQUUsU0FBT1IsR0FBRyxDQUFDUSxPQUFELEVBQVVwQixnQkFBVixDQUFWO0FBQTZCOztBQUV2RCxTQUFTd0MsS0FBVCxDQUFlcEIsT0FBZixFQUF3QjtBQUFFLFNBQU9SLEdBQUcsQ0FBQ1EsT0FBRCxFQUFVbkIsZ0JBQVYsQ0FBVjtBQUE2Qjs7QUFFdkQsU0FBU3dDLElBQVQsQ0FBY3JCLE9BQWQsRUFBdUI7QUFBRSxTQUFPUixHQUFHLENBQUNRLE9BQUQsRUFBVWxCLGVBQVYsQ0FBVjtBQUE0Qjs7QUFFckQsU0FBU3dDLE9BQVQsQ0FBaUJ0QixPQUFqQixFQUEwQjtBQUFFLFNBQU9SLEdBQUcsQ0FBQ1EsT0FBRCxFQUFVakIsa0JBQVYsQ0FBVjtBQUErQjs7QUFFM0QsU0FBU2dCLEtBQVQsQ0FBZUMsT0FBZixFQUF3QjtBQUFFLFNBQU9SLEdBQUcsQ0FBQ1EsT0FBRCxFQUFVaEIsZ0JBQVYsQ0FBVjtBQUE2Qjs7QUFFdkQsU0FBU3VDLEtBQVQsQ0FBZXZCLE9BQWYsRUFBd0I7QUFBRSxTQUFPUixHQUFHLENBQUNRLE9BQUQsRUFBVWYsZ0JBQVYsQ0FBVjtBQUE2Qjs7QUFFdkQsU0FBU3VDLFdBQVQsQ0FBcUI5QixLQUFyQixFQUE0QjtBQUFFUixFQUFBQSxRQUFRLEdBQUdRLEtBQVg7QUFBbUI7O0FBRWpELFNBQVMrQixrQkFBVCxDQUE0QkMsWUFBNUIsRUFBMEM7QUFBRXRDLEVBQUFBLGVBQWUsR0FBR3NDLFlBQWxCO0FBQWlDOztBQUU3RSxTQUFTQyxtQkFBVCxDQUE2QkMsYUFBN0IsRUFBNEM7QUFBRXRDLEVBQUFBLGdCQUFnQixHQUFHc0MsYUFBbkI7QUFBbUM7O0FBRWpGLFNBQVNDLGFBQVQsQ0FBdUJDLFVBQXZCLEVBQW1DO0FBQUEsTUFDekJwQyxLQUR5QixHQUNjb0MsVUFEZCxDQUN6QnBDLEtBRHlCO0FBQUEsTUFDbEJnQyxZQURrQixHQUNjSSxVQURkLENBQ2xCSixZQURrQjtBQUFBLE1BQ0pFLGFBREksR0FDY0UsVUFEZCxDQUNKRixhQURJO0FBR2pDSixFQUFBQSxXQUFXLENBQUM5QixLQUFELENBQVg7QUFFQStCLEVBQUFBLGtCQUFrQixDQUFDQyxZQUFELENBQWxCO0FBRUFDLEVBQUFBLG1CQUFtQixDQUFDQyxhQUFELENBQW5CO0FBQ0Q7O0FBRUQsU0FBU0csaUJBQVQsR0FBNkI7QUFDM0IsTUFBTWYsV0FBVyxHQUFHQyxjQUFjLEVBQWxDO0FBQUEsTUFDTUMsY0FBYyxHQUFHLDBCQUFTRixXQUFULENBRHZCO0FBR0EsU0FBT0UsY0FBUDtBQUNEOztBQUVEYyxNQUFNLENBQUNDLE1BQVAsQ0FBY3pDLEdBQWQsRUFBbUI7QUFDakJaLEVBQUFBLEtBQUssRUFBTEEsZ0JBRGlCO0FBRWpCQyxFQUFBQSxLQUFLLEVBQUxBLGdCQUZpQjtBQUdqQkMsRUFBQUEsSUFBSSxFQUFKQSxlQUhpQjtBQUlqQkMsRUFBQUEsT0FBTyxFQUFQQSxrQkFKaUI7QUFLakJDLEVBQUFBLEtBQUssRUFBTEEsZ0JBTGlCO0FBTWpCQyxFQUFBQSxLQUFLLEVBQUxBLGdCQU5pQjtBQU9qQmtDLEVBQUFBLEtBQUssRUFBTEEsS0FQaUI7QUFRakJDLEVBQUFBLEtBQUssRUFBTEEsS0FSaUI7QUFTakJDLEVBQUFBLElBQUksRUFBSkEsSUFUaUI7QUFVakJDLEVBQUFBLE9BQU8sRUFBUEEsT0FWaUI7QUFXakJ2QixFQUFBQSxLQUFLLEVBQUxBLEtBWGlCO0FBWWpCd0IsRUFBQUEsS0FBSyxFQUFMQSxLQVppQjtBQWFqQkMsRUFBQUEsV0FBVyxFQUFYQSxXQWJpQjtBQWNqQkMsRUFBQUEsa0JBQWtCLEVBQWxCQSxrQkFkaUI7QUFlakJFLEVBQUFBLG1CQUFtQixFQUFuQkEsbUJBZmlCO0FBZ0JqQkUsRUFBQUEsYUFBYSxFQUFiQSxhQWhCaUI7QUFpQmpCRSxFQUFBQSxpQkFBaUIsRUFBakJBO0FBakJpQixDQUFuQjs7QUFvQkEsU0FBU2QsY0FBVCxHQUEwQjtBQUN4QixNQUFNaUIsV0FBVyxhQUFNOUMsZUFBTixTQUFqQjtBQUFBLE1BQ000QixXQUFXLEdBQUcsNkJBQWlCMUIsZ0JBQWpCLEVBQW1DNEMsV0FBbkMsQ0FEcEI7QUFHQSxTQUFPbEIsV0FBUDtBQUNEOztBQUVELFNBQVNtQix3QkFBVCxHQUFvQztBQUNsQyxNQUFNQyxpQkFBaUIsR0FBR0Msb0JBQW9CLEVBQTlDO0FBQUEsTUFDTUMscUJBQXFCLGFBQU1sRCxlQUFOLGNBQXlCZ0QsaUJBQXpCLFNBRDNCO0FBQUEsTUFFTUcscUJBQXFCLEdBQUcsNkJBQWlCakQsZ0JBQWpCLEVBQW1DZ0QscUJBQW5DLENBRjlCO0FBSUEsU0FBT0MscUJBQVA7QUFDRDs7QUFFRCxTQUFTQywwQkFBVCxHQUFzQztBQUM5QixNQUFBeEIsV0FBVyxHQUFHQyxjQUFjLEVBQTVCO0FBQUEsTUFDQXdCLFlBREEsR0FDZSwwQkFBU3pCLFdBQVQsQ0FEZjtBQUFBLE1BRUUwQixLQUZGLEdBRVlELFlBRlosQ0FFRUMsS0FGRjtBQUFBLE1BR0FDLHVCQUhBLEdBRzBCLElBQUlDLElBQUosQ0FBU0YsS0FBVCxDQUgxQixDQUQ4QixDQUljOztBQUVsRCxTQUFPQyx1QkFBUDtBQUNEOztBQUVELFNBQVM1QixlQUFULEdBQTJCO0FBQ3pCLE1BQU1DLFdBQVcsR0FBR0MsY0FBYyxFQUFsQztBQUFBLE1BQ000QixhQUFhLEdBQUcsaUNBQWdCN0IsV0FBaEIsQ0FEdEI7O0FBR0EsTUFBSSxDQUFDNkIsYUFBTCxFQUFvQjtBQUNsQjtBQUNEOztBQUVELE1BQU1GLHVCQUF1QixHQUFHSCwwQkFBMEIsRUFBMUQ7QUFBQSxNQUNNTSxrQ0FBa0MsR0FBR0MsaUJBQWlCLENBQUNKLHVCQUFELENBRDVEOztBQUdBLE1BQUksQ0FBQ0csa0NBQUwsRUFBeUM7QUFDdkMsUUFBTVAscUJBQXFCLEdBQUdKLHdCQUF3QixFQUF0RDtBQUVBLGdDQUFXbkIsV0FBWCxFQUF3QnVCLHFCQUF4QjtBQUNEO0FBQ0Y7O0FBRUQsU0FBU1EsaUJBQVQsQ0FBMkJDLElBQTNCLEVBQWlDO0FBQy9CLE1BQU1DLFdBQVcsR0FBRyxJQUFJTCxJQUFKLEVBQXBCO0FBQUEsTUFDTU0sVUFBVSxHQUFHRixJQUFJLENBQUNHLFlBQUwsRUFEbkI7QUFBQSxNQUVNZixpQkFBaUIsR0FBR2EsV0FBVyxDQUFDRSxZQUFaLEVBRjFCO0FBQUEsTUFHTUMsZUFBZSxHQUFJRixVQUFVLEtBQUtkLGlCQUh4QztBQUtBLFNBQU9nQixlQUFQO0FBQ0Q7O0FBRUQsU0FBU2Ysb0JBQVQsR0FBZ0M7QUFDOUIsTUFBTVcsSUFBSSxHQUFHLElBQUlKLElBQUosRUFBYjtBQUFBLE1BQ01TLEdBQUcsR0FBR0Msa0JBQWtCLENBQUNOLElBQUksQ0FBQ08sT0FBTCxFQUFELEVBQWlCLENBQWpCLENBRDlCO0FBQUEsTUFDb0Q7QUFDOUNDLEVBQUFBLEtBQUssR0FBR0Ysa0JBQWtCLENBQUNOLElBQUksQ0FBQ1MsUUFBTCxLQUFrQixDQUFuQixFQUFzQixDQUF0QixDQUZoQztBQUFBLE1BRTBEO0FBQ3BEQyxFQUFBQSxJQUFJLEdBQUdWLElBQUksQ0FBQ1csV0FBTCxFQUhiO0FBQUEsTUFJTXBELHdCQUF3QixhQUFNOEMsR0FBTixjQUFhRyxLQUFiLGNBQXNCRSxJQUF0QixDQUo5QjtBQU1BLFNBQU9uRCx3QkFBUDtBQUNEOztBQUVELFNBQVNDLDJCQUFULEdBQXVDO0FBQ3JDLE1BQU13QyxJQUFJLEdBQUcsSUFBSUosSUFBSixFQUFiO0FBQUEsTUFDTVMsR0FBRyxHQUFHQyxrQkFBa0IsQ0FBQ04sSUFBSSxDQUFDTyxPQUFMLEVBQUQsRUFBaUIsQ0FBakIsQ0FEOUI7QUFBQSxNQUNvRDtBQUM5Q0MsRUFBQUEsS0FBSyxHQUFHRixrQkFBa0IsQ0FBQ04sSUFBSSxDQUFDUyxRQUFMLEtBQWtCLENBQW5CLEVBQXNCLENBQXRCLENBRmhDO0FBQUEsTUFFMEQ7QUFDcERDLEVBQUFBLElBQUksR0FBR1YsSUFBSSxDQUFDVyxXQUFMLEVBSGI7QUFBQSxNQUlNQyxLQUFLLEdBQUdOLGtCQUFrQixDQUFDTixJQUFJLENBQUNhLFFBQUwsRUFBRCxFQUFrQixDQUFsQixDQUpoQztBQUFBLE1BS01DLE9BQU8sR0FBR1Isa0JBQWtCLENBQUNOLElBQUksQ0FBQ2UsVUFBTCxFQUFELEVBQW9CLENBQXBCLENBTGxDO0FBQUEsTUFNTUMsT0FBTyxHQUFHVixrQkFBa0IsQ0FBQ04sSUFBSSxDQUFDaUIsVUFBTCxFQUFELEVBQW9CLENBQXBCLENBTmxDO0FBQUEsTUFPTUMsWUFBWSxHQUFHWixrQkFBa0IsQ0FBQ04sSUFBSSxDQUFDbUIsZUFBTCxFQUFELEVBQXlCLENBQXpCLENBUHZDO0FBQUEsTUFRTTVELHdCQUF3QixhQUFNOEMsR0FBTixjQUFhRyxLQUFiLGNBQXNCRSxJQUF0QixjQUE4QkUsS0FBOUIsY0FBdUNFLE9BQXZDLGNBQWtERSxPQUFsRCxjQUE2REUsWUFBN0QsQ0FSOUI7QUFVQSxTQUFPM0Qsd0JBQVA7QUFDRDs7QUFFRCxTQUFTSCxzQkFBVCxDQUFnQ0YsS0FBaEMsRUFBdUM7QUFDckMsTUFBTUMsYUFBYSxHQUFHLEVBQXRCO0FBQUEsTUFDTWlFLFVBQVUsR0FBR2xFLEtBQUssQ0FBQ21FLEtBQU4sQ0FBWSxTQUFaLENBRG5CO0FBR0EsTUFBSS9ELFlBQVksR0FBRyxFQUFuQjtBQUVBOEQsRUFBQUEsVUFBVSxDQUFDRSxPQUFYLENBQW1CLFVBQUNDLFNBQUQsRUFBZTtBQUNoQyxRQUFNQyxPQUFPLEdBQUcsV0FBV0MsSUFBWCxDQUFnQkYsU0FBaEIsQ0FBaEI7QUFFQWpFLElBQUFBLFlBQVksR0FBSUEsWUFBWSxLQUFLLEVBQWxCLEdBQ0dpRSxTQURILGFBRVFqRSxZQUZSLGVBRXlCaUUsU0FGekIsQ0FBZjs7QUFJQSxRQUFJQyxPQUFKLEVBQWE7QUFDWHJFLE1BQUFBLGFBQWEsQ0FBQ3VFLElBQWQsQ0FBbUJwRSxZQUFuQjtBQUVBQSxNQUFBQSxZQUFZLEdBQUcsRUFBZjtBQUNEO0FBQ0YsR0FaRDtBQWNBLFNBQU9ILGFBQVA7QUFDRDs7QUFFRCxTQUFTTyx3QkFBVCxDQUFrQ0osWUFBbEMsRUFBZ0Q7QUFDOUMsTUFBTWtFLE9BQU8sR0FBR2xFLFlBQVksQ0FBQ3FFLEtBQWIsQ0FBbUIsaUJBQW5CLENBQWhCO0FBQUEsTUFDTUMsV0FBVyxHQUFHLG1CQUFPSixPQUFQLENBRHBCO0FBQUEsTUFFTUssZ0JBQWdCLEdBQUdELFdBRnpCO0FBQUEsTUFFdUM7QUFDakNFLEVBQUFBLDJCQUEyQixHQUFHQyxpQkFBS0MsT0FBTCxDQUFhLEdBQWIsQ0FIcEM7QUFBQSxNQUd3RDtBQUNsREMsRUFBQUEsaUNBQWlDLEdBQUdILDJCQUEyQixDQUFDSSxNQUp0RTtBQUFBLE1BS01DLEtBQUssR0FBR0YsaUNBQWlDLEdBQUcsQ0FMbEQ7QUFBQSxNQUtzRDtBQUNoRHhFLEVBQUFBLFFBQVEsR0FBR29FLGdCQUFnQixDQUFDTyxNQUFqQixDQUF3QkQsS0FBeEIsQ0FOakI7O0FBUUEsU0FBTzFFLFFBQVA7QUFDRDs7QUFFRCxTQUFTRywwQkFBVCxDQUFvQ04sWUFBcEMsRUFBa0Q7QUFDaEQsTUFBTWtFLE9BQU8sR0FBR2xFLFlBQVksQ0FBQ3FFLEtBQWIsQ0FBbUIsU0FBbkIsQ0FBaEI7QUFBQSxNQUNNQyxXQUFXLEdBQUcsbUJBQU9KLE9BQVAsQ0FEcEI7QUFBQSxNQUVNN0QsVUFBVSxHQUFHaUUsV0FGbkIsQ0FEZ0QsQ0FHaEI7O0FBRWhDLFNBQU9qRSxVQUFQO0FBQ0Q7O0FBRUQsU0FBUzJDLGtCQUFULENBQTRCK0IsTUFBNUIsRUFBb0NDLFlBQXBDLEVBQWtEO0FBQ2hELE1BQU1DLFNBQVMsR0FBRyxHQUFsQjtBQUFBLE1BQ01DLFlBQVksR0FBR0MsUUFBUSxDQUFDSixNQUFELEVBQVNDLFlBQVQsRUFBdUJDLFNBQXZCLENBRDdCO0FBR0EsU0FBT0MsWUFBUDtBQUNEOztBQUVELFNBQVNDLFFBQVQsQ0FBa0JKLE1BQWxCLEVBQTBCQyxZQUExQixFQUF3Q0MsU0FBeEMsRUFBbUQ7QUFDakQsTUFBSUcsT0FBTyxHQUFHLEVBQWQ7O0FBRUEsT0FBSyxJQUFJQyxLQUFLLEdBQUcsQ0FBakIsRUFBb0JBLEtBQUssR0FBR0wsWUFBNUIsRUFBMENLLEtBQUssRUFBL0MsRUFBbUQ7QUFDakRELElBQUFBLE9BQU8sSUFBSUgsU0FBWDtBQUNEOztBQUVELE1BQU1DLFlBQVksR0FBRyxVQUFHRSxPQUFILFNBQWFMLE1BQWIsRUFBc0JELE1BQXRCLENBQTZCLENBQUNFLFlBQTlCLENBQXJCO0FBRUEsU0FBT0UsWUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5cbmltcG9ydCB7IHNlY29uZCB9IGZyb20gXCIuLi91dGlsaXRpZXMvYXJyYXlcIjtcbmltcG9ydCB7IGNvbmNhdGVuYXRlUGF0aHMgfSBmcm9tIFwiLi4vdXRpbGl0aWVzL3BhdGhcIjtcbmltcG9ydCB7IGNoZWNrRmlsZUV4aXN0cywgcmVhZEZpbGUsIGFwcGVuZFRvRmlsZSwgcmVuYW1lRmlsZSwgZ2V0U3RhdHMgfSBmcm9tIFwiLi4vdXRpbGl0aWVzL2ZpbGVTeXN0ZW1cIjtcbmltcG9ydCB7IFRSQUNFLCBERUJVRywgSU5GTywgV0FSTklORywgRVJST1IsIEZBVEFMLCBERUZBVUxUX0xPR19MRVZFTCwgREVGQVVMVF9MT0dfRklMRV9CQVNFX05BTUUsIERFRkFVTFRfTE9HX0RJUkVDVE9SWV9QQVRIIH0gZnJvbSBcIi4uL2NvbnN0YW50c1wiO1xuXG5jb25zdCBsZXZlbHMgPSBbXG4gIFRSQUNFLFxuICBERUJVRyxcbiAgSU5GTyxcbiAgV0FSTklORyxcbiAgRVJST1IsXG4gIEZBVEFMLFxuXTtcblxubGV0IGxvZ0xldmVsID0gREVGQVVMVF9MT0dfTEVWRUwsXG4gICAgbG9nRmlsZUJhc2VOYW1lID0gREVGQVVMVF9MT0dfRklMRV9CQVNFX05BTUUsXG4gICAgbG9nRGlyZWN0b3J5UGF0aCA9IERFRkFVTFRfTE9HX0RJUkVDVE9SWV9QQVRIO1xuXG5leHBvcnQgZnVuY3Rpb24gbG9nKG1lc3NhZ2VPckVycm9yLCBsZXZlbCA9IFwiXCIpIHtcbiAgbGV0IHNhbGllbnRTdGFja01lc3NhZ2VJbmRleCA9IDE7XG5cbiAgaWYgKGxldmVsICE9PSBcIlwiKSB7XG4gICAgY29uc3QgbGV2ZWxJbmRleCA9IGxldmVscy5pbmRleE9mKGxldmVsKSxcbiAgICAgICAgICBsb2dMZXZlbEluZGV4ID0gbGV2ZWxzLmluZGV4T2YobG9nTGV2ZWwpO1xuXG4gICAgaWYgKGxldmVsSW5kZXggPCBsb2dMZXZlbEluZGV4KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgc2FsaWVudFN0YWNrTWVzc2FnZUluZGV4ICs9IDE7XG5cbiAgICBsZXZlbCA9IGAke2xldmVsfSBgOyAgLy8vXG4gIH1cblxuICBsZXQgZXJyb3IsXG4gICAgICBtZXNzYWdlO1xuXG4gIGlmIChtZXNzYWdlT3JFcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgZXJyb3IgPSBtZXNzYWdlT3JFcnJvcjsgLy8vXG5cbiAgICAoeyBtZXNzYWdlIH0gPSBlcnJvcik7XG4gIH0gZWxzZSB7XG4gICAgbWVzc2FnZSA9IG1lc3NhZ2VPckVycm9yOyAvLy9cblxuICAgIGVycm9yID0gbmV3IEVycm9yKG1lc3NhZ2UpO1xuICB9XG5cbiAgY29uc3QgeyBzdGFjayB9ID0gZXJyb3IsXG4gICAgICAgIHN0YWNrTWVzc2FnZXMgPSBzdGFja01lc3NhZ2VzRnJvbVN0YWNrKHN0YWNrKSxcbiAgICAgICAgcGVydGluZW50U3RhY2tNZXNzYWdlID0gc3RhY2tNZXNzYWdlc1tzYWxpZW50U3RhY2tNZXNzYWdlSW5kZXhdLFxuICAgICAgICBzdGFja01lc3NhZ2UgPSBwZXJ0aW5lbnRTdGFja01lc3NhZ2UsIC8vL1xuICAgICAgICBjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmcgPSBnZXRDdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmcoKSxcbiAgICAgICAgZmlsZVBhdGggPSBmaWxlUGF0aEZyb21TdGFja01lc3NhZ2Uoc3RhY2tNZXNzYWdlKSxcbiAgICAgICAgbGluZU51bWJlciA9IGxpbmVOdW1iZXJGcm9tU3RhY2tNZXNzYWdlKHN0YWNrTWVzc2FnZSksXG4gICAgICAgIGxvZ01lc3NhZ2UgPSBgJHtsZXZlbH0ke2N1cnJlbnREYXRlQW5kVGltZVN0cmluZ30gJHtmaWxlUGF0aH0oJHtsaW5lTnVtYmVyfSkgJHttZXNzYWdlfWA7XG5cbiAgY29uc29sZS5sb2cobG9nTWVzc2FnZSk7XG5cbiAgaWYgKGxvZ0RpcmVjdG9yeVBhdGggIT09IG51bGwpIHtcbiAgICByb2xsT3ZlckxvZ0ZpbGUoKTtcblxuICAgIGNvbnN0IGxvZ0ZpbGVQYXRoID0gZ2V0TG9nRmlsZVBhdGgoKSxcbiAgICAgICAgICBsb2dGaWxlQ29udGVudCA9IGAke2xvZ01lc3NhZ2V9XFxuYDtcblxuICAgIGFwcGVuZFRvRmlsZShsb2dGaWxlUGF0aCwgbG9nRmlsZUNvbnRlbnQpO1xuICB9XG5cbiAgcmV0dXJuIGxvZ01lc3NhZ2U7XG59XG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgbG9nXG59XG5cbmZ1bmN0aW9uIHRyYWNlKG1lc3NhZ2UpIHsgcmV0dXJuIGxvZyhtZXNzYWdlLCBUUkFDRSk7IH1cblxuZnVuY3Rpb24gZGVidWcobWVzc2FnZSkgeyByZXR1cm4gbG9nKG1lc3NhZ2UsIERFQlVHKTsgfVxuXG5mdW5jdGlvbiBpbmZvKG1lc3NhZ2UpIHsgcmV0dXJuIGxvZyhtZXNzYWdlLCBJTkZPKTsgfVxuXG5mdW5jdGlvbiB3YXJuaW5nKG1lc3NhZ2UpIHsgcmV0dXJuIGxvZyhtZXNzYWdlLCBXQVJOSU5HKTsgfVxuXG5mdW5jdGlvbiBlcnJvcihtZXNzYWdlKSB7IHJldHVybiBsb2cobWVzc2FnZSwgRVJST1IpOyB9XG5cbmZ1bmN0aW9uIGZhdGFsKG1lc3NhZ2UpIHsgcmV0dXJuIGxvZyhtZXNzYWdlLCBGQVRBTCk7IH1cblxuZnVuY3Rpb24gc2V0TG9nTGV2ZWwobGV2ZWwpIHsgbG9nTGV2ZWwgPSBsZXZlbDsgfVxuXG5mdW5jdGlvbiBzZXRMb2dGaWxlQmFzZU5hbWUoZmlsZUJhc2VOYW1lKSB7IGxvZ0ZpbGVCYXNlTmFtZSA9IGZpbGVCYXNlTmFtZTsgfVxuXG5mdW5jdGlvbiBzZXRMb2dEaXJlY3RvcnlQYXRoKGRpcmVjdG9yeVBhdGgpIHsgbG9nRGlyZWN0b3J5UGF0aCA9IGRpcmVjdG9yeVBhdGg7IH1cblxuZnVuY3Rpb24gc2V0TG9nT3B0aW9ucyhsb2dPcHRpb25zKSB7XG4gIGNvbnN0IHsgbGV2ZWwsIGZpbGVCYXNlTmFtZSwgZGlyZWN0b3J5UGF0aCB9ID0gbG9nT3B0aW9ucztcblxuICBzZXRMb2dMZXZlbChsZXZlbCk7XG5cbiAgc2V0TG9nRmlsZUJhc2VOYW1lKGZpbGVCYXNlTmFtZSk7XG5cbiAgc2V0TG9nRGlyZWN0b3J5UGF0aChkaXJlY3RvcnlQYXRoKTtcbn1cblxuZnVuY3Rpb24gZ2V0TG9nRmlsZUNvbnRlbnQoKSB7XG4gIGNvbnN0IGxvZ0ZpbGVQYXRoID0gZ2V0TG9nRmlsZVBhdGgoKSxcbiAgICAgICAgbG9nRmlsZUNvbnRlbnQgPSByZWFkRmlsZShsb2dGaWxlUGF0aCk7XG5cbiAgcmV0dXJuIGxvZ0ZpbGVDb250ZW50O1xufVxuXG5PYmplY3QuYXNzaWduKGxvZywge1xuICBUUkFDRSxcbiAgREVCVUcsXG4gIElORk8sXG4gIFdBUk5JTkcsXG4gIEVSUk9SLFxuICBGQVRBTCxcbiAgdHJhY2UsXG4gIGRlYnVnLFxuICBpbmZvLFxuICB3YXJuaW5nLFxuICBlcnJvcixcbiAgZmF0YWwsXG4gIHNldExvZ0xldmVsLFxuICBzZXRMb2dGaWxlQmFzZU5hbWUsXG4gIHNldExvZ0RpcmVjdG9yeVBhdGgsXG4gIHNldExvZ09wdGlvbnMsXG4gIGdldExvZ0ZpbGVDb250ZW50XG59KTtcblxuZnVuY3Rpb24gZ2V0TG9nRmlsZVBhdGgoKSB7XG4gIGNvbnN0IGxvZ0ZpbGVOYW1lID0gYCR7bG9nRmlsZUJhc2VOYW1lfS5sb2dgLFxuICAgICAgICBsb2dGaWxlUGF0aCA9IGNvbmNhdGVuYXRlUGF0aHMobG9nRGlyZWN0b3J5UGF0aCwgbG9nRmlsZU5hbWUpO1xuXG4gIHJldHVybiBsb2dGaWxlUGF0aDtcbn1cblxuZnVuY3Rpb24gZ2V0Um9sbGVkT3ZlckxvZ0ZpbGVQYXRoKCkge1xuICBjb25zdCBjdXJyZW50RGF0ZVN0cmluZyA9IGdldEN1cnJlbnREYXRlU3RyaW5nKCksXG4gICAgICAgIHJvbGxlZE92ZXJMb2dGaWxlTmFtZSA9IGAke2xvZ0ZpbGVCYXNlTmFtZX0uJHtjdXJyZW50RGF0ZVN0cmluZ30ubG9nYCxcbiAgICAgICAgcm9sbGVkT3ZlckxvZ0ZpbGVQYXRoID0gY29uY2F0ZW5hdGVQYXRocyhsb2dEaXJlY3RvcnlQYXRoLCByb2xsZWRPdmVyTG9nRmlsZU5hbWUpO1xuXG4gIHJldHVybiByb2xsZWRPdmVyTG9nRmlsZVBhdGg7XG59XG5cbmZ1bmN0aW9uIGdldExvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlKCkge1xuICBjb25zdCBsb2dGaWxlUGF0aCA9IGdldExvZ0ZpbGVQYXRoKCksXG4gICAgICAgIGxvZ0ZpbGVTdGF0cyA9IGdldFN0YXRzKGxvZ0ZpbGVQYXRoKSxcbiAgICAgICAgeyBtdGltZSB9ID0gbG9nRmlsZVN0YXRzLFxuICAgICAgICBsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZSA9IG5ldyBEYXRlKG10aW1lKTsgIC8vL1xuXG4gIHJldHVybiBsb2dGaWxlTGFzdE1vZGlmaWVkRGF0ZTtcbn1cblxuZnVuY3Rpb24gcm9sbE92ZXJMb2dGaWxlKCkge1xuICBjb25zdCBsb2dGaWxlUGF0aCA9IGdldExvZ0ZpbGVQYXRoKCksXG4gICAgICAgIGxvZ0ZpbGVFeGlzdHMgPSBjaGVja0ZpbGVFeGlzdHMobG9nRmlsZVBhdGgpO1xuXG4gIGlmICghbG9nRmlsZUV4aXN0cykge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IGxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlID0gZ2V0TG9nRmlsZUxhc3RNb2RpZmllZERhdGUoKSxcbiAgICAgICAgbG9nRmlsZUxhc3RNb2RpZmllZERhdGVDdXJyZW50RGF0ZSA9IGlzRGF0ZUN1cnJlbnREYXRlKGxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlKTtcblxuICBpZiAoIWxvZ0ZpbGVMYXN0TW9kaWZpZWREYXRlQ3VycmVudERhdGUpIHtcbiAgICBjb25zdCByb2xsZWRPdmVyTG9nRmlsZVBhdGggPSBnZXRSb2xsZWRPdmVyTG9nRmlsZVBhdGgoKTtcblxuICAgIHJlbmFtZUZpbGUobG9nRmlsZVBhdGgsIHJvbGxlZE92ZXJMb2dGaWxlUGF0aCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gaXNEYXRlQ3VycmVudERhdGUoZGF0ZSkge1xuICBjb25zdCBjdXJyZW50RGF0ZSA9IG5ldyBEYXRlKCksXG4gICAgICAgIGRhdGVTdHJpbmcgPSBkYXRlLnRvRGF0ZVN0cmluZygpLFxuICAgICAgICBjdXJyZW50RGF0ZVN0cmluZyA9IGN1cnJlbnREYXRlLnRvRGF0ZVN0cmluZygpLFxuICAgICAgICBkYXRlQ3VycmVudERhdGUgPSAoZGF0ZVN0cmluZyA9PT0gY3VycmVudERhdGVTdHJpbmcpO1xuXG4gIHJldHVybiBkYXRlQ3VycmVudERhdGU7XG59XG5cbmZ1bmN0aW9uIGdldEN1cnJlbnREYXRlU3RyaW5nKCkge1xuICBjb25zdCBkYXRlID0gbmV3IERhdGUoKSxcbiAgICAgICAgZGF5ID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0RGF0ZSgpLCAyKSwgIC8vL1xuICAgICAgICBtb250aCA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldE1vbnRoKCkgKyAxLCAyKSwgLy8vXG4gICAgICAgIHllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCksXG4gICAgICAgIGN1cnJlbnREYXRlQW5kVGltZVN0cmluZyA9IGAke2RheX0tJHttb250aH0tJHt5ZWFyfWA7XG5cbiAgcmV0dXJuIGN1cnJlbnREYXRlQW5kVGltZVN0cmluZztcbn1cblxuZnVuY3Rpb24gZ2V0Q3VycmVudERhdGVBbmRUaW1lU3RyaW5nKCkge1xuICBjb25zdCBkYXRlID0gbmV3IERhdGUoKSxcbiAgICAgICAgZGF5ID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0RGF0ZSgpLCAyKSwgIC8vL1xuICAgICAgICBtb250aCA9IHBhZFN0YXJ0V2l0aFplcm9lcyhkYXRlLmdldE1vbnRoKCkgKyAxLCAyKSwgLy8vXG4gICAgICAgIHllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCksXG4gICAgICAgIGhvdXJzID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0SG91cnMoKSwgMiksXG4gICAgICAgIG1pbnV0ZXMgPSBwYWRTdGFydFdpdGhaZXJvZXMoZGF0ZS5nZXRNaW51dGVzKCksIDIpLFxuICAgICAgICBzZWNvbmRzID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0U2Vjb25kcygpLCAyKSxcbiAgICAgICAgbWlsbGlzZWNvbmRzID0gcGFkU3RhcnRXaXRoWmVyb2VzKGRhdGUuZ2V0TWlsbGlzZWNvbmRzKCksIDMpLFxuICAgICAgICBjdXJyZW50RGF0ZUFuZFRpbWVTdHJpbmcgPSBgJHtkYXl9LSR7bW9udGh9LSR7eWVhcn0gJHtob3Vyc306JHttaW51dGVzfToke3NlY29uZHN9LiR7bWlsbGlzZWNvbmRzfWA7XG5cbiAgcmV0dXJuIGN1cnJlbnREYXRlQW5kVGltZVN0cmluZztcbn1cblxuZnVuY3Rpb24gc3RhY2tNZXNzYWdlc0Zyb21TdGFjayhzdGFjaykge1xuICBjb25zdCBzdGFja01lc3NhZ2VzID0gW10sXG4gICAgICAgIHN0YWNrTGluZXMgPSBzdGFjay5zcGxpdCgvXFxyXFxufFxcbi8pO1xuXG4gIGxldCBzdGFja01lc3NhZ2UgPSBcIlwiO1xuXG4gIHN0YWNrTGluZXMuZm9yRWFjaCgoc3RhY2tMaW5lKSA9PiB7XG4gICAgY29uc3QgbWF0Y2hlcyA9IC9eXFxzKmF0LiovLnRlc3Qoc3RhY2tMaW5lKTtcblxuICAgIHN0YWNrTWVzc2FnZSA9IChzdGFja01lc3NhZ2UgPT09IFwiXCIpID9cbiAgICAgICAgICAgICAgICAgICAgICBzdGFja0xpbmUgOlxuICAgICAgICAgICAgICAgICAgICAgICAgYCR7c3RhY2tNZXNzYWdlfVxcbiR7c3RhY2tMaW5lfWA7XG5cbiAgICBpZiAobWF0Y2hlcykge1xuICAgICAgc3RhY2tNZXNzYWdlcy5wdXNoKHN0YWNrTWVzc2FnZSk7XG5cbiAgICAgIHN0YWNrTWVzc2FnZSA9IFwiXCI7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gc3RhY2tNZXNzYWdlcztcbn1cblxuZnVuY3Rpb24gZmlsZVBhdGhGcm9tU3RhY2tNZXNzYWdlKHN0YWNrTWVzc2FnZSkge1xuICBjb25zdCBtYXRjaGVzID0gc3RhY2tNZXNzYWdlLm1hdGNoKC8oXFwvLispOlxcZCs6XFxkKy9tKSxcbiAgICAgICAgc2Vjb25kTWF0Y2ggPSBzZWNvbmQobWF0Y2hlcyksXG4gICAgICAgIGFic29sdXRlRmlsZVBhdGggPSBzZWNvbmRNYXRjaCwgIC8vL1xuICAgICAgICBjdXJyZW50V29ya2luZ0RpcmVjdG9yeVBhdGggPSBwYXRoLnJlc29sdmUoXCIuXCIpLCAgLy8vXG4gICAgICAgIGN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aExlbmd0aCA9IGN1cnJlbnRXb3JraW5nRGlyZWN0b3J5UGF0aC5sZW5ndGgsXG4gICAgICAgIHN0YXJ0ID0gY3VycmVudFdvcmtpbmdEaXJlY3RvcnlQYXRoTGVuZ3RoICsgMSwgIC8vL1xuICAgICAgICBmaWxlUGF0aCA9IGFic29sdXRlRmlsZVBhdGguc3Vic3RyKHN0YXJ0KTtcblxuICByZXR1cm4gZmlsZVBhdGg7XG59XG5cbmZ1bmN0aW9uIGxpbmVOdW1iZXJGcm9tU3RhY2tNZXNzYWdlKHN0YWNrTWVzc2FnZSkge1xuICBjb25zdCBtYXRjaGVzID0gc3RhY2tNZXNzYWdlLm1hdGNoKC86KFxcZCspL20pLFxuICAgICAgICBzZWNvbmRNYXRjaCA9IHNlY29uZChtYXRjaGVzKSxcbiAgICAgICAgbGluZU51bWJlciA9IHNlY29uZE1hdGNoOyAvLy9cblxuICByZXR1cm4gbGluZU51bWJlcjtcbn1cblxuZnVuY3Rpb24gcGFkU3RhcnRXaXRoWmVyb2VzKHN0cmluZywgdGFyZ2V0TGVuZ3RoKSB7XG4gIGNvbnN0IHBhZFN0cmluZyA9IFwiMFwiLFxuICAgICAgICBwYWRkZWRTdHJpbmcgPSBwYWRTdGFydChzdHJpbmcsIHRhcmdldExlbmd0aCwgcGFkU3RyaW5nKTtcblxuICByZXR1cm4gcGFkZGVkU3RyaW5nO1xufVxuXG5mdW5jdGlvbiBwYWRTdGFydChzdHJpbmcsIHRhcmdldExlbmd0aCwgcGFkU3RyaW5nKSB7XG4gIGxldCBwYWRkaW5nID0gXCJcIjtcblxuICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdGFyZ2V0TGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgcGFkZGluZyArPSBwYWRTdHJpbmc7XG4gIH1cblxuICBjb25zdCBwYWRkZWRTdHJpbmcgPSBgJHtwYWRkaW5nfSR7c3RyaW5nfWAuc3Vic3RyKC10YXJnZXRMZW5ndGgpO1xuXG4gIHJldHVybiBwYWRkZWRTdHJpbmc7XG59XG4iXX0=